<!DOCTYPE html>

<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notificaciones</title>
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logoPwa256.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
</head>

<body id="body" class="bg-gray-100 overflow-x-hidden min-h-screen">
  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
    <span class="loader"></span>
  </div>

  <!-- Navigation -->
  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden xl:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 xl:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden xl:flex items-center space-x-8">
        <!-- Navigation items will be dynamically created by createDesktopNavigation() -->

        <!-- Desktop Menu Notifications Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="desktopBellContainer">
          <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
          <span id="desktopNotificationCount"
            class="absolute top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="xl:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="mobileBellContainer">
          <img id="bellMobile" src="https://dosxdos.app.iidos.com/img/bell2.png"
            class="w-8 text-gray-900 object-contain mt-2" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-0 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Mobile Menu Button -->
        <button id="menuButton" class="xl:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

    </div>

    <div id="opcionesMenu"
      class="xl:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
      <div class="absolute inset-0 z-0"
        style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain; opacity: 0.7;">
      </div>
      <!-- User Profile Section -->
      <div class="px-8 py-4 mt-16 relative z-10">
        <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
          <!-- Profile image -->
          <div
            class="absolute left-0 w-28 h-28 rounded-full overflow-hidden border-4 border-white bg-gradient-to-br from-red-50 to-white flex items-center justify-center shadow-xl"
            style="transform: translateX(-15%);">
            <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
              class="w-full h-full object-cover" alt="Profile"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
            <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="ml-28 flex items-center py-4">
            <!-- User name -->
            <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
            <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
            <span class="text-black font-medium text-xl">!</span>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Navigation Links -->
      <nav class="px-8 pt-3 space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar mt-2">
        <!-- Dynamic menu items will be added here based on user role -->
      </nav>

      <!-- Mobile Menu Footer -->
      <div class="relative z-10">
        <div class="website-divider-container-734167" style="height: 100px; overflow: visible">
          <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
            preserveAspectRatio="none" style="bottom: -20px">
            <path
              d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
              style="fill: #ffffff"></path>
            <path
              d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.5"></path>
            <path
              d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.25"></path>
          </svg>
        </div>
      </div>

      <!-- User Actions -->
      <div class="relative z-10 mt-auto px-8 pb-6 bg-white shadow-lg flex justify-center space-x-6 pb-2 rounded-t-xl">
        <!-- Edit Button -->
        <button id="editarUsuarioMobile"
          class="flex items-center justify-center w-14 h-14 bg-white border-2 border-red-500 rounded-full hover:bg-red-100 transition-all duration-300">
          <svg class="w-8 h-8 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>

        <!-- Logout Button -->
        <button id="cerrarSesionMobile"
          class="flex items-center justify-center w-14 h-14 bg-red-600 rounded-full transition-all duration-300">
          <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        </button>
      </div>
    </div>
    </div>
  </section>

  <div class="pt-16 w-full">
    <div id="cabeceraContenido" class="flex flex-col bg-gray-100 shadow">
      <!-- Search Section -->
      <div class="relative flex items-center w-full px-12 mt-20 mb-6">
        <img src="https://dosxdos.app.iidos.com/img/lupa.png"
          class="w-5 h-5 opacity-90 absolute left-16 top-1/2 transform -translate-y-1/2" />
        <input type="text" id="buscador"
          class="shadow w-full h-12 pl-12 pr-4 bg-white/10 border border-white/20 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-red-600 transition-all duration-300 ease-in-out text-black placeholder-white/70"
          placeholder="Buscar notificaciones..." />
      </div>
      <div class="w-full">
        <div class="border-b border-gray-200">
          <nav class="flex -mb-px w-full" aria-label="Pestañas">
            <button id="pestañaPendientes"
              class="flex-1 w-[50vw] py-4 px-1 text-center border-b-2 border-red-500 text-red-600 font-medium text-sm">
              <span class="flex items-center justify-center">
                <span class="ml-2">Notificaciones Pendientes</span>
                <span id="contadorPendientes"
                  class="bg-red-100 text-red-600 ml-3 py-0.5 px-2.5 rounded-full text-xs">0</span>
              </span>
            </button>
            <button id="pestañaAceptadas"
              class="flex-1 w-[50vw] py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
              <span class="flex items-center justify-center">
                <span class="ml-2">Notificaciones Aceptadas</span>
                <span id="contadorAceptadas"
                  class="bg-gray-100 text-gray-600 ml-3 py-0.5 px-2.5 rounded-full text-xs">0</span>
              </span>
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <section id="contenidoPendientes" class="p-6 bg-gray-100"></section>
  <section id="contenidoAceptadas" class="hidden p-6 bg-gray-100"></section>

  <div id="modalNotificacion"
    class="fixed inset-0 z-50 hidden opacity-0 pointer-events-none transition-all duration-300 ease-in-out">
    <div class="fixed inset-0 overflow-y-auto custom-scrollbar flex items-center justify-center p-4">
      <div
        class="modal-content bg-white rounded-xl shadow-xl max-w-md w-full p-4 mx-4 transform scale-95 transition-all duration-300 ease-in-out">
        <h2 class="modal-title text-xl font-bold mb-4"></h2>
        <p class="modal-description text-gray-600 mb-4"></p>
        <div class="modal-details text-sm text-gray-500 mb-6"></div>
        <div class="flex space-x-3">
          <button id="cancelarAceptar"
            class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition">
            Cancelar
          </button><button id="confirmarAceptar"
            class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-600 transition">
            Aceptar
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
<script>
  let ruta = localStorage.getItem("ruta");
  let montador = localStorage.getItem("montador");
  let usuario, notificacionesSinAcpetarNumero = 0;


  // console.log("usuario", usuario);
  // console.log("ruta", ruta);
  // console.log("montador", montador);

  // Initialize ruta if not exists
  if (!ruta) {
    leerDatos("dosxdos", "usuario").then((userData) => {
      if (userData.length > 0 && userData[0].ruta) {
        ruta = userData[0].ruta;
        localStorage.setItem("ruta", ruta);
      } else {
        console.log("Ruta undefined.");
      }
    });
  }

  // Initialize montador if not exists
  if (!montador) {
    leerDatos("dosxdos", "usuario").then((data) => {
      if (data.length > 0 && data[0].cod) {
        montador = data[0].cod;
        localStorage.setItem("montador", montador);
      } else {
        console.log("No valid montador found.");
      }
    });
  }

  // Core Element References
  const elements = {
    buscador: document.getElementById("buscador"),
    loader: document.getElementById("loader"),
    body: document.getElementById("body"),
    nombreUsuarioDesktop: document.getElementById("nombreUsuarioDesktop"),
    nombreUsuarioMobile: document.getElementById("nombreUsuarioMobile"),
    imagenUsuarioDesktop: document.getElementById("imagenUsuarioDesktop"),
    imagenUsuarioMobile: document.getElementById("imagenUsuarioMobile"),
    contenidoPendientes: document.getElementById("contenidoPendientes"),
    contenidoAceptadas: document.getElementById("contenidoAceptadas"),
    userMenuButton: document.getElementById("userMenuButton"),
    userDropdownMenu: document.getElementById("userDropdownMenu"),
    menuButton: document.getElementById("menuButton"),
    mobileMenu: document.getElementById("mobileMenu"),
    hamburgerTop: document.getElementById("hamburgerTop"),
    hamburgerMiddle: document.getElementById("hamburgerMiddle"),
    hamburgerBottom: document.getElementById("hamburgerBottom"),
    editarUsuarioDesktop: document.getElementById("editarUsuarioDesktop"),
    editarUsuarioMobile: document.getElementById("editarUsuarioMobile"),
    cerrarSesionDesktop: document.getElementById("cerrarSesionDesktop"),
    cerrarSesionMobile: document.getElementById("cerrarSesionMobile"),
    pestañaPendientes: document.getElementById("pestañaPendientes"),
    pestañaAceptadas: document.getElementById("pestañaAceptadas"),
  };

  function scrollToTop() {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
  }

  /* LOADER */
  function loaderOn() {
    scrollToTop();
    elements.loader.classList.remove("displayOff");
    elements.loader.classList.add("displayOn");
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
  }

  function loaderOff() {
    setTimeout(() => {
      elements.loader.classList.remove("displayOn");
      elements.loader.classList.add("displayOff");
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
    }, 1000);
  }

  function alerta(mensaje) {
    // Remove existing alert if present
    const existingAlert = document.querySelector("#customAlert");
    if (existingAlert) {
      existingAlert.remove();
    }

    // Create alert container
    const alertContainer = document.createElement("div");
    alertContainer.id = "customAlert";
    alertContainer.className =
      "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[85vw] md:w-[80vw] lg:w-[75vw]";
    alertContainer.style.top = "-100px";

    // Create alert content
    const alertContent = document.createElement("div");
    alertContent.className = `
        relative
        bg-white
        border-2 border-red-600
        rounded-lg
        shadow-lg
        p-4 md:p-5
        flex flex-col md:flex-row md:items-center gap-3 md:gap-4
      `;

    // Create close button
    const closeButton = document.createElement("button");
    closeButton.className =
      "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600  rounded-full p-1.5 transition-colors duration-200";
    closeButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      `;

    // Create main content container for mobile layout
    const contentContainer = document.createElement("div");
    contentContainer.className =
      "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

    // Create icon with exclamation mark
    const iconContainer = document.createElement("div");
    iconContainer.className = "flex-shrink-0 text-red-600";
    iconContainer.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10" />
    <path d="M12 7v6" />
    <path d="M12 16h0.01" />
  </svg>
`;

    // Create message text
    const messageText = document.createElement("p");
    messageText.className = "text-gray-900 text-base md:text-lg flex-1";
    messageText.textContent = mensaje;

    // Assemble the content container
    contentContainer.appendChild(iconContainer);
    contentContainer.appendChild(messageText);

    // Assemble the alert
    alertContent.appendChild(closeButton);
    alertContent.appendChild(contentContainer);
    alertContainer.appendChild(alertContent);
    document.body.appendChild(alertContainer);

    // Slide down animation
    requestAnimationFrame(() => {
      alertContainer.style.top = "56px";
    });

    // Add event listeners
    closeButton.addEventListener("click", () => {
      hideAlert(alertContainer);
    });

    // Hide loader if it exists
    loaderOff();
  }

  function hideAlert(alertContainer) {
    alertContainer.style.top = "-100px";

    setTimeout(() => {
      alertContainer.remove();
    }, 300);
  }

  /* CERRAR SESIÓN */
  function eliminarCookie(nombre) {
    const tiempoExpiracion = 1;
    document.cookie = `${nombre}=; expires=${new Date(
      tiempoExpiracion * 1000
    ).toUTCString()}; path=/;`;
  }

  function deleteDB2(database) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.deleteDatabase(database);
      request.onsuccess = () => {
        console.log(`Base de datos "${database}" eliminada exitosamente.`);
        resolve(true);
      };
      request.onerror = (event) => {
        console.error(
          `Error al eliminar la base de datos "${database}":`,
          event.target.error
        );
        reject(event.target.error);
      };
    });
  }

  /* API AND DATA FUNCTIONS */
  function fetchRutas() {
    return new Promise((resolve, reject) => {
      url =
        "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" +
        montador;
      fetch(url)
        .then((res) => {
          if (res.ok) {
            return res.json();
          } else {
            mensaje =
              "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
            alerta(mensaje);
          }
        })
        .then((res) => {
          if (res[0]) {
            const request = indexedDB.open("dosxdos");
            request.onsuccess = (event) => {
              const db = event.target.result;
              const transaction = db.transaction("rutas", "readwrite");
              const datosStore = transaction.objectStore("rutas");
              const clearRequest = datosStore.clear();
              clearRequest.onsuccess = (clearEvent) => {
                const datos = res[1];
                datos.forEach((item) => {
                  datosStore.add(item);
                });
                resolve(true);
              };
              clearRequest.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                alerta(mensaje);
              };
            };
            request.onerror = (event) => {
              error = event.target.error;
              mensaje = `ERROR: ` + error;
              alerta(mensaje);
            };
          } else {
            mensaje = res[1];
            console.warn(mensaje);
            resolve(true);
          }
        })
        .catch((res) => {
          mensaje = "Sin conexión: " + res.message;
          alerta(mensaje);
        });
    });
  }

  function fetchLineas(vectorRutas) {
    return new Promise(async (resolve, reject) => {
      try {
        const promises = vectorRutas.map(async (objeto) => {
          const url =
            "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
            objeto.cod;
          const res = await fetch(url);

          if (!res.ok) {
            throw new Error(
              `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
            );
          }

          const resJson = await res.json();

          if (resJson[0]) {
            const db = await new Promise((dbResolve, dbReject) => {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                dbResolve(db);
              };
              request.onerror = (event) => {
                dbReject(
                  new Error(
                    `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                  )
                );
              };
            });

            const transaction = db.transaction("lineas", "readwrite");
            const datosStore = transaction.objectStore("lineas");
            const datos = resJson[1];
            if (Array.isArray(datos)) {
              datos.forEach((item) => {
                datosStore.add(item);
              });
            } else {
              datosStore.add(datos);
            }
          } else {
            throw new Error(
              `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
            );
          }
        });

        await Promise.all(promises);
        resolve(true);
      } catch (err) {
        console.error(err);
        reject(err);
      }
    });
  }

  async function sincronizarDb2() {
    return new Promise(async (resolve, reject) => {
      try {
        loaderOn();
        const fRutas = await fetchRutas();
        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));
        const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
        if (limpiarLineas) {
          lineas = await fetchLineas(rutas);
          if (lineas) {
            resolve(true);
          } else {
            resolve(false);
          }
        }
      } catch (error) {
        console.error(error);
        reject(false);
      }
    });
  }

  /* LOGIN */
  async function vLogin() {
    return new Promise((resolve, reject) => {
      const login = localStorage.getItem("login");
      if (login && login !== null) {
        leerDatos("dosxdos", "usuario")
          .then((res) => {
            console.log("data for user ---->", res[0]);
            usuario = res[0];
            resolve(usuario.clase);
          })
          .catch((err) => {
            resolve(false);
          });
      } else {
        resolve(false);
      }
    });
  }

  let isUpdating = false;

  const actualizarVistaNotificaciones = async () => {
    console.log('Starting actualizarVistaNotificaciones');

    if (isUpdating) {
      console.log('Already updating, returning');
      return;
    }

    isUpdating = true;

    try {
      const pendientesContainer = elements.contenidoPendientes;
      const aceptadasContainer = elements.contenidoAceptadas;
      const pestañaPendientes = elements.pestañaPendientes;

      console.log('Containers:', {
        pendientes: pendientesContainer,
        aceptadas: aceptadasContainer
      });

      const mostrarPendientes = pestañaPendientes.classList.contains("border-red-500");
      console.log('Showing pending notifications:', mostrarPendientes);

      pendientesContainer.style.display = mostrarPendientes ? "block" : "none";
      aceptadasContainer.style.display = mostrarPendientes ? "none" : "block";

      console.log('Fetching notifications');
      const TotalNotificaciones = await leerDatos("dosxdos", "notificaciones");

      console.log('Total notifications:', TotalNotificaciones);

      // Sort notifications by date in reverse chronological order (newest first)
      TotalNotificaciones.sort((a, b) => {
        return new Date(b.fecha_envio) - new Date(a.fecha_envio);
      });

      const pendientes = TotalNotificaciones.filter(notif => notif.visto === 0);
      const aceptadas = TotalNotificaciones.filter(notif => notif.visto === 1);

      console.log('Pending notifications:', pendientes);
      console.log('Accepted notifications:', aceptadas);

      // Update counters
      document.getElementById("contadorPendientes").textContent = pendientes.length;
      document.getElementById("contadorAceptadas").textContent = aceptadas.length;

      // Check if we should show empty state
      const shouldShowEmptyState = mostrarPendientes ? pendientes.length === 0 : aceptadas.length === 0;
      console.log('Should show empty state:', shouldShowEmptyState);

      if (shouldShowEmptyState) {
        const emptyStateHTML = mostrarPendientes
          ? `
        <div class="flex flex-col items-center justify-center p-8 bg-gray-100 rounded-xl text-center">
          <div class="mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.5a1.5 1.5 0 010-3h2.5v3z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4l3 3" />
            </svg>
          </div>
          <h3 class="text-2xl font-bold text-gray-800 mb-3">
            Sin Notificaciones Pendientes
          </h3>
          <p class="text-gray-600 mb-6 max-w-md">
            Parece que no tienes ninguna notificación pendiente en este momento.
          </p>
        </div>`
          : `
        <div class="flex flex-col items-center justify-center p-8 bg-gray-100 rounded-xl text-center">
          <div class="mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.5a1.5 1.5 0 010-3h2.5v3z" />
              <path stroke-linecap="round" stroke-lienjoin="round" stroke-width="1" d="M12 8v4l3 3" />
            </svg>
          </div>
          <h3 class="text-2xl font-bold text-gray-800 mb-3">
            No Hay Notificaciones Aceptadas
          </h3>
          <p class="text-gray-600 mb-6 max-w-md">
            Aún no has aceptado ninguna notificación.
          </p>
        </div>`;

        console.log('Rendering empty state');

        if (mostrarPendientes) {
          pendientesContainer.innerHTML = emptyStateHTML;
        } else {
          aceptadasContainer.innerHTML = emptyStateHTML;
        }
      } else {
        console.log('Rendering notifications');
        // Clear containers first
        pendientesContainer.innerHTML = '';
        aceptadasContainer.innerHTML = '';

        // Add notifications to containers
        pendientes.forEach(notif => {
          const searchTerm = elements.buscador.value.toLowerCase().trim();
          const element = createNotificationElement(notif, searchTerm);
          pendientesContainer.appendChild(element);
        });

        aceptadas.forEach(notif => {
          const searchTerm = elements.buscador.value.toLowerCase().trim();
          const element = createNotificationElement(notif, searchTerm);
          aceptadasContainer.appendChild(element);
        });
      }

      console.log('Finished actualizarVistaNotificaciones');
    } catch (error) {
      console.error('Error in actualizarVistaNotificaciones:', error);
    } finally {
      isUpdating = false;
    }
  };


  async function updateCounters() {
    const TotalNotificaciones = await leerDatos("dosxdos", "notificaciones");

    const contadorPendientes = TotalNotificaciones.filter(
      (notif) => notif.visto === 0
    ).length;
    const contadorAceptadas = TotalNotificaciones.filter(
      (notif) => notif.visto === 1
    ).length;

    document.getElementById("contadorPendientes").textContent =
      contadorPendientes;
    document.getElementById("contadorAceptadas").textContent =
      contadorAceptadas;
  }

  function parseLineDetails(mensaje, titulo) {
    // Special case for route closure messages
    if (mensaje.includes("ruta esta cerrada")) {
      return {
        client: "-",
        ot: "-",
        route: mensaje.split("ruta:")[1]?.trim() || "-",
        address: "-",
      };
    }

    // Remove "Datos de línea: " if it exists
    let cleanMessage = mensaje.replace("Datos de línea:", "").trim();

    // Split the message into parts by commas and trim spaces
    const details = cleanMessage.split(",").map((detail) => detail.trim());

    // If we don't have enough parts, return default values
    if (details.length < 5) {
      console.warn("Non-standard message format:", mensaje);
      return {
        client: details[0] || "-",
        ot: details[2] || "-",
        route: extractRoute(titulo) || "-",
        address: details[3] ? details.slice(3).join(", ") : "-",
      };
    }

    return {
      client: details[0],
      ot: details[2],
      route: extractRoute(titulo),
      address: details.slice(3).join(", "),
    };
  }

  // Extract route from the title
  function extractRoute(titulo) {
    const match = titulo.match(/ruta\s+([^\s]+)/i);
    return match ? match[1].replace("con", "").trim() : "-";
  }

  // Extract line number
  function extractLineNumber(titulo) {
    const match = titulo.match(/línea\s*(\d+)/i);
    return match ? match[1] : "-";
  }

  function highlightText(text, searchTerm) {
    if (!searchTerm) return text; // Return original text if no search term

    const escapedTerm = searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"); // Escape special characters
    const regex = new RegExp(`(${escapedTerm})`, "gi");

    return text.replace(
      regex,
      `<mark class="bg-white bg-opacity-70">$1</mark>`
    );
  }

  // NOTIFICATION PROCESSING FUNCTIONS
  function createNotificationElement(objeto, searchTerm = "") {
    let existingElement = document.querySelector(
      `[data-notification-id="${objeto.id}"]`
    );

    if (existingElement) existingElement.remove(); // Ensure we remove outdated elements

    const containerDiv = document.createElement("div");
    containerDiv.className = "w-full mb-4";
    containerDiv.setAttribute("data-notification-id", objeto.id);
    containerDiv.setAttribute(
      "data-estado",
      objeto.visto === 1 ? "aceptada" : "pendiente"
    );

    const notificationContent = document.createElement("div");
    notificationContent.className =
      objeto.visto === 1
        ? "bg-gradient-to-r from-red-500 to-red-600 text-white opacity-50 grayscale"
        : "bg-gradient-to-r from-red-500 to-red-600 text-white";
    notificationContent.classList.add(
      "rounded-xl",
      "p-4",
      "cursor-pointer",
      "relative"
    );

    // Format date for display
    const formattedDate = formatDate(objeto.fecha_envio);

    notificationContent.innerHTML = `
    <div class="flex justify-between items-center">
        <div
          class="absolute inset-0 -z-10 rounded-xl"
          style="
            background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
            background-size: contain, 70%;
            opacity: 0.5;
          "
        ></div>
      <h3 class="font-bold text-lg flex-grow pr-2 pt-4 lg:pt-0 pb-2 z-10">${highlightText(
      objeto.titulo,
      searchTerm
    )}</h3>
      <span class="${objeto.visto === 1
        ? "bg-gray-200 text-gray-600"
        : "bg-white text-red-600"
      } absolute top-2 right-2 px-2 py-0.5 rounded-full text-xs font-semibold tracking-tight">
        ${objeto.visto === 1 ? "Aceptada" : "Pendiente"}
      </span>
    </div>
    <p class="text-sm opacity-75 mt-2 mb-6">${highlightText(
        objeto.mensaje,
        searchTerm
      )}</p>
    <p class="text-xs opacity-75 absolute bottom-2 right-4">${formattedDate}</p>
  `;

    notificationContent.addEventListener("click", () =>
      openNotificationModal(objeto)
    );

    containerDiv.appendChild(notificationContent);
    return containerDiv;
  }

  // CODE FOR THE NOTIFICATION MODAL
  function openNotificationModal(objeto) {
    const modal = document.getElementById("modalNotificacion");

    // Parse data
    const lineNumber = extractLineNumber(objeto.titulo);
    const parsedDetails = parseLineDetails(objeto.mensaje, objeto.titulo);
    const cleanedTitle = objeto.titulo.replace(/\s*con\s*línea\s*\d+/i, "").trim();

    // Determine if the notification is already read
    const isReadTab = !document
      .getElementById("pestañaPendientes")
      .classList.contains("border-red-500");

    // Create new modal content
    const modalContent = `
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-auto overflow-hidden">
      <!-- Modal Header with improved layout -->
      <div class="relative bg-red-600 p-4 text-white">
        <div class="absolute inset-0 opacity-70" style="
              background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
              background-size: contain;
            "></div>

        <!-- Title and Close Button Row -->
        <div class="relative z-10 flex justify-between items-start">
          <div>
            <h2 id="notification-line" class="text-xl font-bold">${lineNumber}</h2>
            <h3 id="notification-title" class="text-lg font-medium mt-1">
              ${cleanedTitle}
            </h3>
          </div>

          <button id="modal-close" class="p-1 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Info Grid -->
        <div class="mt-4 relative z-10 grid grid-cols-2 gap-y-2 gap-x-10 text-sm">
          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">Fecha:</div>
            <div id="notification-date" class="font-medium">${formatDate(objeto.fecha_envio)}</div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">Cliente:</div>
            <div id="notification-client" class="font-medium">
              ${parsedDetails.client}
            </div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">OT:</div>
            <div id="notification-ot" class="font-medium">${parsedDetails.ot}</div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">Ruta:</div>
            <div id="notification-route" class="font-medium">${parsedDetails.route}</div>
          </div>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="p-4 space-y-3">
        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-sm text-gray-700 font-medium">Dirección</p>
          <p id="notification-address" class="text-gray-900 font-medium">${parsedDetails.address}</p>
        </div>

        <div id="modal-description" class="bg-gray-100 p-3 rounded-lg" style="${objeto.mensaje ? '' : 'display: none;'}">
          <p class="text-sm text-gray-700 font-medium">Observaciones</p>
          <p id="notification-observaciones" class="text-gray-900 font-medium">${objeto.mensaje || ''}</p>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="p-4 flex gap-3">
        <button id="cancelarAceptar"
          class="flex-1 h-12 bg-gray-200 hover:bg-gray-400 text-gray-700 font-bold rounded-lg transition-colors flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd" />
          </svg>
          Cancelar
        </button>
                ${isReadTab ? '' : `
        <button id="confirmarAceptar"
          class="flex-1 h-12 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
              clip-rule="evenodd" />
          </svg>
          Aceptar
        </button>
        `}
      </div>
    </div>
  `;

    // Set modal content
    modal.innerHTML = modalContent;

    // Add event listeners
    document.getElementById("modal-close").addEventListener("click", closeModal);
    document.getElementById("cancelarAceptar").addEventListener("click", closeModal);

    if (!isReadTab) {
      document.getElementById("confirmarAceptar").addEventListener("click", () =>
        aceptarNotificacion(objeto)
      );
    }

    // Show modal
    modal.classList.remove("hidden", "opacity-0", "pointer-events-none");
    modal.classList.add("fixed", "inset-0", "bg-black", "bg-opacity-50", "z-40", "flex", "items-center", "justify-center", "p-4", "opacity-100", "pointer-events-auto");
  }

  // Date formatting function
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString("es-ES", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  // Initialize modal structure on page load
  document.addEventListener("DOMContentLoaded", () => {
    const modalNotificacion = document.getElementById("modalNotificacion");
    if (modalNotificacion) {
      const modalContent = modalNotificacion.querySelector(".modal-content");
      if (modalContent) {
        modalContent.innerHTML = `
                  <div class="p-2 space-y-4">
                    <h2 class="modal-title text-xl font-bold text-gray-800 mb-2"></h2>
                    <p class="modal-description text-gray-600 mb-4"></p>
                    <div class="modal-details text-sm text-gray-500 mb-6"></div>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                      <button
                        id="confirmarAceptar"
                        class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-semibold px-2"
                      >
                        Marcar como Leída
                      </button>
                      <button
                        id="cancelarAceptar"
                        class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition font-semibold"
                      >
                        Cancelar
                      </button>
                    </div>
                  </div>
                `;
      }
    }
  });

  function closeModal() {
    const modal = document.getElementById("modalNotificacion");
    modal.classList.remove("opacity-100", "pointer-events-auto");
    modal.classList.add("opacity-0", "pointer-events-none");
    setTimeout(() => {
      modal.classList.add("hidden");
    }, 300);
  }

  function closeSidebar() {
    const mobileMenu = document.getElementById("mobileMenu");
    const hamburgerTop = document.getElementById("hamburgerTop");
    const hamburgerMiddle = document.getElementById("hamburgerMiddle");
    const hamburgerBottom = document.getElementById("hamburgerBottom");

    if (mobileMenu) {
      mobileMenu.classList.add("translate-x-full");

      // Reset hamburger icon colors and position
      if (hamburgerTop && hamburgerMiddle && hamburgerBottom) {
        // Remove white background
        hamburgerTop.classList.remove("bg-white");
        hamburgerMiddle.classList.remove("bg-white");
        hamburgerBottom.classList.remove("bg-white");

        // Add dark background
        hamburgerTop.classList.add("bg-gray-900");
        hamburgerMiddle.classList.add("bg-gray-900");
        hamburgerBottom.classList.add("bg-gray-900");

        // Reset transforms
        hamburgerTop.style.transform = "";
        hamburgerMiddle.style.opacity = "1";
        hamburgerBottom.style.transform = "";
      }
    }
  }

  // SEARCH FUNCTIONALITY
  function initializeSearch() {
    const buscador = document.getElementById("buscador");
    if (buscador) {
      buscador.addEventListener("input", () => {
        const searchTerm = buscador.value.toLowerCase().trim();
        const notifications = document.querySelectorAll(
          "[data-notification-id]"
        );

        notifications.forEach((notification) => {
          const titleEl = notification.querySelector("h3");
          const messageEl = notification.querySelector("p");

          const titleText = titleEl?.textContent.toLowerCase() || "";
          const messageText = messageEl?.textContent.toLowerCase() || "";

          const matchesSearch =
            titleText.includes(searchTerm) ||
            messageText.includes(searchTerm);
          const isPending =
            notification.getAttribute("data-estado") !== "aceptada";
          const showingPending =
            document.getElementById("contenidoPendientes").style.display !==
            "none";

          // Show or hide based on the search
          notification.style.display =
            matchesSearch &&
              ((showingPending && isPending) || (!showingPending && !isPending))
              ? "block"
              : "none";

          // Apply the highlight effect
          if (matchesSearch) {
            if (titleEl)
              titleEl.innerHTML = highlightText(
                titleEl.textContent,
                searchTerm
              );
            if (messageEl)
              messageEl.innerHTML = highlightText(
                messageEl.textContent,
                searchTerm
              );
          }
        });
      });
    }
  }

  async function aceptarNotificacion(objeto) {
    try {
      loaderOn();
      if (navigator.onLine) {
        const response = await fetch(
          `https://dosxdos.app.iidos.com/apirest/rutas_notificaciones.php/notificaciones/aceptar/${objeto.id}`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ visto: true }), // Changed to true for API
          }
        );
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }

        const data = await response.json();
        console.log("Response data:", data);

        // Update IndexedDB - store as 1 for consistency with existing data
        const db = await new Promise((resolve, reject) => {
          const request = indexedDB.open("dosxdos");
          request.onsuccess = (event) => resolve(event.target.result);
          request.onerror = (event) => reject(event.target.error);
        });

        const transaction = db.transaction("notificaciones", "readwrite");
        const store = transaction.objectStore("notificaciones");

        // Update notification status - store as 1 in local DB
        objeto.visto = 1; // Keep as 1 for local storage
        await store.put(objeto);

        // Rest of the UI update code remains the same...
        const notificationElement = document.querySelector(
          `[data-notification-id="${objeto.id}"]`
        );

        if (notificationElement) {
          notificationElement.setAttribute("data-estado", "aceptada");
          notificationElement.classList.add("opacity-50", "grayscale");

          const statusBadge = notificationElement.querySelector("span");
          if (statusBadge) {
            statusBadge.textContent = "Leída";
            statusBadge.classList.replace("bg-white", "bg-gray-200");
            statusBadge.classList.replace("text-red-600", "text-gray-600");
          }

          const aceptadasContainer =
            document.getElementById("contenidoAceptadas");
          if (aceptadasContainer) {
            aceptadasContainer.appendChild(notificationElement);
          }

          await actualizarVistaNotificaciones();
        }
      } else {
        alerta("Sin conexión a internet no puedes aceptar notificaciones");
      }

      closeModal();
    } catch (error) {
      console.error("Error processing notification:", error);
      alerta("Error al procesar la notificación: " + error.message);
    } finally {
      loaderOff();
    }
  }

  // TAB SWITCHING LOGIC
  function setupNotificationTabs() {
    const pestañaPendientes = document.getElementById("pestañaPendientes");
    const pestañaAceptadas = document.getElementById("pestañaAceptadas");

    pestañaPendientes.addEventListener("click", () => {
      pestañaPendientes.classList.add("border-red-500", "text-red-600");
      pestañaPendientes.classList.remove(
        "border-transparent",
        "text-gray-500"
      );
      pestañaAceptadas.classList.remove("border-red-500", "text-red-600");
      pestañaAceptadas.classList.add("border-transparent", "text-gray-500");

      actualizarVistaNotificaciones(); // Only call this once
    });

    pestañaAceptadas.addEventListener("click", () => {
      pestañaAceptadas.classList.add("border-red-500", "text-red-600");
      pestañaAceptadas.classList.remove(
        "border-transparent",
        "text-gray-500"
      );
      pestañaPendientes.classList.remove("border-red-500", "text-red-600");
      pestañaPendientes.classList.add("border-transparent", "text-gray-500");

      actualizarVistaNotificaciones(); // Only call this once
    });

    // Initial load
    actualizarVistaNotificaciones();
  }

  // FINAL DOM CONTENT LOADED EVENT
  document.addEventListener("DOMContentLoaded", () => {
    initializeSearch();
    setupNotificationTabs();
  });

  // APPLICATION ONLINE STATE HANDLER
  async function appOnline() {
    try {
      const login = await vLogin();

      const Arrayusuario = await leerDatos("dosxdos", "usuario");
      if (!Arrayusuario || !Arrayusuario.length) {
        throw new Error("No se encontraron datos de usuario");
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      }

      // Find the actual user object (the one with 'usuario' property)
      usuario = Arrayusuario.find((item) => item.hasOwnProperty("usuario"));

      if (!usuario) {
        throw new Error("No se encontró el objeto de usuario correcto");
      }

      let loginMontador = localStorage.getItem("loginMontador");

      // if (!loginMontador) {
      //   window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?id=${usuario.id}&rol=${usuario.clase}`;
      //   return;
      // }

      montador = usuario.cod;

      // Dynamically create navigation based on user role
      createDesktopNavigation(usuario.clase);
      // Setup desktop and mobile navigation
      setupMenu(usuario.clase);

      // Setup menu interactions
      setupMenuInteractions();
      setupUserActions();
      setupGlobalMenuClosing();

      updateUserDisplay();

      // Update UI with user details
      const imagenUsuarioDesktop = document.getElementById(
        "imagenUsuarioDesktop"
      );
      const imagenUsuarioMobile = document.getElementById(
        "imagenUsuarioMobile"
      );

      const nombreUsuarioDesktop = document.getElementById(
        "nombreUsuarioDesktop"
      );
      const nombreUsuarioMobile = document.getElementById(
        "nombreUsuarioMobile"
      );

      if (usuario && usuario.nombre) {
        if (nombreUsuarioDesktop) {
          nombreUsuarioDesktop.textContent = usuario.nombre;
        } else {
          console.error("Desktop element not found");
        }

        if (nombreUsuarioMobile) {
          nombreUsuarioMobile.textContent = usuario.nombre;
        } else {
          console.error("Mobile element not found");
        }
      } else {
        console.error("⚠️ No se pudo cargar el nombre del usuario.");
      }

      if (usuario.imagen !== "0") {
        if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
        if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
      }

      // Synchronize database
      const sinc = await sincronizarDb2();
      if (!sinc) console.error("Error al sincronizar la base de datos");

      // Synchronize notifications
      await sincronizarNotificaciones();

      // Process pending requests
      const TotalNotificaciones = await leerDatos(
        "dosxdos",
        "notificaciones"
      );

      console.warn("TotalNotificaciones", TotalNotificaciones);

      if (TotalNotificaciones) {
        // Sort notifications by date (newest first)
        TotalNotificaciones.sort((a, b) => {
          return new Date(b.fecha_envio) - new Date(a.fecha_envio);
        });

        // Split notifications
        const pendientes = TotalNotificaciones.filter(objeto => objeto.visto == 0);
        const aceptadas = TotalNotificaciones.filter(objeto => objeto.visto == 1);

        console.log("Pendientes:", pendientes);
        console.log("Aceptadas:", aceptadas);

        // Populate notification containers
        const pendientesContainer = document.getElementById("contenidoPendientes");
        const aceptadasContainer = document.getElementById("contenidoAceptadas");

        pendientesContainer.innerHTML = "";
        aceptadasContainer.innerHTML = "";

        pendientes.forEach(objeto => {
          const element = createNotificationElement(objeto);
          pendientesContainer.appendChild(element);
        });

        aceptadas.forEach((objeto) => {
          const element = createNotificationElement(objeto);
          aceptadasContainer.appendChild(element);
        });

        // Update notification counters
        const contadorPendientes =
          document.getElementById("contadorPendientes");
        const contadorAceptadas =
          document.getElementById("contadorAceptadas");

        if (contadorPendientes)
          contadorPendientes.textContent = pendientes.length;
        if (contadorAceptadas)
          contadorAceptadas.textContent = aceptadas.length;

        await procesarPeticiones2();
        loaderOff();
      } else {
        await procesarPeticiones2();
        alerta("Error al leer el almacén de notificaciones");
        loaderOff();
      }
    } catch (error) {
      console.error("ERROR:", error.message);
      alerta(error.message);
    }
  }

  function removeDuplicates(array) {
    const seen = new Set();
    return array.filter((item) => {
      if (!seen.has(item.id)) {
        seen.add(item.id);
        return true;
      }
      return false;
    });
  }

  // APPLICATION OFFLINE STATE HANDLER
  async function appOffline() {
    try {
      const login = await vLogin();

      const Arrayusuario = await leerDatos("dosxdos", "usuario");
      if (!Arrayusuario || !Arrayusuario.length) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
        throw new Error("No se encontraron datos de usuario");
      }

      // Find the actual user object (the one with 'usuario' property)
      usuario = Arrayusuario.find((item) => item.hasOwnProperty("usuario"));

      if (!usuario) {
        throw new Error("No se encontró el objeto de usuario correcto");
      }

      let loginMontador = localStorage.getItem("loginMontador");

      // if (!loginMontador) {
      //   window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?id=${usuario.id}&rol=${usuario.clase}`;
      //   return;
      // }

      montador = usuario.cod;

      // Update UI with user details
      const imagenUsuarioDesktop = document.getElementById(
        "imagenUsuarioDesktop"
      );
      const imagenUsuarioMobile = document.getElementById(
        "imagenUsuarioMobile"
      );

      const nombreUsuarioDesktop = document.getElementById(
        "nombreUsuarioDesktop"
      );
      const nombreUsuarioMobile = document.getElementById(
        "nombreUsuarioMobile"
      );

      if (usuario && usuario.nombre) {
        if (nombreUsuarioDesktop) {
          nombreUsuarioDesktop.textContent = usuario.nombre;
        } else {
          console.error("Desktop element not found");
        }

        if (nombreUsuarioMobile) {
          nombreUsuarioMobile.textContent = usuario.nombre;
        } else {
          console.error("Mobile element not found");
        }
      } else {
        console.error("⚠️ No se pudo cargar el nombre del usuario.");
      }

      if (usuario.imagen !== "0") {
        if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
        if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
      }

      // Process pending requests
      let TotalNotificaciones = await leerDatos("dosxdos", "notificaciones");

      console.warn(
        "TotalNotificaciones before deduplication:",
        TotalNotificaciones
      );

      // Filter out duplicate items by `id`
      TotalNotificaciones = removeDuplicates(TotalNotificaciones);

      console.warn(
        "TotalNotificaciones after deduplication:",
        TotalNotificaciones
      );

      if (TotalNotificaciones) {
        // Split notifications
        const pendientes = TotalNotificaciones.filter(
          (objeto) => objeto.visto == 0
        );
        const aceptadas = TotalNotificaciones.filter(
          (objeto) => objeto.visto == 1
        );

        console.log("Pendientes:", pendientes);
        console.log("Aceptadas:", aceptadas);

        // Populate notification containers
        const pendientesContainer = document.getElementById(
          "contenidoPendientes"
        );
        const aceptadasContainer =
          document.getElementById("contenidoAceptadas");

        pendientesContainer.innerHTML = "";
        aceptadasContainer.innerHTML = "";

        pendientes.forEach((objeto) => {
          const element = createNotificationElement(objeto);
          pendientesContainer.appendChild(element);
        });

        aceptadas.forEach((objeto) => {
          const element = createNotificationElement(objeto);
          aceptadasContainer.appendChild(element);
        });

        // Update notification counters
        const contadorPendientes =
          document.getElementById("contadorPendientes");
        const contadorAceptadas =
          document.getElementById("contadorAceptadas");

        if (contadorPendientes)
          contadorPendientes.textContent = pendientes.length;
        if (contadorAceptadas)
          contadorAceptadas.textContent = aceptadas.length;

        loaderOff();
      } else {
        alerta("Error al leer el almacén de notificaciones");
        loaderOff();
      }
    } catch (error) {
      console.error("ERROR:", error.message);
      alerta(error.message);
    }
  }

  /* PETICIONES PENDIENTES */

  function actualizarLinea(json) {
    console.log(json);
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/lineas.php", {
        method: "PUT",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) =>
          res.ok
            ? res.json()
            : reject(
              new Error(
                `Error en los servidores al actualizar los datos de la línea`
              )
            )
        )
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFotos(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/fotos.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las fotos. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFirmas(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/firmas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las firmas. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirNota(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/notas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar la nota. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }


  async function enviarPeticiones(vectorObjDb, tipoVector) {
    return new Promise(async (resolve, reject) => {
      try {
        let solicitud,
          mensaje = "",
          vaciarStore;
        for (const objeto of vectorObjDb) {
          jsonObjeto = JSON.stringify(objeto);
          if (tipoVector == "lineas") {
            solicitud = await actualizarLinea(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error en el envío de la petición pendiente de la actualización de datos en la api de Navision en la ruta: ${objeto.CodigoRuta} y la línea de ruta: ${objeto.LineaRuta}-`;
            }
          } else if (tipoVector == "fotos") {
            solicitud = await subirFotos(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las fotos pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "firmas") {
            solicitud = await subirFirmas(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las firmas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "notas") {
            solicitud = await subirNota(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las notas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.linea}-`;
            }
          }
        }
        if (tipoVector == "lineas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesLineas");
          mensaje += "-Datos pendientes enviados al servidor-";
        } else if (tipoVector == "fotos") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFotos");
          mensaje += "-Fotos pendientes subidas al servidor-";
        } else if (tipoVector == "firmas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFirmas");
          mensaje += "-Firmas pendientes subidas al servidor-";
        } else if (tipoVector == "notas") {
          vaciarStore = await limpiarDatos2("dosxdos", "notas");
          mensaje += "-Notas pendientes subidas al servidor-";
        }
        resolve(mensaje);
      } catch (err) {
        console.error(err);
        alerta(err.message);
        scrollToTop();
        reject(err);
      }
    });
  }

  async function procesarPeticiones() {
    try {
      loaderOn();
      mensaje = "";
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
        }
      }
      if (!mensaje) {
        mensaje = "No hay datos pendientes para ser enviados al servidor";
      }
      const sincronizarBaseDatos = await sincronizarDb2();
      if (sincronizarBaseDatos) {
        mensaje += "- Se ha sincronizado la base de datos exitosamente";
      } else {
        mensaje += "-Error: No ha sido posible sincronizar la base de datos-";
      }
      localStorage.setItem("mensaje", mensaje);
      location.reload();
      /*alerta(mensaje);
            scrollToTop();*/
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  async function procesarPeticiones2(mensaje) {
    try {
      if (mensaje == null) {
        mensaje = "";
      }
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
        }
      }
      if (mensaje) {
        alerta(mensaje);
        scrollToTop();
      }
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  /* TAREAS EN LA INTERMITENCIA DE LA CONEXIÓN */

  window.addEventListener("online", () => {
    console.log("La conexión a Internet se ha recuperado.");
    //cache();
    procesarPeticiones();
  });

  window.addEventListener("offline", () => {
    alerta("La conexión a Internet se ha perdido.");
  });

  /* PAGESHOW */
  window.addEventListener("pageshow", (e) => {
    console.log("Carga completa de los elementos de la página no fetch");
    let mensaje = localStorage.getItem("mensaje");
    if (mensaje && mensaje !== null) {
      alerta(mensaje); // Use the new alert instead
      localStorage.removeItem("mensaje");
    }
    let login = localStorage.getItem("login");
    if (!login || login === null) {
      window.location.href = "https://dosxdos.app.iidos.com/index.html";
    }
  });



  // INITIALIZATION FUNCTION
  function initializeAppState() {
    if (navigator.onLine) {
      console.log("La aplicación está en línea.");
      appOnline();
    } else {
      console.log("La aplicación está fuera de línea.");
      appOffline();
    }
  }

  // Attach initialization to DOMContentLoaded
  document.addEventListener("DOMContentLoaded", initializeAppState);
</script>

<script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
<script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>
<script src="https://dosxdos.app.iidos.com/js/navigation.js"></script>

</html>