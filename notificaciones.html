<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RUTA</title>
    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="https://dosxdos.app.iidos.com/img/logoPwa256.png"
    />
    <link rel="stylesheet" href="./css/tailwindmain.css" />
    <style>
      @charset "UTF-8";

      /* INICIO */
      * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
        letter-spacing: 0.5px;
      }

      .displayOff {
        display: none;
      }

      .displayOn {
        display: flex;
      }

      /* FUENTES */
      @font-face {
        font-family: "Roboto";
        src: url("https://dosxdos.app.iidos.com/css/fuentes/Roboto/Roboto-Light.ttf")
          format("truetype");
      }

      @font-face {
        font-family: "Merriweather";
        src: url("https://dosxdos.app.iidos.com/css/fuentes/Merriweather/Merriweather-Light.ttf")
          format("truetype");
      }

      @font-face {
        font-family: "Merriweather-Bold";
        src: url("https://dosxdos.app.iidos.com/css/fuentes/Merriweather/Merriweather-Bold.ttf")
          format("truetype");
      }

      @font-face {
        font-family: "Lora";
        src: url("https://dosxdos.app.iidos.com/css/fuentes/Lora/Lora-Regular.ttf")
          format("truetype");
      }

      @font-face {
        font-family: "Lora-Medium";
        src: url("https://dosxdos.app.iidos.com/css/fuentes/Lora/Lora-Medium.ttf")
          format("truetype");
      }

      @font-face {
        font-family: "Lora-Bold";
        src: url("https://dosxdos.app.iidos.com/css/fuentes/Lora/Lora-Bold.ttf")
          format("truetype");
      }

      /* LOADER */
      #loader {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        z-index: 2000;
        background-color: rgba(0, 0, 0, 0.886);
        justify-content: center;
        align-items: center;
      }

      .loader {
        transform: rotateZ(45deg);
        perspective: 1000px;
        border-radius: 50%;
        width: 14vw;
        height: 14vw;
        color: #fff;
      }

      .loader:before,
      .loader:after {
        content: "";
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: inherit;
        height: inherit;
        border-radius: 50%;
        transform: rotateX(70deg);
        animation: 1s spin linear infinite;
      }

      .loader:after {
        color: #b20b15;
        transform: rotateY(70deg);
        animation-delay: 0.4s;
      }

      @keyframes spin {
        0%,
        100% {
          box-shadow: 0.2em 0px 0 0px currentcolor;
        }

        12% {
          box-shadow: 0.2em 0.2em 0 0 currentcolor;
        }

        25% {
          box-shadow: 0 0.2em 0 0px currentcolor;
        }

        37% {
          box-shadow: -0.2em 0.2em 0 0 currentcolor;
        }

        50% {
          box-shadow: -0.2em 0 0 0 currentcolor;
        }

        62% {
          box-shadow: -0.2em -0.2em 0 0 currentcolor;
        }

        75% {
          box-shadow: 0px -0.2em 0 0 currentcolor;
        }

        87% {
          box-shadow: 0.2em -0.2em 0 0 currentcolor;
        }
      }
    </style>
  </head>

  <body id="body" class="bg-gray-100">
    <div id="loader" class="displayOn">
      <span class="loader"></span>
    </div>

    <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
      <!-- Main header -->
      <div class="flex items-center justify-between w-full px-6 py-4">
        <!-- Logo -->
        <div class="flex items-center">
          <img
            src="https://dosxdos.app.iidos.com/img/logo300.png"
            class="h-16 hidden md:block"
            alt="Logo completo"
          />
          <img
            src="https://dosxdos.app.iidos.com/img/Isotipo-38.png"
            class="h-16 md:hidden"
            alt="Isotipo"
          />
        </div>

        <!-- Desktop Navigation -->
        <nav class="hidden md:flex items-center space-x-8">
          <a
            href="https://dosxdos.app.iidos.com/rutas_montador.html"
            class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 mr-2"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M4 5c8 0 8 14 16 14" />
              <circle cx="4" cy="5" r="2" />
              <circle cx="12" cy="12" r="2" />
              <circle cx="20" cy="19" r="2" />
            </svg>
            <span>Rutas</span>
          </a>

          <a
            href="https://dosxdos.app.iidos.com/ruta_montador.html"
            class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 mr-2"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
              />
              <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
              <path d="M9 12h6" />
              <path d="M9 16h6" />
            </svg>
            <span>Líneas</span>
          </a>

          <a
            href="https://dosxdos.app.iidos.com/historial_montador.html"
            class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 mr-2"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
            <span>Historial</span>
          </a>

          <!-- Desktop User Menu -->
          <div class="relative group drop-shadow">
            <button
              id="userMenuButton"
              class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
              aria-expanded="false"
            >
              <div
                class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center"
              >
                <img
                  id="imagenUsuarioDesktop"
                  src="https://dosxdos.app.iidos.com/img/usuario.png"
                  class="w-full h-full object-cover"
                  alt="Profile"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                />
                <svg
                  class="w-5 h-5 text-gray-400 hidden"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </div>

              <span
                id="nombreUsuarioDesktop"
                class="text-gray-700 font-medium text-lg"
              ></span>

              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>

            <!-- Desktop Dropdown Menu -->
            <div
              id="userDropdownMenu"
              class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50"
            >
              <button
                id="editarUsuarioDesktop"
                class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 mr-2"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                  />
                  <path
                    d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                  />
                </svg>
                Editar Usuario
              </button>
              <button
                id="cerrarSesionDesktop"
                class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 mr-2"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                  <polyline points="16 17 21 12 16 7" />
                  <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                Cerrar Sesión
              </button>
            </div>
          </div>
        </nav>

        <!-- Mobile Hamburger Button -->
        <button
          id="menuButton"
          class="md:hidden relative z-50 p-2 focus:outline-none mr-4"
        >
          <div class="relative w-8 h-8">
            <span
              class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"
            ></span>
            <span
              class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"
            ></span>
            <span
              class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"
            ></span>
          </div>
        </button>
      </div>

      <div
        id="mobileMenu"
        class="md:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm"
      >
        <!-- User Profile Section -->
        <div class="px-8 py-4 mt-20">
          <div
            class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full"
          >
            <!-- Profile image -->
            <div
              class="absolute left-0 w-24 h-24 rounded-full overflow-hidden border-2 border-white bg-gray-100 flex items-center justify-center shadow-lg"
            >
              <img
                id="imagenUsuarioMobile"
                src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover"
                alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
              />
              <!-- Fallback initials/icon (hidden by default) -->
              <svg
                class="w-12 h-12 text-gray-400 hidden"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="ml-24 flex items-center py-4">
              <!-- User name -->
              <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
              <span
                id="nombreUsuarioMobile"
                class="text-black font-medium text-xl"
              ></span>
              <span class="text-black font-medium text-xl">!</span>
            </div>
          </div>
        </div>

        <!-- Navigation Links -->
        <nav class="px-8 py-6 space-y-2">
          <a
            href="https://dosxdos.app.iidos.com/rutas_montador.html"
            class="z-10 flex items-center px-6 py-4 text-white bg-white/10 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-md group backdrop-blur-md"
          >
            <div
              class="z-0 flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all"
            >
              <svg
                class="w-7 h-7 text-white group-hover:text-gray-900 transition-all"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M4 5c8 0 8 14 16 14" />
                <circle cx="4" cy="5" r="2" />
                <circle cx="12" cy="12" r="2" />
                <circle cx="20" cy="19" r="2" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Rutas</span>
          </a>

          <a
            href="https://dosxdos.app.iidos.com/ruta_montador.html"
            class="z-10 flex items-center px-6 py-4 text-white bg-white/10 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-md group backdrop-blur-md"
          >
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all"
            >
              <svg
                class="w-7 h-7 text-white group-hover:text-gray-900 transition-all"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
                />
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                <path d="M9 12h6" />
                <path d="M9 16h6" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Líneas</span>
          </a>

          <a
            href="https://dosxdos.app.iidos.com/historial_montador.html"
            class="z-10 flex items-center px-6 py-4 text-white bg-white/10 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-md group backdrop-blur-md"
          >
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all"
            >
              <svg
                class="w-7 h-7 text-white group-hover:text-gray-900 transition-all"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Historial</span>
          </a>
        </nav>

        <!-- User Actions -->
        <div
          class="absolute bottom-0 left-0 right-0 px-8 py-2 bg-white bg-opacity-05 rounded-t-2xl shadow"
        >
          <button
            id="editarUsuarioMobile"
            class="flex items-center w-full px-4 text-white rounded-xl transition-all duration-300 group my-3 backdrop-blur-sm shadow-lg bg-red-600"
          >
            <div
              class="flex items-center justify-center w-12 h-10 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all"
            >
              <svg
                class="w-6 h-6 shadow-lg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                />
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                />
              </svg>
            </div>
            <span class="text-lg font-medium">Editar usuario</span>
          </button>

          <button
            id="cerrarSesionMobile"
            class="flex items-center w-full px-4 text-white rounded-xl transition-all duration-300 group mb-3 backdrop-blur-sm shadow-lg bg-red-600"
          >
            <div
              class="flex items-center justify-center w-12 h-10 bg-white/20 rounded-lg mr-4 group-hover:bg-white/30 transition-all"
            >
              <svg
                class="w-6 h-6"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
            </div>
            <span class="text-lg font-medium">Cerrar sesión</span>
          </button>
        </div>
      </div>
    </section>

    <div class="pt-16 w-full">
      <div id="cabeceraContenido" class="flex flex-col bg-gray-100 shadow">
        <!-- Search Section -->
        <div class="relative flex items-center w-full px-12 mt-20 mb-6">
          <img
            src="https://dosxdos.app.iidos.com/img/lupa.png"
            class="w-5 h-5 opacity-90 absolute left-16 top-1/2 transform -translate-y-1/2"
          />
          <input
            type="text"
            id="buscador"
            class="shadow w-full h-12 pl-12 pr-4 bg-white/10 border border-white/20 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300 ease-in-out text-black placeholder-white/70"
            placeholder="Buscar notificaciones..."
          />
        </div>
        <div class="w-full">
          <div class="border-b border-gray-200">
            <nav class="flex -mb-px w-full" aria-label="Pestañas">
              <button
                id="pestañaPendientes"
                class="flex-1 w-[50vw] py-4 px-1 text-center border-b-2 border-red-500 text-red-600 font-medium text-sm"
              >
                <span class="flex items-center justify-center">
                  <span class="ml-2">Notificaciones Pendientes</span>
                  <span
                    id="contadorPendientes"
                    class="bg-red-100 text-red-600 ml-3 py-0.5 px-2.5 rounded-full text-xs"
                    >0</span
                  >
                </span>
              </button>
              <button
                id="pestañaAceptadas"
                class="flex-1 w-[50vw] py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm"
              >
                <span class="flex items-center justify-center">
                  <span class="ml-2">Notificaciones Leídas</span>
                  <span
                    id="contadorAceptadas"
                    class="bg-gray-100 text-gray-600 ml-3 py-0.5 px-2.5 rounded-full text-xs"
                    >0</span
                  >
                </span>
              </button>
            </nav>
          </div>
        </div>
      </div>
    </div>

    <section id="contenidoPendientes" class="p-6 bg-gray-100"></section>
    <section id="contenidoAceptadas" class="hidden p-6 bg-gray-100"></section>

    <div id="mensaje" class="displayOff">
      <p id="textoMensaje"></p>
    </div>

    <div
      id="modalNotificacion"
      class="fixed inset-0 z-50 hidden opacity-0 pointer-events-none transition-all duration-300 ease-in-out"
    >
      <div
        class="fixed inset-0 bg-black bg-opacity-50"
        onclick="closeModal()"
      ></div>
      <div
        class="fixed inset-0 overflow-y-auto flex items-center justify-center p-4"
      >
        <div
          class="modal-content bg-white rounded-xl shadow-xl max-w-md w-full p-6 mx-4 transform scale-95 transition-all duration-300 ease-in-out"
        >
          <h2 class="modal-title text-xl font-bold mb-4"></h2>
          <p class="modal-description text-gray-600 mb-4"></p>
          <div class="modal-details text-sm text-gray-500 mb-6"></div>
          <div class="flex space-x-3">
            <button
              id="confirmarAceptar"
              class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-600 transition"
            >
              Marcar como Leída
            </button>
            <button
              id="cancelarAceptar"
              class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
  <script>
    let ruta = localStorage.getItem("ruta");
    let montador = localStorage.getItem("montador");
    let usuario;

    // Initialize ruta if not exists
    if (!ruta) {
      console.warn("⚠️ Ruta is not defined, checking user data...");
      leerDatos("dosxdos", "usuario").then((userData) => {
        if (userData.length > 0 && userData[0].ruta) {
          ruta = userData[0].ruta;
          localStorage.setItem("ruta", ruta);
          console.log("✅ Ruta set:", ruta);
        } else {
          console.error("❌ Ruta still undefined.");
        }
      });
    }

    // Initialize montador if not exists
    if (!montador) {
      console.error("⚠️ montador is not defined. Attempting to set it...");
      leerDatos("dosxdos", "usuario").then((data) => {
        if (data.length > 0 && data[0].cod) {
          montador = data[0].cod;
          localStorage.setItem("montador", montador);
          console.log("✅ montador set:", montador);
        } else {
          console.error("❌ No valid montador found.");
        }
      });
    }

    // Core Element References
    const elements = {
      buscador: document.getElementById("buscador"),
      mensaje: document.getElementById("mensaje"),
      textoMensaje: document.getElementById("textoMensaje"),
      loader: document.getElementById("loader"),
      body: document.getElementById("body"),
      nombreUsuarioDesktop: document.getElementById("nombreUsuarioDesktop"),
      nombreUsuarioMobile: document.getElementById("nombreUsuarioMobile"),
      imagenUsuarioDesktop: document.getElementById("imagenUsuarioDesktop"),
      imagenUsuarioMobile: document.getElementById("imagenUsuarioMobile"),
      contenidoPendientes: document.getElementById("contenidoPendientes"),
      contenidoAceptadas: document.getElementById("contenidoAceptadas"),
      userMenuButton: document.getElementById("userMenuButton"),
      userDropdownMenu: document.getElementById("userDropdownMenu"),
      menuButton: document.getElementById("menuButton"),
      mobileMenu: document.getElementById("mobileMenu"),
      hamburgerTop: document.getElementById("hamburgerTop"),
      hamburgerMiddle: document.getElementById("hamburgerMiddle"),
      hamburgerBottom: document.getElementById("hamburgerBottom"),
      editarUsuarioDesktop: document.getElementById("editarUsuarioDesktop"),
      editarUsuarioMobile: document.getElementById("editarUsuarioMobile"),
      cerrarSesionDesktop: document.getElementById("cerrarSesionDesktop"),
      cerrarSesionMobile: document.getElementById("cerrarSesionMobile"),
      pestañaPendientes: document.getElementById("pestañaPendientes"),
      pestañaAceptadas: document.getElementById("pestañaAceptadas"),
    };

    function scrollToTop() {
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
    }

    /* LOADER */
    function loaderOn() {
      scrollToTop();
      elements.loader.classList.remove("displayOff");
      elements.loader.classList.add("displayOn");
      elements.body.classList.add("oyh");
    }

    function loaderOff() {
      setTimeout(() => {
        elements.loader.classList.remove("displayOn");
        elements.loader.classList.add("displayOff");
        elements.body.classList.remove("oyh");
      }, 1000);
    }

    /* MENSAJE */
    function mensajeOn() {
      if (!elements.mensaje) return;
      elements.mensaje.classList.remove("displayOff");
      elements.mensaje.classList.add("displayOn");
    }

    function mensajeOff() {
      elements.mensaje.classList.remove("displayOn");
      elements.mensaje.classList.add("displayOff");
    }

    function alerta(men) {
      let textoMensaje = document.getElementById("textoMensaje");

      if (!textoMensaje) {
        console.error(
          "ERROR: Elemento textoMensaje no encontrado en el DOM. Creándolo..."
        );
        textoMensaje = document.createElement("p");
        textoMensaje.id = "textoMensaje";
        textoMensaje.style.position = "fixed";
        textoMensaje.style.top = "10px";
        textoMensaje.style.left = "50%";
        textoMensaje.style.transform = "translateX(-50%)";
        textoMensaje.style.background = "red";
        textoMensaje.style.color = "white";
        textoMensaje.style.padding = "10px";
        textoMensaje.style.borderRadius = "5px";
        textoMensaje.style.zIndex = "10000";
        textoMensaje.style.display = "none";
        document.body.appendChild(textoMensaje);
      }

      textoMensaje.textContent = men;
      textoMensaje.style.display = "block";

      setTimeout(() => {
        textoMensaje.style.display = "none";
      }, 3000);

      mensajeOn();
      loaderOff();
    }

    /* CERRAR SESIÓN */
    function eliminarCookie(nombre) {
      const tiempoExpiracion = 1;
      document.cookie = `${nombre}=; expires=${new Date(
        tiempoExpiracion * 1000
      ).toUTCString()}; path=/;`;
    }

    function deleteDB2(database) {
      return new Promise((resolve, reject) => {
        const request = indexedDB.deleteDatabase(database);
        request.onsuccess = () => {
          console.log(`Base de datos "${database}" eliminada exitosamente.`);
          resolve(true);
        };
        request.onerror = (event) => {
          console.error(
            `Error al eliminar la base de datos "${database}":`,
            event.target.error
          );
          reject(event.target.error);
        };
      });
    }

    async function cerrarSesion() {
      if (navigator.onLine) {
        try {
          loaderOn();
          localStorage.clear();
          eliminarCookie("login");
          eliminarCookie("usuario");
          (await deleteDB2("dosxdos"))
            ? console.log("Base de datos eliminada exitosamente")
            : console.error("error al eliminar la base de datos");
          window.location.href = "https://dosxdos.app.iidos.com/index.html";
        } catch (error) {
          mensaje = "ERROR: " + error.message;
          console.error(error);
          alerta(mensaje);
        }
      } else {
        mensaje = "No es posible cerrar la sesión sin conexión a internet";
        elements.textoMensaje.innerHTML = mensaje;
        mensajeOn();
      }
    }

    /* Initial event handlers that don't need DOM loaded */
    elements.mensaje.addEventListener("click", mensajeOff);

    /* API AND DATA FUNCTIONS */
    function fetchRutas() {
      return new Promise((resolve, reject) => {
        url =
          "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" + montador;
        fetch(url)
          .then((res) => {
            if (res.ok) {
              return res.json();
            } else {
              mensaje =
                "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
              alerta(mensaje);
            }
          })
          .then((res) => {
            if (res[0]) {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction("rutas", "readwrite");
                const datosStore = transaction.objectStore("rutas");
                const clearRequest = datosStore.clear();
                clearRequest.onsuccess = (clearEvent) => {
                  const datos = res[1];
                  datos.forEach((item) => {
                    datosStore.add(item);
                  });
                  resolve(true);
                };
                clearRequest.onerror = (event) => {
                  error = event.target.error;
                  mensaje = `ERROR: ` + error;
                  alerta(mensaje);
                };
              };
              request.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                alerta(mensaje);
              };
            } else {
              mensaje = res[1];
              alerta(mensaje);
            }
          })
          .catch((res) => {
            mensaje = "Sin conexión: " + res.message;
            alerta(mensaje);
          });
      });
    }

    function fetchLineas(vectorRutas) {
      return new Promise(async (resolve, reject) => {
        try {
          const promises = vectorRutas.map(async (objeto) => {
            const url =
              "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
              objeto.cod;
            const res = await fetch(url);

            if (!res.ok) {
              throw new Error(
                `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
              );
            }

            const resJson = await res.json();

            if (resJson[0]) {
              const db = await new Promise((dbResolve, dbReject) => {
                const request = indexedDB.open("dosxdos");
                request.onsuccess = (event) => {
                  const db = event.target.result;
                  dbResolve(db);
                };
                request.onerror = (event) => {
                  dbReject(
                    new Error(
                      `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                    )
                  );
                };
              });

              const transaction = db.transaction("lineas", "readwrite");
              const datosStore = transaction.objectStore("lineas");
              const datos = resJson[1];
              if (Array.isArray(datos)) {
                datos.forEach((item) => {
                  datosStore.add(item);
                });
              } else {
                datosStore.add(datos);
              }
            } else {
              throw new Error(
                `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
              );
            }
          });

          await Promise.all(promises);
          resolve(true);
        } catch (err) {
          console.error(err);
          reject(err);
        }
      });
    }

    async function sincronizarDb2() {
      return new Promise(async (resolve, reject) => {
        try {
          loaderOn();
          const fRutas = await fetchRutas();
          rutas = await leerDatos("dosxdos", "rutas");
          rutas = rutas.map((objeto) => ({
            cod: objeto["No."],
            nombre: objeto["Descripcion"],
          }));
          const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
          if (limpiarLineas) {
            lineas = await fetchLineas(rutas);
            if (lineas) {
              resolve(true);
            } else {
              resolve(false);
            }
          }
        } catch (error) {
          console.error(error);
          reject(false);
        }
      });
    }

    /* LOGIN */
    function vLogin() {
      return new Promise((resolve, reject) => {
        const login = localStorage.getItem("login");
        if (login && login !== null) {
          leerDatos("dosxdos", "usuario")
            .then((res) => {
              console.log("data for user ---->", res[0]);
              usuario = res[0];
              resolve(usuario.clase);
            })
            .catch((err) => {
              resolve(false);
            });
        } else {
          resolve(false);
        }
      });
    }

    /* NOTIFICATION HANDLING */
    async function markNotificationAsRead(objeto) {
      loaderOn();
      closeModal();

      try {
        const response = await fetch(
          `https://dosxdos.app.iidos.com/apirest/rutas_notificaciones.php/notificaciones/aceptar/${objeto.id}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ visto: 1 }),
          }
        );

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error("Failed to mark as read. Server error.");
        }

        console.log("Notification marked as read:", data);

        const notificationElement = document.querySelector(
          `[data-notification-id="${objeto.id}"]`
        );

        if (notificationElement) {
          notificationElement.setAttribute("data-estado", "aceptada");
          notificationElement.classList.remove(
            "bg-gradient-to-r",
            "from-red-600",
            "to-red-500",
            "text-white"
          );
          notificationElement.classList.add("bg-gray-100");

          const statusBadge = notificationElement.querySelector("span");
          statusBadge.textContent = "Leída";
          statusBadge.classList.replace("bg-red-500", "bg-green-500");

          document
            .getElementById("contenidoAceptadas")
            .appendChild(notificationElement);
          actualizarVistaNotificaciones();
        }

        loaderOff();
      } catch (error) {
        console.error("Error updating notification:", error);
        alerta("No se pudo marcar como leída.");
        loaderOff();
      }
    }

    function openNotificationModal(objeto) {
      const modal = document.getElementById("modalNotificacion");
      const modalTitle = modal.querySelector(".modal-title");
      const modalDescription = modal.querySelector(".modal-description");
      const modalDetails = modal.querySelector(".modal-details");
      const confirmButton = document.getElementById("confirmarAceptar");
      const cancelButton = document.getElementById("cancelarAceptar");

      modalTitle.textContent = objeto.titulo;
      modalDescription.textContent = objeto.mensaje;
      modalDetails.innerHTML = `
      <p class="mb-2"><strong>Línea de Actividad:</strong> ${objeto.LineaActividad}</p>
      <p><strong>Fecha:</strong> ${objeto.fecha_envio}</p>
    `;

      confirmButton.replaceWith(confirmButton.cloneNode(true));
      cancelButton.replaceWith(cancelButton.cloneNode(true));

      document
        .getElementById("confirmarAceptar")
        .addEventListener("click", () => markNotificationAsRead(objeto));
      document
        .getElementById("cancelarAceptar")
        .addEventListener("click", closeModal);

      modal.classList.remove("hidden", "opacity-0", "pointer-events-none");
      modal.classList.add("opacity-100", "pointer-events-auto");
    }

    function closeModal() {
      const modal = document.getElementById("modalNotificacion");
      modal.classList.remove("opacity-100", "pointer-events-auto");
      modal.classList.add("opacity-0", "pointer-events-none");
      setTimeout(() => {
        modal.classList.add("hidden");
      }, 300);
    }

    function createNotificationElement(objeto) {
      const containerDiv = document.createElement("div");
      containerDiv.className = "w-full mb-4";
      containerDiv.setAttribute("data-notification-id", objeto.id);
      containerDiv.setAttribute(
        "data-estado",
        objeto.visto === 1 ? "aceptada" : "pendiente"
      );

      const notificationContent = document.createElement("div");
      notificationContent.className =
        objeto.visto === 1
          ? "bg-gradient-to-r from-red-500 to-red-600 text-white opacity-50 grayscale"
          : "bg-gradient-to-r from-red-500 to-red-600 text-white";
      notificationContent.classList.add(
        "rounded-xl",
        "p-4",
        "cursor-pointer",
        "relative",
        "overflow-hidden"
      );

      // Truncate long titles and messages
      const truncateText = (text, maxLength = 50) =>
        text.length > maxLength ? text.slice(0, maxLength) + "..." : text;

      notificationContent.innerHTML = `
    <div class="flex justify-between items-start">
      <div class="pr-4">
        <h3 class="font-bold text-lg leading-tight mb-1.5 max-w-[calc(100%-60px)] truncate">
          ${truncateText(objeto.titulo)}
        </h3>
        <p class="text-sm opacity-75 leading-snug max-w-[calc(100%-60px)] truncate">
          ${truncateText(objeto.mensaje, 80)}
        </p>
      </div>
      <span class="${
        objeto.visto === 1
          ? "bg-gray-200 text-gray-600"
          : "bg-white text-red-600 border border-red-200 shadow-sm"
      } absolute top-3 right-3 px-2.5 py-0.5 rounded-full text-xs font-semibold tracking-tight">
        ${objeto.visto === 1 ? "Leída" : "Pendiente"}
      </span>
    </div>
  `;

      notificationContent.addEventListener("click", () =>
        openNotificationModal(objeto)
      );

      containerDiv.appendChild(notificationContent);
      return containerDiv;
    }

    const actualizarVistaNotificaciones = async () => {
      const pendientesContainer = elements.contenidoPendientes;
      const aceptadasContainer = elements.contenidoAceptadas;
      const pestañaPendientes = elements.pestañaPendientes;

      const mostrarPendientes =
        pestañaPendientes.classList.contains("border-red-500");

      pendientesContainer.style.display = mostrarPendientes ? "block" : "none";
      aceptadasContainer.style.display = mostrarPendientes ? "none" : "block";

      const TotalNotificaciones = await leerDatos("dosxdos", "notificaciones");

      const pendientes = TotalNotificaciones.filter(
        (notif) => notif.visto === 0
      );
      const aceptadas = TotalNotificaciones.filter(
        (notif) => notif.visto === 1
      );

      pendientesContainer.innerHTML = "";
      aceptadasContainer.innerHTML = "";

      pendientes.forEach((notif) => {
        const element = createNotificationElement(notif);
        pendientesContainer.appendChild(element);
      });

      aceptadas.forEach((notif) => {
        const element = createNotificationElement(notif);
        aceptadasContainer.appendChild(element);
      });

      document.getElementById("contadorPendientes").textContent =
        pendientes.length;
      document.getElementById("contadorAceptadas").textContent =
        aceptadas.length;
    };

    function updateCounters(notifications) {
      let contadorPendientes = 0;
      let contadorAceptadas = 0;

      notifications.forEach((notification) => {
        if (notification.getAttribute("data-estado") === "aceptada") {
          contadorAceptadas++;
        } else {
          contadorPendientes++;
        }
      });

      document.getElementById("contadorPendientes").textContent =
        contadorPendientes;
      document.getElementById("contadorAceptadas").textContent =
        contadorAceptadas;
    }

    function parseLineDetails(mensaje, titulo) {
      // Remove "Datos de línea: " if it exists
      let cleanMessage = mensaje.replace("Datos de línea:", "").trim();

      // Split the message into parts by commas and trim spaces
      const details = cleanMessage.split(",").map((detail) => detail.trim());

      // Ensure we have at least 4 parts: Client, "OT", OT Number, Location, Address
      if (details.length < 5) {
        console.warn("Unexpected message format:", mensaje);
        return {
          client: "-",
          ot: "-",
          route: "-",
          address: "-",
        };
      }

      return {
        client: details[0], // First part is the Client Name
        ot: details[2], // Third part is the OT Number
        route: extractRoute(titulo), // Extract route from the title
        address: details.slice(3).join(", "), // Everything after OT Number is the Address
      };
    }

    // Extract route from the title
    function extractRoute(titulo) {
      const match = titulo.match(/ruta\s+([^\s]+)/i);
      return match ? match[1].replace("con", "").trim() : "-";
    }

    // Extract line number
    function extractLineNumber(titulo) {
      const match = titulo.match(/línea\s*(\d+)/i);
      return match ? match[1] : "-";
    }

    // NOTIFICATION PROCESSING FUNCTIONS
    function createNotificationElement(objeto) {
      const containerDiv = document.createElement("div");
      containerDiv.className = "w-full mb-4";
      containerDiv.setAttribute("data-notification-id", objeto.id);
      containerDiv.setAttribute(
        "data-estado",
        objeto.visto === 1 ? "aceptada" : "pendiente"
      );

      const notificationContent = document.createElement("div");
      notificationContent.className =
        objeto.visto === 1
          ? "bg-gradient-to-r from-red-500 to-red-600 text-white opacity-50 grayscale"
          : "bg-gradient-to-r from-red-500 to-red-600 text-white";
      notificationContent.classList.add(
        "rounded-xl",
        "p-4",
        "cursor-pointer",
        "relative"
      );

      notificationContent.innerHTML = `
    <div class="flex justify-between items-center">
      <h3 class="font-bold text-lg flex-grow pr-2 pt-4 lg:pt-0 pb-2">${
        objeto.titulo
      }</h3>
      <span class="${
        objeto.visto === 1
          ? "bg-gray-200 text-gray-600"
          : "bg-white text-red-600"
      } absolute top-2 right-2 px-2 py-0.5 rounded-full text-xs font-semibold tracking-tight">
        ${objeto.visto === 1 ? "Leída" : "Pendiente"}
      </span>
    </div>
    <p class="text-sm opacity-75 mt-2">${objeto.mensaje}</p>
  `;

      notificationContent.addEventListener("click", () =>
        openNotificationModal(objeto)
      );

      containerDiv.appendChild(notificationContent);
      return containerDiv;
    }

    // CODE FOR THE NOTIFICATION MODAL
    function openNotificationModal(objeto) {
      const modal = document.getElementById("modalNotificacion");
      const modalTitle = modal.querySelector(".modal-title");
      const modalDetails = modal.querySelector(".modal-details");
      const confirmButton = document.getElementById("confirmarAceptar");
      const cancelButton = document.getElementById("cancelarAceptar");

      // Extract data
      const lineNumber = extractLineNumber(objeto.titulo);
      const parsedDetails = parseLineDetails(objeto.mensaje, objeto.titulo);

      // Determine if the notification is already read
      const isReadTab = !document
        .getElementById("pestañaPendientes")
        .classList.contains("border-red-500");

      // Modal content (WITHOUT the raw message)
      const formattedDetails = `
    <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-xs font-semibold text-gray-500 uppercase">Número de Línea</p>
          <p class="text-lg font-bold text-red-600">${lineNumber}</p>
        </div>
        <div>
          <p class="text-xs font-semibold text-gray-500 uppercase">Fecha</p>
          <p class="text-base text-gray-800">${formatDate(
            objeto.fecha_envio
          )}</p>
        </div>
      </div>

            <div class="grid grid-cols-2 gap-4">
   <div>
        <p class="text-xs font-semibold text-gray-500 uppercase mb-1">Cliente</p>
        <p class="text-base text-gray-800">${parsedDetails.client}</p>
      </div>
    <div>
        <p class="text-xs font-semibold text-gray-500 uppercase mb-1">OT</p>
        <p class="text-base text-gray-800">${parsedDetails.ot}</p>
      </div>
      </div>

      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase mb-1">Ruta</p>
        <p class="text-base text-gray-800">${parsedDetails.route}</p>
      </div>

      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase mb-1">Dirección</p>
        <p class="text-base text-gray-800">${parsedDetails.address}</p>
      </div>
    </div>
  `;

      // Clean title for better readability
      const cleanedTitle = objeto.titulo
        .replace(/\s*con\s*línea\s*\d+/i, "")
        .trim();

      // Apply modal content
      modalTitle.textContent = cleanedTitle;
      modalDetails.innerHTML = formattedDetails;

      // **REMOVE the duplicate message**
      const modalDescription = modal.querySelector(".modal-description");
      if (modalDescription) {
        modalDescription.style.display = "none"; // Hides the duplicate text
      }

      // Remove existing event listeners and add new ones
      confirmButton.replaceWith(confirmButton.cloneNode(true));
      cancelButton.replaceWith(cancelButton.cloneNode(true));

      const updatedConfirmButton = document.getElementById("confirmarAceptar");
      const updatedCancelButton = document.getElementById("cancelarAceptar");

      if (isReadTab) {
        updatedConfirmButton.textContent = "Marcar como No Leída";
        updatedConfirmButton.classList.replace("bg-red-600", "bg-red-500");
        updatedConfirmButton.addEventListener("click", () =>
          markNotificationAsUnread(objeto)
        );
      } else {
        updatedConfirmButton.textContent = "Marcar como Leída";
        updatedConfirmButton.classList.replace("bg-red-500", "bg-red-600");
        updatedConfirmButton.addEventListener("click", () =>
          markNotificationAsRead(objeto)
        );
      }

      updatedCancelButton.addEventListener("click", closeModal);

      // Add smooth scrolling for long content
      modal
        .querySelector(".modal-content")
        .classList.add("max-h-[90vh]", "overflow-y-auto");

      // Show modal
      modal.classList.remove("hidden", "opacity-0", "pointer-events-none");
      modal.classList.add("opacity-100", "pointer-events-auto");
    }

    // Date formatting function
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString("es-ES", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    // Initialize modal structure on page load
    document.addEventListener("DOMContentLoaded", () => {
      const modalNotificacion = document.getElementById("modalNotificacion");
      if (modalNotificacion) {
        const modalContent = modalNotificacion.querySelector(".modal-content");
        if (modalContent) {
          modalContent.innerHTML = `
        <div class="p-4 space-y-4">
          <h2 class="modal-title text-xl font-bold text-gray-800 mb-2"></h2>
          <p class="modal-description text-gray-600 mb-4"></p>
          <div class="modal-details text-sm text-gray-500 mb-6"></div>
          <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
            <button
              id="confirmarAceptar"
              class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-semibold px-2"
            >
              Marcar como Leída
            </button>
            <button
              id="cancelarAceptar"
              class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition font-semibold"
            >
              Cancelar
            </button>
          </div>
        </div>
      `;
        }
      }
    });

    // New function to mark notification as unread
    async function markNotificationAsUnread(objeto) {
      loaderOn();
      closeModal();

      try {
        const response = await fetch(
          `https://dosxdos.app.iidos.com/apirest/rutas_notificaciones.php/notificaciones/aceptar/${objeto.id}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ visto: 0 }),
          }
        );

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error("Failed to mark as unread. Server error.");
        }

        console.log("Notification marked as unread:", data);

        const notificationElement = document.querySelector(
          `[data-notification-id="${objeto.id}"]`
        );

        if (notificationElement) {
          notificationElement.setAttribute("data-estado", "pendiente");
          notificationElement.classList.remove("opacity-50", "grayscale");
          notificationElement.classList.add(
            "bg-gradient-to-r",
            "from-red-500",
            "to-red-600",
            "text-white"
          );

          const statusBadge = notificationElement.querySelector("span");
          statusBadge.textContent = "Pendiente";
          statusBadge.classList.replace("bg-gray-100", "bg-red-100");
          statusBadge.classList.replace("text-gray-800", "text-red-800");

          document
            .getElementById("contenidoPendientes")
            .appendChild(notificationElement);

          actualizarVistaNotificaciones();
        }

        loaderOff();
      } catch (error) {
        console.error("Error updating notification:", error);
        alerta("No se pudo marcar como no leída.");
        loaderOff();
      }
    }

    function closeModal() {
      const modal = document.getElementById("modalNotificacion");
      modal.classList.remove("opacity-100", "pointer-events-auto");
      modal.classList.add("opacity-0", "pointer-events-none");
      setTimeout(() => {
        modal.classList.add("hidden");
      }, 300);
    }

    // NOTIFICATION MANAGEMENT FUNCTIONS
    async function markNotificationAsRead(objeto) {
      loaderOn();
      closeModal();

      try {
        const response = await fetch(
          `https://dosxdos.app.iidos.com/apirest/rutas_notificaciones.php/notificaciones/aceptar/${objeto.id}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ visto: 1 }),
          }
        );

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error("Failed to mark as read. Server error.");
        }

        console.log("Notification marked as read:", data);

        const notificationElement = document.querySelector(
          `[data-notification-id="${objeto.id}"]`
        );

        if (notificationElement) {
          notificationElement.setAttribute("data-estado", "aceptada");
          notificationElement.classList.remove(
            "bg-gradient-to-r",
            "from-red-600",
            "to-red-500",
            "text-white"
          );
          notificationElement.classList.add("bg-gray-100");

          const statusBadge = notificationElement.querySelector("span");
          statusBadge.textContent = "Leída";
          statusBadge.classList.replace("bg-red-500", "bg-green-500");

          document
            .getElementById("contenidoAceptadas")
            .appendChild(notificationElement);
          actualizarVistaNotificaciones();
        }

        loaderOff();
      } catch (error) {
        console.error("Error updating notification:", error);
        alerta("No se pudo marcar como leída.");
        loaderOff();
      }
    }

    // SEARCH FUNCTIONALITY
    function initializeSearch() {
      const buscador = document.getElementById("buscador");
      if (buscador) {
        buscador.addEventListener("input", () => {
          const valorBusqueda = buscador.value.toLowerCase().trim();
          const notifications = document.querySelectorAll(
            "[data-notification-id]"
          );

          notifications.forEach((notification) => {
            const title =
              notification.querySelector("h3")?.textContent?.toLowerCase() ||
              "";
            const message =
              notification.querySelector("p")?.textContent?.toLowerCase() || "";
            const matchesSearch =
              title.includes(valorBusqueda) || message.includes(valorBusqueda);

            const isPendiente =
              notification.getAttribute("data-estado") !== "aceptada";
            const mostrandoPendientes =
              document.getElementById("contenidoPendientes").style.display !==
              "none";

            const shouldShow =
              matchesSearch &&
              ((mostrandoPendientes && isPendiente) ||
                (!mostrandoPendientes && !isPendiente));

            notification.style.display = shouldShow ? "block" : "none";
          });
        });
      }
    }

    // ASYNC NOTIFICATION ACCEPTANCE
    async function aceptarNotificación(objeto) {
      const modal = document.getElementById("modalNotificacion");
      const modalTitle = modal.querySelector(".modal-title");
      const modalDescription = modal.querySelector(".modal-description");
      const modalLineaActividad = modal.querySelector(".modal-linea-actividad");
      const confirmarBtn = document.getElementById("confirmarAceptar");
      const cancelarBtn = document.getElementById("cancelarAceptar");

      modalTitle.textContent = objeto.titulo;
      modalDescription.textContent = objeto.mensaje;
      modalLineaActividad.textContent = `Línea de Actividad: ${objeto.LineaActividad}`;

      return new Promise((resolve) => {
        modal.classList.remove("hidden");

        function handleConfirm() {
          loaderOn();
          fetch(
            `https://dosxdos.app.iidos.com/apirest/rutas_notificaciones.php/notificaciones/aceptar/${objeto.id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ visto: true }),
            }
          )
            .then((response) => response.json())
            .then((data) => {
              const notificationDiv = document.querySelector(
                `[data-notification-id="${objeto.id}"]`
              );
              if (notificationDiv) {
                notificationDiv.setAttribute("data-estado", "aceptada");
                notificationDiv.classList.add("bg-gray-100");
                notificationDiv.classList.remove(
                  "bg-gradient-to-r",
                  "from-red-600",
                  "to-red-500",
                  "text-white"
                );

                const titleSpan = notificationDiv.querySelector(
                  ".notification-title"
                );
                const descriptionSpan = notificationDiv.querySelector(
                  ".notification-description"
                );

                if (titleSpan)
                  titleSpan.classList.replace("text-white", "text-gray-800");
                if (descriptionSpan)
                  descriptionSpan.classList.replace(
                    "text-white/80",
                    "text-gray-600"
                  );

                const actionButton = notificationDiv.querySelector(
                  ".notification-action"
                );
                if (actionButton) {
                  actionButton.textContent = "✓ Aceptada";
                  actionButton.classList.replace("bg-white", "bg-gray-200");
                  actionButton.classList.replace(
                    "text-red-600",
                    "text-gray-700"
                  );
                }

                const pestañaAceptadas =
                  document.getElementById("pestañaAceptadas");
                pestañaAceptadas.click();

                actualizarVistaNotificaciones();
              }
              resolve(true);
            })
            .catch((error) => {
              console.error("Error:", error);
              resolve(false);
            })
            .finally(() => {
              modal.classList.add("hidden");
              loaderOff();
              cleanup();
            });
        }

        function handleCancel() {
          modal.classList.add("hidden");
          cleanup();
          resolve(false);
        }

        function cleanup() {
          confirmarBtn.removeEventListener("click", handleConfirm);
          cancelarBtn.removeEventListener("click", handleCancel);
        }

        confirmarBtn.addEventListener("click", handleConfirm);
        cancelarBtn.addEventListener("click", handleCancel);
      });
    }

    // TAB SWITCHING LOGIC
    function setupNotificationTabs() {
      const pestañaPendientes = document.getElementById("pestañaPendientes");
      const pestañaAceptadas = document.getElementById("pestañaAceptadas");

      pestañaPendientes.addEventListener("click", () => {
        pestañaPendientes.classList.add("border-red-500", "text-red-600");
        pestañaPendientes.classList.remove(
          "border-transparent",
          "text-gray-500"
        );
        pestañaAceptadas.classList.remove("border-red-500", "text-red-600");
        pestañaAceptadas.classList.add("border-transparent", "text-gray-500");

        actualizarVistaNotificaciones();
      });

      pestañaAceptadas.addEventListener("click", () => {
        pestañaAceptadas.classList.add("border-red-500", "text-red-600");
        pestañaAceptadas.classList.remove(
          "border-transparent",
          "text-gray-500"
        );
        pestañaPendientes.classList.remove("border-red-500", "text-red-600");
        pestañaPendientes.classList.add("border-transparent", "text-gray-500");

        actualizarVistaNotificaciones();
      });

      // Initial load of notifications
      actualizarVistaNotificaciones();
    }

    // INITIALIZATION
    document.addEventListener("DOMContentLoaded", () => {
      initializeSearch();
      setupNotificationTabs();
    });

    // MENU AND USER INTERACTION SETUP
    function setupMenuInteractions() {
      // Desktop Menu
      const userMenuButton = document.getElementById("userMenuButton");
      const userDropdownMenu = document.getElementById("userDropdownMenu");

      if (userMenuButton && userDropdownMenu) {
        userMenuButton.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          userDropdownMenu.classList.toggle("hidden");
          const isExpanded = !userDropdownMenu.classList.contains("hidden");
          userMenuButton.setAttribute("aria-expanded", isExpanded.toString());
        });
      }

      // Mobile Menu Links
      const mobileMenuLinks = document.querySelectorAll("#mobileMenu nav a");
      mobileMenuLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.stopPropagation();
          window.location.href = link.href;
          menuButton.click(); // Close menu after clicking
        });
      });

      // Mobile Menu Toggle
      const menuButton = document.getElementById("menuButton");
      const mobileMenu = document.getElementById("mobileMenu");
      const hamburgerTop = document.getElementById("hamburgerTop");
      const hamburgerMiddle = document.getElementById("hamburgerMiddle");
      const hamburgerBottom = document.getElementById("hamburgerBottom");

      if (menuButton && mobileMenu) {
        menuButton.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const isOpen = !mobileMenu.classList.contains("translate-x-full");
          mobileMenu.classList.toggle("translate-x-full");
          document.body.classList.toggle("overflow-hidden");

          if (!isOpen) {
            // Menu is opening
            hamburgerTop.classList.remove("bg-gray-900");
            hamburgerMiddle.classList.remove("bg-gray-900");
            hamburgerBottom.classList.remove("bg-gray-900");
            hamburgerTop.classList.add("bg-white");
            hamburgerMiddle.classList.add("bg-white");
            hamburgerBottom.classList.add("bg-white");

            hamburgerTop.style.transform = "rotate(45deg) translate(10px, 7px)";
            hamburgerMiddle.style.opacity = "0";
            hamburgerBottom.style.transform =
              "rotate(-45deg) translate(10px, -7px)";
          } else {
            // Menu is closing
            hamburgerTop.classList.remove("bg-white");
            hamburgerMiddle.classList.remove("bg-white");
            hamburgerBottom.classList.remove("bg-white");
            hamburgerTop.classList.add("bg-gray-900");
            hamburgerMiddle.classList.add("bg-gray-900");
            hamburgerBottom.classList.add("bg-gray-900");

            hamburgerTop.style.transform = "";
            hamburgerMiddle.style.opacity = "1";
            hamburgerBottom.style.transform = "";
          }
        });
      }
    }

    // USER EDIT AND LOGOUT SETUP
    function setupUserActions() {
      // Edit User Buttons
      const editarUsuarioDesktop = document.getElementById(
        "editarUsuarioDesktop"
      );
      const editarUsuarioMobile = document.getElementById(
        "editarUsuarioMobile"
      );

      [editarUsuarioDesktop, editarUsuarioMobile].forEach((button) => {
        if (button) {
          button.addEventListener("click", (e) => {
            if (navigator.onLine) {
              window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?modulo=editarUsuario&id=${usuario.id}`;
            } else {
              alerta(
                "No es posible acceder a las opciones de edición de usuario sin conexión a internet"
              );
              scrollToTop();
            }
          });
        }
      });

      // Logout Buttons
      const cerrarSesionDesktop = document.getElementById(
        "cerrarSesionDesktop"
      );
      const cerrarSesionMobile = document.getElementById("cerrarSesionMobile");

      [cerrarSesionDesktop, cerrarSesionMobile].forEach((button) => {
        if (button) {
          button.addEventListener("click", () => {
            cerrarSesion();
          });
        }
      });
    }

    // GLOBAL MENU CLOSING LOGIC
    function setupGlobalMenuClosing() {
      // Close menus when clicking outside
      document.addEventListener("click", (e) => {
        const userMenuButton = document.getElementById("userMenuButton");
        const userDropdownMenu = document.getElementById("userDropdownMenu");
        const menuButton = document.getElementById("menuButton");
        const mobileMenu = document.getElementById("mobileMenu");

        // Close desktop dropdown if clicking outside
        if (
          userMenuButton &&
          userDropdownMenu &&
          !userMenuButton.contains(e.target) &&
          !userDropdownMenu.contains(e.target)
        ) {
          userDropdownMenu.classList.add("hidden");
          userMenuButton.setAttribute("aria-expanded", "false");
        }

        // Close mobile menu if clicking outside
        if (
          mobileMenu &&
          menuButton &&
          !mobileMenu.contains(e.target) &&
          !menuButton.contains(e.target) &&
          !mobileMenu.classList.contains("translate-x-full")
        ) {
          menuButton.click();
        }
      });

      // Handle escape key
      document.addEventListener("keydown", (e) => {
        const userMenuButton = document.getElementById("userMenuButton");
        const userDropdownMenu = document.getElementById("userDropdownMenu");
        const menuButton = document.getElementById("menuButton");
        const mobileMenu = document.getElementById("mobileMenu");

        if (e.key === "Escape") {
          // Close desktop dropdown
          if (
            userDropdownMenu &&
            !userDropdownMenu.classList.contains("hidden")
          ) {
            userDropdownMenu.classList.add("hidden");
            userMenuButton?.setAttribute("aria-expanded", "false");
          }

          // Close mobile menu
          if (
            mobileMenu &&
            !mobileMenu.classList.contains("translate-x-full")
          ) {
            menuButton.click();
          }
        }
      });
    }

    // FINAL INITIALIZATION
    function initializeApplication() {
      setupMenuInteractions();
      setupUserActions();
      setupGlobalMenuClosing();

      // Populate user information if available
      if (usuario && usuario.nombre) {
        const nombreUsuarioDesktop = document.getElementById(
          "nombreUsuarioDesktop"
        );
        const nombreUsuarioMobile = document.getElementById(
          "nombreUsuarioMobile"
        );
        const imagenUsuarioDesktop = document.getElementById(
          "imagenUsuarioDesktop"
        );
        const imagenUsuarioMobile = document.getElementById(
          "imagenUsuarioMobile"
        );

        // Update usernames
        if (nombreUsuarioDesktop)
          nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile)
          nombreUsuarioMobile.textContent = usuario.nombre;

        // Update profile images
        if (usuario.imagen !== "0") {
          console.log("🛠 Debugging Image URL:", usuario.imagen);
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }
      }
    }

    // FINAL DOM CONTENT LOADED EVENT
    document.addEventListener("DOMContentLoaded", () => {
      initializeSearch();
      setupNotificationTabs();
      initializeApplication();
    });

    // APPLICATION ONLINE STATE HANDLER
    async function appOnline() {
      try {
        const login = await vLogin();
        if (!login) {
          window.location.href = "https://dosxdos.app.iidos.com/index.html";
          return;
        }

        const Arrayusuario = await leerDatos("dosxdos", "usuario");
        if (!Arrayusuario || !Arrayusuario.length) {
          throw new Error("No se encontraron datos de usuario");
        }

        usuario = Arrayusuario[0];
        let loginMontador = localStorage.getItem("loginMontador");

        if (!loginMontador) {
          window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?id=${usuario.id}&rol=${usuario.clase}`;
          return;
        }

        montador = usuario.cod;

        // Update UI with user details
        const nombreUsuarioDesktop = document.getElementById(
          "nombreUsuarioDesktop"
        );
        const nombreUsuarioMobile = document.getElementById(
          "nombreUsuarioMobile"
        );
        const imagenUsuarioDesktop = document.getElementById(
          "imagenUsuarioDesktop"
        );
        const imagenUsuarioMobile = document.getElementById(
          "imagenUsuarioMobile"
        );

        if (nombreUsuarioDesktop)
          nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile)
          nombreUsuarioMobile.textContent = usuario.nombre;

        if (usuario.imagen !== "0") {
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }

        // Synchronize database
        const sinc = await sincronizarDb2();
        if (!sinc) console.error("Error al sincronizar la base de datos");

        // Synchronize notifications
        await sincronizarNotificaciones();

        // Process pending requests
        const TotalNotificaciones = await leerDatos(
          "dosxdos",
          "notificaciones"
        );

        // Split notifications
        const pendientes = TotalNotificaciones.filter(
          (objeto) => objeto.visto === 0
        );
        const aceptadas = TotalNotificaciones.filter(
          (objeto) => objeto.visto === 1
        );

        if (TotalNotificaciones) {
          console.log("TotalNotificaciones", TotalNotificaciones);

          // Populate notification containers
          const pendientesContainer = document.getElementById(
            "contenidoPendientes"
          );
          const aceptadasContainer =
            document.getElementById("contenidoAceptadas");

          pendientesContainer.innerHTML = "";
          aceptadasContainer.innerHTML = "";

          pendientes.forEach((objeto) => {
            const element = createNotificationElement(objeto);
            pendientesContainer.appendChild(element);
          });

          aceptadas.forEach((objeto) => {
            const element = createNotificationElement(objeto);
            aceptadasContainer.appendChild(element);
          });

          // Update notification counters
          const contadorPendientes =
            document.getElementById("contadorPendientes");
          const contadorAceptadas =
            document.getElementById("contadorAceptadas");

          if (contadorPendientes)
            contadorPendientes.textContent = pendientes.length;
          if (contadorAceptadas)
            contadorAceptadas.textContent = aceptadas.length;

          // Process pending requests
          await procesarPeticiones2();
          loaderOff();
        } else {
          alerta("Error al leer el almacén de líneas");
          await procesarPeticiones2();
          loaderOff();
        }
      } catch (error) {
        console.error("ERROR:", error.message);
        alerta(error.message);
      }
    }

    // APPLICATION OFFLINE STATE HANDLER
    async function appOffline() {
      try {
        const login = await vLogin();
        if (!login) {
          window.location.href = "https://dosxdos.app.iidos.com/index.html";
          return;
        }

        const Arrayusuario = await leerDatos("dosxdos", "usuario");
        usuario = Arrayusuario[0];
        montador = usuario.cod;

        // Update user name
        const nombreUsuarioDesktop = document.getElementById(
          "nombreUsuarioDesktop"
        );
        const nombreUsuarioMobile = document.getElementById(
          "nombreUsuarioMobile"
        );

        if (usuario && usuario.nombre) {
          if (nombreUsuarioDesktop)
            nombreUsuarioDesktop.textContent = usuario.nombre;
          if (nombreUsuarioMobile)
            nombreUsuarioMobile.textContent = usuario.nombre;
        }

        // Fetch routes and lines
        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));

        const TotalLineas = await leerDatos("dosxdos", "lineas");
        if (TotalLineas) {
          const lineas = TotalLineas.filter(
            (objeto) => objeto.Proyecto == ruta
          );
          const fragmento = document.createDocumentFragment();

          lineas.forEach((objeto) => {
            const button = document.createElement("button");
            const estaAceptada = objeto.Estado === "Realizado";

            button.className = `${
              estaAceptada ? "ruta2" : "ruta"
            } displayOn flex justify-between items-center`;
            button.type = "button";
            button.id = `${objeto.Linea}`;

            const observaciones = objeto.Observaciones;
            const LineaActividad = objeto.LineaActividad;
            const ot = objeto.OT;
            const otNavision = objeto.Navision_OT;

            const divContenedor = document.createElement("div");
            divContenedor.className = "flex justify-between items-start";

            const divInfo = document.createElement("div");
            divInfo.className = "flex-1";

            const texto = observaciones
              ? `${objeto.Sector} _ ${objeto.Zona} _ ${LineaActividad} _ ${objeto.NombrePuntoVenta} _ ${objeto.NombreCliente} _ ${objeto.TipoTrabajo} _ ${observaciones} _ NAVISION: ${otNavision} _ CRM: ${ot}`
              : `${objeto.Sector} _ ${objeto.Zona} _ ${LineaActividad} _ ${objeto.NombrePuntoVenta} _ ${objeto.NombreCliente} _ ${objeto.TipoTrabajo} _ NAVISION: ${otNavision} _ CRM: ${ot}`;

            divInfo.textContent = texto;

            const botonAceptar = document.createElement("button");
            botonAceptar.className = `ml-4 inline-flex items-center rounded-md ${
              estaAceptada
                ? "bg-gray-100 px-2 py-1 text-xs font-medium text-gray-600"
                : "bg-red-100 px-2 py-1 text-xs font-medium text-red-700 hover:bg-red-200"
            }`;
            botonAceptar.textContent = estaAceptada ? "Aceptada" : "Aceptar";
            botonAceptar.onclick = (e) => {
              e.stopPropagation();
              aceptarNotificación(objeto.id);
            };

            divContenedor.appendChild(divInfo);
            divContenedor.appendChild(botonAceptar);
            button.appendChild(divContenedor);

            button.setAttribute("data-LineaActividad", LineaActividad);
            button.setAttribute(
              "data-estado",
              estaAceptada ? "aceptada" : "pendiente"
            );

            fragmento.appendChild(button);
          });

          $contenido.appendChild(fragmento);
          startBuscador();

          const editarUsuario = document.getElementById("editarUsuario");
          editarUsuario.addEventListener("click", (e) => {
            if (navigator.onLine) {
              window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?modulo=editarUsuario&id=${usuario.id}`;
            } else {
              mensaje =
                "No es posible acceder a las opciones de edición de usuario sin conexión a internet";
              alerta(mensaje);
              scrollToTop();
            }
          });

          loaderOff();
        } else {
          alerta("Error al leer el almacén de líneas");
          const editarUsuario = document.getElementById("editarUsuario");
          editarUsuario.addEventListener("click", (e) => {
            if (navigator.onLine) {
              window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?modulo=editarUsuario&id=${usuario.id}`;
            } else {
              mensaje =
                "No es posible acceder a las opciones de edición de usuario sin conexión a internet";
              alerta(mensaje);
              scrollToTop();
            }
          });
          loaderOff();
        }
      } catch (error) {
        mensaje = "ERROR: " + error.message;
        console.error(error);
        alerta(mensaje);
      }
    }

    // INITIALIZATION FUNCTION
    function initializeAppState() {
      if (navigator.onLine) {
        console.log("La aplicación está en línea.");
        appOnline();
      } else {
        console.log("La aplicación está fuera de línea.");
        appOffline();
      }
    }

    // Attach initialization to DOMContentLoaded
    document.addEventListener("DOMContentLoaded", initializeAppState);
  </script>
  <script src="https://dosxdos.app.iidos.com/js/utils/notificaciones.js"></script>
</html>
