<!DOCTYPE html>

<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rutas</title>
  <!-- Favicons -->
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logo-red.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
</head>

<body id="body" class="oyh min-h-screen overflow-x-hidden">
  <div id="loader" class="displayOn">
    <span class="loader"></span>
  </div>

  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden xl:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 xl:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden xl:flex items-center space-x-8">
        <!-- Navigation items will be dynamically created by createDesktopNavigation() -->

        <!-- Desktop Menu Notifications Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="desktopBellContainer">
          <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
          <span id="desktopNotificationCount"
            class="absolute -top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="xl:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="mobileBellContainer">
          <img id="bellMobile" src="https://dosxdos.app.iidos.com/img/bell2.png"
            class="w-8 text-gray-900 object-contain mt-2" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-1 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Mobile Menu Button -->
        <button id="menuButton" class="xl:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

    </div>

    <div id="opcionesMenu"
      class="xl:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
      <div class="absolute inset-0 z-0"
        style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain; opacity: 0.7;">
      </div>
      <!-- User Profile Section -->
      <div class="px-8 py-4 mt-16 relative z-10">
        <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
          <!-- Profile image -->
          <div
            class="absolute left-0 w-28 h-28 rounded-full overflow-hidden border-4 border-white bg-gradient-to-br from-red-50 to-white flex items-center justify-center shadow-xl"
            style="transform: translateX(-15%);">
            <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
              class="w-full h-full object-cover" alt="Profile"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
            <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="ml-28 flex items-center py-4">
            <!-- User name -->
            <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
            <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
            <span class="text-black font-medium text-xl">!</span>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Navigation Links -->
      <nav class="px-8 pt-3 space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar mt-2">
        <!-- Dynamic menu items will be added here based on user role -->
      </nav>

      <!-- Mobile Menu Footer -->
      <div class="relative z-10">
        <div class="website-divider-container-734167" style="height: 100px; overflow: visible">
          <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
            preserveAspectRatio="none" style="bottom: -20px">
            <path
              d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
              style="fill: #ffffff"></path>
            <path
              d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.5"></path>
            <path
              d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.25"></path>
          </svg>
        </div>
      </div>

      <!-- User Actions -->
      <div class="relative z-10 mt-auto px-8 pb-6 bg-white shadow-lg flex justify-center space-x-6 pb-2 rounded-t-xl">
        <!-- Edit Button -->
        <button id="editarUsuarioMobile"
          class="flex items-center justify-center w-14 h-14 bg-white border-2 border-red-500 rounded-full hover:bg-red-100 transition-all duration-300">
          <svg class="w-8 h-8 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>

        <!-- Logout Button -->
        <button id="cerrarSesionMobile"
          class="flex items-center justify-center w-14 h-14 bg-red-600 rounded-full transition-all duration-300">
          <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        </button>
      </div>
    </div>
    </div>
  </section>

  <div class="pt-16 w-full">
    <div id="cabeceraContenido" class="flex flex-col bg-gray-100 shadow">
      <!-- Search Section -->
      <div class="relative flex items-center w-full px-12 mt-20 mb-6">
        <img src="https://dosxdos.app.iidos.com/img/lupa.png"
          class="w-5 h-5 opacity-90 absolute left-16 top-1/2 transform -translate-y-1/2" />
        <input type="text" id="buscador"
          class="shadow w-full h-12 pl-12 pr-4 bg-white/10 border border-white/20 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-red-600 transition-all duration-300 ease-in-out text-black placeholder-white/70"
          placeholder="Buscar rutas..." />
      </div>
      <h1 id="titulo" class="text-2xl font-bold text-center mb-4">RUTAS</h1>
    </div>
  </div>

  <section class="flex flex-col min-h-screen">
    <div class="flex-grow p-6 bg-gray-100">
      <div id="rutas" class="h-full w-full mx-auto grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>
  </section>
</body>
<script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
<script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
<script src="https://dosxdos.app.iidos.com/js/navigation.js"></script>
<script>
  const $rutas = document.getElementById("rutas"),
    $loader = document.getElementById("loader"),
    $body = document.getElementById("body"),
    buscador = document.getElementById("buscador");
  let usuario,
    montador,
    rutas,
    lineas,
    notificacionesSinAcpetarNumero = 0;

  /* LOADER */

  function scrollToTop() {
    $body.scrollTop = 0;
  }

  /* LOADER */
  function loaderOn() {
    scrollToTop();
    $loader.classList.remove("displayOff");
    $loader.classList.add("displayOn");
    $body.style.overflow = 'hidden';
    $body.style.overflow = 'hidden';
    $body.style.position = 'fixed';
    $body.style.width = '100%';
    $body.style.height = '100vh';
  }

  function loaderOff() {
    setTimeout(() => {
      $loader.classList.remove("displayOn");
      $loader.classList.add("displayOff");
      $body.style.overflow = '';
      document.documentElement.style.overflow = '';
      $body.style.position = '';
      $body.style.width = '';
      $body.style.height = '';
    }, 1000);
  }

  function alerta(mensaje) {
    // Remove existing alert if present
    const existingAlert = document.querySelector("#customAlert");
    if (existingAlert) {
      existingAlert.remove();
    }

    // Create alert container
    const alertContainer = document.createElement("div");
    alertContainer.id = "customAlert";
    alertContainer.className =
      "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[85vw] md:w-[80vw] lg:w-[75vw]";
    alertContainer.style.top = "-100px";

    // Create alert content
    const alertContent = document.createElement("div");
    alertContent.className = `
    relative
    bg-white
    border-2 border-red-600
    rounded-lg
    shadow-lg
    p-4 md:p-5
    flex flex-col md:flex-row md:items-center gap-3 md:gap-4
  `;

    // Create close button
    const closeButton = document.createElement("button");
    closeButton.className =
      "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600 rounded-full p-1.5 transition-colors duration-200";
    closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

    // Create main content container for mobile layout
    const contentContainer = document.createElement("div");
    contentContainer.className =
      "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

    // Create icon with exclamation mark
    const iconContainer = document.createElement("div");
    iconContainer.className = "flex-shrink-0 text-red-600";
    iconContainer.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="10" />
  <path d="M12 7v6" />
  <path d="M12 16h0.01" />
</svg>
`;

    // Create message text
    const messageText = document.createElement("p");
    messageText.className = "text-gray-900 text-base md:text-lg flex-1";
    messageText.textContent = mensaje;

    // Assemble the content container
    contentContainer.appendChild(iconContainer);
    contentContainer.appendChild(messageText);

    // Assemble the alert
    alertContent.appendChild(closeButton);
    alertContent.appendChild(contentContainer);
    alertContainer.appendChild(alertContent);
    $body.appendChild(alertContainer);

    // Slide down animation
    requestAnimationFrame(() => {
      alertContainer.style.top = "56px";
    });

    // Add event listeners
    closeButton.addEventListener("click", () => {
      hideAlert(alertContainer);
    });

    // Hide loader if it exists
    loaderOff();
  }

  function hideAlert(alertContainer) {
    alertContainer.style.top = "-100px";

    setTimeout(() => {
      alertContainer.remove();
    }, 300);
  }

  /* TRAER DATOS DE LOS SERVIDORES */

  function fetchRutas() {
    return new Promise((resolve, reject) => {
      url =
        "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" + montador;
      fetch(url)
        .then((res) => {
          if (res.ok) {
            return res.json();
          } else {
            mensaje =
              "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
            alerta(mensaje);
            loaderOff();
          }
        })
        .then((res) => {
          if (res[0]) {
            const request = indexedDB.open("dosxdos");
            request.onsuccess = (event) => {
              const db = event.target.result;
              const transaction = db.transaction("rutas", "readwrite");
              const datosStore = transaction.objectStore("rutas");
              const clearRequest = datosStore.clear();
              clearRequest.onsuccess = (clearEvent) => {
                const datos = res[1];
                datos.forEach((item) => {
                  datosStore.add(item);
                });
                resolve(true);
              };
              clearRequest.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                alerta(mensaje);
                loaderOff();
              };
            };
            request.onerror = (event) => {
              error = event.target.error;
              mensaje = `ERROR: ` + error;
              alerta(mensaje);
              loaderOff();
            };
          } else {
            mensaje = res[1];
            alerta(mensaje);
            loaderOff();
          }
        })
        .catch((res) => {
          mensaje = "Error al consultar las rutas: " + res.message;
          alerta(mensaje);
          loaderOff();
        });
    });
  }

  function fetchLineas(vectorRutas) {
    return new Promise(async (resolve, reject) => {
      try {
        const promises = vectorRutas.map(async (objeto) => {
          const url =
            "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
            objeto.cod;
          const res = await fetch(url);

          if (!res.ok) {
            throw new Error(
              `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
            );
          }

          const resJson = await res.json();

          if (resJson[0]) {
            const db = await new Promise((dbResolve, dbReject) => {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                dbResolve(db);
              };
              request.onerror = (event) => {
                dbReject(
                  new Error(
                    `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                  )
                );
              };
            });

            const transaction = db.transaction("lineas", "readwrite");
            const datosStore = transaction.objectStore("lineas");
            const datos = resJson[1];
            if (Array.isArray(datos)) {
              datos.forEach((item) => {
                datosStore.add(item);
              });
            } else {
              datosStore.add(datos);
            }
          } else {
            throw new Error(
              `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
            );
          }
        });

        await Promise.all(promises);
        resolve(true);
      } catch (err) {
        console.error(err);
        reject(err);
      }
    });
  }

  /* SINCRONIZAR BASE DE DATOS */

  async function sincronizarDb() {
    try {
      loaderOn();
      const fRutas = await fetchRutas();
      rutas = await leerDatos("dosxdos", "rutas");
      rutas = rutas.map((objeto) => ({
        cod: objeto["No."],
        nombre: objeto["Descripcion"],
      }));
      const limpiarLineas = await limpiarAlmacen("dosxdos", "lineas");
      if (limpiarLineas) {
        lineas = await fetchLineas(rutas);
        if (lineas) {
          const mensaje = "Se ha sincronizado la base de datos exitosamente";
          localStorage.setItem("mensaje", mensaje);
          window.location.href =
            "https://dosxdos.app.iidos.com/rutas_montador.html";
        } else {
          alerta(
            "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
          );
          loaderOff();
        }
      }
    } catch (error) {
      const mensaje =
        "No se ha sincronizado la base de datos: " + error.message;
      localStorage.setItem("mensaje", mensaje);
      window.location.href =
        "https://dosxdos.app.iidos.com/rutas_montador.html";
    }
  }

  async function sincronizarDb2() {
    return new Promise(async (resolve, reject) => {
      try {
        loaderOn();
        const fRutas = await fetchRutas();
        rutas = await leerDatos2("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));
        const limpiarLineas = await limpiarDatos2("dosxdos", "lineas");
        if (limpiarLineas) {
          lineas = await fetchLineas(rutas);
          if (lineas) {
            resolve(true);
          } else {
            resolve(false);
          }
        }
      } catch (error) {
        console.error(error);
        reject(false);
      }
    });
  }

  /* LOGIN */

  function vLogin() {
    return new Promise((resolve, reject) => {
      const login = localStorage.getItem("login");
      if (login && login !== null) {
        leerDatos("dosxdos", "usuario")
          .then((res) => {
            usuario = res[0];
            resolve(usuario.clase);
          })
          .catch((err) => {
            resolve(false);
          });
      } else {
        resolve(false);
      }
    });
  }

  function startBuscador() {
    if (buscador.value) {
      botones = document.querySelectorAll("#rutas button");
      const valorBusqueda = buscador.value.toLowerCase();
      botones.forEach((boton) => {
        const textoBoton = boton.textContent.toLowerCase();
        const span = boton.querySelector("span"); // Obtener el elemento <span> dentro del botón
        if (textoBoton.includes(valorBusqueda)) {
          boton.classList.replace("displayOff", "displayOn");
          // Crear una expresión regular para buscar la coincidencia exacta
          const regex = new RegExp(valorBusqueda, "gi");
          const textoResaltado = boton.textContent.replace(
            regex,
            '<span class="resaltado">$&</span>'
          );
          span.innerHTML = textoResaltado;
        } else {
          boton.classList.replace("displayOn", "displayOff");
          // Restablecer el texto original sin resaltado
          span.textContent = span.textContent;
        }
      });
    }
  }

  // INITIALIZATION FUNCTION
  function initializeApplication() {
    return new Promise(resolve => {
      try {
        // Dynamically create navigation based on user role
        createDesktopNavigation(usuario.clase);
        // Setup desktop and mobile navigation
        setupMenu(usuario.clase);

        // Setup menu interactions
        setupMenuInteractions();
        setupUserActions();
        setupGlobalMenuClosing();

        updateUserDisplay();

        // Update the user information in the new UI elements
        const nombreUsuarioDesktop = document.getElementById('nombreUsuarioDesktop');
        const nombreUsuarioMobile = document.getElementById('nombreUsuarioMobile');
        const imagenUsuarioDesktop = document.getElementById('imagenUsuarioDesktop');
        const imagenUsuarioMobile = document.getElementById('imagenUsuarioMobile');

        if (nombreUsuarioDesktop) nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile) nombreUsuarioMobile.textContent = usuario.nombre;

        if (usuario.imagen !== "0") {
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }
        resolve(true);
      } catch (error) {
        console.error("Error initializing application:", error);
        resolve(false);
      }
    })
  }


  /* INICIAR APP ONLINE */

  async function appOnline() {
    try {
      const login = await vLogin();
      if (!login) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      } else {
        const Arrayusuario = await leerDatos("dosxdos", "usuario");
        usuario = Arrayusuario[0];
        let loginMontador = localStorage.getItem("loginMontador");
        if (!loginMontador || loginMontador === null) {
          window.location.href =
            "https://dosxdos.app.iidos.com/dosxdos.php?id=" +
            usuario.id +
            "&rol=" +
            usuario.clase;
        }
        montador = usuario.cod;

        await initializeApplication();
        try {
          const sincronizacionDeNotificaciones = await sincronizarNotificaciones();
          if (sincronizacionDeNotificaciones) {
            await notificar();
          }
        } catch (error) {
          console.error("Error loading notifications:", error);
        }

        const rutasResult = await fetchRutas();
        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));

        rutas.sort((a, b) => a.nombre.localeCompare(b.nombre));

        const fragmento = document.createDocumentFragment();
        const rutasContainer = document.getElementById("rutas");

        if (rutas.length === 0) {
          // Create a no data placeholder
          const noDataPlaceholder = document.createElement('div');
          noDataPlaceholder.className = 'flex flex-col items-center justify-center min-h-[calc(100vh-300px)] text-center p-8 bg-gray-100';

          noDataPlaceholder.innerHTML = `
            <h2 class="text-2xl font-semibold text-gray-600 mb-4">No hay rutas disponibles</h2>
            <p class="text-gray-500 max-w-md">
                Parece que no hay rutas asignadas en este momento.
            </p>
        `;

          rutasContainer.appendChild(noDataPlaceholder);

          // Exit the function early since there are no lines
          loaderOff();
          return;
        }

        rutas.forEach((objeto) => {
          const button = document.createElement("button");
          button.className =
            "relative w-full h-16 sm:h-20 md:h-24 lg:h-28 flex items-center justify-center rounded-2xl text-white font-semibold text-lg transition-all duration-300 transform hover:scale-95 hover:shadow-lg active:scale-100";
          button.type = "button";
          button.id = objeto.cod;

          // Background SVG (Full Cover)
          button.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
          button.style.backgroundSize = "contain";
          button.style.backgroundPosition = "center";

          // Text Overlay
          const textSpan = document.createElement("span");
          textSpan.className = "relative z-10";
          textSpan.textContent = objeto.nombre;

          button.appendChild(textSpan);

          button.addEventListener("click", () => {
            localStorage.setItem("ruta", button.id);
            localStorage.setItem("nombreRuta", objeto.nombre);
            window.location.href = "https://dosxdos.app.iidos.com/ruta_montador.html";
          });

          fragmento.appendChild(button);
        });

        rutasContainer.innerHTML = "";
        rutasContainer.appendChild(fragmento);


        const limpiarLineas = await limpiarAlmacen("dosxdos", "lineas");
        if (limpiarLineas) {
          lineas = await fetchLineas(rutas);
          if (lineas) {
            initializeSearch();
            const peticionesCierre = await procesarPeticiones2();
            loaderOff();
          } else {
            alerta("Error al cargar las líneas de las rutas del servidor");
            initializeSearch();
            const peticionesCierre = await procesarPeticiones2();
            loaderOff();
          }
        }
      }
    } catch (error) {
      mensaje = "ERROR: " + error.message;
      console.log(mensaje);
      loaderOff();
    }
  }

  /* INICIAR APP OFFLINE */

  async function appOffline() {
    try {
      const login = await vLogin();
      if (!login) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      } else {
        const Arrayusuario = await leerDatos("dosxdos", "usuario");
        usuario = Arrayusuario[0];
        montador = usuario.cod;

        initializeApplication()

        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));

        rutas.sort((a, b) => a.nombre.localeCompare(b.nombre));

        const fragmento = document.createDocumentFragment();
        const rutasContainer = document.getElementById("rutas");

        if (rutas.length === 0) {
          // Create a no data placeholder
          const noDataPlaceholder = document.createElement('div');
          noDataPlaceholder.className = 'flex flex-col items-center justify-center min-h-[calc(100vh-300px)] text-center p-8 bg-gray-100';

          noDataPlaceholder.innerHTML = `
            <h2 class="text-2xl font-semibold text-gray-600 mb-4">No hay rutas disponibles</h2>
            <p class="text-gray-500 max-w-md">
                Parece que no hay rutas asignadas en este momento.
            </p>
        `;

          rutasContainer.appendChild(noDataPlaceholder);

          // Exit the function early since there are no lines
          loaderOff();
          return;
        }

        rutas.forEach((objeto) => {
          const button = document.createElement("button");
          button.className =
            "relative w-full h-16 sm:h-20 md:h-24 lg:h-28 flex items-center justify-center rounded-2xl text-white font-semibold text-lg transition-all duration-300 transform hover:scale-95 hover:shadow-lg active:scale-100";
          button.type = "button";
          button.id = objeto.cod;

          // Background SVG (Full Cover)
          button.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
          button.style.backgroundSize = "contain";
          button.style.backgroundPosition = "center";

          // Text Overlay
          const textSpan = document.createElement("span");
          textSpan.className = "relative z-10";
          textSpan.textContent = objeto.nombre;

          button.appendChild(textSpan);

          button.addEventListener("click", () => {
            localStorage.setItem("ruta", button.id);
            localStorage.setItem("nombreRuta", objeto.nombre);
            window.location.href = "https://dosxdos.app.iidos.com/ruta_montador.html";
          });

          fragmento.appendChild(button);
        });

        rutasContainer.innerHTML = "";
        rutasContainer.appendChild(fragmento);

        initializeSearch();
        await notificar();
        loaderOff();
      }
      await notificar();

    } catch (error) {
      initializeApplication()
      mensaje = "ERROR: " + error.message;
      alerta(mensaje);
      loaderOff();
    }
  }

  /* EVENTOS CLIC */

  document.addEventListener("click", (e) => {
    if (e.target.matches("#cerrarSesion")) {
      cerrarSesion();
    }
  });

  /* BUSCADOR */

  buscador.addEventListener("input", () => {
    botones = document.querySelectorAll("#rutas button");
    const valorBusqueda = buscador.value.toLowerCase();
    botones.forEach((boton) => {
      const textoBoton = boton.textContent.toLowerCase();
      const span = boton.querySelector("span"); // Obtener el elemento <span> dentro del botón
      if (textoBoton.includes(valorBusqueda)) {
        boton.classList.replace("displayOff", "displayOn");
        // Crear una expresión regular para buscar la coincidencia exacta
        const regex = new RegExp(valorBusqueda, "gi");
        const textoResaltado = boton.textContent.replace(
          regex,
          '<span class="resaltado">$&</span>'
        );
        span.innerHTML = textoResaltado;
      } else {
        boton.classList.replace("displayOn", "displayOff");
        // Restablecer el texto original sin resaltado
        span.textContent = span.textContent;
      }
    });
  });

  // SEARCH FUNCTIONALITY
  function initializeSearch() {
    const buscador = document.getElementById("buscador");
    if (buscador) {
      buscador.addEventListener("input", () => {
        const searchTerm = buscador.value.toLowerCase().trim();
        const buttons = document.querySelectorAll("#rutas button");

        buttons.forEach((button) => {
          const textContent = button.textContent.toLowerCase();
          const span = button.querySelector("span");

          if (textContent.includes(searchTerm)) {
            button.classList.remove("displayOff");
            button.classList.add("displayOn");

            // Highlight matching text
            if (searchTerm && span) {
              const regex = new RegExp(`(${searchTerm})`, "gi");
              span.innerHTML = span.textContent.replace(
                regex,
                '<span class="resaltado">$1</span>'
              );
            }
          } else {
            button.classList.remove("displayOn");
            button.classList.add("displayOff");
          }
        });
      });
    } else {
      console.warn("Could not find search input element");
    }
  }

  /* PETICIONES PENDIENTES */

  function actualizarLinea(json) {
    console.log(json);
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/lineas.php", {
        method: "PUT",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) =>
          res.ok
            ? res.json()
            : reject(
              new Error(
                `Error en los servidores al actualizar los datos de la línea`
              )
            )
        )
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFotos(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/fotos.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las fotos. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFirmas(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/firmas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las firmas. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirNota(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/notas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar la nota. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  async function enviarPeticiones(vectorObjDb, tipoVector) {
    return new Promise(async (resolve, reject) => {
      try {
        let solicitud,
          mensaje = "",
          vaciarStore;
        for (const objeto of vectorObjDb) {
          jsonObjeto = JSON.stringify(objeto);
          if (tipoVector == "lineas") {
            solicitud = await actualizarLinea(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error en el envío de la petición pendiente de la actualización de datos en la api de Navision en la ruta: ${objeto.CodigoRuta} y la línea de ruta: ${objeto.LineaRuta}-`;
            }
          } else if (tipoVector == "fotos") {
            solicitud = await subirFotos(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las fotos pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "firmas") {
            solicitud = await subirFirmas(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las firmas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "notas") {
            solicitud = await subirNota(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las notas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.linea}-`;
            }
          }
        }
        if (tipoVector == "lineas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesLineas");
          mensaje += "-Datos pendientes enviados al servidor-";
        } else if (tipoVector == "fotos") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFotos");
          mensaje += "-Fotos pendientes subidas al servidor-";
        } else if (tipoVector == "firmas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFirmas");
          mensaje += "-Firmas pendientes subidas al servidor-";
        } else if (tipoVector == "notas") {
          vaciarStore = await limpiarDatos2("dosxdos", "notas");
          mensaje += "-Notas pendientes subidas al servidor-";
        }
        resolve(mensaje);
      } catch (err) {
        console.error(err);
        alerta(err.message);
        scrollToTop();
        reject(err);
      }
    });
  }

  async function procesarPeticiones() {
    try {
      loaderOn();
      mensaje = "";
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas";
        }
      }
      if (!mensaje) {
        mensaje = "No hay datos pendientes para ser enviados al servidor";
      }
      const sincronizarBaseDatos = await sincronizarDb2();
      if (sincronizarBaseDatos) {
        mensaje += "Se ha sincronizado la base de datos exitosamente";
      } else {
        mensaje += "Error: No ha sido posible sincronizar la base de datos";
      }
      localStorage.setItem("mensaje", mensaje);
      location.reload();
      /*alerta(mensaje);
        scrollToTop();*/
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  async function procesarPeticiones2(mensaje) {
    try {
      if (mensaje == null) {
        mensaje = "";
      }
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
        }
      }
      if (mensaje) {
        alerta(mensaje);
        scrollToTop();
      }
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  /* TAREAS EN LA INTERMITENCIA DE LA CONEXIÓN */

  window.addEventListener("online", () => {
    console.log("La conexión a Internet se ha recuperado.");
    //cache();
    procesarPeticiones();
  });

  window.addEventListener("offline", () => {
    console.log("La conexión a Internet se ha perdido.");
  });

  /* PAGESHOW */
  window.addEventListener("pageshow", (e) => {
    console.log("Carga completa de los elementos de la página no fetch");
    let mensaje = localStorage.getItem("mensaje");
    if (mensaje && mensaje !== null) {
      alerta(mensaje);
      localStorage.removeItem("mensaje");
    }
    let login = localStorage.getItem("login");
    if (!login || login === null) {
      window.location.href = "https://dosxdos.app.iidos.com/index.html";
    }
  });

  /* TAREAS AL INICIAR LA PANTALLA CON EL ESTADO DE LA CONEXIÓN */
  if (navigator.onLine) {
    console.log("La aplicación está en línea.");
    //cache();
    initializeApplication()
    appOnline();
  } else {
    console.log("La aplicación está fuera de línea.");
    appOffline();
  }

  // Call initialization when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM fully loaded");
    initializeSearch();
  });

</script>

<script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>

</html>