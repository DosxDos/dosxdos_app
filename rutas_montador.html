<!DOCTYPE html>

<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RUTAS</title>
  <!-- Favicons -->
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logoPwa256.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
</head>

<body id="body" class="oyh min-h-screen">
  <div id="loader" class="displayOn">
    <span class="loader"></span>
  </div>

  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden md:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 md:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center space-x-8">

        <a href="https://dosxdos.app.iidos.com/ruta_montador.html"
          class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
            <path d="M9 12h6" />
            <path d="M9 16h6" />
          </svg>
          <span>Líneas</span>
        </a>

        <!-- History Link -->
        <a href="https://dosxdos.app.iidos.com/historial_montador.html"
          class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200">
          <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
          <span>Historial</span>
        </a>

        <!-- Desktop Menu Notifications Bell -->

        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="desktopBellContainer">
          <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
          <span id="desktopNotificationCount"
            class="absolute top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>


        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="md:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->

        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="mobileBellContainer">
          <img id="bellMobile" src="" class="text-gray-900 object-contain mt-2" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-0 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Hamburger Button -->
        <button id="menuButton" class="md:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

      <div id="mobileMenu"
        class="md:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
        <div class="absolute inset-0 z-0" style="
            background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
            background-size: contain;
            opacity: 0.7;
          "></div>
        <!-- User Profile Section -->
        <div class="px-8 py-4 mt-20 relative z-10">
          <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
            <!-- Profile image -->
            <div
              class="absolute left-0 w-24 h-24 rounded-full overflow-hidden border-2 border-white bg-gray-100 flex items-center justify-center shadow-lg">
              <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="ml-28 flex items-center py-4">
              <!-- User name -->
              <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
              <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
              <span class="text-black font-medium text-xl">!</span>
            </div>
          </div>
        </div>

        <!-- Navigation Links -->
        <nav class="px-8 py-6 space-y-2 relative z-10 flex-1 overflow-y-auto">
          <a href="https://dosxdos.app.iidos.com/notificaciones.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8a6 6 0 0 0-12 0v5a6 6 0 0 1-2 4h16a6 6 0 0 1-2-4V8"></path>
                <line x1="12" y1="22" x2="12" y2="22"></line> <!-- Small bell clapper -->
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Notificaciones</span>
          </a>


          <a href="https://dosxdos.app.iidos.com/ruta_montador.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                <path d="M9 12h6" />
                <path d="M9 16h6" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Líneas</span>
          </a>

          <a href="https://dosxdos.app.iidos.com/historial_montador.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Historial</span>
          </a>
        </nav>

        <div class="relative z-10">
          <div id="divider_id" class="website-divider-container-734167" style="height: 100px; overflow: visible">
            <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
              preserveAspectRatio="none" style="bottom: -20px">
              <path
                d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
                style="fill: #ffffff"></path>
              <path
                d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
                style="fill: #ffffff; opacity: 0.5"></path>
              <path
                d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
                style="fill: #ffffff; opacity: 0.25"></path>
            </svg>
          </div>
        </div>

        <!-- User Actions -->
        <div class="relative z-10 mt-auto px-8 pb-6 bg-white shadow-lg flex justify-center space-x-6 pb-2 rounded-t-xl">
          <!-- Edit Button -->
          <button id="editarUsuarioMobile"
            class="flex items-center justify-center w-14 h-14 bg-white border-2 border-red-500 rounded-full hover:bg-red-100 transition-all duration-300">
            <svg class="w-12 h-12 text-red-600 pl-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
              <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
              <g id="SVGRepo_iconCarrier">
                <path
                  d="M10.56 11.87C9.81832 11.87 9.0933 11.6501 8.47661 11.238C7.85993 10.826 7.37928 10.2403 7.09545 9.55506C6.81162 8.86984 6.73736 8.11584 6.88205 7.38841C7.02675 6.66098 7.3839 5.99279 7.90835 5.46835C8.4328 4.9439 9.10098 4.58675 9.82841 4.44205C10.5558 4.29736 11.3098 4.37162 11.9951 4.65545C12.6803 4.93928 13.266 5.41992 13.678 6.03661C14.0901 6.65329 14.31 7.37832 14.31 8.12C14.3074 9.11375 13.9114 10.066 13.2087 10.7687C12.506 11.4714 11.5538 11.8674 10.56 11.87ZM10.56 5.87C10.115 5.87 9.67998 6.00196 9.30997 6.24919C8.93996 6.49642 8.65157 6.84783 8.48127 7.25896C8.31097 7.67009 8.26642 8.12249 8.35323 8.55895C8.44005 8.99541 8.65434 9.39632 8.96901 9.71099C9.28368 10.0257 9.68459 10.2399 10.121 10.3268C10.5575 10.4136 11.0099 10.369 11.421 10.1987C11.8322 10.0284 12.1836 9.74004 12.4308 9.37003C12.678 9.00002 12.81 8.565 12.81 8.12C12.81 7.52326 12.5729 6.95096 12.151 6.52901C11.729 6.10705 11.1567 5.87 10.56 5.87Z"
                  fill="#e53935"></path>
                <path
                  d="M3.56 18.87C3.36109 18.87 3.17032 18.791 3.02967 18.6503C2.88902 18.5097 2.81 18.3189 2.81 18.12C2.81 13.37 8.24 13.37 10.56 13.37C11.28 13.37 11.92 13.37 12.5 13.44C12.6973 13.4553 12.8805 13.548 13.0098 13.6979C13.139 13.8477 13.2038 14.0426 13.19 14.24C13.1722 14.4381 13.0773 14.6214 12.9259 14.7504C12.7744 14.8794 12.5785 14.9439 12.38 14.93C11.84 14.93 11.24 14.87 10.56 14.87C5.38 14.87 4.31 16.17 4.31 18.12C4.31134 18.2189 4.29286 18.317 4.25565 18.4086C4.21843 18.5002 4.16324 18.5834 4.09333 18.6533C4.02341 18.7232 3.9402 18.7784 3.84859 18.8156C3.75699 18.8529 3.65886 18.8713 3.56 18.87Z"
                  fill="#e53935"></path>
                <path
                  d="M12.67 19.63C12.4711 19.6299 12.2805 19.5507 12.14 19.41C12.061 19.3348 12.0002 19.2426 11.9621 19.1404C11.9239 19.0382 11.9096 18.9286 11.92 18.82L12.08 16.9C12.0923 16.7235 12.1667 16.557 12.29 16.43L17.81 10.91C18.1908 10.5572 18.6908 10.3612 19.21 10.3612C19.7291 10.3612 20.2291 10.5572 20.61 10.91C20.7978 11.0993 20.9458 11.3242 21.0454 11.5715C21.145 11.8188 21.1942 12.0835 21.19 12.35C21.1939 12.5958 21.149 12.8398 21.0581 13.0681C20.9671 13.2964 20.8318 13.5044 20.66 13.68L15.14 19.2C15.0176 19.3256 14.8545 19.4035 14.68 19.42L12.74 19.6L12.67 19.63ZM13.55 17.29L13.49 18.05L14.27 17.98L19.6 12.65C19.6629 12.5746 19.6951 12.4782 19.69 12.38C19.6896 12.2408 19.64 12.1062 19.55 12C19.4517 11.927 19.3325 11.8875 19.21 11.8875C19.0875 11.8875 18.9683 11.927 18.87 12L13.55 17.29Z"
                  fill="#e53935"></path>
              </g>
            </svg>
          </button>

          <!-- Logout Button -->
          <button id="cerrarSesionMobile"
            class="flex items-center justify-center w-14 h-14 bg-red-600 rounded-full  transition-all duration-300">
            <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
        </div>

      </div>
  </section>

  <div class="pt-16 w-full">
    <div id="cabeceraContenido" class="flex flex-col bg-gray-100 shadow">
      <!-- Search Section -->
      <div class="relative flex items-center w-full px-12 mt-20 mb-6">
        <img src="https://dosxdos.app.iidos.com/img/lupa.png"
          class="w-5 h-5 opacity-90 absolute left-16 top-1/2 transform -translate-y-1/2" />
        <input type="text" id="buscador"
          class="shadow w-full h-12 pl-12 pr-4 bg-white/10 border border-white/20 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-red-600 transition-all duration-300 ease-in-out text-black placeholder-white/70"
          placeholder="Buscar rutas..." />
      </div>
      <h1 id="titulo" class="text-2xl font-bold text-center mb-4">RUTAS</h1>
    </div>
  </div>

  <section class="flex flex-col min-h-screen">
    <div class="flex-grow p-6 bg-gray-100">
      <div id="rutas" class="h-full w-full mx-auto grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>
  </section>


</body>

<script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>

<script>

  const $rutas = document.getElementById("rutas"),
    $loader = document.getElementById("loader"),
    $body = document.getElementById("body"),
    buscador = document.getElementById("buscador");
  let usuario,
    montador,
    rutas,
    lineas,
    notificacionesSinAcpetarNumero = 0;

  /* LOADER */

  function scrollToTop() {
    // Para navegadores modernos
    $body.scrollTop = 0;
    // Para navegadores antiguos
    $body.scrollTop = 0;
  }

  /* LOADER */
  function loaderOn() {
    scrollToTop();
    $loader.classList.remove("displayOff");
    $loader.classList.add("displayOn");
    $body.style.overflow = 'hidden';
    $body.style.overflow = 'hidden';
    $body.style.position = 'fixed';
    $body.style.width = '100%';
    $body.style.height = '100vh';
  }

  function loaderOff() {
    setTimeout(() => {
      $loader.classList.remove("displayOn");
      $loader.classList.add("displayOff");
      $body.style.overflow = '';
      document.documentElement.style.overflow = '';
      $body.style.position = '';
      $body.style.width = '';
      $body.style.height = '';
    }, 1000);
  }

  function alerta(mensaje) {
    // Remove existing alert if present
    const existingAlert = document.querySelector("#customAlert");
    if (existingAlert) {
      existingAlert.remove();
    }

    // Create alert container
    const alertContainer = document.createElement("div");
    alertContainer.id = "customAlert";
    alertContainer.className =
      "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[95%] md:w-[75%] lg:w-[65%]";
    alertContainer.style.top = "-100px";

    // Create alert content
    const alertContent = document.createElement("div");
    alertContent.className = `
    relative
    bg-white
    border-2 border-red-600
    rounded-lg
    shadow-lg
    p-4 md:p-5
    flex flex-col md:flex-row md:items-center gap-3 md:gap-4
  `;

    // Create close button
    const closeButton = document.createElement("button");
    closeButton.className =
      "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600 rounded-full p-1.5 transition-colors duration-200";
    closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

    // Create main content container for mobile layout
    const contentContainer = document.createElement("div");
    contentContainer.className =
      "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

    // Create icon with exclamation mark
    const iconContainer = document.createElement("div");
    iconContainer.className = "flex-shrink-0 text-red-600";
    iconContainer.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="10" />
  <path d="M12 7v6" />
  <path d="M12 16h0.01" />
</svg>
`;

    // Create message text
    const messageText = document.createElement("p");
    messageText.className = "text-gray-900 text-base md:text-lg flex-1";
    messageText.textContent = mensaje;

    // Assemble the content container
    contentContainer.appendChild(iconContainer);
    contentContainer.appendChild(messageText);

    // Assemble the alert
    alertContent.appendChild(closeButton);
    alertContent.appendChild(contentContainer);
    alertContainer.appendChild(alertContent);
    $body.appendChild(alertContainer);

    // Slide down animation
    requestAnimationFrame(() => {
      alertContainer.style.top = "56px";
    });

    // Add event listeners
    closeButton.addEventListener("click", () => {
      hideAlert(alertContainer);
    });

    // Hide loader if it exists
    loaderOff();
  }

  function hideAlert(alertContainer) {
    alertContainer.style.top = "-100px";

    setTimeout(() => {
      alertContainer.remove();
    }, 300);
  }

  /* CERRAR SESIÓN */

  function eliminarCookie(nombre) {
    const tiempoExpiracion = 1; // Segundo 1 de la Época Unix
    document.cookie = `${nombre}=; expires=${new Date(
      tiempoExpiracion * 1000
    ).toUTCString()}; path=/;`;
  }

  async function cerrarSesion() {
    if (navigator.onLine) {
      try {
        loaderOn();
        const eliminarBaseDeDatosCliente = await deleteDB2("dosxdos");
        if (eliminarBaseDeDatosCliente) {
          const eliminarTokenDeLasNotificaciones = eliminarTokenNotificaciones()
          if (eliminarTokenDeLasNotificaciones) {
            localStorage.clear();
            eliminarCookie("login");
            eliminarCookie("usuario");
            window.location.href = "https://dosxdos.app.iidos.com/index.html";
          }
        }
      } catch (error) {
        mensaje = "ERROR: " + error.message;
        console.error(error);
        alerta(mensaje);
      }
    } else {
      mensaje = "No es posible cerrar la sesión sin conexión a internet";
      $textoMensaje.innerHTML = mensaje;
      mensajeOn();
    }
  }


  /* TRAER DATOS DE LOS SERVIDORES */

  function fetchRutas() {
    return new Promise((resolve, reject) => {
      url =
        "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" + montador;
      fetch(url)
        .then((res) => {
          if (res.ok) {
            return res.json();
          } else {
            mensaje =
              "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
            alerta(mensaje);
            loaderOff();
          }
        })
        .then((res) => {
          if (res[0]) {
            const request = indexedDB.open("dosxdos");
            request.onsuccess = (event) => {
              const db = event.target.result;
              const transaction = db.transaction("rutas", "readwrite");
              const datosStore = transaction.objectStore("rutas");
              const clearRequest = datosStore.clear();
              clearRequest.onsuccess = (clearEvent) => {
                const datos = res[1];
                datos.forEach((item) => {
                  datosStore.add(item);
                });
                resolve(true);
              };
              clearRequest.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                alerta(mensaje);
                loaderOff();
              };
            };
            request.onerror = (event) => {
              error = event.target.error;
              mensaje = `ERROR: ` + error;
              alerta(mensaje);
              loaderOff();
            };
          } else {
            mensaje = res[1];
            alerta(mensaje);
            loaderOff();
          }
        })
        .catch((res) => {
          mensaje = "Error al consultar las rutas: " + res.message;
          alerta(mensaje);
          loaderOff();
        });
    });
  }

  function fetchLineas(vectorRutas) {
    return new Promise(async (resolve, reject) => {
      try {
        const promises = vectorRutas.map(async (objeto) => {
          const url =
            "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
            objeto.cod;
          const res = await fetch(url);

          if (!res.ok) {
            throw new Error(
              `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
            );
          }

          const resJson = await res.json();

          if (resJson[0]) {
            const db = await new Promise((dbResolve, dbReject) => {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                dbResolve(db);
              };
              request.onerror = (event) => {
                dbReject(
                  new Error(
                    `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                  )
                );
              };
            });

            const transaction = db.transaction("lineas", "readwrite");
            const datosStore = transaction.objectStore("lineas");
            const datos = resJson[1];
            if (Array.isArray(datos)) {
              datos.forEach((item) => {
                datosStore.add(item);
              });
            } else {
              datosStore.add(datos);
            }
          } else {
            throw new Error(
              `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
            );
          }
        });

        await Promise.all(promises);
        resolve(true);
      } catch (err) {
        console.error(err);
        reject(err);
      }
    });
  }

  /* SINCRONIZAR BASE DE DATOS */

  async function sincronizarDb() {
    try {
      loaderOn();
      const fRutas = await fetchRutas();
      rutas = await leerDatos("dosxdos", "rutas");
      rutas = rutas.map((objeto) => ({
        cod: objeto["No."],
        nombre: objeto["Descripcion"],
      }));
      const limpiarLineas = await limpiarAlmacen("dosxdos", "lineas");
      if (limpiarLineas) {
        lineas = await fetchLineas(rutas);
        if (lineas) {
          const mensaje = "Se ha sincronizado la base de datos exitosamente";
          localStorage.setItem("mensaje", mensaje);
          window.location.href =
            "https://dosxdos.app.iidos.com/rutas_montador.html";
        } else {
          alerta(
            "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
          );
          loaderOff();
        }
      }
    } catch (error) {
      const mensaje =
        "No se ha sincronizado la base de datos: " + error.message;
      localStorage.setItem("mensaje", mensaje);
      window.location.href =
        "https://dosxdos.app.iidos.com/rutas_montador.html";
    }
  }

  async function sincronizarDb2() {
    return new Promise(async (resolve, reject) => {
      try {
        loaderOn();
        const fRutas = await fetchRutas();
        rutas = await leerDatos2("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));
        const limpiarLineas = await limpiarDatos2("dosxdos", "lineas");
        if (limpiarLineas) {
          lineas = await fetchLineas(rutas);
          if (lineas) {
            resolve(true);
          } else {
            resolve(false);
          }
        }
      } catch (error) {
        console.error(error);
        reject(false);
      }
    });
  }

  /* LOGIN */

  function vLogin() {
    return new Promise((resolve, reject) => {
      const login = localStorage.getItem("login");
      if (login && login !== null) {
        leerDatos("dosxdos", "usuario")
          .then((res) => {
            usuario = res[0];
            resolve(usuario.clase);
          })
          .catch((err) => {
            resolve(false);
          });
      } else {
        resolve(false);
      }
    });
  }

  function startBuscador() {
    if (buscador.value) {
      botones = document.querySelectorAll("#rutas button");
      const valorBusqueda = buscador.value.toLowerCase();
      botones.forEach((boton) => {
        const textoBoton = boton.textContent.toLowerCase();
        const span = boton.querySelector("span"); // Obtener el elemento <span> dentro del botón
        if (textoBoton.includes(valorBusqueda)) {
          boton.classList.replace("displayOff", "displayOn");
          // Crear una expresión regular para buscar la coincidencia exacta
          const regex = new RegExp(valorBusqueda, "gi");
          const textoResaltado = boton.textContent.replace(
            regex,
            '<span class="resaltado">$&</span>'
          );
          span.innerHTML = textoResaltado;
        } else {
          boton.classList.replace("displayOn", "displayOff");
          // Restablecer el texto original sin resaltado
          span.textContent = span.textContent;
        }
      });
    }
  }

  /* INICIAR APP ONLINE */

  async function appOnline() {
    try {
      const login = await vLogin();
      if (!login) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      } else {
        const Arrayusuario = await leerDatos("dosxdos", "usuario");
        usuario = Arrayusuario[0];
        let loginMontador = localStorage.getItem("loginMontador");
        if (!loginMontador || loginMontador === null) {
          window.location.href =
            "https://dosxdos.app.iidos.com/dosxdos.php?id=" +
            usuario.id +
            "&rol=" +
            usuario.clase;
        }
        montador = usuario.cod;

        // Update the user information in the new UI elements
        const nombreUsuarioDesktop = document.getElementById(
          "nombreUsuarioDesktop"
        );
        const nombreUsuarioMobile = document.getElementById(
          "nombreUsuarioMobile"
        );
        const imagenUsuarioDesktop = document.getElementById(
          "imagenUsuarioDesktop"
        );
        const imagenUsuarioMobile = document.getElementById(
          "imagenUsuarioMobile"
        );

        if (nombreUsuarioDesktop)
          nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile)
          nombreUsuarioMobile.textContent = usuario.nombre;

        if (usuario.imagen !== "0") {
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }

        const rutasResult = await fetchRutas();
        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));

        rutas.sort((a, b) => a.nombre.localeCompare(b.nombre));


        const fragmento = document.createDocumentFragment();
        const rutasContainer = document.getElementById("rutas");

        rutas.forEach((objeto) => {
          const button = document.createElement("button");
          button.className =
            "relative w-full h-16 sm:h-20 md:h-24 lg:h-28 flex items-center justify-center rounded-2xl text-white font-semibold text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg active:scale-100";
          button.type = "button";
          button.id = objeto.cod;

          // Background SVG (Full Cover)
          button.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
          button.style.backgroundSize = "contain";
          button.style.backgroundPosition = "center";

          // Text Overlay
          const textSpan = document.createElement("span");
          textSpan.className = "relative z-10";
          textSpan.textContent = objeto.nombre;

          button.appendChild(textSpan);

          button.addEventListener("click", () => {
            localStorage.setItem("ruta", button.id);
            localStorage.setItem("nombreRuta", objeto.nombre);
            window.location.href = "https://dosxdos.app.iidos.com/ruta_montador.html";
          });

          fragmento.appendChild(button);
        });

        rutasContainer.innerHTML = "";
        rutasContainer.appendChild(fragmento);


        const limpiarLineas = await limpiarAlmacen("dosxdos", "lineas");
        if (limpiarLineas) {
          lineas = await fetchLineas(rutas);
          if (lineas) {
            initializeSearch();
            initializeApplication();
            const peticionesCierre = await procesarPeticiones2();
            loaderOff();
          } else {
            alerta("Error al cargar las líneas de las rutas del servidor");
            initializeSearch();
            initializeApplication();
            const peticionesCierre = await procesarPeticiones2();
            loaderOff();
          }
          const sincronizacionDeNotificaciones =
            await sincronizarNotificaciones();
          if (sincronizacionDeNotificaciones) {
            await notificar();
          }
        }
      }
    } catch (error) {
      mensaje = "ERROR: " + error.message;
      console.log(mensaje);
      loaderOff();
    }
  }

  /* INICIAR APP OFFLINE */

  async function appOffline() {
    try {
      const login = await vLogin();
      if (!login) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      } else {
        const Arrayusuario = await leerDatos("dosxdos", "usuario");
        usuario = Arrayusuario[0];
        montador = usuario.cod;

        // Update the user information in the new UI elements
        const nombreUsuarioDesktop = document.getElementById(
          "nombreUsuarioDesktop"
        );
        const nombreUsuarioMobile = document.getElementById(
          "nombreUsuarioMobile"
        );
        const imagenUsuarioDesktop = document.getElementById(
          "imagenUsuarioDesktop"
        );
        const imagenUsuarioMobile = document.getElementById(
          "imagenUsuarioMobile"
        );

        if (nombreUsuarioDesktop)
          nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile)
          nombreUsuarioMobile.textContent = usuario.nombre;

        if (usuario.imagen !== "0") {
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }

        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));

        rutas.sort((a, b) => a.nombre.localeCompare(b.nombre));

        const fragmento = document.createDocumentFragment();
        const rutasContainer = document.getElementById("rutas");

        rutas.forEach((objeto) => {
          const button = document.createElement("button");
          button.className =
            "relative w-full h-16 sm:h-20 md:h-24 lg:h-28 flex items-center justify-center rounded-2xl text-white font-semibold text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg active:scale-100";
          button.type = "button";
          button.id = objeto.cod;

          // Background SVG (Full Cover)
          button.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
          button.style.backgroundSize = "contain";
          button.style.backgroundPosition = "center";

          // Text Overlay
          const textSpan = document.createElement("span");
          textSpan.className = "relative z-10";
          textSpan.textContent = objeto.nombre;

          button.appendChild(textSpan);

          button.addEventListener("click", () => {
            localStorage.setItem("ruta", button.id);
            localStorage.setItem("nombreRuta", objeto.nombre);
            window.location.href = "https://dosxdos.app.iidos.com/ruta_montador.html";
          });

          fragmento.appendChild(button);
        });

        rutasContainer.innerHTML = "";
        rutasContainer.appendChild(fragmento);

        initializeSearch();
        initializeApplication();
        notificar();
        loaderOff();
      }
    } catch (error) {
      mensaje = "ERROR: " + error.message;
      alerta(mensaje);
      loaderOff();
    }
  }

  /* EVENTOS CLIC */

  document.addEventListener("click", (e) => {
    if (e.target.matches("#cerrarSesion")) {
      cerrarSesion();
    }
  });

  /* BUSCADOR */

  buscador.addEventListener("input", () => {
    botones = document.querySelectorAll("#rutas button");
    const valorBusqueda = buscador.value.toLowerCase();
    botones.forEach((boton) => {
      const textoBoton = boton.textContent.toLowerCase();
      const span = boton.querySelector("span"); // Obtener el elemento <span> dentro del botón
      if (textoBoton.includes(valorBusqueda)) {
        boton.classList.replace("displayOff", "displayOn");
        // Crear una expresión regular para buscar la coincidencia exacta
        const regex = new RegExp(valorBusqueda, "gi");
        const textoResaltado = boton.textContent.replace(
          regex,
          '<span class="resaltado">$&</span>'
        );
        span.innerHTML = textoResaltado;
      } else {
        boton.classList.replace("displayOn", "displayOff");
        // Restablecer el texto original sin resaltado
        span.textContent = span.textContent;
      }
    });
  });

  // SEARCH FUNCTIONALITY
  function initializeSearch() {
    console.log("Initializing search...");
    const buscador = document.getElementById("buscador");
    if (buscador) {
      buscador.addEventListener("input", () => {
        const searchTerm = buscador.value.toLowerCase().trim();
        const buttons = document.querySelectorAll("#rutas button");

        console.log(
          `Searching for: "${searchTerm}" among ${buttons.length} routes`
        );

        buttons.forEach((button) => {
          const textContent = button.textContent.toLowerCase();
          const span = button.querySelector("span");

          if (textContent.includes(searchTerm)) {
            button.classList.remove("displayOff");
            button.classList.add("displayOn");

            // Highlight matching text
            if (searchTerm && span) {
              const regex = new RegExp(`(${searchTerm})`, "gi");
              span.innerHTML = span.textContent.replace(
                regex,
                '<span class="resaltado">$1</span>'
              );
            }
          } else {
            button.classList.remove("displayOn");
            button.classList.add("displayOff");
          }
        });
      });
    } else {
      console.warn("Could not find search input element");
    }
  }

  /* PETICIONES PENDIENTES */

  function actualizarLinea(json) {
    console.log(json);
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/lineas.php", {
        method: "PUT",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) =>
          res.ok
            ? res.json()
            : reject(
              new Error(
                `Error en los servidores al actualizar los datos de la línea`
              )
            )
        )
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFotos(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/fotos.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las fotos. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFirmas(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/firmas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las firmas. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirNota(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/notas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar la nota. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  async function enviarPeticiones(vectorObjDb, tipoVector) {
    return new Promise(async (resolve, reject) => {
      try {
        let solicitud,
          mensaje = "",
          vaciarStore;
        for (const objeto of vectorObjDb) {
          jsonObjeto = JSON.stringify(objeto);
          if (tipoVector == "lineas") {
            solicitud = await actualizarLinea(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error en el envío de la petición pendiente de la actualización de datos en la api de Navision en la ruta: ${objeto.CodigoRuta} y la línea de ruta: ${objeto.LineaRuta}-`;
            }
          } else if (tipoVector == "fotos") {
            solicitud = await subirFotos(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las fotos pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "firmas") {
            solicitud = await subirFirmas(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las firmas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "notas") {
            solicitud = await subirNota(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las notas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.linea}-`;
            }
          }
        }
        if (tipoVector == "lineas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesLineas");
          mensaje += "-Datos pendientes enviados al servidor-";
        } else if (tipoVector == "fotos") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFotos");
          mensaje += "-Fotos pendientes subidas al servidor-";
        } else if (tipoVector == "firmas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFirmas");
          mensaje += "-Firmas pendientes subidas al servidor-";
        } else if (tipoVector == "notas") {
          vaciarStore = await limpiarDatos2("dosxdos", "notas");
          mensaje += "-Notas pendientes subidas al servidor-";
        }
        resolve(mensaje);
      } catch (err) {
        console.error(err);
        alerta(err.message);
        scrollToTop();
        reject(err);
      }
    });
  }

  async function procesarPeticiones() {
    try {
      loaderOn();
      mensaje = "";
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas";
        }
      }
      if (!mensaje) {
        mensaje = "No hay datos pendientes para ser enviados al servidor";
      }
      const sincronizarBaseDatos = await sincronizarDb2();
      if (sincronizarBaseDatos) {
        mensaje += "Se ha sincronizado la base de datos exitosamente";
      } else {
        mensaje += "Error: No ha sido posible sincronizar la base de datos";
      }
      localStorage.setItem("mensaje", mensaje);
      location.reload();
      /*alerta(mensaje);
        scrollToTop();*/
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  async function procesarPeticiones2(mensaje) {
    try {
      if (mensaje == null) {
        mensaje = "";
      }
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
        }
      }
      if (mensaje) {
        alerta(mensaje);
        scrollToTop();
      }
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  /* TAREAS EN LA INTERMITENCIA DE LA CONEXIÓN */

  window.addEventListener("online", () => {
    console.log("La conexión a Internet se ha recuperado.");
    //cache();
    procesarPeticiones();
  });

  window.addEventListener("offline", () => {
    console.log("La conexión a Internet se ha perdido.");
  });

  /* PAGESHOW */
  window.addEventListener("pageshow", (e) => {
    console.log("Carga completa de los elementos de la página no fetch");
    let mensaje = localStorage.getItem("mensaje");
    if (mensaje && mensaje !== null) {
      alerta(mensaje);
      localStorage.removeItem("mensaje");
    }
    let login = localStorage.getItem("login");
    if (!login || login === null) {
      window.location.href = "https://dosxdos.app.iidos.com/index.html";
    }
  });

  /* TAREAS AL INICIAR LA PANTALLA CON EL ESTADO DE LA CONEXIÓN */
  if (navigator.onLine) {
    console.log("La aplicación está en línea.");
    //cache();
    appOnline();
  } else {
    console.log("La aplicación está fuera de línea.");
    appOffline();
  }

  // MENU AND USER INTERACTION SETUP
  function setupMenuInteractions() {
    console.log("Setting up menu interactions...");

    // Desktop Menu
    const userMenuButton = document.getElementById("userMenuButton");
    const userDropdownMenu = document.getElementById("userDropdownMenu");

    if (userMenuButton && userDropdownMenu) {
      console.log("Setting up desktop menu button listener");
      userMenuButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        userDropdownMenu.classList.toggle("hidden");
        const isExpanded = !userDropdownMenu.classList.contains("hidden");
        userMenuButton.setAttribute("aria-expanded", isExpanded.toString());
      });
    } else {
      console.warn(
        "Could not find userMenuButton or userDropdownMenu elements"
      );
    }

    // Mobile Menu Links
    const mobileMenuLinks = document.querySelectorAll("#mobileMenu nav a");
    mobileMenuLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.stopPropagation();
        window.location.href = link.href;
        const menuButton = document.getElementById("menuButton");
        if (menuButton) menuButton.click(); // Close menu after clicking
      });
    });

    // Mobile Menu Toggle
    const menuButton = document.getElementById("menuButton");
    const mobileMenu = document.getElementById("mobileMenu");
    const hamburgerTop = document.getElementById("hamburgerTop");
    const hamburgerMiddle = document.getElementById("hamburgerMiddle");
    const hamburgerBottom = document.getElementById("hamburgerBottom");

    if (menuButton && mobileMenu) {
      console.log("Setting up mobile menu button listener");
      menuButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = !mobileMenu.classList.contains("translate-x-full");
        mobileMenu.classList.toggle("translate-x-full");
        $body.classList.toggle("overflow-hidden");

        if (!isOpen) {
          // Menu is opening
          hamburgerTop.classList.remove("bg-gray-900");
          hamburgerMiddle.classList.remove("bg-gray-900");
          hamburgerBottom.classList.remove("bg-gray-900");
          hamburgerTop.classList.add("bg-white");
          hamburgerMiddle.classList.add("bg-white");
          hamburgerBottom.classList.add("bg-white");

          hamburgerTop.style.transform = "rotate(45deg) translate(10px, 7px)";
          hamburgerMiddle.style.opacity = "0";
          hamburgerBottom.style.transform =
            "rotate(-45deg) translate(10px, -7px)";
        } else {
          // Menu is closing
          hamburgerTop.classList.remove("bg-white");
          hamburgerMiddle.classList.remove("bg-white");
          hamburgerBottom.classList.remove("bg-white");
          hamburgerTop.classList.add("bg-gray-900");
          hamburgerMiddle.classList.add("bg-gray-900");
          hamburgerBottom.classList.add("bg-gray-900");

          hamburgerTop.style.transform = "";
          hamburgerMiddle.style.opacity = "1";
          hamburgerBottom.style.transform = "";
        }
      });
    } else {
      console.warn("Could not find menuButton or mobileMenu elements");
    }
  }

  // USER EDIT AND LOGOUT SETUP
  function setupUserActions() {
    // Edit User Buttons
    const editarUsuarioDesktop = document.getElementById(
      "editarUsuarioDesktop"
    );
    const editarUsuarioMobile = document.getElementById(
      "editarUsuarioMobile"
    );

    [editarUsuarioDesktop, editarUsuarioMobile].forEach((button) => {
      if (button) {
        button.addEventListener("click", (e) => {
          if (navigator.onLine) {
            window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?modulo=editarUsuario&id=${usuario.id}`;
          } else {
            alerta(
              "No es posible acceder a las opciones de edición de usuario sin conexión a internet"
            );
            scrollToTop();
          }
        });
      }
    });

    // Logout Buttons
    const cerrarSesionDesktop = document.getElementById(
      "cerrarSesionDesktop"
    );
    const cerrarSesionMobile = document.getElementById("cerrarSesionMobile");

    [cerrarSesionDesktop, cerrarSesionMobile].forEach((button) => {
      if (button) {
        button.addEventListener("click", () => {
          closeSidebar(); // Close the sidebar first
          cerrarSesion(); // Then proceed with logout
        });
      }
    });
  }

  // GLOBAL MENU CLOSING LOGIC
  function setupGlobalMenuClosing() {
    // Close menus when clicking outside
    document.addEventListener("click", (e) => {
      const userMenuButton = document.getElementById("userMenuButton");
      const userDropdownMenu = document.getElementById("userDropdownMenu");
      const menuButton = document.getElementById("menuButton");
      const mobileMenu = document.getElementById("mobileMenu");

      // Close desktop dropdown if clicking outside
      if (
        userMenuButton &&
        userDropdownMenu &&
        !userMenuButton.contains(e.target) &&
        !userDropdownMenu.contains(e.target)
      ) {
        userDropdownMenu.classList.add("hidden");
        userMenuButton.setAttribute("aria-expanded", "false");
      }

      // Close mobile menu if clicking outside
      if (
        mobileMenu &&
        menuButton &&
        !mobileMenu.contains(e.target) &&
        !menuButton.contains(e.target) &&
        !mobileMenu.classList.contains("translate-x-full")
      ) {
        menuButton.click();
      }
    });

    // Handle escape key
    document.addEventListener("keydown", (e) => {
      const userMenuButton = document.getElementById("userMenuButton");
      const userDropdownMenu = document.getElementById("userDropdownMenu");
      const menuButton = document.getElementById("menuButton");
      const mobileMenu = document.getElementById("mobileMenu");

      if (e.key === "Escape") {
        // Close desktop dropdown
        if (
          userDropdownMenu &&
          !userDropdownMenu.classList.contains("hidden")
        ) {
          userDropdownMenu.classList.add("hidden");
          userMenuButton?.setAttribute("aria-expanded", "false");
        }

        // Close mobile menu
        if (
          mobileMenu &&
          !mobileMenu.classList.contains("translate-x-full")
        ) {
          menuButton.click();
        }
      }
    });
  }

  function closeSidebar() {
    const mobileMenu = document.getElementById("mobileMenu");
    const hamburgerTop = document.getElementById("hamburgerTop");
    const hamburgerMiddle = document.getElementById("hamburgerMiddle");
    const hamburgerBottom = document.getElementById("hamburgerBottom");

    if (mobileMenu) {
      mobileMenu.classList.add("translate-x-full");

      // Reset hamburger icon colors and position
      if (hamburgerTop && hamburgerMiddle && hamburgerBottom) {
        // Remove white background
        hamburgerTop.classList.remove("bg-white");
        hamburgerMiddle.classList.remove("bg-white");
        hamburgerBottom.classList.remove("bg-white");

        // Add dark background
        hamburgerTop.classList.add("bg-gray-900");
        hamburgerMiddle.classList.add("bg-gray-900");
        hamburgerBottom.classList.add("bg-gray-900");

        // Reset transforms
        hamburgerTop.style.transform = "";
        hamburgerMiddle.style.opacity = "1";
        hamburgerBottom.style.transform = "";
      }
    }
  }

  // INITIALIZATION FUNCTION
  function initializeApplication() {
    // Set up menu interactions
    setupMenuInteractions();
    setupUserActions();
    setupGlobalMenuClosing();

    // Populate user information if available
    if (usuario && usuario.nombre) {
      const nombreUsuarioDesktop = document.getElementById(
        "nombreUsuarioDesktop"
      );
      const nombreUsuarioMobile = document.getElementById(
        "nombreUsuarioMobile"
      );
      const imagenUsuarioDesktop = document.getElementById(
        "imagenUsuarioDesktop"
      );
      const imagenUsuarioMobile = document.getElementById(
        "imagenUsuarioMobile"
      );

      // Update usernames
      if (nombreUsuarioDesktop)
        nombreUsuarioDesktop.textContent = usuario.nombre;
      if (nombreUsuarioMobile)
        nombreUsuarioMobile.textContent = usuario.nombre;

      // Update profile images
      if (usuario.imagen !== "0") {
        if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
        if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
      }
    }
  }

  // Call initialization when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM fully loaded");
    initializeSearch();
  });
</script>

<script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
<script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>

</html>