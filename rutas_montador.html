<!DOCTYPE html>

<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RUTAS</title>
  <!-- Favicons -->
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logoPwa256.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <style>
     * {
      -webkit-tap-highlight-color: transparent;
    }

    /* Add the divider styles from notificaciones */
    .website-divider-container-734167 {
      overflow: hidden;
      position: relative;
      height: 100%;
    }

    .divider-img-734167 {
      position: absolute;
      width: 500%;
      height: 105px;
      transform: scale(1, 1);
      bottom: 0px;
      left: 0px;
      fill: rgb(255, 255, 255);
    }

    /* Keep the important existing styles */
    .displayOff {
      display: none;
    }

    .displayOn {
      display: flex;
    }

    /* Loader styles */
    #loader {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      z-index: 2000;
      background-color: rgba(0, 0, 0, 0.886);
      justify-content: center;
      align-items: center;
    }

    .loader {
      transform: rotateZ(45deg);
      perspective: 1000px;
      border-radius: 50%;
      width: 14vw;
      height: 14vw;
      color: #fff;
    }

    .loader:before,
    .loader:after {
      content: "";
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: inherit;
      height: inherit;
      border-radius: 50%;
      transform: rotateX(70deg);
      animation: 1s spin linear infinite;
    }

    .loader:after {
      color: #b20b15;
      transform: rotateY(70deg);
      animation-delay: 0.4s;
    }

    @keyframes spin {

      0%,
      100% {
        box-shadow: 0.2em 0px 0 0px currentcolor;
      }

      12% {
        box-shadow: 0.2em 0.2em 0 0 currentcolor;
      }

      25% {
        box-shadow: 0 0.2em 0 0px currentcolor;
      }

      37% {
        box-shadow: -0.2em 0.2em 0 0 currentcolor;
      }

      50% {
        box-shadow: -0.2em 0 0 0 currentcolor;
      }

      62% {
        box-shadow: -0.2em -0.2em 0 0 currentcolor;
      }

      75% {
        box-shadow: 0px -0.2em 0 0 currentcolor;
      }

      87% {
        box-shadow: 0.2em -0.2em 0 0 currentcolor;
      }
    }

    .bell-animate {
      animation: bell-shake 2s ease-in-out infinite;
      transform-origin: top center;
    }

    @keyframes bell-shake {
      0% {
        transform: rotate(0);
      }

      10% {
        transform: rotate(10deg);
      }

      20% {
        transform: rotate(-10deg);
      }

      30% {
        transform: rotate(10deg);
      }

      40% {
        transform: rotate(-10deg);
      }

      50% {
        transform: rotate(0);
      }

      100% {
        transform: rotate(0);
      }
    }
  </style>
</head>

<body id="body" class="oyh">
  <div id="loader" class="displayOn">
    <span class="loader"></span>
  </div>

  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden md:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 md:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center space-x-8">

        <a href="https://dosxdos.app.iidos.com/ruta_montador.html"
          class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
            <path d="M9 12h6" />
            <path d="M9 16h6" />
          </svg>
          <span>Líneas</span>
        </a>

        <!-- History Link -->
        <a href="https://dosxdos.app.iidos.com/historial_montador.html"
          class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200">
          <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
          <span>Historial</span>
        </a>

        <!-- Desktop Menu Notifications Bell -->
        <div class="relative">
          <div id="notificaciones"
            class="displayOff absolute -top-2 -right-2 min-w-[24px] h-5 bg-red-600 rounded-full flex items-center justify-center z-10">
            <span id="numNtf" class="text-white text-xs px-1">0</span>
          </div>
          <div id="sinNotificaciones" class="displayOff"></div>

          <a href="https://dosxdos.app.iidos.com/notificaciones.html"
            class="relative flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200"
            id="desktopBellContainer">
            <img id="bell" src="https://dosxdos.app.iidos.com/img/bell2.png" class="w-8 h-8 object-contain" />
          </a>
        </div>

        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="md:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->

        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10 p-2 mt-2"
          id="mobileBellContainer">
          <img id="bellMobile" src="https://dosxdos.app.iidos.com/img/bell2.png"
            class="w-8 h-8 text-gray-900 object-contain" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-0 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center">0</span>
        </a>

        <!-- Hamburger Button -->
        <button id="menuButton" class="md:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

      <div id="mobileMenu"
        class="md:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
        <div class="absolute inset-0 z-0" style="
            background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
            background-size: contain;
            opacity: 0.7;
          "></div>
        <!-- User Profile Section -->
        <div class="px-8 py-4 mt-20 relative z-10">
          <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
            <!-- Profile image -->
            <div
              class="absolute left-0 w-24 h-24 rounded-full overflow-hidden border-2 border-white bg-gray-100 flex items-center justify-center shadow-lg">
              <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="ml-28 flex items-center py-4">
              <!-- User name -->
              <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
              <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
              <span class="text-black font-medium text-xl">!</span>
            </div>
          </div>
        </div>

        <!-- Navigation Links -->
        <nav class="px-8 py-6 space-y-2 relative z-10 flex-1 overflow-y-auto">
          <a href="https://dosxdos.app.iidos.com/notificaciones.html"
          class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
          <div
            class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
            <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8a6 6 0 0 0-12 0v5a6 6 0 0 1-2 4h16a6 6 0 0 1-2-4V8"></path>
              <line x1="12" y1="22" x2="12" y2="22"></line> <!-- Small bell clapper -->
            </svg>
          </div>
          <span class="text-lg font-semibold tracking-wide">Notificaciones</span>
        </a>
        
         
          <a href="https://dosxdos.app.iidos.com/ruta_montador.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                <path d="M9 12h6" />
                <path d="M9 16h6" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Líneas</span>
          </a>

          <a href="https://dosxdos.app.iidos.com/historial_montador.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Historial</span>
          </a>
        </nav>

        <div class="relative z-10">
          <div id="divider_id" class="website-divider-container-734167" style="height: 100px; overflow: visible">
            <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
              preserveAspectRatio="none" style="bottom: -20px">
              <path
                d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
                style="fill: #ffffff"></path>
              <path
                d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
                style="fill: #ffffff; opacity: 0.5"></path>
              <path
                d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
                style="fill: #ffffff; opacity: 0.25"></path>
            </svg>
          </div>
        </div>

        <!-- User Actions -->
        <div class="relative z-10 mt-auto px-8 pb-6 bg-white bg-opacity-05 shadow flex flex-col space-y-2">
          <button id="editarUsuarioMobile"
            class="z-30 flex items-center w-full px-6 py-2 text-white bg-red-600 shadow-xl backdrop-blur-lg rounded-xl transition-all duration-300 group">
            <div
              class="flex items-center justify-center w-12 h-10 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-6 h-6 shadow-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
            </div>
            <span class="text-lg font-medium">Editar usuario</span>
          </button>

          <button id="cerrarSesionMobile"
            class="z-30 flex items-center w-full px-6 py-2 bg-red-600 shadow-xl backdrop-blur-lg text-white rounded-xl transition-all duration-300 group mb-3">
            <div
              class="flex items-center justify-center w-12 h-10 bg-white/20 rounded-lg mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
            </div>
            <span class="text-lg font-medium">Cerrar sesión</span>
          </button>
        </div>
      </div>
  </section>

  <div class="pt-16 w-full">
    <div id="cabeceraContenido" class="flex flex-col bg-gray-100 shadow">
      <!-- Search Section -->
      <div class="relative flex items-center w-full px-12 mt-20 mb-6">
        <img src="https://dosxdos.app.iidos.com/img/lupa.png"
          class="w-5 h-5 opacity-90 absolute left-16 top-1/2 transform -translate-y-1/2" />
        <input type="text" id="buscador"
          class="shadow w-full h-12 pl-12 pr-4 bg-white/10 border border-white/20 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300 ease-in-out text-black placeholder-white/70"
          placeholder="Buscar rutas..." />
      </div>
      <h1 id="titulo" class="text-2xl font-bold text-center mb-4">RUTAS</h1>
    </div>
  </div>

  <section class="flex flex-col min-h-screen">
    <div class="flex-grow p-6 bg-gray-100">
      <div id="rutas" class="h-full w-full mx-auto grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>
  </section>
  

</body>

<script>
  function cache() {
    const urlsToCache = [
      "https://dosxdos.app.iidos.com/index.html?utm_source=web_app_manifest",
      "https://dosxdos.app.iidos.com/index.html",
      "https://dosxdos.app.iidos.com/manifest.json",
      "https://dosxdos.app.iidos.com/serviceworker.js",
      "https://dosxdos.app.iidos.com/sw.js",
      "https://dosxdos.app.iidos.com/css/index.css",
      "https://dosxdos.app.iidos.com/rutas_montador.html",
      "https://dosxdos.app.iidos.com/css/rutas_montador.css",
      "https://dosxdos.app.iidos.com/ruta_montador.html",
      "https://dosxdos.app.iidos.com/css/ruta_montador.css",
      "https://dosxdos.app.iidos.com/linea_montador.html",
      "https://dosxdos.app.iidos.com/css/linea_montador.css",
      "https://dosxdos.app.iidos.com/fotos_y_firmas.html",
      "https://dosxdos.app.iidos.com/css/fotos_y_firmas.css",
      "https://dosxdos.app.iidos.com/css/fuentes/Roboto/Roboto-Light.ttf",
      "https://dosxdos.app.iidos.com/css/fuentes/Merriweather/Merriweather-Light.ttf",
      "https://dosxdos.app.iidos.com/css/fuentes/Merriweather/Merriweather-Bold.ttf",
      "https://dosxdos.app.iidos.com/css/fuentes/Lora/Lora-Regular.ttf",
      "https://dosxdos.app.iidos.com/css/fuentes/Lora/Lora-Medium.ttf",
      "https://dosxdos.app.iidos.com/css/fuentes/Lora/Lora-Bold.ttf",
      "https://dosxdos.app.iidos.com/img/candado.png",
      "https://dosxdos.app.iidos.com/img/casa.png",
      "https://dosxdos.app.iidos.com/img/casaWhite.png",
      "https://dosxdos.app.iidos.com/img/dosxdos.png",
      "https://dosxdos.app.iidos.com/img/email.png",
      "https://dosxdos.app.iidos.com/img/flechaAbajo.png",
      "https://dosxdos.app.iidos.com/img/fondo.jpg",
      "https://dosxdos.app.iidos.com/img/logoPwa1024.png",
      "https://dosxdos.app.iidos.com/img/logoPwa512.png",
      "https://dosxdos.app.iidos.com/img/logoPwa384.png",
      "https://dosxdos.app.iidos.com/img/logoPwa256.png",
      "https://dosxdos.app.iidos.com/img/logoPwa192.png",
      "https://dosxdos.app.iidos.com/img/logoPwa128.png",
      "https://dosxdos.app.iidos.com/img/logoPwa96.png",
      "https://dosxdos.app.iidos.com/img/logoPwa64.png",
      "https://dosxdos.app.iidos.com/img/logoPwa32.png",
      "https://dosxdos.app.iidos.com/img/logoPwa16.png",
      "https://dosxdos.app.iidos.com/img/logo300.png",
      "https://dosxdos.app.iidos.com/img/lupa.png",
      "https://dosxdos.app.iidos.com/img/reloj.png",
      "https://dosxdos.app.iidos.com/img/relojWhite.png",
      "https://dosxdos.app.iidos.com/img/usuario.png",
      "https://dosxdos.app.iidos.com/img/rutasWhite.png",
      "https://dosxdos.app.iidos.com/img/cerrar.png",
      "https://dosxdos.app.iidos.com/img/usuarios.png",
      "https://dosxdos.app.iidos.com/img/trash.png",
      "https://dosxdos.app.iidos.com/img/folder.png",
      "https://dosxdos.app.iidos.com/img/comprimido.png",
      "https://dosxdos.app.iidos.com/img/task.png",
      "https://dosxdos.app.iidos.com/css/dosxdos.css",
    ];
    caches.open("dosxdos").then((cache) => {
      urlsToCache.forEach((resource) => {
        cache.match(resource).then((response) => {
          if (!response) {
            fetch(resource).then((response) => {
              cache.put(resource, response);
              console.log(`se cacheó ${resource}`);
            });
          }
        });
      });
    });
  }

  const $rutas = document.getElementById("rutas"),
    $loader = document.getElementById("loader"),
    $body = document.getElementById("body"),
    buscador = document.getElementById("buscador");
  let usuario,
    montador,
    rutas,
    lineas,
    notificacionesSinAcpetarNumero = 0;

  /* LOADER */

  function scrollToTop() {
    // Para navegadores modernos
    document.documentElement.scrollTop = 0;
    // Para navegadores antiguos
    document.body.scrollTop = 0;
  }

  /* LOADER */
  function loaderOn() {
    scrollToTop();
    $loader.classList.remove("displayOff");
    $loader.classList.add("displayOn");
    $body.classList.add("oyh");
  }

  function loaderOff() {
    setTimeout(() => {
      $loader.classList.remove("displayOn");
      $loader.classList.add("displayOff");
      $body.classList.remove("oyh");
    }, 1000);
  }

  function alerta(mensaje) {
    // Remove existing alert if present
    const existingAlert = document.querySelector("#customAlert");
    if (existingAlert) {
      existingAlert.remove();
    }

    // Create alert container
    const alertContainer = document.createElement("div");
    alertContainer.id = "customAlert";
    alertContainer.className =
      "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[95%] md:w-[75%] lg:w-[65%]";
    alertContainer.style.top = "-100px";

    // Create alert content
    const alertContent = document.createElement("div");
    alertContent.className = `
    relative
    bg-white
    border-2 border-red-600
    rounded-lg
    shadow-lg
    p-4 md:p-5
    flex flex-col md:flex-row md:items-center gap-3 md:gap-4
  `;

    // Create close button
    const closeButton = document.createElement("button");
    closeButton.className =
      "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600 rounded-full p-1.5 transition-colors duration-200";
    closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

    // Create main content container for mobile layout
    const contentContainer = document.createElement("div");
    contentContainer.className =
      "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

    // Create icon with exclamation mark
    const iconContainer = document.createElement("div");
    iconContainer.className = "flex-shrink-0 text-red-600";
    iconContainer.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="10" />
  <path d="M12 7v6" />
  <path d="M12 16h0.01" />
</svg>
`;

    // Create message text
    const messageText = document.createElement("p");
    messageText.className = "text-gray-900 text-base md:text-lg flex-1";
    messageText.textContent = mensaje;

    // Assemble the content container
    contentContainer.appendChild(iconContainer);
    contentContainer.appendChild(messageText);

    // Assemble the alert
    alertContent.appendChild(closeButton);
    alertContent.appendChild(contentContainer);
    alertContainer.appendChild(alertContent);
    document.body.appendChild(alertContainer);

    // Slide down animation
    requestAnimationFrame(() => {
      alertContainer.style.top = "56px";
    });

    // Add event listeners
    closeButton.addEventListener("click", () => {
      hideAlert(alertContainer);
    });

    // Hide loader if it exists
    loaderOff();
  }

  function hideAlert(alertContainer) {
    alertContainer.style.top = "-100px";

    setTimeout(() => {
      alertContainer.remove();
    }, 300);
  }

  /* LEER DATOS DE INDEXDB */

  function leerDatos(store) {
    return new Promise((resolve, reject) => {
      datos = [];
      const request = indexedDB.open("dosxdos");
      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction(store, "readonly");
        const almacen = transaction.objectStore(store);
        const cursorRequest = almacen.openCursor();
        cursorRequest.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            datos.push(cursor.value);
            cursor.continue();
          } else {
            resolve(datos);
          }
        };
        cursorRequest.onerror = function (event) {
          error = event.target.error;
          mensaje = "ERROR: " + error;
          alerta(mensaje);
          loaderOff();
        };
      };
      request.onerror = (event) => {
        error = event.target.error;
        mensaje = "ERROR: " + error;
        alerta(mensaje);
        loaderOff();
      };
    });
  }

  function leerDatos2(database, store) {
    return new Promise((resolve, reject) => {
      datos = [];
      const request = indexedDB.open(database);
      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction(store, "readonly");
        const almacen = transaction.objectStore(store);
        const cursorRequest = almacen.openCursor();
        cursorRequest.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            datos.push(cursor.value);
            cursor.continue();
          } else {
            resolve(datos);
          }
        };
        cursorRequest.onerror = function (event) {
          console.error(
            `Error en la función leerDatos al solcitar el cursor para leer el almacen ${store}: ${event.target.error}`
          );
          reject(event.target.error);
        };
      };
      request.onerror = (event) => {
        console.error(
          `Error en la función leerDatos al solcitar abrir la base de datos para leer el almacen ${store}: ${event.target.error}`
        );
        reject(event.target.error);
      };
    });
  }

  /* LIMPIAR ALMACÉN DE INDEXDB */

  function limpiarDatos(store) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("dosxdos");
      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction(store, "readwrite");
        const datosStore = transaction.objectStore(store);
        const clearRequest = datosStore.clear();
        clearRequest.onsuccess = (clearEvent) => {
          resolve(true);
        };
        clearRequest.onerror = (event) => {
          error = event.target.error;
          mensaje = `Error al limpiar el almacén ${store}: ` + error;
          alerta(mensaje);
          loaderOff();
        };
      };
      request.onerror = (event) => {
        error = event.target.error;
        mensaje =
          `Error al abrir la base de datos para limpiar el almacén ${store}` +
          error;
        alerta(mensaje);
        loaderOff();
      };
    });
  }

  function limpiarDatos2(database, store) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(database);
      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction(store, "readwrite");
        const datosStore = transaction.objectStore(store);
        const clearRequest = datosStore.clear();
        clearRequest.onsuccess = (clearEvent) => {
          resolve(true);
        };
        clearRequest.onerror = (event) => {
          console.error(
            `Error en la función limpiarDatos al solcitar limpiar el almacen ${store}: ${event.target.error}`
          );
          reject(event.target.error);
        };
      };
      request.onerror = (event) => {
        console.error(
          `Error en la función limpiarDatos al solcitar abrir la base de datos para limpiar el almacen ${store}: ${event.target.error}`
        );
        reject(event.target.error);
      };
    });
  }

  function limpiarAlmacen(database, store) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(database);
      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction(store, "readwrite");
        const datosStore = transaction.objectStore(store);
        const clearRequest = datosStore.clear();
        clearRequest.onsuccess = (clearEvent) => {
          resolve(true);
        };
        clearRequest.onerror = (event) => {
          console.error(
            `Error en la función limpiarDatos al solcitar limpiar el almacen ${store}: ${event.target.error}`
          );
          reject(event.target.error);
        };
      };
      request.onerror = (event) => {
        console.error(
          `Error en la función limpiarDatos al solcitar abrir la base de datos para limpiar el almacen ${store}: ${event.target.error}`
        );
        reject(event.target.error);
      };
    });
  }

  function almacenVacio(db, almacen) {
    return new Promise((resolve, reject) => {
      const dbName = db;
      const storeName = almacen;
      const request = indexedDB.open(dbName);
      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const getAllRequest = store.getAll();
        getAllRequest.onsuccess = (event) => {
          const data = event.target.result;
          if (data.length > 0) {
            resolve(false);
          } else {
            resolve(true);
          }
        };
        getAllRequest.onerror = (event) => {
          console.error(
            `Error en la función almacenVacio al verificar si el almacen ${almacen} tiene contenido: ${event.target.error}`
          );
          reject(event.target.error);
        };
      };
      request.onerror = (event) => {
        console.error(
          `Error en la función almacenVacio al abrir la base de datos ${db} para verificar si el almacen ${almacen} tiene contenido: ${event.target.error}`
        );
        reject(event.target.error);
      };
    });
  }

  /* CERRAR SESIÓN */

  function eliminarCookie(nombre) {
    const tiempoExpiracion = 1; // Segundo 1 de la Época Unix
    document.cookie = `${nombre}=; expires=${new Date(
      tiempoExpiracion * 1000
    ).toUTCString()}; path=/;`;
  }

  //ESTA FUNCION ELIMINA POR COMPLETO DEL LADO DEL CLIENTE LA BASE DE DATOS CADA VEZ QUE SE EJEUTA
  function deleteDB2(database) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.deleteDatabase(database);

      // Evento que se dispara cuando la base de datos se elimina correctamente
      request.onsuccess = () => {
        console.log(`Base de datos "${database}" eliminada exitosamente.`);
        resolve(true);
      };

      // Evento que se dispara si ocurre un error al eliminar la base de datos
      request.onerror = (event) => {
        console.error(
          `Error al eliminar la base de datos "${database}":`,
          event.target.error
        );
        reject(event.target.error);
      };
    });
  }

  async function cerrarSesion() {
    if (navigator.onLine) {
      try {
        loaderOn();
        const eliminarBaseDeDatosCliente = await deleteDB2("dosxdos");
        if (eliminarBaseDeDatosCliente) {
          const eliminarTokenDeLasNotificaciones =
            eliminarTokenNotificaciones();
          if (eliminarTokenDeLasNotificaciones) {
            localStorage.clear();
            eliminarCookie("login");
            eliminarCookie("usuario");
            window.location.href = "https://dosxdos.app.iidos.com/index.html";
          }
        }
      } catch (error) {
        mensaje = "ERROR: " + error.message;
        console.error(error);
        alerta(mensaje);
      }
    } else {
      mensaje = "No es posible cerrar la sesión sin conexión a internet";
      alerta(mensaje);
      mensajeOn();
    }
  }

  /* TRAER DATOS DE LOS SERVIDORES */

  function fetchRutas() {
    return new Promise((resolve, reject) => {
      url =
        "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" + montador;
      fetch(url)
        .then((res) => {
          if (res.ok) {
            return res.json();
          } else {
            mensaje =
              "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
            alerta(mensaje);
            loaderOff();
          }
        })
        .then((res) => {
          if (res[0]) {
            const request = indexedDB.open("dosxdos");
            request.onsuccess = (event) => {
              const db = event.target.result;
              const transaction = db.transaction("rutas", "readwrite");
              const datosStore = transaction.objectStore("rutas");
              const clearRequest = datosStore.clear();
              clearRequest.onsuccess = (clearEvent) => {
                const datos = res[1];
                datos.forEach((item) => {
                  datosStore.add(item);
                });
                resolve(true);
              };
              clearRequest.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                alerta(mensaje);
                loaderOff();
              };
            };
            request.onerror = (event) => {
              error = event.target.error;
              mensaje = `ERROR: ` + error;
              alerta(mensaje);
              loaderOff();
            };
          } else {
            mensaje = res[1];
            alerta(mensaje);
            loaderOff();
          }
        })
        .catch((res) => {
          mensaje = "Error al consultar las rutas: " + res.message;
          alerta(mensaje);
          loaderOff();
        });
    });
  }

  function fetchLineas(vectorRutas) {
    return new Promise(async (resolve, reject) => {
      try {
        const promises = vectorRutas.map(async (objeto) => {
          const url =
            "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
            objeto.cod;
          const res = await fetch(url);

          if (!res.ok) {
            throw new Error(
              `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
            );
          }

          const resJson = await res.json();

          if (resJson[0]) {
            const db = await new Promise((dbResolve, dbReject) => {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                dbResolve(db);
              };
              request.onerror = (event) => {
                dbReject(
                  new Error(
                    `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                  )
                );
              };
            });

            const transaction = db.transaction("lineas", "readwrite");
            const datosStore = transaction.objectStore("lineas");
            const datos = resJson[1];
            if (Array.isArray(datos)) {
              datos.forEach((item) => {
                datosStore.add(item);
              });
            } else {
              datosStore.add(datos);
            }
          } else {
            throw new Error(
              `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
            );
          }
        });

        await Promise.all(promises);
        resolve(true);
      } catch (err) {
        console.error(err);
        reject(err);
      }
    });
  }

  /* SINCRONIZAR BASE DE DATOS */

  async function sincronizarDb() {
    try {
      loaderOn();
      const fRutas = await fetchRutas();
      rutas = await leerDatos("rutas");
      rutas = rutas.map((objeto) => ({
        cod: objeto["No."],
        nombre: objeto["Descripcion"],
      }));
      const limpiarLineas = await limpiarAlmacen("dosxdos", "lineas");
      if (limpiarLineas) {
        lineas = await fetchLineas(rutas);
        if (lineas) {
          const mensaje = "Se ha sincronizado la base de datos exitosamente";
          localStorage.setItem("mensaje", mensaje);
          window.location.href =
            "https://dosxdos.app.iidos.com/rutas_montador.html";
        } else {
          alerta(
            "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
          );
          loaderOff();
        }
      }
    } catch (error) {
      const mensaje =
        "No se ha sincronizado la base de datos: " + error.message;
      localStorage.setItem("mensaje", mensaje);
      window.location.href =
        "https://dosxdos.app.iidos.com/rutas_montador.html";
    }
  }

  async function sincronizarDb2() {
    return new Promise(async (resolve, reject) => {
      try {
        loaderOn();
        const fRutas = await fetchRutas();
        rutas = await leerDatos2("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));
        const limpiarLineas = await limpiarDatos2("dosxdos", "lineas");
        if (limpiarLineas) {
          lineas = await fetchLineas(rutas);
          if (lineas) {
            resolve(true);
          } else {
            resolve(false);
          }
        }
      } catch (error) {
        console.error(error);
        reject(false);
      }
    });
  }

  /* LOGIN */

  function vLogin() {
    return new Promise((resolve, reject) => {
      const login = localStorage.getItem("login");
      if (login && login !== null) {
        leerDatos("usuario")
          .then((res) => {
            usuario = res[0];
            resolve(usuario.clase);
          })
          .catch((err) => {
            resolve(false);
          });
      } else {
        resolve(false);
      }
    });
  }

  function startBuscador() {
    if (buscador.value) {
      botones = document.querySelectorAll("#rutas button");
      const valorBusqueda = buscador.value.toLowerCase();
      botones.forEach((boton) => {
        const textoBoton = boton.textContent.toLowerCase();
        const span = boton.querySelector("span"); // Obtener el elemento <span> dentro del botón
        if (textoBoton.includes(valorBusqueda)) {
          boton.classList.replace("displayOff", "displayOn");
          // Crear una expresión regular para buscar la coincidencia exacta
          const regex = new RegExp(valorBusqueda, "gi");
          const textoResaltado = boton.textContent.replace(
            regex,
            '<span class="resaltado">$&</span>'
          );
          span.innerHTML = textoResaltado;
        } else {
          boton.classList.replace("displayOn", "displayOff");
          // Restablecer el texto original sin resaltado
          span.textContent = span.textContent;
        }
      });
    }
  }

  /* INICIAR APP ONLINE */

  async function appOnline() {
    try {
      const login = await vLogin();
      if (!login) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      } else {
        const Arrayusuario = await leerDatos("usuario");
        usuario = Arrayusuario[0];
        let loginMontador = localStorage.getItem("loginMontador");
        if (!loginMontador || loginMontador === null) {
          window.location.href =
            "https://dosxdos.app.iidos.com/dosxdos.php?id=" +
            usuario.id +
            "&rol=" +
            usuario.clase;
        }
        montador = usuario.cod;

        // Update the user information in the new UI elements
        const nombreUsuarioDesktop = document.getElementById(
          "nombreUsuarioDesktop"
        );
        const nombreUsuarioMobile = document.getElementById(
          "nombreUsuarioMobile"
        );
        const imagenUsuarioDesktop = document.getElementById(
          "imagenUsuarioDesktop"
        );
        const imagenUsuarioMobile = document.getElementById(
          "imagenUsuarioMobile"
        );

        if (nombreUsuarioDesktop)
          nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile)
          nombreUsuarioMobile.textContent = usuario.nombre;

        if (usuario.imagen !== "0") {
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }

        const rutasResult = await fetchRutas();
        rutas = await leerDatos("rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));

        const fragmento = document.createDocumentFragment();
        const rutasContainer = document.getElementById("rutas");

        rutas.forEach((objeto) => {
          const button = document.createElement("button");
          button.className =
            "relative w-full h-16 sm:h-20 md:h-24 lg:h-28 flex items-center justify-center rounded-2xl text-white font-semibold text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg active:scale-100";
          button.type = "button";
          button.id = objeto.cod;

          // Background SVG (Full Cover)
          button.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
          button.style.backgroundSize = "contain";
          button.style.backgroundPosition = "center";

          // Text Overlay
          const textSpan = document.createElement("span");
          textSpan.className = "relative z-10";
          textSpan.textContent = objeto.nombre;

          button.appendChild(textSpan);

          button.addEventListener("click", () => {
            localStorage.setItem("ruta", button.id);
            localStorage.setItem("nombreRuta", objeto.nombre);
            window.location.href = "https://dosxdos.app.iidos.com/ruta_montador.html";
          });

          fragmento.appendChild(button);
        });

        rutasContainer.innerHTML = "";
        rutasContainer.appendChild(fragmento);


        const limpiarLineas = await limpiarAlmacen("dosxdos", "lineas");
        if (limpiarLineas) {
          lineas = await fetchLineas(rutas);
          if (lineas) {
            initializeSearch();
            initializeApplication();
            const peticionesCierre = await procesarPeticiones2();
            loaderOff();
          } else {
            alerta("Error al cargar las líneas de las rutas del servidor");
            initializeSearch();
            initializeApplication();
            await updateNotificationCount();
            const peticionesCierre = await procesarPeticiones2();
            loaderOff();
          }
          const sincronizacionDeNotificaciones =
            await sincronizarNotificaciones();
          if (sincronizacionDeNotificaciones) {
            await notificar();
            await updateNotificationCount();
          }
        }
      }
    } catch (error) {
      mensaje = "ERROR: " + error.message;
      alerta(mensaje);
      loaderOff();
    }
  }

  /* INICIAR APP OFFLINE */

  async function appOffline() {
    try {
      const login = await vLogin();
      if (!login) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      } else {
        const Arrayusuario = await leerDatos("usuario");
        usuario = Arrayusuario[0];
        montador = usuario.cod;

        // Update the user information in the new UI elements
        const nombreUsuarioDesktop = document.getElementById(
          "nombreUsuarioDesktop"
        );
        const nombreUsuarioMobile = document.getElementById(
          "nombreUsuarioMobile"
        );
        const imagenUsuarioDesktop = document.getElementById(
          "imagenUsuarioDesktop"
        );
        const imagenUsuarioMobile = document.getElementById(
          "imagenUsuarioMobile"
        );

        if (nombreUsuarioDesktop)
          nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile)
          nombreUsuarioMobile.textContent = usuario.nombre;

        if (usuario.imagen !== "0") {
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }

        rutas = await leerDatos("rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));

        const fragmento = document.createDocumentFragment();
        rutas.forEach((objeto, index) => {
          const button = document.createElement("button");
          button.className = "ruta displayOn";
          button.type = "button";
          button.id = `${objeto.cod}`;
          const texto = `${objeto.nombre}`;
          const span = document.createElement("span");
          span.textContent = texto;
          button.appendChild(span);
          button.addEventListener("click", () => {
            const rutaStorage = button.id;
            localStorage.setItem("ruta", rutaStorage);
            const nombreRutaStorage = button.textContent;
            localStorage.setItem("nombreRuta", nombreRutaStorage);
            window.location.href =
              "https://dosxdos.app.iidos.com/ruta_montador.html";
          });
          fragmento.appendChild(button);
        });

        // Clear the rutas container before adding new elements
        $rutas.innerHTML = "";
        $rutas.appendChild(fragmento);

        initializeSearch();
        initializeApplication();
        await updateNotificationCount();
        loaderOff();
      }
    } catch (error) {
      mensaje = "ERROR: " + error.message;
      alerta(mensaje);
      loaderOff();
    }
  }

  /* EVENTOS CLIC */

  document.addEventListener("click", (e) => {
    if (e.target.matches("#cerrarSesion")) {
      cerrarSesion();
    }
  });

  /* BUSCADOR */

  buscador.addEventListener("input", () => {
    botones = document.querySelectorAll("#rutas button");
    const valorBusqueda = buscador.value.toLowerCase();
    botones.forEach((boton) => {
      const textoBoton = boton.textContent.toLowerCase();
      const span = boton.querySelector("span"); // Obtener el elemento <span> dentro del botón
      if (textoBoton.includes(valorBusqueda)) {
        boton.classList.replace("displayOff", "displayOn");
        // Crear una expresión regular para buscar la coincidencia exacta
        const regex = new RegExp(valorBusqueda, "gi");
        const textoResaltado = boton.textContent.replace(
          regex,
          '<span class="resaltado">$&</span>'
        );
        span.innerHTML = textoResaltado;
      } else {
        boton.classList.replace("displayOn", "displayOff");
        // Restablecer el texto original sin resaltado
        span.textContent = span.textContent;
      }
    });
  });

  // SEARCH FUNCTIONALITY
  function initializeSearch() {
    console.log("Initializing search...");
    const buscador = document.getElementById("buscador");
    if (buscador) {
      buscador.addEventListener("input", () => {
        const searchTerm = buscador.value.toLowerCase().trim();
        const buttons = document.querySelectorAll("#rutas button");

        console.log(
          `Searching for: "${searchTerm}" among ${buttons.length} routes`
        );

        buttons.forEach((button) => {
          const textContent = button.textContent.toLowerCase();
          const span = button.querySelector("span");

          if (textContent.includes(searchTerm)) {
            button.classList.remove("displayOff");
            button.classList.add("displayOn");

            // Highlight matching text
            if (searchTerm && span) {
              const regex = new RegExp(`(${searchTerm})`, "gi");
              span.innerHTML = span.textContent.replace(
                regex,
                '<span class="resaltado">$1</span>'
              );
            }
          } else {
            button.classList.remove("displayOn");
            button.classList.add("displayOff");
          }
        });
      });
    } else {
      console.warn("Could not find search input element");
    }
  }

  /* PETICIONES PENDIENTES */

  function actualizarLinea(json) {
    console.log(json);
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/lineas.php", {
        method: "PUT",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) =>
          res.ok
            ? res.json()
            : reject(
              new Error(
                `Error en los servidores al actualizar los datos de la línea`
              )
            )
        )
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFotos(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/fotos.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las fotos. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirFirmas(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/firmas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar las firmas. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  function subirNota(json) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/notas.php", {
        method: "POST",
        headers: {
          "Content-type": "application/json; charset=utf-8",
        },
        body: json,
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en el servidor de la API intermedia al guardar la nota. Status: ${res.status}`
            );
          }
          return res.json();
        })
        .then((res) => {
          if (res[0]) {
            resolve(true);
          } else {
            resolve(false);
          }
        })
        .catch((err) => {
          console.log(err);
          reject(err);
        });
    });
  }

  async function enviarPeticiones(vectorObjDb, tipoVector) {
    return new Promise(async (resolve, reject) => {
      try {
        let solicitud,
          mensaje = "",
          vaciarStore;
        for (const objeto of vectorObjDb) {
          jsonObjeto = JSON.stringify(objeto);
          if (tipoVector == "lineas") {
            solicitud = await actualizarLinea(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error en el envío de la petición pendiente de la actualización de datos en la api de Navision en la ruta: ${objeto.CodigoRuta} y la línea de ruta: ${objeto.LineaRuta}-`;
            }
          } else if (tipoVector == "fotos") {
            solicitud = await subirFotos(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las fotos pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "firmas") {
            solicitud = await subirFirmas(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las firmas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
            }
          } else if (tipoVector == "notas") {
            solicitud = await subirNota(jsonObjeto);
            if (!solicitud) {
              mensaje += `-Error al subir las notas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.linea}-`;
            }
          }
        }
        if (tipoVector == "lineas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesLineas");
          mensaje += "-Datos pendientes enviados al servidor-";
        } else if (tipoVector == "fotos") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFotos");
          mensaje += "-Fotos pendientes subidas al servidor-";
        } else if (tipoVector == "firmas") {
          vaciarStore = await limpiarDatos2("dosxdos", "peticionesFirmas");
          mensaje += "-Firmas pendientes subidas al servidor-";
        } else if (tipoVector == "notas") {
          vaciarStore = await limpiarDatos2("dosxdos", "notas");
          mensaje += "-Notas pendientes subidas al servidor-";
        }
        resolve(mensaje);
      } catch (err) {
        console.error(err);
        alerta(err.message);
        scrollToTop();
        reject(err);
      }
    });
  }

  async function procesarPeticiones() {
    try {
      loaderOn();
      mensaje = "";
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
        }
      }
      if (!mensaje) {
        mensaje = "No hay datos pendientes para ser enviados al servidor";
      }
      const sincronizarBaseDatos = await sincronizarDb2();
      if (sincronizarBaseDatos) {
        mensaje += "-Se ha sincronizado la base de datos exitosamente-";
      } else {
        mensaje += "-Error: No ha sido posible sincronizar la base de datos-";
      }
      localStorage.setItem("mensaje", mensaje);
      location.reload();
      /*alerta(mensaje);
        scrollToTop();*/
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  async function procesarPeticiones2(mensaje) {
    try {
      if (mensaje == null) {
        mensaje = "";
      }
      const exPeticionesLineas = await almacenVacio(
        "dosxdos",
        "peticionesLineas"
      );
      if (!exPeticionesLineas) {
        const peticionesLineas = await leerDatos2(
          "dosxdos",
          "peticionesLineas"
        );
        if (peticionesLineas) {
          //console.log(peticionesLineas);
          const enviarPeticionesLineas = await enviarPeticiones(
            peticionesLineas,
            "lineas"
          );
          if (enviarPeticionesLineas) {
            mensaje += enviarPeticionesLineas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
        }
      }
      const exPeticionesFotos = await almacenVacio(
        "dosxdos",
        "peticionesFotos"
      );
      if (!exPeticionesFotos) {
        const peticionesFotos = await leerDatos2(
          "dosxdos",
          "peticionesFotos"
        );
        if (peticionesFotos) {
          //console.log(peticionesFotos);
          const enviarPeticionesFotos = await enviarPeticiones(
            peticionesFotos,
            "fotos"
          );
          if (enviarPeticionesFotos) {
            mensaje += enviarPeticionesFotos;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
        }
      }
      const exPeticionesFirmas = await almacenVacio(
        "dosxdos",
        "peticionesFirmas"
      );
      if (!exPeticionesFirmas) {
        const peticionesFirmas = await leerDatos2(
          "dosxdos",
          "peticionesFirmas"
        );
        if (peticionesFirmas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesFirmas = await enviarPeticiones(
            peticionesFirmas,
            "firmas"
          );
          if (enviarPeticionesFirmas) {
            mensaje += enviarPeticionesFirmas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
        }
      }
      const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
      if (!exPeticionesNotas) {
        const peticionesNotas = await leerDatos2("dosxdos", "notas");
        if (peticionesNotas) {
          //console.log(peticionesFirmas);
          const enviarPeticionesNotas = await enviarPeticiones(
            peticionesNotas,
            "notas"
          );
          if (enviarPeticionesNotas) {
            mensaje += enviarPeticionesNotas;
          }
        } else {
          mensaje +=
            "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
        }
      }
      if (mensaje) {
        alerta(mensaje);
        scrollToTop();
      }
    } catch (error) {
      console.error(error);
      alerta(error.message);
      scrollToTop();
    }
  }

  /* TAREAS EN LA INTERMITENCIA DE LA CONEXIÓN */

  window.addEventListener("online", () => {
    console.log("La conexión a Internet se ha recuperado.");
    //cache();
    procesarPeticiones();
  });

  window.addEventListener("offline", () => {
    console.log("La conexión a Internet se ha perdido.");
  });

  /* PAGESHOW */
  window.addEventListener("pageshow", (e) => {
    console.log("Carga completa de los elementos de la página no fetch");
    let mensaje = localStorage.getItem("mensaje");
    if (mensaje && mensaje !== null) {
      alerta(mensaje);
      localStorage.removeItem("mensaje");
    }
    let login = localStorage.getItem("login");
    if (!login || login === null) {
      window.location.href = "https://dosxdos.app.iidos.com/index.html";
    }
  });

  /* TAREAS AL INICIAR LA PANTALLA CON EL ESTADO DE LA CONEXIÓN */
  if (navigator.onLine) {
    console.log("La aplicación está en línea.");
    //cache();
    appOnline();
  } else {
    console.log("La aplicación está fuera de línea.");
    appOffline();
  }

  // MENU AND USER INTERACTION SETUP
  function setupMenuInteractions() {
    console.log("Setting up menu interactions...");

    // Desktop Menu
    const userMenuButton = document.getElementById("userMenuButton");
    const userDropdownMenu = document.getElementById("userDropdownMenu");

    if (userMenuButton && userDropdownMenu) {
      console.log("Setting up desktop menu button listener");
      userMenuButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        userDropdownMenu.classList.toggle("hidden");
        const isExpanded = !userDropdownMenu.classList.contains("hidden");
        userMenuButton.setAttribute("aria-expanded", isExpanded.toString());
      });
    } else {
      console.warn(
        "Could not find userMenuButton or userDropdownMenu elements"
      );
    }

    // Mobile Menu Links
    const mobileMenuLinks = document.querySelectorAll("#mobileMenu nav a");
    mobileMenuLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.stopPropagation();
        window.location.href = link.href;
        const menuButton = document.getElementById("menuButton");
        if (menuButton) menuButton.click(); // Close menu after clicking
      });
    });

    // Mobile Menu Toggle
    const menuButton = document.getElementById("menuButton");
    const mobileMenu = document.getElementById("mobileMenu");
    const hamburgerTop = document.getElementById("hamburgerTop");
    const hamburgerMiddle = document.getElementById("hamburgerMiddle");
    const hamburgerBottom = document.getElementById("hamburgerBottom");

    if (menuButton && mobileMenu) {
      console.log("Setting up mobile menu button listener");
      menuButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = !mobileMenu.classList.contains("translate-x-full");
        mobileMenu.classList.toggle("translate-x-full");
        document.body.classList.toggle("overflow-hidden");

        if (!isOpen) {
          // Menu is opening
          hamburgerTop.classList.remove("bg-gray-900");
          hamburgerMiddle.classList.remove("bg-gray-900");
          hamburgerBottom.classList.remove("bg-gray-900");
          hamburgerTop.classList.add("bg-white");
          hamburgerMiddle.classList.add("bg-white");
          hamburgerBottom.classList.add("bg-white");

          hamburgerTop.style.transform = "rotate(45deg) translate(10px, 7px)";
          hamburgerMiddle.style.opacity = "0";
          hamburgerBottom.style.transform =
            "rotate(-45deg) translate(10px, -7px)";
        } else {
          // Menu is closing
          hamburgerTop.classList.remove("bg-white");
          hamburgerMiddle.classList.remove("bg-white");
          hamburgerBottom.classList.remove("bg-white");
          hamburgerTop.classList.add("bg-gray-900");
          hamburgerMiddle.classList.add("bg-gray-900");
          hamburgerBottom.classList.add("bg-gray-900");

          hamburgerTop.style.transform = "";
          hamburgerMiddle.style.opacity = "1";
          hamburgerBottom.style.transform = "";
        }
      });
    } else {
      console.warn("Could not find menuButton or mobileMenu elements");
    }
  }

  // USER EDIT AND LOGOUT SETUP
  function setupUserActions() {
    // Edit User Buttons
    const editarUsuarioDesktop = document.getElementById(
      "editarUsuarioDesktop"
    );
    const editarUsuarioMobile = document.getElementById(
      "editarUsuarioMobile"
    );

    [editarUsuarioDesktop, editarUsuarioMobile].forEach((button) => {
      if (button) {
        button.addEventListener("click", (e) => {
          if (navigator.onLine) {
            window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?modulo=editarUsuario&id=${usuario.id}`;
          } else {
            alerta(
              "No es posible acceder a las opciones de edición de usuario sin conexión a internet"
            );
            scrollToTop();
          }
        });
      }
    });

    // Logout Buttons
    const cerrarSesionDesktop = document.getElementById(
      "cerrarSesionDesktop"
    );
    const cerrarSesionMobile = document.getElementById("cerrarSesionMobile");

    [cerrarSesionDesktop, cerrarSesionMobile].forEach((button) => {
      if (button) {
        button.addEventListener("click", () => {
          closeSidebar(); // Close the sidebar first
          cerrarSesion(); // Then proceed with logout
        });
      }
    });
  }

  // GLOBAL MENU CLOSING LOGIC
  function setupGlobalMenuClosing() {
    // Close menus when clicking outside
    document.addEventListener("click", (e) => {
      const userMenuButton = document.getElementById("userMenuButton");
      const userDropdownMenu = document.getElementById("userDropdownMenu");
      const menuButton = document.getElementById("menuButton");
      const mobileMenu = document.getElementById("mobileMenu");

      // Close desktop dropdown if clicking outside
      if (
        userMenuButton &&
        userDropdownMenu &&
        !userMenuButton.contains(e.target) &&
        !userDropdownMenu.contains(e.target)
      ) {
        userDropdownMenu.classList.add("hidden");
        userMenuButton.setAttribute("aria-expanded", "false");
      }

      // Close mobile menu if clicking outside
      if (
        mobileMenu &&
        menuButton &&
        !mobileMenu.contains(e.target) &&
        !menuButton.contains(e.target) &&
        !mobileMenu.classList.contains("translate-x-full")
      ) {
        menuButton.click();
      }
    });

    // Handle escape key
    document.addEventListener("keydown", (e) => {
      const userMenuButton = document.getElementById("userMenuButton");
      const userDropdownMenu = document.getElementById("userDropdownMenu");
      const menuButton = document.getElementById("menuButton");
      const mobileMenu = document.getElementById("mobileMenu");

      if (e.key === "Escape") {
        // Close desktop dropdown
        if (
          userDropdownMenu &&
          !userDropdownMenu.classList.contains("hidden")
        ) {
          userDropdownMenu.classList.add("hidden");
          userMenuButton?.setAttribute("aria-expanded", "false");
        }

        // Close mobile menu
        if (
          mobileMenu &&
          !mobileMenu.classList.contains("translate-x-full")
        ) {
          menuButton.click();
        }
      }
    });
  }

  function closeSidebar() {
    const mobileMenu = document.getElementById("mobileMenu");
    const hamburgerTop = document.getElementById("hamburgerTop");
    const hamburgerMiddle = document.getElementById("hamburgerMiddle");
    const hamburgerBottom = document.getElementById("hamburgerBottom");

    if (mobileMenu) {
      mobileMenu.classList.add("translate-x-full");

      // Reset hamburger icon colors and position
      if (hamburgerTop && hamburgerMiddle && hamburgerBottom) {
        // Remove white background
        hamburgerTop.classList.remove("bg-white");
        hamburgerMiddle.classList.remove("bg-white");
        hamburgerBottom.classList.remove("bg-white");

        // Add dark background
        hamburgerTop.classList.add("bg-gray-900");
        hamburgerMiddle.classList.add("bg-gray-900");
        hamburgerBottom.classList.add("bg-gray-900");

        // Reset transforms
        hamburgerTop.style.transform = "";
        hamburgerMiddle.style.opacity = "1";
        hamburgerBottom.style.transform = "";
      }
    }
  }

  // INITIALIZATION FUNCTION
  function initializeApplication() {
    // Set up menu interactions
    setupMenuInteractions();
    setupUserActions();
    setupGlobalMenuClosing();

    // Populate user information if available
    if (usuario && usuario.nombre) {
      const nombreUsuarioDesktop = document.getElementById(
        "nombreUsuarioDesktop"
      );
      const nombreUsuarioMobile = document.getElementById(
        "nombreUsuarioMobile"
      );
      const imagenUsuarioDesktop = document.getElementById(
        "imagenUsuarioDesktop"
      );
      const imagenUsuarioMobile = document.getElementById(
        "imagenUsuarioMobile"
      );

      // Update usernames
      if (nombreUsuarioDesktop)
        nombreUsuarioDesktop.textContent = usuario.nombre;
      if (nombreUsuarioMobile)
        nombreUsuarioMobile.textContent = usuario.nombre;

      // Update profile images
      if (usuario.imagen !== "0") {
        if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
        if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
      }
    }
  }

  async function updateNotificationCount() {
    try {
      const notificaciones = await leerDatos2("dosxdos", "notificaciones");
      const unreadCount = notificaciones
        ? notificaciones.filter((notif) => notif.visto === 0).length
        : 0;

      const desktopNotificacionesDiv =
        document.getElementById("notificaciones");
      const desktopNotificationCount = document.getElementById("numNtf");
      const desktopSinNotificacionesDiv =
        document.getElementById("sinNotificaciones");
      const desktopBellImg = document.getElementById("bell");

      const mobileNotificationCount = document.getElementById(
        "mobileNotificationCount"
      );
      const mobileBellImg = document.getElementById("bellMobile");

      // Show/hide notification elements
      if (unreadCount > 0) {
        // Desktop Notifications
        if (desktopNotificacionesDiv) {
          desktopNotificacionesDiv.classList.remove("displayOff");
          desktopNotificacionesDiv.classList.add("displayOn");
          desktopNotificationCount.textContent = unreadCount;
        }
        if (desktopSinNotificacionesDiv) {
          desktopSinNotificacionesDiv.classList.remove("displayOn");
          desktopSinNotificacionesDiv.classList.add("displayOff");
        }
        if (desktopBellImg) {
          desktopBellImg.src = "https://dosxdos.app.iidos.com/img/bell.gif";
          desktopBellImg.classList.add("bell-animate");
          desktopBellImg.classList.add("w-10", "h-10");
        }

        // Mobile Notifications
        if (mobileNotificationCount) {
          mobileNotificationCount.textContent = unreadCount;
          mobileNotificationCount.classList.remove("hidden");
        }
        if (mobileBellImg) {
          mobileBellImg.src = "https://dosxdos.app.iidos.com/img/bell.gif";
          mobileBellImg.classList.add("bell-animate");
          mobileBellImg.classList.add("w-14", "h-14");
        }
      } else {
        // Desktop Notifications
        if (desktopNotificacionesDiv) {
          desktopNotificacionesDiv.classList.remove("displayOn");
          desktopNotificacionesDiv.classList.add("displayOff");
        }
        if (desktopSinNotificacionesDiv) {
          desktopSinNotificacionesDiv.classList.remove("displayOff");
          desktopSinNotificacionesDiv.classList.add("displayOn");
        }
        if (desktopBellImg) {
          desktopBellImg.src = "https://dosxdos.app.iidos.com/img/bell2.png";
          desktopBellImg.classList.remove("bell-animate");
        }

        // Mobile Notifications
        if (mobileNotificationCount) {
          mobileNotificationCount.textContent = "0";
          mobileNotificationCount.classList.add("hidden");
        }
        if (mobileBellImg) {
          mobileBellImg.src = "https://dosxdos.app.iidos.com/img/bell2.png";
          mobileBellImg.classList.remove("bell-animate");
        }
      }

      return unreadCount;
    } catch (error) {
      console.error("Error updating notification count:", error);
      return 0;
    }
  }

  // Call initialization when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM fully loaded");
    initializeSearch();
  });
</script>

<script src="https://dosxdos.app.iidos.com/js/utils/notificaciones2.js"></script>

</html>