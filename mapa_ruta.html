<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa Rutas</title>
    <link
      rel="icon"
      type="image/png"
      href="https://dosxdos.app.iidos.com/img/logoPwa256.png"
    />
    <link
      rel="stylesheet"
      href="https://dosxdos.app.iidos.com/css/tailwindmain.css"
    />
    <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDojih1XShuEEmyRVE8FYOGvJn37blq0ng"></script>
  </head>

  <body
    id="body"
    class="bg-gray-100 overflow-hidden relative h-screen flex flex-col"
  >
    <div id="loader" class="displayOn">
      <span class="loader"></span>
    </div>

    <!-- Header -->
    <div class="w-full bg-white shadow-md fixed top-0 z-30">
      <div class="flex items-center justify-between px-6 py-4">
        <button id="volverBtn" class="text-red-600">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
        <h1 id="ruta-title" class="text-xl font-bold text-gray-800 text-center">
          MAPA DE RUTA
        </h1>
        <div class="w-8"></div>
      </div>
    </div>

    <!-- Map Container -->
    <div class="flex-1 relative">
      <div id="map" class="w-full h-full z-10"></div>
    </div>

    <!-- modal block -->
    <div
      id="modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-auto overflow-hidden"
      >
        <!-- Modal Header with improved layout -->
        <div class="relative bg-red-600 p-4 text-white">
          <div
            class="absolute inset-0 opacity-70"
            style="
              background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
              background-size: contain;
            "
          ></div>

          <!-- Title and Close Button Row -->
          <div class="relative z-10 flex justify-between items-start">
            <div>
              <h2 id="point-id" class="text-xl font-bold">11820</h2>
              <h3 id="point-name" class="text-lg font-medium mt-1">
                Perfumes.es Fariones
              </h3>
            </div>

            <button id="modal-close" class="p-1 text-white">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Info Grid -->
          <div
            class="mt-4 relative z-10 grid grid-cols-2 gap-y-2 gap-x-10 text-sm"
          >
            <div class="flex gap-2">
              <div class="text-white opacity-80 font-medium">Estado:</div>
              <div id="point-estado" class="font-medium">Pendiente</div>
            </div>

            <div class="flex gap-2">
              <div class="text-white opacity-80 font-medium">Cliente:</div>
              <div id="point-cliente" class="font-medium">
                COMERCIAL FARLABO ESPAÑA, S.L.
              </div>
            </div>

            <div class="flex gap-2">
              <div class="text-white opacity-80 font-medium">OT CRM:</div>
              <div id="point-ot-crm" class="font-medium">31280</div>
            </div>

            <div class="flex gap-2">
              <div class="text-white opacity-80 font-medium">OT Navision:</div>
              <div id="point-ot-navision" class="font-medium">24292</div>
            </div>
          </div>
        </div>

        <!-- Modal Body -->
        <div class="p-4 space-y-3">
          <div class="bg-gray-100 p-3 rounded-lg">
            <p class="text-sm text-gray-700 font-medium">Dirección</p>
            <p id="point-address" class="text-gray-900 font-medium"></p>
          </div>

          <div class="flex gap-3">
            <div class="bg-gray-100 p-3 rounded-lg flex-1">
              <p class="text-sm text-gray-700 font-medium">Latitud</p>
              <p id="point-lat" class="text-gray-900 text-sm font-medium"></p>
            </div>
            <div class="bg-gray-100 p-3 rounded-lg flex-1">
              <p class="text-sm text-gray-700 font-medium">Longitud</p>
              <p id="point-lng" class="text-gray-900 text-sm font-medium"></p>
            </div>
          </div>

          <!-- Type and Observations -->
          <div class="bg-gray-100 p-3 rounded-lg">
            <p class="text-sm text-gray-700 font-medium">Tipo</p>
            <p id="point-tipo" class="text-gray-900 font-medium"></p>
          </div>

          <div class="bg-gray-100 p-3 rounded-lg">
            <p class="text-sm text-gray-700 font-medium">Observaciones</p>
            <p id="point-observaciones" class="text-gray-900 font-medium"></p>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="p-4 bg-gray-100 flex gap-3">
          <button
            id="navigate-button"
            class="flex-1 h-12 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z"
                clip-rule="evenodd"
              />
            </svg>
            Navegar
          </button>
          <button
            id="report-button"
            class="flex-1 h-12 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-lg transition-colors flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clip-rule="evenodd"
              />
            </svg>
            Reportar
          </button>
        </div>
      </div>
    </div>

    <!-- Alert Container -->
    <div
      id="alert-container"
      class="fixed top-16 right-4 z-30 flex flex-col gap-2 max-w-md"
    ></div>

    <script src="./js/index_db.js"></script>

    <script>
      let montador;
      const ruta = localStorage.getItem("ruta");
      const nombreRuta = localStorage.getItem("nombreRuta");
      const $loader = document.getElementById("loader");
      const $body = document.getElementById("body");
      let bounds;
      let marcadores = [];

      function scrollToTop() {
        // Para navegadores modernos
        document.documentElement.scrollTop = 0;
        // Para navegadores antiguos
        document.body.scrollTop = 0;
      }

      /* LOADER */
      function loaderOn() {
        scrollToTop();
        $loader.classList.remove("displayOff");
        $loader.classList.add("displayOn");
        $body.classList.add("oyh");
      }

      function loaderOff() {
        setTimeout(() => {
          $loader.classList.remove("displayOn");
          $loader.classList.add("displayOff");
          $body.classList.remove("oyh");
        }, 1000);
      }

      // Setup route title and back button
      if (nombreRuta) {
        document.getElementById("ruta-title").innerText = nombreRuta;
      } else if (ruta) {
        document.getElementById("ruta-title").innerText = ruta;
      } else {
        document.getElementById("ruta-title").innerText = "MAPA DE RUTA";
      }

      document.getElementById("volverBtn").addEventListener("click", () => {
        window.location.href =
          "https://dosxdos.app.iidos.com/ruta_montador.html";
      });

      document.getElementById("modal-close").addEventListener("click", () => {
        document.getElementById("modal").classList.add("hidden");
      });

      let lineasRuta = [];

      const lineas = async () => {
        loaderOn();
        const Arrayusuario = await leerDatos("dosxdos", "usuario");
        usuario = Arrayusuario[0];
        montador = usuario.cod;
        sinc = await sincronizarDb2();
        sinc
          ? console.log("Base de datos sincronizada")
          : console.error("Error al sincronizar la base de datos");
        const TotalLineas = await leerDatos("dosxdos", "lineas");
        if (TotalLineas) {
          lineasRuta = TotalLineas.filter((objeto) => objeto.Proyecto === ruta);
          console.log("Lineas: ", lineasRuta);
          storageLineas = JSON.stringify(lineasRuta);
          localStorage.setItem("lineasRuta", storageLineas);
          await initMap(lineasRuta);
          sincronizador();
        }
        loaderOff();
      };

      let map;
      const modal = document.getElementById("modal");
      const pointName = document.getElementById("point-name");
      const pointAddress = document.getElementById("point-address");
      const pointLat = document.getElementById("point-lat");
      const pointLng = document.getElementById("point-lng");
      const navigateButton = document.getElementById("navigate-button");
      const reportButton = document.getElementById("report-button");
      const closeButton = document.getElementById("close-button");

      function initMap(lineasInicio) {
        bounds = new google.maps.LatLngBounds();
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 8,
          gestureHandling: "greedy",
          fullscreenControl: false,
        });
        renderPins(lineasInicio);
      }

      function renderPins(lineasRender) {
        return new Promise((resolve, reject) => {
          try {
            const offset = 0.00007;
            let i = 0;
            for (const point of lineasRender) {
              const nameToDisplay =
                point.NombrePuntoVenta ||
                "Nombre del punto de venta no disponible";
              const firma = point.Firma || "Sin firma";
              const observaciones = point.Observaciones || "Sin observaciones";
              const nombreCliente =
                point.NombreCliente || "Nombre del cliente no disponible";
              const concatenatedName = `${point.Linea} - ${nameToDisplay} - ${firma} - ${nombreCliente} - OT CRM: ${point.OT} - OT Navision: ${point.Navision_OT} - ${point.TipoOT} - ${observaciones}`;
              const lat = point.lat ? parseFloat(point.lat) : null;
              const lng = point.lng ? parseFloat(point.lng) : null;
              if (lat !== null && lng !== null) {
                const adjustedLat = lat + i * offset;
                const adjustedLng = lng + i * offset;
                const marker = new google.maps.Marker({
                  position: { lat: adjustedLat, lng: adjustedLng },
                  map: map,
                  title: concatenatedName,
                });
                bounds.extend(marker.position);
                marker.addListener("click", () => {
                  // Update modal content with this point's data
                  updateModalContent(point, adjustedLat, adjustedLng);

                  // Show the modal
                  modal.classList.remove("hidden");
                  modal.classList.add("flex");

                  // Center the map on this point
                  map.setZoom(19);
                  map.setCenter(marker.getPosition());

                  // Set up navigation button
                  navigateButton.onclick = () => {
                    if (lat !== null && lng !== null) {
                      const url = `https://www.google.com/maps/dir/?api=1&destination=${adjustedLat},${adjustedLng}`;
                      window.open(url, "_blank");
                    } else {
                      alert(
                        "Las coordenadas no están disponibles para este punto."
                      );
                    }
                  };

                  // Set up report button
                  reportButton.onclick = () => {
                    localStorage.setItem("linea", point.Linea);
                    localStorage.setItem("lineaActividad", point.Linea);
                    localStorage.setItem("ot", point.OT);
                    localStorage.setItem("cliente", point.Cliente);
                    localStorage.setItem("nombreCliente", point.NombreCliente);
                    window.location.href =
                      "https://dosxdos.app.iidos.com/linea_montador.html";
                  };
                });
                // Agregar una propiedad personalizada al marcador
                marker.customId = point.Linea; // Usa un identificador único de tu objeto `point`
                // Guarda el marcador en un array para gestionarlo más tarde si es necesario
                marcadores.push(marker);
              } else {
                console.log(
                  `Missing coordinates for point: ${JSON.stringify(point)}`
                );
                const alertMessage = `Fallo al cargar la ubicación para la línea: `;
                showAlert(alertMessage, concatenatedName);
                i++;
                continue;
              }
              i++;
            }
            map.fitBounds(bounds);
            resolve(true);
          } catch (error) {
            console.error(error);
            showAlertMessage(
              "Error al renderizar los puntos en el mapa, por favor carga de nuevo el mapa para intentarlo nuevamente"
            );
            resolve(false);
          }
        });
      }

      function showAlert(message, concatenatedName) {
        const alertBox = document.createElement("div");
        alertBox.className =
          "bg-red-100 border-l-4 border-red-600 text-red-800 p-4 rounded-lg shadow-md relative mb-2 pr-10";
        alertBox.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm">${message} ${concatenatedName}</p>
            </div>
          </div>
          <button class="absolute top-2 right-2 text-red-600 hover:text-red-800">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;

        alertBox.querySelector("button").addEventListener("click", () => {
          alertBox.remove();
        });

        document.getElementById("alert-container").appendChild(alertBox);

        // Auto-dismiss after 10 seconds
        setTimeout(() => {
          if (alertBox.parentNode) {
            alertBox.remove();
          }
        }, 10000);
      }

      function showAlertMessage(message) {
        const alertBox = document.createElement("div");
        alertBox.className =
          "bg-red-100 border-l-4 border-red-600 text-red-800 p-4 rounded-lg shadow-md relative mb-2 pr-10";
        alertBox.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm">${message}</p>
            </div>
          </div>
          <button class="absolute top-2 right-2 text-red-600 hover:text-red-800">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;

        alertBox.querySelector("button").addEventListener("click", () => {
          alertBox.remove();
        });

        document.getElementById("alert-container").appendChild(alertBox);

        // Auto-dismiss after 10 seconds
        setTimeout(() => {
          if (alertBox.parentNode) {
            alertBox.remove();
          }
        }, 10000);
      }

      lineas();

      function fetchRutas() {
        return new Promise((resolve, reject) => {
          url =
            "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" +
            montador;
          fetch(url)
            .then((res) => {
              if (res.ok) {
                return res.json();
              } else {
                mensaje =
                  "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
                showAlertMessage(mensaje);
              }
            })
            .then((res) => {
              if (res[0]) {
                const request = indexedDB.open("dosxdos");
                request.onsuccess = (event) => {
                  const db = event.target.result;
                  const transaction = db.transaction("rutas", "readwrite");
                  const datosStore = transaction.objectStore("rutas");
                  const clearRequest = datosStore.clear();
                  clearRequest.onsuccess = (clearEvent) => {
                    const datos = res[1];
                    datos.forEach((item) => {
                      datosStore.add(item);
                    });
                    resolve(true);
                  };
                  clearRequest.onerror = (event) => {
                    error = event.target.error;
                    mensaje = `ERROR: ` + error;
                    console.error(error);
                    showAlertMessage(mensaje);
                  };
                };
                request.onerror = (event) => {
                  error = event.target.error;
                  mensaje = `ERROR: ` + error;
                  console.error(error);
                  showAlertMessage(mensaje);
                };
              } else {
                mensaje = res[1];
                console.error(res);
                showAlertMessage(mensaje);
              }
            })
            .catch((res) => {
              mensaje = "Sin conexión: " + res.message;
              localStorage.setItem("error", res);
              console.error(res);
              showAlertMessage(mensaje);
            });
        });
      }

      function fetchLineas(vectorRutas) {
        return new Promise(async (resolve, reject) => {
          try {
            console.log(vectorRutas);
            const promises = vectorRutas.map(async (objeto) => {
              const url =
                "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
                objeto.cod;
              const res = await fetch(url);
              if (!res.ok) {
                throw new Error(
                  `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
                );
              }
              const resJson = await res.json();
              if (resJson[0]) {
                const db = await new Promise((dbResolve, dbReject) => {
                  const request = indexedDB.open("dosxdos");
                  request.onsuccess = (event) => {
                    const db = event.target.result;
                    dbResolve(db);
                  };
                  request.onerror = (event) => {
                    dbReject(
                      new Error(
                        `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                      )
                    );
                  };
                });
                const transaction = db.transaction("lineas", "readwrite");
                const datosStore = transaction.objectStore("lineas");
                const datos = resJson[1];
                if (Array.isArray(datos)) {
                  datos.forEach((item) => {
                    datosStore.add(item);
                  });
                } else {
                  datosStore.add(datos);
                }
              } else {
                throw new Error(
                  `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
                );
              }
            });
            await Promise.all(promises);
            resolve(true);
          } catch (err) {
            console.error(err);
            localStorage.setItem("error", error);
            resolve(false);
          }
        });
      }

      async function sincronizarDb() {
        try {
          if (navigator.onLine) {
            const fRutas = await fetchRutas();
            rutas = await leerDatos("dosxdos", "rutas");
            rutas = rutas.map((objeto) => ({
              cod: objeto["No."],
              nombre: objeto["Descripcion"],
            }));
            const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
            if (limpiarLineas) {
              lineasCrm = await fetchLineas(rutas);
              if (lineasCrm) {
                mensaje = true;
                localStorage.setItem("sinc", mensaje);
                window.location.href =
                  "https://dosxdos.app.iidos.com/mapa_ruta.html";
              } else {
                showAlertMessage(
                  "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
                );
              }
            }
          }
        } catch (error) {
          const mensaje =
            "No se ha sincronizado la base de datos: " + error.message;
          console.error(error);
          localStorage.setItem("error", error);
          localStorage.setItem("mensaje", mensaje);
          window.location.href = "https://dosxdos.app.iidos.com/mapa_ruta.html";
        }
      }

      window.addEventListener("pageshow", (e) => {
        console.log("Carga completa de los elementos de la página no fetch");
        let mensaje = localStorage.getItem("mensaje");
        if (mensaje && mensaje !== null) {
          showAlertMessage(mensaje);
          localStorage.removeItem("mensaje");
        }
        let login = localStorage.getItem("login");
        if (!login || login === null) {
          window.location.href = "https://dosxdos.app.iidos.com/index.html";
        }
      });

      async function sincronizarDb2() {
        return new Promise(async (resolve, reject) => {
          try {
            const fRutas = await fetchRutas();
            rutas = await leerDatos("dosxdos", "rutas");
            rutas = rutas.map((objeto) => ({
              cod: objeto["No."],
              nombre: objeto["Descripcion"],
            }));
            const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
            if (limpiarLineas) {
              lineasCrm = await fetchLineas(rutas);
              if (lineasCrm) {
                resolve(true);
              } else {
                resolve(false);
              }
            }
          } catch (error) {
            console.error(error);
            resolve(false);
          }
        });
      }

      function fetchLineasRuta(ruta) {
        return new Promise(async (resolve, reject) => {
          try {
            const url =
              "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" + ruta;
            const res = await fetch(url);
            if (!res.ok) {
              console.error(res);
              throw new Error(
                `Error en la función fetchLineasRuta al solicitar las líneas de la ruta`
              );
            }
            const resJson = await res.json();
            if (resJson[0]) {
              const datos = resJson[1];
              resolve(datos);
            } else {
              console.error(resJson);
              throw new Error(
                `Error en la función fetchLineasRuta al solicitar las líneas de la ruta`
              );
            }
          } catch (err) {
            console.error(err);
            localStorage.setItem("error", error);
            resolve(false);
          }
        });
      }

      const compararDatos = () => {
        return new Promise((resolve, reject) => {
          try {
            marcadoresAccion = {};
            marcadoresAccion.data = [];
            marcadoresAccion.accion = "none";
            marcadoresAccion.lineasRuta = lineasRuta.length;
            marcadoresAccion.marcadores = marcadores.length;
            if (lineasRuta.length != marcadores.length) {
              if (lineasRuta.length < marcadores.length) {
                for (const marcador of marcadores) {
                  let validarMarcador = true;
                  for (const linea of lineasRuta) {
                    if (linea.Linea == marcador.customId) {
                      validarMarcador = false;
                      break;
                    }
                  }
                  if (validarMarcador) {
                    showAlertMessage(
                      `La línea ${marcador.customId} ha sido reportada o eliminada de la ruta`
                    );
                    marcadoresAccion.data.push(marcador);
                  }
                }
                marcadoresAccion.accion = "delete";
              } else {
                for (const linea of lineasRuta) {
                  let validarLinea = true;
                  for (const marcador of marcadores) {
                    if (linea.Linea == marcador.customId) {
                      validarLinea = false;
                      break;
                    }
                  }
                  if (validarLinea) {
                    showAlertMessage(
                      `La línea ${linea.Linea} ha sido agregada __ ${linea.NombrePuntoVenta} __ ${linea.DireccionPuntoVenta}`
                    );
                    marcadoresAccion.data.push(linea);
                  }
                }
                marcadoresAccion.accion = "add";
              }
            }
            resolve(marcadoresAccion);
          } catch (error) {
            console.error(error);
            showAlertMessage(
              "Error en el sincronizador al eliminar líneas ya realizadas, por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
            );
            resolve(false);
          }
        });
      };

      const deleteMarcadores = (marcadoresDelete) => {
        return new Promise((resolve, reject) => {
          try {
            let i = 0;
            for (const marcador of marcadores) {
              for (const marcadorDelete of marcadoresDelete) {
                if (marcadorDelete.customId == marcador.customId) {
                  marcadores.splice(i, 1);
                  marcador.setMap(null);
                  resolve(true);
                  break;
                }
              }
              i++;
            }
            resolve(false);
          } catch (error) {
            console.error(error);
            alerta(
              "Error en el sincronizador al eliminar líneas ya realizadas, por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
            );
            resolve(false);
          }
        });
      };

      const deleteAllMarcadores = () => {
        return new Promise((resolve, reject) => {
          try {
            for (const marcador of marcadores) {
              marcador.setMap(null);
            }
            marcadores = [];
            resolve(true);
          } catch (error) {
            console.error(error);
            alerta(
              "Error en el sincronizador al eliminar líneas para actualizar el mapa completo, error en deleteAllMarcadores. Por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
            );
            resolve(false);
          }
        });
      };

      const sincronizador = async () => {
        try {
          lineasRuta = await fetchLineasRuta(ruta);
          if (lineasRuta) {
            const comparacion = await compararDatos();
            console.log(comparacion);
            if (comparacion.data.length) {
              if (comparacion.accion == "delete") {
                deleteMarcadores(comparacion.data);
                if (deleteMarcadores) {
                  alerta("El mapa ha sido actualizado");
                }
              } else if (comparacion.accion == "add") {
                const deleteMarcadores = await deleteAllMarcadores();
                if (deleteMarcadores) {
                  const render = await renderPins(lineasRuta);
                  if (render) {
                    alerta("El mapa ha sido actualizado");
                  } else {
                    alerta(
                      "Error, el mapa no ha sido actualizado, por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
                    );
                  }
                } else {
                  alerta(
                    "Error, el mapa no ha sido actualizado, por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
                  );
                }
              }
            }
          } else {
            alerta(
              "Error en el sincronizador para actualizar el mapa, error en fetchLineas. Por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
            );
          }
          intervaloAleatorio =
            Math.floor(Math.random() * (6000 - 5000 + 1)) + 5000;
          setTimeout(sincronizador, intervaloAleatorio);
        } catch (error) {
          console.error(error);
          alerta(
            "Error en el sincronizador del mapa. Por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
          );
        }
      };

      // Add event listeners for modal closing
      document.addEventListener("DOMContentLoaded", function () {
        // Close modal when clicking outside of it
        const modal = document.getElementById("modal");
        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            closeModal();
          }
        });

        // Close modal with the X button
        document
          .getElementById("modal-close")
          .addEventListener("click", closeModal);
      });

      // Function to close the modal
      function closeModal() {
        const modal = document.getElementById("modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      // Function to format point data nicely
      function formatPointData(concatenatedName) {
        // Split the concatenated string by hyphens and handle each part
        const parts = concatenatedName.split(" - ");

        // Create a formatted HTML string with line breaks and proper labels
        let formattedHTML = "";

        if (parts.length >= 1)
          formattedHTML += `<div class="font-bold">${parts[0]}</div>`;
        if (parts.length >= 2)
          formattedHTML += `<div class="mt-1">${parts[1]}</div>`;

        // Add remaining parts with proper labels
        const labels = [
          "Estado",
          "Cliente",
          "OT CRM",
          "OT Navision",
          "Tipo",
          "Observaciones",
        ];
        for (let i = 2; i < parts.length && i - 2 < labels.length; i++) {
          formattedHTML += `<div class="mt-1 text-sm"><span class="text-gray-500">${
            labels[i - 2]
          }:</span> ${parts[i]}</div>`;
        }

        return formattedHTML;
      }

      // Function to process marker data for the modal
      function updateModalContent(point, adjustedLat, adjustedLng) {
        // Parse the point ID and name
        const id = point.Linea || "";
        document.getElementById("point-id").textContent = id;
        document.getElementById("point-name").textContent =
          point.NombrePuntoVenta || "Sin nombre";

        // Fill in all the specific fields
        document.getElementById("point-estado").textContent =
          point.Estado || "-";
        document.getElementById("point-cliente").textContent =
          point.NombreCliente || "-";
        document.getElementById("point-ot-crm").textContent = point.OT || "-";
        document.getElementById("point-ot-navision").textContent =
          point.Navision_OT || "-";
        document.getElementById("point-tipo").textContent =
          point.TipoOT || point.TipoTrabajo || "-";
        document.getElementById("point-observaciones").textContent =
          point.Observaciones || "-";

        // Address and coordinates
        document.getElementById("point-address").textContent =
          point.DireccionPuntoVenta || "Dirección no disponible";
        document.getElementById("point-lat").textContent = adjustedLat;
        document.getElementById("point-lng").textContent = adjustedLng;
      }

      // Add event listeners for modal closing
      document.addEventListener("DOMContentLoaded", function () {
        // Close modal when clicking outside of it
        const modal = document.getElementById("modal");
        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            closeModal();
          }
        });

        // Close modal with the X button
        document
          .getElementById("modal-close")
          .addEventListener("click", closeModal);
      });

      // Function to close the modal
      function closeModal() {
        const modal = document.getElementById("modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    </script>
  </body>
</html>
