<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Rutas</title>
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logoPwa256.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDojih1XShuEEmyRVE8FYOGvJn37blq0ng"></script>
</head>

<body id="body" class="bg-gray-100 overflow-hidden relative h-screen flex flex-col">
  <div id="loader" class="displayOn">
    <span class="loader"></span>
  </div>



  <!-- Navigation -->
  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden xl:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 xl:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden xl:flex items-center space-x-8">
        <a href="https://dosxdos.app.iidos.com/rutas_montador.html"
          class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 5c8 0 8 14 16 14" />
            <circle cx="4" cy="5" r="2" />
            <circle cx="12" cy="12" r="2" />
            <circle cx="20" cy="19" r="2" />
          </svg>
          <span>Rutas</span>
        </a>

        <a href="https://dosxdos.app.iidos.com/ruta_montador.html"
          class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
            <path d="M9 12h6" />
            <path d="M9 16h6" />
          </svg>
          <span>Líneas</span>
        </a>

        <!-- History Link -->
        <a href="https://dosxdos.app.iidos.com/historial_montador.html"
          class="flex items-center text-gray-700 hover:text-red-600 transition-colors duration-200">
          <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
          <span>Historial</span>
        </a>

        <!-- Desktop Menu Notifications Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="desktopBellContainer">
          <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
          <span id="desktopNotificationCount"
            class="absolute top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="xl:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="mobileBellContainer">
          <img id="bellMobile" src="" class="text-gray-900 object-contain mt-2" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-0 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Hamburger Button -->
        <button id="menuButton" class="xl:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

      <div id="mobileMenu"
        class="xl:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
        <div class="absolute inset-0 z-0" style="
          background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
          background-size: contain;
          opacity: 0.7;
        "></div>
        <!-- User Profile Section -->
        <div class="px-8 py-4 mt-20 relative z-10">
          <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
            <!-- Profile image -->
            <div
              class="absolute left-0 w-24 h-24 rounded-full overflow-hidden border-2 border-white bg-gray-100 flex items-center justify-center shadow-lg">
              <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="ml-28 flex items-center py-4">
              <!-- User name -->
              <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
              <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
              <span class="text-black font-medium text-xl">!</span>
            </div>
          </div>
        </div>

        <!-- Navigation Links -->
        <nav class="px-8 py-6 space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar">
          <a href="https://dosxdos.app.iidos.com/notificaciones.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8a6 6 0 0 0-12 0v5a6 6 0 0 1-2 4h16a6 6 0 0 1-2-4V8"></path>
                <line x1="12" y1="22" x2="12" y2="22"></line>
                <!-- Small bell clapper -->
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Notificaciones</span>
          </a>

          <a href="https://dosxdos.app.iidos.com/rutas_montador.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 shadow-xl backdrop-blur-lg hover:bg-white/20 rounded-xl transition-all duration-300 group">
            <div
              class="z-0 flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M4 5c8 0 8 14 16 14" />
                <circle cx="4" cy="5" r="2" />
                <circle cx="12" cy="12" r="2" />
                <circle cx="20" cy="19" r="2" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Rutas</span>
          </a>

          <a href="https://dosxdos.app.iidos.com/ruta_montador.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                <path d="M9 12h6" />
                <path d="M9 16h6" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Líneas</span>
          </a>

          <a href="https://dosxdos.app.iidos.com/historial_montador.html"
            class="z-10 flex items-center px-6 py-2 text-white bg-red-600 bg-opacity-60 hover:bg-white/20 rounded-xl transition-all duration-300 shadow-xl group backdrop-blur-lg">
            <div
              class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-7 h-7 text-white group-hover:text-gray-900 transition-all" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
            </div>
            <span class="text-lg font-semibold tracking-wide">Historial</span>
          </a>
        </nav>

        <div class="relative z-10">
          <div id="divider_id" class="website-divider-container-734167" style="height: 100px; overflow: visible">
            <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
              preserveAspectRatio="none" style="bottom: -20px">
              <path
                d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
                style="fill: #ffffff"></path>
              <path
                d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
                style="fill: #ffffff; opacity: 0.5"></path>
              <path
                d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
                style="fill: #ffffff; opacity: 0.25"></path>
            </svg>
          </div>
        </div>

        <!-- User Actions -->
        <div class="relative z-10 mt-auto px-8 pb-6 bg-white bg-opacity-05 shadow flex flex-col space-y-2">
          <button id="editarUsuarioMobile"
            class="z-30 flex items-center w-full px-6 py-2 text-white bg-red-600 shadow-xl backdrop-blur-lg rounded-xl transition-all duration-300 group">
            <div
              class="flex items-center justify-center w-12 h-10 bg-white/20 rounded-xl mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-6 h-6 shadow-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
            </div>
            <span class="text-lg font-medium">Editar usuario</span>
          </button>

          <button id="cerrarSesionMobile"
            class="z-30 flex items-center w-full px-6 py-2 bg-red-600 shadow-xl backdrop-blur-lg text-white rounded-xl transition-all duration-300 group mb-3">
            <div
              class="flex items-center justify-center w-12 h-10 bg-white/20 rounded-lg mr-4 group-hover:bg-white/30 transition-all">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
            </div>
            <span class="text-lg font-medium">Cerrar sesión</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Back Button and Map Title  -->
  <div class="w-full bg-white shadow-md fixed top-24 z-20">
    <div class="flex items-center justify-between px-6 py-4">
      <button id="volverBtn" class="text-red-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd" />
        </svg>
      </button>
      <h1 id="ruta-title" class="text-xl font-bold text-gray-800 text-center">
        MAPA DE RUTA
      </h1>
      <div class="w-8"></div>
    </div>
  </div>

  <!-- Map Container -->
  <div class="flex-1 relative">
    <div id="map" class="w-full h-full z-10"></div>
  </div>

  <!-- modal block -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-auto overflow-hidden">
      <!-- Modal Header with improved layout -->
      <div class="relative bg-red-600 p-4 text-white">
        <div class="absolute inset-0 opacity-70" style="
              background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
              background-size: contain;
            "></div>

        <!-- Title and Close Button Row -->
        <div class="relative z-10 flex justify-between items-start">
          <div>
            <h2 id="point-id" class="text-xl font-bold">11820</h2>
            <h3 id="point-name" class="text-lg font-medium mt-1">
              Perfumes.es Fariones
            </h3>
          </div>

          <button id="modal-close" class="p-1 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Info Grid -->
        <div class="mt-4 relative z-10 grid grid-cols-2 gap-y-2 gap-x-10 text-sm">
          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">Estado:</div>
            <div id="point-estado" class="font-medium">Pendiente</div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">Cliente:</div>
            <div id="point-cliente" class="font-medium">
              COMERCIAL FARLABO ESPAÑA, S.L.
            </div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">OT CRM:</div>
            <div id="point-ot-crm" class="font-medium">31280</div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">OT Navision:</div>
            <div id="point-ot-navision" class="font-medium">24292</div>
          </div>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="p-4 space-y-3">
        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-sm text-gray-700 font-medium">Dirección</p>
          <p id="point-address" class="text-gray-900 font-medium"></p>
        </div>

        <div class="flex gap-3">
          <div class="bg-gray-100 p-3 rounded-lg flex-1">
            <p class="text-sm text-gray-700 font-medium">Latitud</p>
            <p id="point-lat" class="text-gray-900 text-sm font-medium"></p>
          </div>
          <div class="bg-gray-100 p-3 rounded-lg flex-1">
            <p class="text-sm text-gray-700 font-medium">Longitud</p>
            <p id="point-lng" class="text-gray-900 text-sm font-medium"></p>
          </div>
        </div>

        <!-- Type and Observations -->
        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-sm text-gray-700 font-medium">Tipo</p>
          <p id="point-tipo" class="text-gray-900 font-medium"></p>
        </div>

        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-sm text-gray-700 font-medium">Observaciones</p>
          <p id="point-observaciones" class="text-gray-900 font-medium"></p>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="p-4 bg-gray-100 flex gap-3">
        <button id="navigate-button"
          class="flex-1 h-12 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z"
              clip-rule="evenodd" />
          </svg>
          Navegar
        </button>
        <button id="report-button"
          class="flex-1 h-12 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-lg transition-colors flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd" />
          </svg>
          Reportar
        </button>
      </div>
    </div>
  </div>

  <!-- Alert Container -->
  <div id="alert-container" class="fixed top-16 right-4 z-30 flex flex-col gap-2 max-w-md"></div>

  <script src="./js/index_db.js"></script>

  <script>
    let montador;
    const ruta = localStorage.getItem("ruta");
    const nombreRuta = localStorage.getItem("nombreRuta");
    const $loader = document.getElementById("loader");
    const $body = document.getElementById("body");
    let bounds;
    let marcadores = [];

    function scrollToTop() {
      // Para navegadores modernos
      document.documentElement.scrollTop = 0;
      // Para navegadores antiguos
      document.body.scrollTop = 0;
    }

    /* LOADER */
    function loaderOn() {
      scrollToTop();
      $loader.classList.remove("displayOff");
      $loader.classList.add("displayOn");
      $body.classList.add("oyh");
    }

    function loaderOff() {
      setTimeout(() => {
        $loader.classList.remove("displayOn");
        $loader.classList.add("displayOff");
        $body.classList.remove("oyh");
      }, 1000);
    }

    // Setup route title and back button
    if (nombreRuta) {
      document.getElementById("ruta-title").innerText = nombreRuta;
    } else if (ruta) {
      document.getElementById("ruta-title").innerText = ruta;
    } else {
      document.getElementById("ruta-title").innerText = "MAPA DE RUTA";
    }

    document.getElementById("volverBtn").addEventListener("click", () => {
      window.location.href =
        "https://dosxdos.app.iidos.com/ruta_montador.html";
    });

    document.getElementById("modal-close").addEventListener("click", () => {
      document.getElementById("modal").classList.add("hidden");
    });

    let lineasRuta = [];

    const lineas = async () => {
      loaderOn();
      const Arrayusuario = await leerDatos("dosxdos", "usuario");
      usuario = Arrayusuario[0];
      montador = usuario.cod;
      sinc = await sincronizarDb2();
      sinc
        ? console.log("Base de datos sincronizada")
        : console.error("Error al sincronizar la base de datos");
      const TotalLineas = await leerDatos("dosxdos", "lineas");
      if (TotalLineas) {
        lineasRuta = TotalLineas.filter((objeto) => objeto.Proyecto === ruta);
        console.log("Lineas: ", lineasRuta);
        storageLineas = JSON.stringify(lineasRuta);
        localStorage.setItem("lineasRuta", storageLineas);
        await initMap(lineasRuta);
        sincronizador();

        // Process notifications
        const sincronizacionDeNotificaciones = await sincronizarNotificaciones();
        if (sincronizacionDeNotificaciones) {
          await notificar();
        }
      }
      loaderOff();
    };

    let map;
    const modal = document.getElementById("modal");
    const pointName = document.getElementById("point-name");
    const pointAddress = document.getElementById("point-address");
    const pointLat = document.getElementById("point-lat");
    const pointLng = document.getElementById("point-lng");
    const navigateButton = document.getElementById("navigate-button");
    const reportButton = document.getElementById("report-button");
    const closeButton = document.getElementById("close-button");

    function initMap(lineasInicio) {
      bounds = new google.maps.LatLngBounds();
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 8,
        gestureHandling: "greedy",
        fullscreenControl: false,
      });
      renderPins(lineasInicio);
    }

    function renderPins(lineasRender) {
      return new Promise((resolve, reject) => {
        try {
          const offset = 0.00007;
          let i = 0;
          for (const point of lineasRender) {
            const nameToDisplay =
              point.NombrePuntoVenta ||
              "Nombre del punto de venta no disponible";
            const firma = point.Firma || "Sin firma";
            const observaciones = point.Observaciones || "Sin observaciones";
            const nombreCliente =
              point.NombreCliente || "Nombre del cliente no disponible";
            const concatenatedName = `${point.Linea} - ${nameToDisplay} - ${firma} - ${nombreCliente} - OT CRM: ${point.OT} - OT Navision: ${point.Navision_OT} - ${point.TipoOT} - ${observaciones}`;
            const lat = point.lat ? parseFloat(point.lat) : null;
            const lng = point.lng ? parseFloat(point.lng) : null;
            if (lat !== null && lng !== null) {
              const adjustedLat = lat + i * offset;
              const adjustedLng = lng + i * offset;
              const marker = new google.maps.Marker({
                position: { lat: adjustedLat, lng: adjustedLng },
                map: map,
                title: concatenatedName,
              });
              bounds.extend(marker.position);
              marker.addListener("click", () => {
                // Update modal content with this point's data
                updateModalContent(point, adjustedLat, adjustedLng);

                // Show the modal
                modal.classList.remove("hidden");
                modal.classList.add("flex");

                // Center the map on this point
                map.setZoom(19);
                map.setCenter(marker.getPosition());

                // Set up navigation button
                navigateButton.onclick = () => {
                  if (lat !== null && lng !== null) {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${adjustedLat},${adjustedLng}`;
                    window.open(url, "_blank");
                  } else {
                    alert(
                      "Las coordenadas no están disponibles para este punto."
                    );
                  }
                };

                // Set up report button
                reportButton.onclick = () => {
                  localStorage.setItem("linea", point.Linea);
                  localStorage.setItem("lineaActividad", point.Linea);
                  localStorage.setItem("ot", point.OT);
                  localStorage.setItem("cliente", point.Cliente);
                  localStorage.setItem("nombreCliente", point.NombreCliente);
                  window.location.href =
                    "https://dosxdos.app.iidos.com/linea_montador.html";
                };
              });
              // Agregar una propiedad personalizada al marcador
              marker.customId = point.Linea; // Usa un identificador único de tu objeto `point`
              // Guarda el marcador en un array para gestionarlo más tarde si es necesario
              marcadores.push(marker);
            } else {
              console.log(
                `Missing coordinates for point: ${JSON.stringify(point)}`
              );
              const alertMessage = `Fallo al cargar la ubicación para la línea: `;
              showAlert(alertMessage, concatenatedName);
              i++;
              continue;
            }
            i++;
          }
          map.fitBounds(bounds);
          resolve(true);
        } catch (error) {
          console.error(error);
          showAlertMessage(
            "Error al renderizar los puntos en el mapa, por favor carga de nuevo el mapa para intentarlo nuevamente"
          );
          resolve(false);
        }
      });
    }

    function showAlert(message, concatenatedName) {
      const alertBox = document.createElement("div");
      alertBox.className =
        "bg-red-100 border-l-4 border-red-600 text-red-800 p-4 rounded-lg shadow-md relative mb-2 pr-10";
      alertBox.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm">${message} ${concatenatedName}</p>
            </div>
          </div>
          <button class="absolute top-2 right-2 text-red-600 hover:text-red-800">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;

      alertBox.querySelector("button").addEventListener("click", () => {
        alertBox.remove();
      });

      document.getElementById("alert-container").appendChild(alertBox);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (alertBox.parentNode) {
          alertBox.remove();
        }
      }, 10000);
    }

    function showAlertMessage(message) {
      const alertBox = document.createElement("div");
      alertBox.className =
        "bg-red-100 border-l-4 border-red-600 text-red-800 p-4 rounded-lg shadow-md relative mb-2 pr-10";
      alertBox.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm">${message}</p>
            </div>
          </div>
          <button class="absolute top-2 right-2 text-red-600 hover:text-red-800">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;

      alertBox.querySelector("button").addEventListener("click", () => {
        alertBox.remove();
      });

      document.getElementById("alert-container").appendChild(alertBox);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (alertBox.parentNode) {
          alertBox.remove();
        }
      }, 10000);
    }

    // Init the menu after loading the map and other components
    lineas().then(() => {
      initializeApplication();
    });

    function fetchRutas() {
      return new Promise((resolve, reject) => {
        url =
          "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" +
          montador;
        fetch(url)
          .then((res) => {
            if (res.ok) {
              return res.json();
            } else {
              mensaje =
                "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
              showAlertMessage(mensaje);
            }
          })
          .then((res) => {
            if (res[0]) {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction("rutas", "readwrite");
                const datosStore = transaction.objectStore("rutas");
                const clearRequest = datosStore.clear();
                clearRequest.onsuccess = (clearEvent) => {
                  const datos = res[1];
                  datos.forEach((item) => {
                    datosStore.add(item);
                  });
                  resolve(true);
                };
                clearRequest.onerror = (event) => {
                  error = event.target.error;
                  mensaje = `ERROR: ` + error;
                  console.error(error);
                  showAlertMessage(mensaje);
                };
              };
              request.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                console.error(error);
                showAlertMessage(mensaje);
              };
            } else {
              mensaje = res[1];
              console.error(res);
              showAlertMessage(mensaje);
            }
          })
          .catch((res) => {
            mensaje = "Sin conexión: " + res.message;
            localStorage.setItem("error", res);
            console.error(res);
            showAlertMessage(mensaje);
          });
      });
    }

    function fetchLineas(vectorRutas) {
      return new Promise(async (resolve, reject) => {
        try {
          console.log(vectorRutas);
          const promises = vectorRutas.map(async (objeto) => {
            const url =
              "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
              objeto.cod;
            const res = await fetch(url);
            if (!res.ok) {
              throw new Error(
                `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
              );
            }
            const resJson = await res.json();
            if (resJson[0]) {
              const db = await new Promise((dbResolve, dbReject) => {
                const request = indexedDB.open("dosxdos");
                request.onsuccess = (event) => {
                  const db = event.target.result;
                  dbResolve(db);
                };
                request.onerror = (event) => {
                  dbReject(
                    new Error(
                      `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                    )
                  );
                };
              });
              const transaction = db.transaction("lineas", "readwrite");
              const datosStore = transaction.objectStore("lineas");
              const datos = resJson[1];
              if (Array.isArray(datos)) {
                datos.forEach((item) => {
                  datosStore.add(item);
                });
              } else {
                datosStore.add(datos);
              }
            } else {
              throw new Error(
                `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
              );
            }
          });
          await Promise.all(promises);
          resolve(true);
        } catch (err) {
          console.error(err);
          localStorage.setItem("error", error);
          resolve(false);
        }
      });
    }

    async function sincronizarDb() {
      try {
        if (navigator.onLine) {
          const fRutas = await fetchRutas();
          rutas = await leerDatos("dosxdos", "rutas");
          rutas = rutas.map((objeto) => ({
            cod: objeto["No."],
            nombre: objeto["Descripcion"],
          }));
          const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
          if (limpiarLineas) {
            lineasCrm = await fetchLineas(rutas);
            if (lineasCrm) {
              mensaje = true;
              localStorage.setItem("sinc", mensaje);
              window.location.href =
                "https://dosxdos.app.iidos.com/mapa_ruta.html";
            } else {
              showAlertMessage(
                "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
              );
            }
          }
        }
      } catch (error) {
        const mensaje =
          "No se ha sincronizado la base de datos: " + error.message;
        console.error(error);
        localStorage.setItem("error", error);
        localStorage.setItem("mensaje", mensaje);
        window.location.href = "https://dosxdos.app.iidos.com/mapa_ruta.html";
      }
    }

    window.addEventListener("pageshow", (e) => {
      console.log("Carga completa de los elementos de la página no fetch");
      let mensaje = localStorage.getItem("mensaje");
      if (mensaje && mensaje !== null) {
        showAlertMessage(mensaje);
        localStorage.removeItem("mensaje");
      }
      let login = localStorage.getItem("login");
      if (!login || login === null) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      }
    });

    async function sincronizarDb2() {
      return new Promise(async (resolve, reject) => {
        try {
          const fRutas = await fetchRutas();
          rutas = await leerDatos("dosxdos", "rutas");
          rutas = rutas.map((objeto) => ({
            cod: objeto["No."],
            nombre: objeto["Descripcion"],
          }));
          const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
          if (limpiarLineas) {
            lineasCrm = await fetchLineas(rutas);
            if (lineasCrm) {
              resolve(true);
            } else {
              resolve(false);
            }
          }
        } catch (error) {
          console.error(error);
          resolve(false);
        }
      });
    }

    function fetchLineasRuta(ruta) {
      return new Promise(async (resolve, reject) => {
        try {
          const url =
            "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" + ruta;
          const res = await fetch(url);
          if (!res.ok) {
            console.error(res);
            throw new Error(
              `Error en la función fetchLineasRuta al solicitar las líneas de la ruta`
            );
          }
          const resJson = await res.json();
          if (resJson[0]) {
            const datos = resJson[1];
            resolve(datos);
          } else {
            console.error(resJson);
            throw new Error(
              `Error en la función fetchLineasRuta al solicitar las líneas de la ruta`
            );
          }
        } catch (err) {
          console.error(err);
          localStorage.setItem("error", error);
          resolve(false);
        }
      });
    }

    const compararDatos = () => {
      return new Promise((resolve, reject) => {
        try {
          marcadoresAccion = {};
          marcadoresAccion.data = [];
          marcadoresAccion.accion = "none";
          marcadoresAccion.lineasRuta = lineasRuta.length;
          marcadoresAccion.marcadores = marcadores.length;
          if (lineasRuta.length != marcadores.length) {
            if (lineasRuta.length < marcadores.length) {
              for (const marcador of marcadores) {
                let validarMarcador = true;
                for (const linea of lineasRuta) {
                  if (linea.Linea == marcador.customId) {
                    validarMarcador = false;
                    break;
                  }
                }
                if (validarMarcador) {
                  showAlertMessage(
                    `La línea ${marcador.customId} ha sido reportada o eliminada de la ruta`
                  );
                  marcadoresAccion.data.push(marcador);
                }
              }
              marcadoresAccion.accion = "delete";
            } else {
              for (const linea of lineasRuta) {
                let validarLinea = true;
                for (const marcador of marcadores) {
                  if (linea.Linea == marcador.customId) {
                    validarLinea = false;
                    break;
                  }
                }
                if (validarLinea) {
                  showAlertMessage(
                    `La línea ${linea.Linea} ha sido agregada __ ${linea.NombrePuntoVenta} __ ${linea.DireccionPuntoVenta}`
                  );
                  marcadoresAccion.data.push(linea);
                }
              }
              marcadoresAccion.accion = "add";
            }
          }
          resolve(marcadoresAccion);
        } catch (error) {
          console.error(error);
          showAlertMessage(
            "Error en el sincronizador al eliminar líneas ya realizadas, por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
          );
          resolve(false);
        }
      });
    };

    const deleteMarcadores = (marcadoresDelete) => {
      return new Promise((resolve, reject) => {
        try {
          let i = 0;
          for (const marcador of marcadores) {
            for (const marcadorDelete of marcadoresDelete) {
              if (marcadorDelete.customId == marcador.customId) {
                marcadores.splice(i, 1);
                marcador.setMap(null);
                resolve(true);
                break;
              }
            }
            i++;
          }
          resolve(false);
        } catch (error) {
          console.error(error);
          alerta(
            "Error en el sincronizador al eliminar líneas ya realizadas, por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
          );
          resolve(false);
        }
      });
    };

    const deleteAllMarcadores = () => {
      return new Promise((resolve, reject) => {
        try {
          for (const marcador of marcadores) {
            marcador.setMap(null);
          }
          marcadores = [];
          resolve(true);
        } catch (error) {
          console.error(error);
          alerta(
            "Error en el sincronizador al eliminar líneas para actualizar el mapa completo, error en deleteAllMarcadores. Por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
          );
          resolve(false);
        }
      });
    };

    const sincronizador = async () => {
      try {
        lineasRuta = await fetchLineasRuta(ruta);
        if (lineasRuta) {
          const comparacion = await compararDatos();
          console.log(comparacion);
          if (comparacion.data.length) {
            if (comparacion.accion == "delete") {
              deleteMarcadores(comparacion.data);
              if (deleteMarcadores) {
                alerta("El mapa ha sido actualizado");
              }
            } else if (comparacion.accion == "add") {
              const deleteMarcadores = await deleteAllMarcadores();
              if (deleteMarcadores) {
                const render = await renderPins(lineasRuta);
                if (render) {
                  alerta("El mapa ha sido actualizado");
                } else {
                  alerta(
                    "Error, el mapa no ha sido actualizado, por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
                  );
                }
              } else {
                alerta(
                  "Error, el mapa no ha sido actualizado, por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
                );
              }
            }
          }
        } else {
          alerta(
            "Error en el sincronizador para actualizar el mapa, error en fetchLineas. Por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
          );
        }
        intervaloAleatorio =
          Math.floor(Math.random() * (6000 - 5000 + 1)) + 5000;
        setTimeout(sincronizador, intervaloAleatorio);
      } catch (error) {
        console.error(error);
        alerta(
          "Error en el sincronizador del mapa. Por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
        );
      }
    };

    // Add event listeners for modal closing
    document.addEventListener("DOMContentLoaded", function () {
      // Close modal when clicking outside of it
      const modal = document.getElementById("modal");
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Close modal with the X button
      document
        .getElementById("modal-close")
        .addEventListener("click", closeModal);
    });

    // Function to close the modal
    function closeModal() {
      const modal = document.getElementById("modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    // Function to format point data nicely
    function formatPointData(concatenatedName) {
      // Split the concatenated string by hyphens and handle each part
      const parts = concatenatedName.split(" - ");

      // Create a formatted HTML string with line breaks and proper labels
      let formattedHTML = "";

      if (parts.length >= 1)
        formattedHTML += `<div class="font-bold">${parts[0]}</div>`;
      if (parts.length >= 2)
        formattedHTML += `<div class="mt-1">${parts[1]}</div>`;

      // Add remaining parts with proper labels
      const labels = [
        "Estado",
        "Cliente",
        "OT CRM",
        "OT Navision",
        "Tipo",
        "Observaciones",
      ];
      for (let i = 2; i < parts.length && i - 2 < labels.length; i++) {
        formattedHTML += `<div class="mt-1 text-sm"><span class="text-gray-500">${labels[i - 2]
          }:</span> ${parts[i]}</div>`;
      }

      return formattedHTML;
    }

    // Function to process marker data for the modal
    function updateModalContent(point, adjustedLat, adjustedLng) {
      // Parse the point ID and name
      const id = point.Linea || "";
      document.getElementById("point-id").textContent = id;
      document.getElementById("point-name").textContent =
        point.NombrePuntoVenta || "Sin nombre";

      // Fill in all the specific fields
      document.getElementById("point-estado").textContent =
        point.Estado || "-";
      document.getElementById("point-cliente").textContent =
        point.NombreCliente || "-";
      document.getElementById("point-ot-crm").textContent = point.OT || "-";
      document.getElementById("point-ot-navision").textContent =
        point.Navision_OT || "-";
      document.getElementById("point-tipo").textContent =
        point.TipoOT || point.TipoTrabajo || "-";
      document.getElementById("point-observaciones").textContent =
        point.Observaciones || "-";

      // Address and coordinates
      document.getElementById("point-address").textContent =
        point.DireccionPuntoVenta || "Dirección no disponible";
      document.getElementById("point-lat").textContent = adjustedLat;
      document.getElementById("point-lng").textContent = adjustedLng;
    }

    // Add event listeners for modal closing
    document.addEventListener("DOMContentLoaded", function () {
      // Close modal when clicking outside of it
      const modal = document.getElementById("modal");
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Close modal with the X button
      document
        .getElementById("modal-close")
        .addEventListener("click", closeModal);
    });

    // Function to close the modal
    function closeModal() {
      const modal = document.getElementById("modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    // MENU AND USER INTERACTION SETUP
    function setupMenuInteractions() {
      // Desktop Menu
      const userMenuButton = document.getElementById("userMenuButton");
      const userDropdownMenu = document.getElementById("userDropdownMenu");

      if (userMenuButton && userDropdownMenu) {
        userMenuButton.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          userDropdownMenu.classList.toggle("hidden");
          const isExpanded = !userDropdownMenu.classList.contains("hidden");
          userMenuButton.setAttribute("aria-expanded", isExpanded.toString());
        });
      }

      // Mobile Menu Links
      const mobileMenuLinks = document.querySelectorAll("#mobileMenu nav a");
      mobileMenuLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.stopPropagation();
          window.location.href = link.href;
          const menuButton = document.getElementById("menuButton");
          if (menuButton) menuButton.click(); // Close menu after clicking
        });
      });

      // Mobile Menu Toggle
      const menuButton = document.getElementById("menuButton");
      const mobileMenu = document.getElementById("mobileMenu");
      const hamburgerTop = document.getElementById("hamburgerTop");
      const hamburgerMiddle = document.getElementById("hamburgerMiddle");
      const hamburgerBottom = document.getElementById("hamburgerBottom");

      if (menuButton && mobileMenu) {
        menuButton.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const isOpen = !mobileMenu.classList.contains("translate-x-full");
          mobileMenu.classList.toggle("translate-x-full");
          document.body.classList.toggle("overflow-hidden");

          if (!isOpen) {
            // Menu is opening
            hamburgerTop.classList.remove("bg-gray-900");
            hamburgerMiddle.classList.remove("bg-gray-900");
            hamburgerBottom.classList.remove("bg-gray-900");
            hamburgerTop.classList.add("bg-white");
            hamburgerMiddle.classList.add("bg-white");
            hamburgerBottom.classList.add("bg-white");

            hamburgerTop.style.transform = "rotate(45deg) translate(10px, 7px)";
            hamburgerMiddle.style.opacity = "0";
            hamburgerBottom.style.transform = "rotate(-45deg) translate(10px, -7px)";
          } else {
            // Menu is closing
            hamburgerTop.classList.remove("bg-white");
            hamburgerMiddle.classList.remove("bg-white");
            hamburgerBottom.classList.remove("bg-white");
            hamburgerTop.classList.add("bg-gray-900");
            hamburgerMiddle.classList.add("bg-gray-900");
            hamburgerBottom.classList.add("bg-gray-900");

            hamburgerTop.style.transform = "";
            hamburgerMiddle.style.opacity = "1";
            hamburgerBottom.style.transform = "";
          }
        });
      }
    }

    // USER EDIT AND LOGOUT SETUP
    function setupUserActions() {
      // Edit User Buttons
      const editarUsuarioDesktop = document.getElementById("editarUsuarioDesktop");
      const editarUsuarioMobile = document.getElementById("editarUsuarioMobile");

      [editarUsuarioDesktop, editarUsuarioMobile].forEach((button) => {
        if (button) {
          button.addEventListener("click", (e) => {
            if (navigator.onLine) {
              window.location.href = `https://dosxdos.app.iidos.com/dosxdos.php?modulo=editarUsuario&id=${usuario.id}`;
            } else {
              showAlertMessage("No es posible acceder a las opciones de edición de usuario sin conexión a internet");
            }
          });
        }
      });

      // Logout Buttons
      const cerrarSesionDesktop = document.getElementById("cerrarSesionDesktop");
      const cerrarSesionMobile = document.getElementById("cerrarSesionMobile");

      [cerrarSesionDesktop, cerrarSesionMobile].forEach((button) => {
        if (button) {
          button.addEventListener("click", () => {
            closeSidebar(); // Close the sidebar first
            cerrarSesion(); // Then proceed with logout
          });
        }
      });
    }

    // Function to close the sidebar
    function closeSidebar() {
      const mobileMenu = document.getElementById("mobileMenu");
      const hamburgerTop = document.getElementById("hamburgerTop");
      const hamburgerMiddle = document.getElementById("hamburgerMiddle");
      const hamburgerBottom = document.getElementById("hamburgerBottom");

      if (mobileMenu) {
        mobileMenu.classList.add("translate-x-full");

        // Reset hamburger icon colors and position
        if (hamburgerTop && hamburgerMiddle && hamburgerBottom) {
          // Remove white background
          hamburgerTop.classList.remove("bg-white");
          hamburgerMiddle.classList.remove("bg-white");
          hamburgerBottom.classList.remove("bg-white");

          // Add dark background
          hamburgerTop.classList.add("bg-gray-900");
          hamburgerMiddle.classList.add("bg-gray-900");
          hamburgerBottom.classList.add("bg-gray-900");

          // Reset transforms
          hamburgerTop.style.transform = "";
          hamburgerMiddle.style.opacity = "1";
          hamburgerBottom.style.transform = "";
        }
      }
    }

    // Initialize the menu functionality 
    function initializeApplication() {
      // Set up menu interactions
      setupMenuInteractions();
      setupUserActions();

      // Populate user information if available
      if (usuario && usuario.nombre) {
        const nombreUsuarioDesktop = document.getElementById("nombreUsuarioDesktop");
        const nombreUsuarioMobile = document.getElementById("nombreUsuarioMobile");
        const imagenUsuarioDesktop = document.getElementById("imagenUsuarioDesktop");
        const imagenUsuarioMobile = document.getElementById("imagenUsuarioMobile");

        // Update usernames
        if (nombreUsuarioDesktop) nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile) nombreUsuarioMobile.textContent = usuario.nombre;

        // Update profile images
        if (usuario.imagen !== "0") {
          if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
          if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }
      }
    }

    // Prevent accidental page navigation on mobile devices
      function preventUnintendedNavigation() {
        // Disable default touch actions that might cause page navigation
        const mapContainer = document.getElementById('map');

        if (mapContainer) {
          // Prevent default touch behaviors
          mapContainer.addEventListener('touchstart', (e) => {
            e.preventDefault();
          }, { passive: false });

          mapContainer.addEventListener('touchmove', (e) => {
            e.preventDefault();
          }, { passive: false });

          // Prevent back/forward navigation on swipe
          window.addEventListener('touchstart', (e) => {
            // Track initial touch point
            window.touchStartX = e.touches[0].clientX;
            window.touchStartY = e.touches[0].clientY;
          }, { passive: true });

          window.addEventListener('touchend', (e) => {
            if (!window.touchStartX || !window.touchStartY) return;

            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const deltaX = touchEndX - window.touchStartX;
            const deltaY = touchEndY - window.touchStartY;

            // Check if the swipe is more horizontal or vertical
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
              // Horizontal swipe detected
              e.preventDefault();
            }

            // Reset touch tracking
            window.touchStartX = null;
            window.touchStartY = null;
          }, { passive: false });

          // Prevent pull-to-refresh on some mobile browsers
          document.body.style.overscrollBehavior = 'none';
        }
      }

      // Call the prevention function when the page loads
      document.addEventListener('DOMContentLoaded', preventUnintendedNavigation);
  </script>
  <script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
  <script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>
</body>

</html>