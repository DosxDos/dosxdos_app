<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Rutas</title>
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logoPwa256.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDojih1XShuEEmyRVE8FYOGvJn37blq0ng"></script>
</head>

<body id="body" class="bg-gray-100 overflow-hidden relative h-screen flex flex-col">
  <div id="loader" class="displayOn">
    <span class="loader"></span>
  </div>

  <!-- Navigation -->
  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden xl:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 xl:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden xl:flex items-center space-x-8">
        <!-- Navigation items will be dynamically created by createDesktopNavigation() -->

        <!-- Desktop Menu Notifications Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="desktopBellContainer">
          <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
          <span id="desktopNotificationCount"
            class="absolute top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="xl:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="mobileBellContainer">
          <img id="bellMobile" src="https://dosxdos.app.iidos.com/img/bell2.png"
            class="w-8 text-gray-900 object-contain mt-2" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-0 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Mobile Menu Button -->
        <button id="menuButton" class="xl:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

    </div>

    <div id="opcionesMenu"
      class="xl:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
      <div class="absolute inset-0 z-0"
        style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain; opacity: 0.7;">
      </div>
      <!-- User Profile Section -->
      <div class="px-8 py-4 mt-16 relative z-10">
        <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
          <!-- Profile image -->
          <div
            class="absolute left-0 w-28 h-28 rounded-full overflow-hidden border-4 border-white bg-gradient-to-br from-red-50 to-white flex items-center justify-center shadow-xl"
            style="transform: translateX(-15%);">
            <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
              class="w-full h-full object-cover" alt="Profile"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
            <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="ml-28 flex items-center py-4">
            <!-- User name -->
            <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
            <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
            <span class="text-black font-medium text-xl">!</span>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Navigation Links -->
      <nav class="px-8 pt-3 space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar mt-2">
        <!-- Dynamic menu items will be added here based on user role -->
      </nav>

      <!-- Mobile Menu Footer -->
      <div class="relative z-10">
        <div class="website-divider-container-734167" style="height: 100px; overflow: visible">
          <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
            preserveAspectRatio="none" style="bottom: -20px">
            <path
              d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
              style="fill: #ffffff"></path>
            <path
              d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.5"></path>
            <path
              d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.25"></path>
          </svg>
        </div>
      </div>

      <!-- User Actions -->
      <div class="relative z-10 mt-auto px-8 pb-6 bg-white shadow-lg flex justify-center space-x-6 pb-2 rounded-t-xl">
        <!-- Edit Button -->
        <button id="editarUsuarioMobile"
          class="flex items-center justify-center w-14 h-14 bg-white border-2 border-red-500 rounded-full hover:bg-red-100 transition-all duration-300">
          <svg class="w-8 h-8 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>

        <!-- Logout Button -->
        <button id="cerrarSesionMobile"
          class="flex items-center justify-center w-14 h-14 bg-red-600 rounded-full transition-all duration-300">
          <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        </button>
      </div>
    </div>
    </div>
  </section>

  <!-- Back Button and Map Title  -->
  <div class="w-full bg-white shadow-md fixed top-24 z-20">
    <div class="flex items-center justify-between px-6 py-4">
      <button id="volverBtn" class="text-red-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd" />
        </svg>
      </button>
      <h1 id="ruta-title" class="text-xl font-bold text-gray-800 text-center">
        MAPA DE RUTA
      </h1>
      <div class="w-8"></div>
    </div>
  </div>

  <!-- Map Container -->
  <div class="flex-1 relative map-container">
    <div id="map" class="w-full h-full z-10"></div>
  </div>

  <!-- modal block -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-auto overflow-hidden">
      <!-- Modal Header with improved layout -->
      <div class="relative bg-red-600 p-4 text-white">
        <div class="absolute inset-0 opacity-70" style="
              background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg');
              background-size: contain;
            "></div>

        <!-- Title and Close Button Row -->
        <div class="relative z-10 flex justify-between items-start">
          <div>
            <h2 id="point-id" class="text-xl font-bold">11820</h2>
            <h3 id="point-name" class="text-lg font-medium mt-1">
              Perfumes.es Fariones
            </h3>
          </div>

          <button id="modal-close" class="p-1 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Info Grid -->
        <div class="mt-4 relative z-10 grid grid-cols-2 gap-y-2 gap-x-10 text-sm">
          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">Estado:</div>
            <div id="point-estado" class="font-medium">Pendiente</div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">Cliente:</div>
            <div id="point-cliente" class="font-medium">
              COMERCIAL FARLABO ESPAÑA, S.L.
            </div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">OT CRM:</div>
            <div id="point-ot-crm" class="font-medium">31280</div>
          </div>

          <div class="flex gap-2">
            <div class="text-white opacity-80 font-medium">OT Navision:</div>
            <div id="point-ot-navision" class="font-medium">24292</div>
          </div>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="p-4 space-y-3">
        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-sm text-gray-700 font-medium">Dirección</p>
          <p id="point-address" class="text-gray-900 font-medium"></p>
        </div>

        <div class="flex gap-3">
          <div class="bg-gray-100 p-3 rounded-lg flex-1">
            <p class="text-sm text-gray-700 font-medium">Latitud</p>
            <p id="point-lat" class="text-gray-900 text-sm font-medium"></p>
          </div>
          <div class="bg-gray-100 p-3 rounded-lg flex-1">
            <p class="text-sm text-gray-700 font-medium">Longitud</p>
            <p id="point-lng" class="text-gray-900 text-sm font-medium"></p>
          </div>
        </div>

        <!-- Type and Observations -->
        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-sm text-gray-700 font-medium">Tipo</p>
          <p id="point-tipo" class="text-gray-900 font-medium"></p>
        </div>

        <div class="bg-gray-100 p-3 rounded-lg">
          <p class="text-sm text-gray-700 font-medium">Observaciones</p>
          <p id="point-observaciones" class="text-gray-900 font-medium"></p>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="p-4 bg-gray-100 flex gap-3">
        <button id="navigate-button"
          class="flex-1 h-12 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z"
              clip-rule="evenodd" />
          </svg>
          Navegar
        </button>
        <button id="report-button"
          class="flex-1 h-12 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-lg transition-colors flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd" />
          </svg>
          Reportar
        </button>
      </div>
    </div>
  </div>
</body>
<script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
<script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
<script src="https://dosxdos.app.iidos.com/js/navigation.js"></script>
<script>
  let montador;
  const ruta = localStorage.getItem("ruta");
  const nombreRuta = localStorage.getItem("nombreRuta");
  const $loader = document.getElementById("loader");
  const $body = document.getElementById("body");
  let bounds;
  let marcadores = [];
  let notificacionesSinAcpetarNumero = 0;

  function scrollToTop() {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
  }

  /* LOADER */
  function loaderOn() {
    scrollToTop();
    $loader.classList.remove("displayOff");
    $loader.classList.add("displayOn");
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
  }

  function loaderOff() {
    setTimeout(() => {
      $loader.classList.remove("displayOn");
      $loader.classList.add("displayOff");
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
    }, 1000);
  }

  // Setup route title and back button
  if (nombreRuta) {
    document.getElementById("ruta-title").innerText = nombreRuta;
  } else if (ruta) {
    document.getElementById("ruta-title").innerText = ruta;
  } else {
    document.getElementById("ruta-title").innerText = "MAPA DE RUTA";
  }

  document.getElementById("volverBtn").addEventListener("click", () => {
    window.location.href =
      "https://dosxdos.app.iidos.com/ruta_montador.html";
  });

  document.getElementById("modal-close").addEventListener("click", () => {
    document.getElementById("modal").classList.add("hidden");
  });

  let lineasRuta = [];

  async function lineas() {
    loaderOn();
    const Arrayusuario = await leerDatos("dosxdos", "usuario");
    usuario = Arrayusuario[0];
    montador = usuario.cod;
    sinc = await sincronizarDb2();
    sinc
      ? console.log("Base de datos sincronizada")
      : console.error("Error al sincronizar la base de datos");
    const TotalLineas = await leerDatos("dosxdos", "lineas");
    if (TotalLineas) {
      lineasRuta = TotalLineas.filter((objeto) => objeto.Proyecto === ruta);
      console.log("Lineas: ", lineasRuta);
      storageLineas = JSON.stringify(lineasRuta);
      localStorage.setItem("lineasRuta", storageLineas);
      await initMap(lineasRuta);
      sincronizador();

      try {
        // Detailed debugging for notifications
        console.log("Attempting to synchronize notifications");
        const sincronizacionDeNotificaciones = await sincronizarNotificaciones();
        console.log("Notification synchronization result:", sincronizacionDeNotificaciones);

        if (sincronizacionDeNotificaciones) {
          console.log("Calling notificar() function");
          await notificar();
        } else {
          console.warn("Notification synchronization failed");
        }
      } catch (error) {
        console.error("Error processing notifications:", error);
      }
    }
    loaderOff();
  }

  let map;
  const modal = document.getElementById("modal");
  const pointName = document.getElementById("point-name");
  const pointAddress = document.getElementById("point-address");
  const pointLat = document.getElementById("point-lat");
  const pointLng = document.getElementById("point-lng");
  const navigateButton = document.getElementById("navigate-button");
  const reportButton = document.getElementById("report-button");
  const closeButton = document.getElementById("close-button");

  function initMap(lineasInicio) {
    bounds = new google.maps.LatLngBounds();
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 8,
      gestureHandling: "greedy",
      fullscreenControl: false,
    });

    // Create legend div with slide animation
    const legendDiv = document.createElement('div');
    legendDiv.style.position = 'absolute';
    legendDiv.style.bottom = '20px';
    legendDiv.style.left = '0';
    legendDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
    legendDiv.style.borderRadius = '0 8px 8px 0';
    legendDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';
    legendDiv.style.padding = '12px 12px 12px 20px';
    legendDiv.style.width = '200px';
    legendDiv.style.zIndex = '1000';
    legendDiv.style.transition = 'transform 0.25s ease';
    legendDiv.style.display = 'flex';
    legendDiv.style.alignItems = 'center';
    legendDiv.style.justifyContent = 'space-between';
    legendDiv.style.height = '100px';
    legendDiv.style.transform = 'translateX(0)';
    legendDiv.style.boxSizing = 'border-box';

    // Content for the legend
    const legendContent = document.createElement('div');
    legendContent.style.flex = '1';

    // Add title
    const title = document.createElement('div');
    title.textContent = 'Leyenda de Marcadores';
    title.style.marginBlock = '10px';
    title.style.fontWeight = 'bold';
    title.style.color = '#333';
    legendContent.appendChild(title);

    // Add markers
    const items = [
      {
        svg: `<svg width="24" height="24" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="#4A90E2" stroke-width="1" fill="white"/>
        <path d="M12 4.248l2.136 4.874 5.44.397-4.184 3.538 1.282 5.015L12 15.65l-4.674 3.422 1.282-5.015-4.184-3.538 5.44-.397L12 4.248z" fill="#4A90E2"/>
      </svg>`,
        text: 'Nueva línea'
      },
      {
        svg: `<svg width="24" height="24" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="#DC2626" stroke-width="1" fill="white"/>
        <line x1="12" y1="7" x2="12" y2="13" stroke="#DC2626" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="16.5" r="1.5" fill="#DC2626"/>
      </svg>`,
        text: 'Línea urgente'
      }
    ];

    items.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.style.display = 'flex';
      itemDiv.style.alignItems = 'center';
      itemDiv.style.marginBottom = '5px';

      const icon = document.createElement('div');
      icon.innerHTML = item.svg;
      icon.style.marginRight = '10px';

      const text = document.createElement('div');
      text.textContent = item.text;
      text.style.color = '#666';

      itemDiv.appendChild(icon);
      itemDiv.appendChild(text);
      legendContent.appendChild(itemDiv);
    });

    // Toggle chevron/arrow
    const toggleArrow = document.createElement('div');

    toggleArrow.innerHTML = `
  <svg width="28" height="32" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="15 18 9 12 15 6"></polyline>
  </svg>
  `;
    toggleArrow.style.cursor = 'pointer';
    toggleArrow.style.display = 'flex';
    toggleArrow.style.alignItems = 'center';
    toggleArrow.style.justifyContent = 'center';
    toggleArrow.style.padding = '5px';
    toggleArrow.style.width = '28px';

    // Add components to legend
    legendDiv.appendChild(legendContent);
    legendDiv.appendChild(toggleArrow);

    // Add to map
    map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legendDiv);

    // Collapse/expand functionality using translateX
    let isExpanded = true;

    function toggleLegend() {
      if (isExpanded) {
        // Calculate how much to slide based on the legend width minus the space for arrow
        const slideAmount = legendDiv.offsetWidth - 50; // Leave room for arrow and padding
        legendDiv.style.transform = `translateX(-${slideAmount}px)`;
        toggleArrow.innerHTML = `
  <svg width="28" height="32" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="9 18 15 12 9 6"></polyline>
  </svg>
`;
      } else {
        // Slide in
        legendDiv.style.transform = 'translateX(0)';
        toggleArrow.innerHTML = `
        <svg width="28" height="32" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      `;
      }
      isExpanded = !isExpanded;
    }

    // Click events
    toggleArrow.addEventListener('click', toggleLegend);
    toggleArrow.addEventListener('touchend', function (e) {
      e.preventDefault();
      toggleLegend();
    });

    // Auto-collapse on map interaction
    google.maps.event.addListener(map, 'dragstart', function () {
      if (isExpanded) {
        toggleLegend();
      }
    });

    const mapDiv = document.getElementById('map');
    if (mapDiv) {
      mapDiv.addEventListener('touchstart', function () {
        if (isExpanded) {
          toggleLegend();
        }
      }, { passive: true });
    }

    renderPins(lineasInicio);
  }

  function renderPins(lineasRender) {
    return new Promise((resolve, reject) => {
      try {
        const offset = 0.00007;
        let i = 0;
        for (const point of lineasRender) {
          const nameToDisplay =
            point.NombrePuntoVenta || "Nombre del punto de venta no disponible";
          const firma = point.Firma || "Sin firma";
          const observaciones = point.Observaciones || "Sin observaciones";
          const nombreCliente =
            point.NombreCliente || "Nombre del cliente no disponible";
          const concatenatedName = `${point.Linea} - ${nameToDisplay} - ${firma} - ${nombreCliente} - OT CRM: ${point.OT} - OT Navision: ${point.Navision_OT} - ${point.TipoOT} - ${observaciones}`;
          const lat = point.lat ? parseFloat(point.lat) : null;
          const lng = point.lng ? parseFloat(point.lng) : null;

          if (lat !== null && lng !== null) {
            const adjustedLat = lat + i * offset;
            const adjustedLng = lng + i * offset;

            // Custom marker icon logic
            let markerIcon = null;
            if (point.urgente === true || point.urgente === "true") {
              // Red circular border with alert icon
              markerIcon = {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
                <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='44' height='44' fill='none' stroke='red' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
                  <circle cx='12' cy='12' r='10' fill='white' stroke='red' stroke-width='2'/>
                  <path d='M12 7v6' stroke='red' stroke-width='2'/>
                  <path d='M12 16h0.01' stroke='red' stroke-width='2'/>
                </svg>`),
                scaledSize: new google.maps.Size(48, 48),
                anchor: new google.maps.Point(24, 24)
              };
            } else if (point.nueva === true || point.nueva === "true") {
              // Blue circular border with properly centered star icon
              markerIcon = {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='44' height='44'>
  <!-- White background circle with gradient and shadow -->
  <circle 
    cx='12' 
    cy='12' 
    r='10' 
    fill='url(#backgroundGradient)' 
    stroke='#4A90E2' 
    stroke-width='1.5'
  />
  
  <!-- Gradient definition -->
  <defs>
    <linearGradient id="backgroundGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#F0F0F0;stop-opacity:1" />
    </linearGradient>
  </defs>
  
  <!-- Star path with a more refined look -->
  <path 
    d='M12 4.248l2.136 4.874 5.44.397-4.184 3.538 1.282 5.015L12 15.65l-4.674 3.422 1.282-5.015-4.184-3.538 5.44-.397L12 4.248z' 
    fill='#4A90E2'
    stroke='#3A7CA5'
    stroke-width='0.5'
  />
</svg>`),
                scaledSize: new google.maps.Size(48, 48),
                anchor: new google.maps.Point(24, 24)
              };
            }

            const marker = new google.maps.Marker({
              position: { lat: adjustedLat, lng: adjustedLng },
              map: map,
              title: concatenatedName,
              icon: markerIcon
            });
            bounds.extend(marker.position);
            marker.addListener("click", () => {
              updateModalContent(point, adjustedLat, adjustedLng);
              modal.classList.remove("hidden");
              modal.classList.add("flex");
              map.setZoom(19);
              map.setCenter(marker.getPosition());

              navigateButton.onclick = () => {
                if (lat !== null && lng !== null) {
                  const url = `https://www.google.com/maps/dir/?api=1&destination=${adjustedLat},${adjustedLng}`;
                  window.open(url, "_blank");
                } else {
                  alert("Las coordenadas no están disponibles para este punto.");
                }
              };
              reportButton.onclick = () => {
                localStorage.setItem("linea", point.Linea);
                localStorage.setItem("lineaActividad", point.Linea);
                localStorage.setItem("ot", point.OT);
                localStorage.setItem("cliente", point.Cliente);
                localStorage.setItem("nombreCliente", point.NombreCliente);
                window.location.href = "https://dosxdos.app.iidos.com/linea_montador.html";
              };
            });

            marker.customId = point.Linea;
            marcadores.push(marker);
          } else {
            console.log(`Missing coordinates for point: ${JSON.stringify(point)}`);
            const alertMessage = `Fallo al cargar la ubicación para la línea: `;
            showAlert(alertMessage, concatenatedName);
            i++;
            continue;
          }
          i++;
        }
        map.fitBounds(bounds);
        resolve(true);
      } catch (error) {
        console.error(error);
        showAlertMessage("Error al renderizar los puntos en el mapa, por favor carga de nuevo el mapa para intentarlo nuevamente");
        resolve(false);
      }
    });
  }

  function showAlert(message, concatenatedName) {
    const alertBox = document.createElement("div");
    alertBox.className =
      "bg-red-100 border-l-4 border-red-600 text-red-800 p-4 rounded-lg shadow-md relative mb-2 pr-10";
    alertBox.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm">${message} ${concatenatedName}</p>
            </div>
          </div>
          <button class="absolute top-2 right-2 text-red-600 hover:text-red-800">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;

    alertBox.querySelector("button").addEventListener("click", () => {
      alertBox.remove();
    });

    document.getElementById("alert-container").appendChild(alertBox);

    // Auto-dismiss after 10 seconds
    setTimeout(() => {
      if (alertBox.parentNode) {
        alertBox.remove();
      }
    }, 10000);
  }

  function showAlertMessage(message) {
    const alertBox = document.createElement("div");
    alertBox.className =
      "bg-red-100 border-l-4 border-red-600 text-red-800 p-4 rounded-lg shadow-md relative mb-2 pr-10";
    alertBox.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm">${message}</p>
            </div>
          </div>
          <button class="absolute top-2 right-2 text-red-600 hover:text-red-800">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `;

    alertBox.querySelector("button").addEventListener("click", () => {
      alertBox.remove();
    });

    document.getElementById("alert-container").appendChild(alertBox);

    // Auto-dismiss after 10 seconds
    setTimeout(() => {
      if (alertBox.parentNode) {
        alertBox.remove();
      }
    }, 10000);
  }

  // Init the menu after loading the map and other components
  lineas().then(() => {
    // Dynamically create navigation based on user role
    createDesktopNavigation(usuario.clase);
    // Setup desktop and mobile navigation
    setupMenu(usuario.clase);

    // Setup menu interactions
    setupMenuInteractions();
    setupUserActions();
    setupGlobalMenuClosing();

    updateUserDisplay();

    // Update the user information in the new UI elements
    const nombreUsuarioDesktop = document.getElementById('nombreUsuarioDesktop');
    const nombreUsuarioMobile = document.getElementById('nombreUsuarioMobile');
    const imagenUsuarioDesktop = document.getElementById('imagenUsuarioDesktop');
    const imagenUsuarioMobile = document.getElementById('imagenUsuarioMobile');

    if (nombreUsuarioDesktop) nombreUsuarioDesktop.textContent = usuario.nombre;
    if (nombreUsuarioMobile) nombreUsuarioMobile.textContent = usuario.nombre;

    if (usuario.imagen !== "0") {
      if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
      if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
    }
  });

  function fetchRutas() {
    return new Promise((resolve, reject) => {
      url =
        "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" +
        montador;
      fetch(url)
        .then((res) => {
          if (res.ok) {
            return res.json();
          } else {
            mensaje =
              "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
            showAlertMessage(mensaje);
          }
        })
        .then((res) => {
          if (res[0]) {
            const request = indexedDB.open("dosxdos");
            request.onsuccess = (event) => {
              const db = event.target.result;
              const transaction = db.transaction("rutas", "readwrite");
              const datosStore = transaction.objectStore("rutas");
              const clearRequest = datosStore.clear();
              clearRequest.onsuccess = (clearEvent) => {
                const datos = res[1];
                datos.forEach((item) => {
                  datosStore.add(item);
                });
                resolve(true);
              };
              clearRequest.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                console.error(error);
                showAlertMessage(mensaje);
              };
            };
            request.onerror = (event) => {
              error = event.target.error;
              mensaje = `ERROR: ` + error;
              console.error(error);
              showAlertMessage(mensaje);
            };
          } else {
            mensaje = res[1];
            console.error(res);
            showAlertMessage(mensaje);
          }
        })
        .catch((res) => {
          mensaje = "Sin conexión: " + res.message;
          localStorage.setItem("error", res);
          console.error(res);
          showAlertMessage(mensaje);
        });
    });
  }

  function fetchLineas(vectorRutas) {
    return new Promise(async (resolve, reject) => {
      try {
        console.log(vectorRutas);
        const promises = vectorRutas.map(async (objeto) => {
          const url =
            "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
            objeto.cod;
          const res = await fetch(url);
          if (!res.ok) {
            throw new Error(
              `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
            );
          }
          const resJson = await res.json();
          if (resJson[0]) {
            const db = await new Promise((dbResolve, dbReject) => {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                dbResolve(db);
              };
              request.onerror = (event) => {
                dbReject(
                  new Error(
                    `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                  )
                );
              };
            });
            const transaction = db.transaction("lineas", "readwrite");
            const datosStore = transaction.objectStore("lineas");
            const datos = resJson[1];
            if (Array.isArray(datos)) {
              datos.forEach((item) => {
                datosStore.add(item);
              });
            } else {
              datosStore.add(datos);
            }
          } else {
            throw new Error(
              `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
            );
          }
        });
        await Promise.all(promises);
        resolve(true);
      } catch (err) {
        console.error(err);
        localStorage.setItem("error", error);
        resolve(false);
      }
    });
  }

  async function sincronizarDb() {
    try {
      if (navigator.onLine) {
        const fRutas = await fetchRutas();
        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));
        const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
        if (limpiarLineas) {
          lineasCrm = await fetchLineas(rutas);
          if (lineasCrm) {
            mensaje = true;
            localStorage.setItem("sinc", mensaje);
            window.location.href =
              "https://dosxdos.app.iidos.com/mapa_ruta.html";
          } else {
            showAlertMessage(
              "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
            );
          }
        }
      }
    } catch (error) {
      const mensaje =
        "No se ha sincronizado la base de datos: " + error.message;
      console.error(error);
      localStorage.setItem("error", error);
      localStorage.setItem("mensaje", mensaje);
      window.location.href = "https://dosxdos.app.iidos.com/mapa_ruta.html";
    }
  }

  window.addEventListener("pageshow", (e) => {
    console.log("Carga completa de los elementos de la página no fetch");
    let mensaje = localStorage.getItem("mensaje");
    if (mensaje && mensaje !== null) {
      showAlertMessage(mensaje);
      localStorage.removeItem("mensaje");
    }
    let login = localStorage.getItem("login");
    if (!login || login === null) {
      window.location.href = "https://dosxdos.app.iidos.com/index.html";
    }
  });

  async function sincronizarDb2() {
    return new Promise(async (resolve, reject) => {
      try {
        const fRutas = await fetchRutas();
        rutas = await leerDatos("dosxdos", "rutas");
        rutas = rutas.map((objeto) => ({
          cod: objeto["No."],
          nombre: objeto["Descripcion"],
        }));
        const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
        if (limpiarLineas) {
          lineasCrm = await fetchLineas(rutas);
          if (lineasCrm) {
            resolve(true);
          } else {
            resolve(false);
          }
        }
      } catch (error) {
        console.error(error);
        resolve(false);
      }
    });
  }

  function fetchLineasRuta(ruta) {
    return new Promise(async (resolve, reject) => {
      try {
        const url =
          "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" + ruta;
        const res = await fetch(url);
        if (!res.ok) {
          console.error(res);
          throw new Error(
            `Error en la función fetchLineasRuta al solicitar las líneas de la ruta`
          );
        }
        const resJson = await res.json();
        if (resJson[0]) {
          const datos = resJson[1];
          resolve(datos);
        } else {
          console.error(resJson);
          throw new Error(
            `Error en la función fetchLineasRuta al solicitar las líneas de la ruta`
          );
        }
      } catch (err) {
        console.error(err);
        localStorage.setItem("error", error);
        resolve(false);
      }
    });
  }

  const compararDatos = () => {
    return new Promise((resolve, reject) => {
      try {
        marcadoresAccion = {};
        marcadoresAccion.data = [];
        marcadoresAccion.accion = "none";
        marcadoresAccion.lineasRuta = lineasRuta.length;
        marcadoresAccion.marcadores = marcadores.length;
        if (lineasRuta.length != marcadores.length) {
          if (lineasRuta.length < marcadores.length) {
            for (const marcador of marcadores) {
              let validarMarcador = true;
              for (const linea of lineasRuta) {
                if (linea.Linea == marcador.customId) {
                  validarMarcador = false;
                  break;
                }
              }
              if (validarMarcador) {
                showAlertMessage(
                  `La línea ${marcador.customId} ha sido reportada o eliminada de la ruta`
                );
                marcadoresAccion.data.push(marcador);
              }
            }
            marcadoresAccion.accion = "delete";
          } else {
            for (const linea of lineasRuta) {
              let validarLinea = true;
              for (const marcador of marcadores) {
                if (linea.Linea == marcador.customId) {
                  validarLinea = false;
                  break;
                }
              }
              if (validarLinea) {
                showAlertMessage(
                  `La línea ${linea.Linea} ha sido agregada __ ${linea.NombrePuntoVenta} __ ${linea.DireccionPuntoVenta}`
                );
                marcadoresAccion.data.push(linea);
              }
            }
            marcadoresAccion.accion = "add";
          }
        }
        resolve(marcadoresAccion);
      } catch (error) {
        console.error(error);
        showAlertMessage(
          "Error en el sincronizador al eliminar líneas ya realizadas, por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
        );
        resolve(false);
      }
    });
  };

  const deleteMarcadores = (marcadoresDelete) => {
    return new Promise((resolve, reject) => {
      try {
        let i = 0;
        for (const marcador of marcadores) {
          for (const marcadorDelete of marcadoresDelete) {
            if (marcadorDelete.customId == marcador.customId) {
              marcadores.splice(i, 1);
              marcador.setMap(null);
              resolve(true);
              break;
            }
          }
          i++;
        }
        resolve(false);
      } catch (error) {
        console.error(error);
        alerta(
          "Error en el sincronizador al eliminar líneas ya realizadas, por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
        );
        resolve(false);
      }
    });
  };

  const deleteAllMarcadores = () => {
    return new Promise((resolve, reject) => {
      try {
        for (const marcador of marcadores) {
          marcador.setMap(null);
        }
        marcadores = [];
        resolve(true);
      } catch (error) {
        console.error(error);
        alerta(
          "Error en el sincronizador al eliminar líneas para actualizar el mapa completo, error en deleteAllMarcadores. Por favor vuelve a cargar de nuevo el mapa para verlo actualizado"
        );
        resolve(false);
      }
    });
  };

  const sincronizador = async () => {
    try {
      lineasRuta = await fetchLineasRuta(ruta);
      if (lineasRuta) {
        const comparacion = await compararDatos();
        console.log(comparacion);
        if (comparacion.data.length) {
          if (comparacion.accion == "delete") {
            deleteMarcadores(comparacion.data);
            if (deleteMarcadores) {
              alerta("El mapa ha sido actualizado");
            }
          } else if (comparacion.accion == "add") {
            const deleteMarcadores = await deleteAllMarcadores();
            if (deleteMarcadores) {
              const render = await renderPins(lineasRuta);
              if (render) {
                alerta("El mapa ha sido actualizado");
              } else {
                alerta(
                  "Error, el mapa no ha sido actualizado, por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
                );
              }
            } else {
              alerta(
                "Error, el mapa no ha sido actualizado, por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
              );
            }
          }
        }
      } else {
        alerta(
          "Error en el sincronizador para actualizar el mapa, error en fetchLineas. Por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
        );
      }
      intervaloAleatorio =
        Math.floor(Math.random() * (6000 - 5000 + 1)) + 5000;
      setTimeout(sincronizador, intervaloAleatorio);
    } catch (error) {
      console.error(error);
      alerta(
        "Error en el sincronizador del mapa. Por favor intenta cargar el mapa nuevamente para ver los actuales cambios"
      );
    }
  };

  // Add event listeners for modal closing
  document.addEventListener("DOMContentLoaded", function () {
    // Close modal when clicking outside of it
    const modal = document.getElementById("modal");
    modal.addEventListener("click", function (e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close modal with the X button
    document
      .getElementById("modal-close")
      .addEventListener("click", closeModal);
  });

  // Function to close the modal
  function closeModal() {
    const modal = document.getElementById("modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  // Function to format point data nicely
  function formatPointData(concatenatedName) {
    // Split the concatenated string by hyphens and handle each part
    const parts = concatenatedName.split(" - ");

    // Create a formatted HTML string with line breaks and proper labels
    let formattedHTML = "";

    if (parts.length >= 1)
      formattedHTML += `<div class="font-bold">${parts[0]}</div>`;
    if (parts.length >= 2)
      formattedHTML += `<div class="mt-1">${parts[1]}</div>`;

    // Add remaining parts with proper labels
    const labels = [
      "Estado",
      "Cliente",
      "OT CRM",
      "OT Navision",
      "Tipo",
      "Observaciones",
    ];
    for (let i = 2; i < parts.length && i - 2 < labels.length; i++) {
      formattedHTML += `<div class="mt-1 text-sm"><span class="text-gray-500">${labels[i - 2]
        }:</span> ${parts[i]}</div>`;
    }

    return formattedHTML;
  }

  function updateModalContent(point, adjustedLat, adjustedLng) {
    // Parse the point ID and name
    const id = point.Linea || "";
    document.getElementById("point-id").textContent = id;
    document.getElementById("point-name").textContent =
      point.NombrePuntoVenta || "Sin nombre";

    // Fill in all the specific fields
    document.getElementById("point-estado").textContent =
      point.Estado || "-";
    document.getElementById("point-cliente").textContent =
      point.NombreCliente || "-";
    document.getElementById("point-ot-crm").textContent = point.OT || "-";
    document.getElementById("point-ot-navision").textContent =
      point.Navision_OT || "-";
    document.getElementById("point-tipo").textContent =
      point.TipoOT || point.TipoTrabajo || "-";
    document.getElementById("point-observaciones").textContent =
      point.Observaciones || "-";

    // Address and coordinates
    document.getElementById("point-address").textContent =
      point.DireccionPuntoVenta || "Dirección no disponible";
    document.getElementById("point-lat").textContent = adjustedLat;
    document.getElementById("point-lng").textContent = adjustedLng;

    // First, let's make the modal relative for positioning
    const modalContent = document.querySelector(".modal .bg-red-600");
    if (modalContent) {
      modalContent.style.position = "relative";
    }

    // Find point-id element which we know exists
    const pointIdElement = document.getElementById("point-id");

    // Always remove any existing badges first
    const existingBadgeContainer = document.getElementById("badge-container");
    if (existingBadgeContainer) {
      existingBadgeContainer.remove();
    }

    // Only create new badges if the properties are actually true
    if ((point.urgente === true || point.urgente === "true") ||
      (point.nueva === true || point.nueva === "true")) {

      // Create container for badges
      const container = document.createElement("div");
      container.id = "badge-container";
      container.style.position = "absolute";
      container.style.top = "0px";
      container.style.marginLeft = "25%";

      // Add badges to container based on individual properties
      if (point.urgente === true || point.urgente === "true") {
        const urgentBadge = document.createElement("span");
        urgentBadge.textContent = "URGENTE";
        urgentBadge.style.backgroundColor = "#FFFFFF";
        urgentBadge.style.color = "#dc2626";
        urgentBadge.style.fontSize = "10px";
        urgentBadge.style.fontWeight = "bold";
        urgentBadge.style.padding = "3px 6px";
        urgentBadge.style.marginInline = '5px';
        urgentBadge.style.borderRadius = "4px";
        container.appendChild(urgentBadge);
      }

      if (point.nueva === true || point.nueva === "true") {
        const newBadge = document.createElement("span");
        newBadge.textContent = "NUEVA";
        newBadge.style.backgroundColor = "#3b82f6";
        newBadge.style.color = "#FFFFFF";
        newBadge.style.fontSize = "10px";
        newBadge.style.fontWeight = "bold";
        newBadge.style.padding = "3px 6px";
        newBadge.style.borderRadius = "4px";
        container.appendChild(newBadge);
      }

      // Insert badges right after point-id (only if we have badges to show)
      if (container.childNodes.length > 0) {
        pointIdElement.parentNode.insertBefore(container, pointIdElement.nextSibling);
      }
    }
  }

  // Add event listeners for modal closing
  document.addEventListener("DOMContentLoaded", function () {
    // Close modal when clicking outside of it
    const modal = document.getElementById("modal");
    modal.addEventListener("click", function (e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close modal with the X button
    document
      .getElementById("modal-close")
      .addEventListener("click", closeModal);
  });

  // Function to close the modal
  function closeModal() {
    const modal = document.getElementById("modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  // Prevent accidental page navigation on mobile devices
  function preventUnintendedNavigation() {
    // Disable default touch actions that might cause page navigation
    const mapContainer = document.getElementById('map');

    if (mapContainer) {
      // Disable touch actions
      mapContainer.style.touchAction = 'none';

      // Prevent default behavior on touch events
      mapContainer.addEventListener('touchstart', (e) => {
        // Prevent default touch actions
        e.preventDefault();
      }, { passive: false });

      mapContainer.addEventListener('touchmove', (e) => {
        // Prevent default touch actions
        e.preventDefault();
      }, { passive: false });

      // Prevent browser's default swipe navigation
      document.addEventListener('touchmove', (e) => {
        // Prevent horizontal swipes
        if (Math.abs(e.touches[0].clientX - window.startX) > 10) {
          e.preventDefault();
        }
      }, { passive: false });

      // Track touch start position
      document.addEventListener('touchstart', (e) => {
        window.startX = e.touches[0].clientX;
        window.startY = e.touches[0].clientY;
      }, { passive: true });

      // Prevent pull-to-refresh and back/forward navigation
      document.body.style.overscrollBehavior = 'none';
    }

    // Prevent default touch actions on the entire body
    document.body.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive: false });
  }

  // Call the prevention function when the page loads
  document.addEventListener('DOMContentLoaded', preventUnintendedNavigation);

  // Additional prevention for Google Maps
  if (window.google && window.google.maps) {
    google.maps.event.addListenerOnce(map, 'idle', () => {
      map.setOptions({
        gestureHandling: 'none'
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const mapContainer = document.getElementById('map');

    if (mapContainer) {
      // Prevent default touch behaviors
      mapContainer.addEventListener('touchstart', (e) => {
        e.preventDefault();
      }, { passive: false });

      mapContainer.addEventListener('touchmove', (e) => {
        e.preventDefault();
      }, { passive: false });

      // Disable pull-to-refresh
      document.body.style.overscrollBehavior = 'none';
    }
  });

  function alerta(mensaje) {
    // Remove existing alert if present
    const existingAlert = document.querySelector("#customAlert");
    if (existingAlert) {
      existingAlert.remove();
    }

    // Create alert container
    const alertContainer = document.createElement("div");
    alertContainer.id = "customAlert";
    alertContainer.className =
      "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[85vw] md:w-[80vw] lg:w-[75vw]";
    alertContainer.style.top = "-100px";

    // Create alert content
    const alertContent = document.createElement("div");
    alertContent.className = `
    relative
    bg-white
    border-2 border-red-600
    rounded-lg
    shadow-lg
    p-4 md:p-5
    flex flex-col md:flex-row md:items-center gap-3 md:gap-4
  `;

    // Create close button
    const closeButton = document.createElement("button");
    closeButton.className =
      "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600 rounded-full p-1.5 transition-colors duration-200";
    closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

    // Create main content container for mobile layout
    const contentContainer = document.createElement("div");
    contentContainer.className =
      "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

    // Create icon with exclamation mark
    const iconContainer = document.createElement("div");
    iconContainer.className = "flex-shrink-0 text-red-600";
    iconContainer.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="10" />
  <path d="M12 7v6" />
  <path d="M12 16h0.01" />
</svg>
`;

    // Create message text
    const messageText = document.createElement("p");
    messageText.className = "text-gray-900 text-base md:text-lg flex-1";
    messageText.textContent = mensaje;

    // Assemble the content container
    contentContainer.appendChild(iconContainer);
    contentContainer.appendChild(messageText);

    // Assemble the alert
    alertContent.appendChild(closeButton);
    alertContent.appendChild(contentContainer);
    alertContainer.appendChild(alertContent);
    $body.appendChild(alertContainer);

    // Slide down animation
    requestAnimationFrame(() => {
      alertContainer.style.top = "56px";
    });

    // Add event listeners
    closeButton.addEventListener("click", () => {
      hideAlert(alertContainer);
    });

    // Hide loader if it exists
    loaderOff();
  }

  function hideAlert(alertContainer) {
    alertContainer.style.top = "-100px";

    setTimeout(() => {
      alertContainer.remove();
    }, 300);
  }

</script>
<script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>

</html>