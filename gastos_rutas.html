<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gastos Rutas</title>
    <style>
      #loader {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        z-index: 6000;
        background-color: rgba(0, 0, 0, 0.886);
        justify-content: center;
        align-items: center;
      }

      .loader {
        border: 4px solid #ffffff;
        border-top: 4px solid #d31216;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .displayOff {
        display: none;
      }
      .displayOn {
        display: flex;
      }

      body {
        overflow-x: hidden;
      }

      .oyh {
        overflow-y: hidden;
      }

      /* Message */
      .message-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 20px;
        background-color: white;
        z-index: 3000;
        overflow-y: auto;
      }

      .fade {
        animation: fade 0.5s;
      }

      @keyframes fade {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .feedback {
        color: red;
        font-size: 14px;
        margin-top: 5px;
      }

      .checkbox-item label {
        margin-left: 8px;
      }

      .selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .tag {
        background-color: #f1f1f1;
        padding: 5px 10px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .tag .tag-close {
        cursor: pointer;
        font-weight: bold;
        color: red;
      }

      #volver {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: red;
        padding: 12px;
        border-radius: 20%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3001;
      }

      #volver img {
        width: 24px;
        height: 24px;
      }

      /* Results Table Styles */
      .results-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: white;
        margin-bottom: 20px;
      }

      .results-table thead th {
        position: sticky;
        top: 0;
        background-color: #d31216;
        color: white;
        z-index: 10;
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
      }

      .results-table th,
      .results-table td {
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
      }

      .table-container {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .error-message {
        color: #d31216;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .action-buttons {
        margin-bottom: 20px;
      }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    id="body"
    class="bg-gray-100 text-black p-5 flex flex-col justify-center items-center my-auto"
  >
    <div id="loader" class="displayOn">
      <span class="loader"></span>
    </div>

    <div
      id="volver"
      onclick="goBack()"
      class="absolute top-5 left-5 flex items-center bg-red-600 p-3 rounded-[20%] cursor-pointer hover:bg-red-700"
    >
      <img
        src="https://dosxdos.app.iidos.com/img/back.png"
        alt="Volver Icon"
        class="w-7 h-7"
      />
    </div>

    <h1
      id="titulo"
      class="relative text-4xl mb-8 mt-16 text-black font-bold mx-auto"
    >
      Gastos Rutas
    </h1>

    <form id="gastosRutasForm" class="w-full max-w-lg mx-auto">
      <div class="mb-5 w-full">
        <label for="fechaInicial" class="block text-lg mb-2 font-semibold"
          >Fecha Inicial</label
        >
        <input
          type="date"
          id="fechaInicial"
          name="fechaInicial"
          required
          class="w-full p-3 border border-gray-300 rounded-lg"
        />
        <div id="fechaInicialFeedback" class="feedback"></div>
      </div>

      <div class="mb-5 w-full">
        <label for="fechaFinal" class="block text-lg mb-2 font-semibold"
          >Fecha Final</label
        >
        <input
          type="date"
          id="fechaFinal"
          name="fechaFinal"
          required
          class="w-full p-3 border border-gray-300 rounded-lg"
        />
        <div id="fechaFinalFeedback" class="feedback"></div>
      </div>

      <div class="mb-5 w-full">
        <label class="block text-lg font-semibold">Rutas</label>
        <div class="dropdown">
          <button
            type="button"
            class="dropbtn w-full p-3 bg-red-600 text-white rounded-lg text-left"
            onclick="toggleDropdown('rutas')"
          >
            Seleccionar Rutas
          </button>
          <div
            id="rutasContent"
            class="dropdown-content z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 p-3 hidden"
          >
            <input
              type="text"
              class="search-input w-full p-3 mb-3 border border-gray-300 rounded-lg"
              id="rutasSearchInput"
              placeholder="Buscar Rutas..."
              onkeyup="filterItems('rutas')"
            />
            <div id="rutasCheckboxes"></div>
          </div>
        </div>
        <div id="selectedRutas" class="selected-tags"></div>
        <div id="rutasFeedback" class="feedback"></div>
      </div>

      <div class="mb-5 w-full">
        <label class="block text-lg font-semibold">Montadores</label>
        <div class="dropdown">
          <button
            type="button"
            class="dropbtn w-full p-3 bg-red-600 text-white rounded-lg text-left"
            onclick="toggleDropdown('montadores')"
          >
            Seleccionar Montadores
          </button>
          <div
            id="montadoresContent"
            class="dropdown-content z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 p-3 hidden"
          >
            <input
              type="text"
              class="search-input w-full p-3 mb-3 border border-gray-300 rounded-lg"
              id="montadoresSearchInput"
              placeholder="Buscar Montadores..."
              onkeyup="filterItems('montadores')"
            />
            <div id="montadoresCheckboxes"></div>
          </div>
        </div>
        <div id="selectedMontadores" class="selected-tags"></div>
        <div id="montadoresFeedback" class="feedback"></div>
      </div>

      <div class="action-buttons flex gap-5 justify-center mt-5 flex-wrap">
        <button
          type="button"
          id="calcularBtn"
          class="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700"
          onclick="validateForm()"
        >
          Calcular
        </button>
        <button
          type="button"
          id="borrarTodoBtn"
          class="bg-gray-300 text-black px-5 py-3 rounded-lg hover:bg-gray-400"
          onclick="clearForm()"
        >
          Borrar Todo
        </button>
      </div>
    </form>

    <div id="tableSection" class="hidden fade">
      <div class="table-container">
        <input
          type="number"
          id="gastosInput"
          class="w-full p-3 border border-gray-300 rounded-lg mb-3"
          placeholder="Ingrese monto de gastos en euros"
        />
        <button
          onclick="processGastos()"
          class="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700 mb-4"
        >
          Calcular Euros
        </button>
        <div id="firstTable"></div>
        <div id="secondTable" class="hidden"></div>
      </div>
      <button
        onclick="reloadForm()"
        class="bg-gray-600 text-white px-5 py-3 rounded-lg hover:bg-gray-700 mt-4"
      >
        Volver al Formulario
      </button>
    </div>

    <script>
      let rutasData = [];
      let montadoresData = [];
      const $loader = document.getElementById("loader");
      const $body = document.getElementById("body");
      let originalTableData = null; // To store the original results for processing

      function scrollToTop() {
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      }

      function loaderOn() {
        scrollToTop();
        $loader.classList.remove("displayOff");
        $loader.classList.add("displayOn");
        $body.classList.add("oyh");
      }

      function loaderOff() {
        setTimeout(() => {
          $loader.classList.remove("displayOn");
          $loader.classList.add("displayOff");
          $body.classList.remove("oyh");
        }, 1000);
      }

      function goBack() {
        window.history.back();
      }

      function toggleDropdown(type) {
        const content = document.getElementById(`${type}Content`);
        const isVisible = content.style.display === "block";

        const dropdowns = document.getElementsByClassName("dropdown-content");
        Array.from(dropdowns).forEach((dropdown) => {
          dropdown.style.display = "none";
        });

        if (!isVisible) {
          content.style.display = "block";
          document.getElementById(`${type}SearchInput`).focus();
        }
      }

      document.addEventListener("click", function (event) {
        if (!event.target.closest(".dropdown")) {
          const dropdowns = document.getElementsByClassName("dropdown-content");
          Array.from(dropdowns).forEach((dropdown) => {
            dropdown.style.display = "none";
          });
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        loaderOn();
        Promise.all([
          fetch("https://dosxdos.app.iidos.com/apirest/rutas.php"),
          fetch("https://dosxdos.app.iidos.com/apirest/crm.php?montadores"),
        ])
          .then(([rutasResponse, montadoresResponse]) =>
            Promise.all([rutasResponse.json(), montadoresResponse.json()])
          )
          .then(([rutasDataResponse, montadoresDataResponse]) => {
            rutasData = rutasDataResponse[1].sort((a, b) =>
              a.Name.localeCompare(b.Name)
            );
            montadoresData = montadoresDataResponse[1].data.sort((a, b) =>
              a.Name.localeCompare(b.Name)
            );
            populateDropdown("rutas", rutasData);
            populateDropdown("montadores", montadoresData);
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
            displayErrorMessage("Error al cargar los datos iniciales");
          })
          .finally(() => loaderOff());
      });

      function populateDropdown(type, items) {
        const container = document.getElementById(`${type}Checkboxes`);
        container.innerHTML = "";

        items.forEach((item) => {
          const div = document.createElement("div");
          div.className =
            "checkbox-item flex items-center p-2 cursor-pointer hover:bg-gray-100";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `${type}-${item.id}`;
          checkbox.checked = false;

          const label = document.createElement("label");
          label.htmlFor = `${type}-${item.id}`;

          const fullName =
            type === "montadores"
              ? [item.Name, item.Apellido_del_montador]
                  .filter(Boolean)
                  .join(" ")
              : item.Name;

          label.textContent = fullName;

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);

          checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
              addTag(type, { ...item, Name: fullName });
            } else {
              removeTag(type, item.id);
            }
          });
        });
      }

      function addTag(type, item) {
        const container = document.getElementById(
          `selected${capitalizeFirstLetter(type)}`
        );
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.dataset.id = `${type}-${item.id}`;
        tag.innerHTML = `${item.Name} <span class="tag-close" onclick="removeTag('${type}', '${item.id}')">&times;</span>`;
        container.appendChild(tag);
      }

      function removeTag(type, id) {
        const container = document.getElementById(
          `selected${capitalizeFirstLetter(type)}`
        );
        const tag = container.querySelector(`div[data-id="${type}-${id}"]`);
        if (tag) {
          tag.remove();
          const checkbox = document.getElementById(`${type}-${id}`);
          if (checkbox) {
            checkbox.checked = false;
          }
        }
      }

      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function filterItems(type) {
        const searchInput = document.getElementById(`${type}SearchInput`);
        const searchTerm = searchInput.value.toLowerCase();
        const checkboxes = document.querySelectorAll(
          `#${type}Checkboxes .checkbox-item`
        );

        checkboxes.forEach((checkbox) => {
          const label = checkbox.querySelector("label");
          const itemText = label.textContent.toLowerCase();
          checkbox.style.display = itemText.includes(searchTerm)
            ? "flex"
            : "none";
        });
      }

      // Validate form
      async function validateForm() {
        const fechaInicial = document.getElementById("fechaInicial");
        const fechaFinal = document.getElementById("fechaFinal");
        const selectedRutas = Array.from(
          document.getElementById("selectedRutas").children
        ).map((tag) => tag.dataset.id.replace("rutas-", ""));
        const selectedMontadores = Array.from(
          document.getElementById("selectedMontadores").children
        ).map((tag) => tag.dataset.id.replace("montadores-", ""));

        let isValid = true;
        document
          .querySelectorAll(".feedback")
          .forEach((el) => (el.textContent = ""));

        if (!fechaInicial.value) {
          document.getElementById("fechaInicialFeedback").textContent =
            "La fecha inicial es requerida.";
          isValid = false;
        }
        if (!fechaFinal.value) {
          document.getElementById("fechaFinalFeedback").textContent =
            "La fecha final es requerida.";
          isValid = false;
        }
        if (selectedRutas.length === 0) {
          document.getElementById("rutasFeedback").textContent =
            "Debes seleccionar al menos una ruta.";
          isValid = false;
        }
        if (selectedMontadores.length === 0) {
          document.getElementById("montadoresFeedback").textContent =
            "Debes seleccionar al menos un montador.";
          isValid = false;
        }

        if (isValid) {
          const formData = {
            fechas: {
              fechaInicial: fechaInicial.value,
              fechaFinal: fechaFinal.value,
            },
            rutas: rutasData.filter((ruta) => selectedRutas.includes(ruta.id)),
            montadores: montadoresData.filter((montador) =>
              selectedMontadores.includes(montador.id)
            ),
          };

          loaderOn();

          const response = await requestBackend(
            "https://dosxdos.app.iidos.com/gastos_rutas.php",
            "POST",
            JSON.stringify(formData)
          );

          loaderOff();

          if (response && response[0]) {
            displayResults(response[1]);
          } else {
            displayErrorMessage(
              response ? response[1] : "Error al procesar la solicitud"
            );
          }
        }
      }

      function clearForm() {
        document.getElementById("fechaInicial").value = "";
        document.getElementById("fechaFinal").value = "";
        document.getElementById("selectedRutas").innerHTML = "";
        document.getElementById("selectedMontadores").innerHTML = "";

        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });

        const feedbacks = document.querySelectorAll(".feedback");
        feedbacks.forEach((feedback) => {
          feedback.textContent = "";
        });
      }

      function displayResults(data) {
        originalTableData = data;
        renderFirstTable(data);
      }

      function renderFirstTable(data) {
        const container = createTableContainer("Resultados del Cálculo");

        const tableHTML = generateTableHTML(data, [
          "OT CRM",
          "OT NAVISION",
          "TOTAL MINUTOS",
          "PORCENTAJE",
        ]);
        container.innerHTML += tableHTML;

        const gastosInputHTML = `
          <input
            type="number"
            id="gastosInput"
            class="w-full p-3 border border-gray-300 rounded-lg mb-3"
            placeholder="Ingrese monto de gastos en euros"
          />
          <button
            onclick="processGastos()"
            class="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700"
          >
            Calcular Euros
          </button>
        `;
        container.innerHTML += gastosInputHTML;

        document.body.appendChild(container);
      }

      function processGastos() {
        const gastosInput = document.getElementById("gastosInput");
        const gastos = parseFloat(gastosInput.value);

        if (isNaN(gastos) || gastos <= 0) {
          alert("Por favor, ingrese un monto válido.");
          return;
        }

        const calculatedData = calculateEuros(originalTableData, gastos);
        renderSecondTable(calculatedData);
      }

      function calculateEuros(data, gastos) {
        const newData = {};

        Object.entries(data).forEach(([otCRM, details]) => {
          const percentage = details.porcentaje || 0;
          newData[otCRM] = {
            ...details,
            euros: (gastos * (percentage / 100)).toFixed(2),
          };
        });

        return newData;
      }

      function renderSecondTable(data) {
        const container = createTableContainer("Resultados en Euros");

        const tableHTML = generateTableHTML(data, [
          "OT CRM",
          "OT NAVISION",
          "PORCENTAJE",
          "TOTAL EUROS",
        ]);
        container.innerHTML += tableHTML;

        const backButton = `
          <button
            onclick="renderFirstTable(originalTableData)"
            class="bg-gray-600 text-white px-5 py-3 rounded-lg hover:bg-gray-700 mt-4"
          >
            Volver a la Tabla Anterior
          </button>
        `;
        container.innerHTML += backButton;

        document.body.appendChild(container);
      }

      function createTableContainer(title) {
        const container = document.createElement("div");
        container.className = "message-container fade";
        container.innerHTML = `<h2 class="text-2xl font-bold mb-4">${title}</h2>`;
        return container;
      }

      function generateTableHTML(data, columns) {
        let tableHTML = `
          <div class="table-container">
            <table class="results-table">
              <thead>
                <tr>${columns.map((col) => `<th>${col}</th>`).join("")}</tr>
              </thead>
              <tbody>
        `;

        Object.entries(data).forEach(([otCRM, details]) => {
          tableHTML += `
            <tr>
              <td>${otCRM}</td>
              <td>${details.navision}</td>
              <td>${(details.porcentaje || 0).toFixed(3)}%</td>
              <td>${
                details.euros ? `${details.euros} €` : details.totalMinutos || 0
              }</td>
            </tr>
          `;
        });

        tableHTML += `</tbody></table></div>`;
        return tableHTML;
      }
    </script>
  </body>
</html>
