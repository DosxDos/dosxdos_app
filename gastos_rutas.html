<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gastos Rutas</title>
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logo-red.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
  <style>
    .checkbox-item label {
      margin-left: 8px;
    }

    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .tag {
      background-color: #f1f1f1;
      padding: 5px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .tag .tag-close {
      cursor: pointer;
      font-weight: bold;
      color: #e53935;
    }


    .desktop-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 50;
      min-width: 10rem;
      padding: 0.5rem 0;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      background-color: #fff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .desktop-dropdown-visible {
      display: block;
    }

    .desktop-dropdown a {
      display: block;
      padding: 0.5rem 1rem;
      clear: both;
      font-weight: 400;
      text-align: inherit;
      white-space: nowrap;
      background-color: transparent;
      border: 0;
      transition: background-color 0.15s ease;
    }
  </style>
</head>

<body id="body" class="bg-gray-100 overflow-x-hidden min-h-screen">
  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
    <span class="loader"></span>
  </div>

  <!-- Navigation -->
  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden xl:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 xl:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden xl:flex items-center space-x-8">
        <!-- Navigation items will be dynamically created by createDesktopNavigation() -->

        <!-- Desktop Menu Notifications Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="desktopBellContainer">
          <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
          <span id="desktopNotificationCount"
            class="absolute top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="xl:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="mobileBellContainer">
          <img id="bellMobile" src="https://dosxdos.app.iidos.com/img/bell2.png"
            class="w-8 text-gray-900 object-contain mt-2" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-0 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Mobile Menu Button -->
        <button id="menuButton" class="xl:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

    </div>

    <div id="opcionesMenu"
      class="xl:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
      <div class="absolute inset-0 z-0"
        style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain; opacity: 0.7;">
      </div>
      <!-- User Profile Section -->
      <div class="px-8 py-4 mt-16 relative z-10">
        <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
          <!-- Profile image -->
          <div
            class="absolute left-0 w-28 h-28 rounded-full overflow-hidden border-4 border-white bg-gradient-to-br from-red-50 to-white flex items-center justify-center shadow-xl"
            style="transform: translateX(-15%);">
            <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
              class="w-full h-full object-cover" alt="Profile"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
            <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="ml-28 flex items-center py-4">
            <!-- User name -->
            <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
            <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
            <span class="text-black font-medium text-xl">!</span>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Navigation Links -->
      <nav class="px-8 pt-3 space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar mt-2">
        <!-- Dynamic menu items will be added here based on user role -->
      </nav>

      <!-- Mobile Menu Footer -->
      <div class="relative z-10">
        <div class="website-divider-container-734167" style="height: 100px; overflow: visible">
          <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
            preserveAspectRatio="none" style="bottom: -20px">
            <path
              d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
              style="fill: #ffffff"></path>
            <path
              d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.5"></path>
            <path
              d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.25"></path>
          </svg>
        </div>
      </div>

      <!-- User Actions -->
      <div class="relative z-10 mt-auto px-8 pb-6 bg-white shadow-lg flex justify-center space-x-6 pb-2 rounded-t-xl">
        <!-- Edit Button -->
        <button id="editarUsuarioMobile"
          class="flex items-center justify-center w-14 h-14 bg-white border-2 border-red-500 rounded-full hover:bg-red-100 transition-all duration-300">
          <svg class="w-8 h-8 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>

        <!-- Logout Button -->
        <button id="cerrarSesionMobile"
          class="flex items-center justify-center w-14 h-14 bg-red-600 rounded-full transition-all duration-300">
          <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        </button>
      </div>
    </div>
    </div>
  </section>

  <!-- Main Content Container -->
  <div class="container mx-auto px-4 sm:px-6 pb-12 pt-32">
    <!-- Header Section -->
    <section class="mb-8">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden relative">
        <div class="absolute inset-0 bg-gradient-to-r from-red-600 to-red-700"
          style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain; ">
        </div>
        <div class="relative p-6 sm:p-8 text-white z-10">
          <h1 id="titulo" class="text-2xl sm:text-3xl font-bold mb-2">Gastos Rutas</h1>
          <p class="text-sm sm:text-base opacity-90">Calcula y visualiza los gastos distribuidos por órdenes de trabajo
          </p>
        </div>
      </div>
    </section>


    <!-- Main Form Section -->
    <section class="bg-white rounded-xl shadow-md mb-8">
      <form id="gastosRutasForm" class="p-6">
        <!-- Date Range Selector -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="space-y-2">
            <label for="fechaInicial" class="block text-sm font-medium text-gray-700">Fecha Inicial</label>
            <div class="relative">
              <input type="date" id="fechaInicial" name="fechaInicial" required
                class="block w-full p-3 text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
              <div id="fechaInicialFeedback" class="text-red-600 text-xs mt-1"></div>
            </div>
          </div>

          <div class="space-y-2">
            <label for="fechaFinal" class="block text-sm font-medium text-gray-700">Fecha Final</label>
            <div class="relative">
              <input type="date" id="fechaFinal" name="fechaFinal" required
                class="block w-full p-3 text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
              <div id="fechaFinalFeedback" class="text-red-600 text-xs mt-1"></div>
            </div>
          </div>
        </div>

        <!-- Rutas Selector -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Rutas</label>
          <div class="dropdown">
            <button type="button"
              class="dropbtn w-full flex items-center justify-between p-3 bg-gray-100 text-black rounded-lg hover:bg-gray-200 transition-colors"
              onclick="toggleDropdown('rutas')">
              <span>Seleccionar Rutas</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                  clip-rule="evenodd" />
              </svg>
            </button>
            <div id="rutasContent"
              class="dropdown-content z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 p-3 hidden">
              <div class="p-3 border-b border-gray-200">
                <input type="text" id="rutasSearchInput" placeholder="Buscar Rutas..." type="text" id="rutasSearchInput"
                  placeholder="Buscar Rutas..." onkeyup="filterItems('rutas')"
                  class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
              </div>
              <div id="rutasCheckboxes" class="max-h-60 overflow-y-auto custom-scrollbar p-2"></div>
            </div>
          </div>
          <div id="selectedRutas" class="selected-tags mt-2"></div>
          <div id="rutasFeedback" class="text-red-600 text-xs mt-1"></div>
        </div>

        <!-- Montadores Selector -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Montadores</label>
          <div class="dropdown">
            <button type="button"
              class="dropbtn w-full flex items-center justify-between p-3 bg-gray-100 text-black rounded-lg hover:bg-gray-200 transition-colors"
              onclick="toggleDropdown('montadores')">
              <span>Seleccionar Montadores</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                  clip-rule="evenodd" />
              </svg>
            </button>
            <div id="montadoresContent"
              class="dropdown-content z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 p-3 hidden">
              <div class="p-3 border-b border-gray-200">
                <input type="text" id="montadoresSearchInput" placeholder="Buscar Montadores..."
                  onkeyup="filterItems('montadores')"
                  class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
              </div>
              <div id="montadoresCheckboxes" class="max-h-60 overflow-y-auto custom-scrollbar p-2"></div>
            </div>
          </div>
          <div id="selectedMontadores" class="selected-tags mt-2"></div>
          <div id="montadoresFeedback" class="text-red-600 text-xs mt-1"></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col-reverse sm:flex-row gap-3 justify-center mt-8">
          <button type="button" id="borrarTodoBtn"
            class="flex-1 flex items-center justify-center gap-2 bg-gray-200 text-gray-800 py-3 px-6 rounded-lg hover:bg-gray-300 transition-all shadow-md text-base font-medium"
            onclick="clearForm()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                clip-rule="evenodd" />
            </svg>
            BORRAR TODO
          </button>
          <button type="button" id="calcularBtn"
            class="flex-1 flex items-center justify-center gap-2 bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition-all shadow-md text-base font-medium"
            onclick="validateForm()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 7a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zm-3 3a1 1 0 100 2h.01a1 1 0 100-2H10zm-4 1a1 1 0 011-1h.01a1 1 0 110 2H7a1 1 0 01-1-1zm1-4a1 1 0 100 2h.01a1 1 0 100-2H7zm2 1a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm4-4a1 1 0 100 2h.01a1 1 0 100-2H13zM9 9a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zM7 8a1 1 0 000 2h.01a1 1 0 000-2H7z"
                clip-rule="evenodd" />
            </svg>
            CALCULAR
          </button>
        </div>
      </form>
    </section>

    <!-- Results Section -->
    <section id="tableSection" class="hidden space-y-6">
      <!-- First Table Container -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden" id="firstTableContainer">
        <!-- Content will be generated dynamically -->
      </div>

      <!-- Second Table Container -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden hidden" id="secondTableContainer">
        <!-- Content will be generated dynamically -->
      </div>
    </section>
  </div>
</body>
<script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
<script src="https://dosxdos.app.iidos.com/js/navigation.js"></script>
<script>
  let rutasData = [];
  let montadoresData = [];
  let originalTableData = null;
  let usuario, notificacionesSinAcpetarNumero = 0;

  const $loader = document.getElementById("loader");
  const $body = document.getElementById("body");

  /* UTILIDADES BÁSICAS */
  function scrollToTop() {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
  }

  function loaderOn() {
    scrollToTop();
    $loader.classList.remove("hidden");
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
  }

  function loaderOff() {
    setTimeout(() => {
      $loader.classList.add("hidden");
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
    }, 1000);
  }

  /* FUNCIÓN DE ALERTA */
  function alerta(mensaje) {
    // Remove existing alert if present
    const existingAlert = document.querySelector("#customAlert");
    if (existingAlert) {
      existingAlert.remove();
    }

    // Create alert container
    const alertContainer = document.createElement("div");
    alertContainer.id = "customAlert";
    alertContainer.className = "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[95%] md:w-[75%] lg:w-[65%]";
    alertContainer.style.top = "-100px";

    // Create alert content
    const alertContent = document.createElement("div");
    alertContent.className = `
        relative
        bg-white
        border-2 border-red-600
        rounded-lg
        shadow-lg
        p-4 md:p-5
        flex flex-col md:flex-row md:items-center gap-3 md:gap-4
      `;

    // Create close button
    const closeButton = document.createElement("button");
    closeButton.className = "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600 rounded-full p-1.5 transition-colors duration-200";
    closeButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      `;

    // Create main content container
    const contentContainer = document.createElement("div");
    contentContainer.className = "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

    // Create icon with exclamation mark
    const iconContainer = document.createElement("div");
    iconContainer.className = "flex-shrink-0 text-red-600";
    iconContainer.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10" />
        <path d="M12 7v6" />
        <path d="M12 16h0.01" />
      </svg>
      `;

    // Create message text
    const messageText = document.createElement("p");
    messageText.className = "text-gray-900 text-base md:text-lg flex-1";
    messageText.textContent = mensaje;

    // Assemble the content container
    contentContainer.appendChild(iconContainer);
    contentContainer.appendChild(messageText);

    // Assemble the alert
    alertContent.appendChild(closeButton);
    alertContent.appendChild(contentContainer);
    alertContainer.appendChild(alertContent);
    document.body.appendChild(alertContainer);

    // Slide down animation
    requestAnimationFrame(() => {
      alertContainer.style.top = "56px";
    });

    // Add event listeners
    closeButton.addEventListener("click", () => {
      hideAlert(alertContainer);
    });

    // Hide loader if it exists
    loaderOff();
  }

  function hideAlert(alertContainer) {
    alertContainer.style.top = "-100px";

    setTimeout(() => {
      alertContainer.remove();
    }, 300);
  }

  /* DROPDOWN FUNCTIONS */
  function toggleDropdown(type) {
    const content = document.getElementById(`${type}Content`);
    const isVisible = content.style.display === "block";

    const dropdowns = document.getElementsByClassName("dropdown-content");
    Array.from(dropdowns).forEach((dropdown) => {
      dropdown.style.display = "none";
    });

    if (!isVisible) {
      content.style.display = "block";
      document.getElementById(`${type}SearchInput`).focus();
    }
  }

  document.addEventListener("click", function (event) {
    if (!event.target.closest(".dropdown")) {
      const dropdowns = document.getElementsByClassName("dropdown-content");
      Array.from(dropdowns).forEach((dropdown) => {
        dropdown.style.display = "none";
      });
    }
  });


  /* DATA FETCH AND FORM HANDLING */
  async function initializeApp() {
    try {
      loaderOn();

      // Check if user is logged in
      const login = await vLogin();
      if (!login) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
        return;
      }

      // Get user data
      const userArray = await leerDatos("dosxdos", "usuario");
      usuario = userArray[0];

      // Dynamically create navigation based on user role
      createDesktopNavigation(usuario.clase);
      // Setup desktop and mobile navigation
      setupMenu(usuario.clase);

      // Setup menu interactions
      setupMenuInteractions();
      setupUserActions();
      setupGlobalMenuClosing();

      updateUserDisplay();

      // Update the user information in the new UI elements
      const nombreUsuarioDesktop = document.getElementById(
        "nombreUsuarioDesktop"
      );
      const nombreUsuarioMobile = document.getElementById(
        "nombreUsuarioMobile"
      );
      const imagenUsuarioDesktop = document.getElementById(
        "imagenUsuarioDesktop"
      );
      const imagenUsuarioMobile = document.getElementById(
        "imagenUsuarioMobile"
      );

      if (nombreUsuarioDesktop)
        nombreUsuarioDesktop.textContent = usuario.nombre;
      if (nombreUsuarioMobile)
        nombreUsuarioMobile.textContent = usuario.nombre;

      if (usuario.imagen !== "0") {
        if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
        if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
      }

      // Fetch data for dropdowns
      await Promise.all([
        fetch("https://dosxdos.app.iidos.com/apirest/rutas.php"),
        fetch("https://dosxdos.app.iidos.com/apirest/crm.php?montadores"),
      ])
        .then(([rutasResponse, montadoresResponse]) =>
          Promise.all([rutasResponse.json(), montadoresResponse.json()])
        )
        .then(([rutasDataResponse, montadoresDataResponse]) => {
          rutasData = rutasDataResponse[1].sort((a, b) =>
            a.Name.localeCompare(b.Name)
          );
          montadoresData = montadoresDataResponse[1].data.sort((a, b) =>
            a.Name.localeCompare(b.Name)
          );
          populateDropdown("rutas", rutasData);
          populateDropdown("montadores", montadoresData);
        });

      // Check for notifications
      console.log("----- deberiua ser el segundo")
      const syncNotifications = await sincronizarNotificaciones();
      if (syncNotifications) {
        await notificar();
      }

      loaderOff();
    } catch (error) {
      console.error("Error initializing app:", error);
      alerta("Error al inicializar la aplicación: " + error.message);
      loaderOff();
    }
  }

  function populateDropdown(type, items) {
    const container = document.getElementById(`${type}Checkboxes`);
    container.innerHTML = "";

    items.forEach((item) => {
      const div = document.createElement("div");
      div.className = "flex items-center p-2 cursor-pointer hover:bg-gray-100 rounded-md transition-colors";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = `${type}-${item.id}`;
      checkbox.className = "form-checkbox h-5 w-5 text-red-600 transition duration-150 ease-in-out cursor-pointer";
      checkbox.checked = false;

      const label = document.createElement("label");
      label.htmlFor = `${type}-${item.id}`;
      label.className = "ml-2 block text-sm text-gray-900 cursor-pointer";

      const fullName =
        type === "montadores"
          ? [item.Name, item.Apellido_del_montador]
            .filter(Boolean)
            .join(" ")
          : item.Name;

      label.textContent = fullName;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);

      checkbox.addEventListener("change", () => {
        if (checkbox.checked) {
          addTag(type, { ...item, Name: fullName });
        } else {
          removeTag(type, item.id);
        }
      });
    });
  }

  function addTag(type, item) {
    const container = document.getElementById(`selected${capitalizeFirstLetter(type)}`);
    const tag = document.createElement("div");
    tag.className = "tag bg-gray-200 text-gray-800 rounded-full px-3 py-1 text-sm flex items-center";
    tag.dataset.id = `${type}-${item.id}`;
    tag.innerHTML = `${item.Name} <span class="tag-close ml-2 text-red-600 hover:text-red-800 font-bold" onclick="removeTag('${type}', '${item.id}')">&times;</span>`;
    container.appendChild(tag);
  }

  function removeTag(type, id) {
    const container = document.getElementById(`selected${capitalizeFirstLetter(type)}`);
    const tag = container.querySelector(`div[data-id="${type}-${id}"]`);
    if (tag) {
      tag.remove();
      const checkbox = document.getElementById(`${type}-${id}`);
      if (checkbox) {
        checkbox.checked = false;
      }
    }
  }

  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  function filterItems(type) {
    const searchInput = document.getElementById(`${type}SearchInput`);
    const searchTerm = searchInput.value.toLowerCase();
    const checkboxes = document.querySelectorAll(`#${type}Checkboxes > div`);

    checkboxes.forEach((checkbox) => {
      const label = checkbox.querySelector("label");
      const itemText = label.textContent.toLowerCase();
      checkbox.style.display = itemText.includes(searchTerm) ? "flex" : "none";
    });
  }

  function requestBackend(endpoint, metodo, cuerpo = false, cabeceras = false) {
    return new Promise((resolve, reject) => {
      let options;
      if (cuerpo) {
        if (cabeceras) {
          options = {
            method: metodo,
            headers: cabeceras,
            body: cuerpo,
          };
        } else {
          options = {
            method: metodo,
            headers: { "Content-Type": "application/json" },
            body: cuerpo,
          };
        }
      } else {
        if (cabeceras) {
          options = {
            method: metodo,
            headers: cabeceras,
          };
        } else {
          options = {
            method: metodo,
          };
        }
      }

      fetch(endpoint, options)
        .then((response) => {
          if (!response.ok) {
            return response
              .clone()
              .json()
              .then((errorResponse) => {
                console.error("Error enviado por la API");
                console.error(errorResponse);
                resolve(errorResponse);
              })
              .catch(() => {
                return response.text().then((errorText) => {
                  respuestaErrorPersonalizada = [false, errorText, 500];
                  console.error("Error en el backend, ha respondido el servidor del backend y no la API");
                  console.error(respuestaErrorPersonalizada);
                  resolve(respuestaErrorPersonalizada);
                });
              });
          }

          return response
            .clone()
            .json()
            .then((response) => {
              resolve(response);
            })
            .catch(() => {
              return response.text().then((errorText) => {
                respuestaErrorPersonalizada = [false, errorText, 500];
                console.error("Error, la API ha respondido pero no lo ha hecho en formato JSON");
                console.error(respuestaErrorPersonalizada);
                resolve(respuestaErrorPersonalizada);
              });
            });
        })
        .catch((error) => {
          if (error.message === "Failed to fetch") {
            respuestaErrorPersonalizada = [
              false,
              "Error de red: No se pudo conectar con el servidor.",
              500,
            ];
            console.error("Error en el cliente, no se ha podido conectar a la API");
            console.error(respuestaErrorPersonalizada);
            resolve(respuestaErrorPersonalizada);
          } else {
            console.error("Error en el código del frontend");
            console.error(error);
            respuestaErrorPersonalizada = [false, error.message, 500];
            console.error(respuestaErrorPersonalizada);
            resolve(respuestaErrorPersonalizada);
          }
        });
    });
  }

  async function validateForm() {
    const fechaInicial = document.getElementById("fechaInicial");
    const fechaFinal = document.getElementById("fechaFinal");
    const selectedRutas = Array.from(
      document.getElementById("selectedRutas").children
    ).map((tag) => tag.dataset.id.replace("rutas-", ""));
    const selectedMontadores = Array.from(
      document.getElementById("selectedMontadores").children
    ).map((tag) => tag.dataset.id.replace("montadores-", ""));

    let isValid = true;
    document.querySelectorAll('[id$="Feedback"]').forEach((el) => (el.textContent = ""));

    if (!fechaInicial.value) {
      document.getElementById("fechaInicialFeedback").textContent =
        "La fecha inicial es requerida.";
      isValid = false;
    }
    if (!fechaFinal.value) {
      document.getElementById("fechaFinalFeedback").textContent =
        "La fecha final es requerida.";
      isValid = false;
    }

    if (isValid) {
      const formData = {
        fechas: {
          fechaInicial: fechaInicial.value,
          fechaFinal: fechaFinal.value,
        },
        // Optional rutas: null if none selected, array if some selected
        rutas: selectedRutas.length > 0
          ? rutasData.filter((ruta) => selectedRutas.includes(ruta.id))
          : null,
        // Optional montadores: null if none selected, array if some selected
        montadores: selectedMontadores.length > 0
          ? montadoresData.filter((montador) => selectedMontadores.includes(montador.id))
          : null,
      };

      loaderOn();

      const response = await requestBackend(
        "https://dosxdos.app.iidos.com/gastos_rutas.php",
        "POST",
        JSON.stringify(formData)
      );

      loaderOff();

      if (response && response[0]) {
        let objeto = response[1];
        let totalOts = Object.keys(objeto).length;
        console.log("Total OTS: " + totalOts);
        displayResults(response[1]);
      } else {
        alerta(response ? response[1] : "Error al procesar la solicitud");
      }
    }
  }

  function copyResults(tableId) {
    const table = document.getElementById(tableId);
    if (!table) {
      alerta("No hay resultados para copiar.");
      return;
    }

    const rows = Array.from(table.querySelectorAll("tr"));
    const text = rows
      .map((row) =>
        Array.from(row.querySelectorAll("th, td"))
          .map((cell) => cell.textContent.trim())
          .join("\t")
      )
      .join("\n");

    navigator.clipboard
      .writeText(text)
      .then(() => alerta("Resultados copiados al portapapeles."))
      .catch((err) =>
        alerta("Error al copiar los resultados: " + err.message)
      );
  }

  function clearForm() {
    document.getElementById("fechaInicial").value = "";
    document.getElementById("fechaFinal").value = "";
    document.getElementById("selectedRutas").innerHTML = "";
    document.getElementById("selectedMontadores").innerHTML = "";

    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach((checkbox) => {
      checkbox.checked = false;
    });

    document.querySelectorAll('[id$="Feedback"]').forEach((el) => (el.textContent = ""));
  }

  function displayResults(data) {
    if (!data || Object.keys(data).length === 0) {
      alerta("No se encontraron resultados para los filtros seleccionados.");
      return;
    }

    originalTableData = data;
    document.getElementById("gastosRutasForm").parentElement.classList.add("hidden");
    document.getElementById("tableSection").classList.remove("hidden");
    document.getElementById("firstTableContainer").classList.remove("hidden");
    document.getElementById("secondTableContainer").classList.add("hidden");
    displayFirstTable(data);
  }

  function displayFirstTable(data) {
    const container = document.getElementById("firstTableContainer");
    container.innerHTML = `
      <div class="p-6">
        <h2 class="text-2xl font-bold mb-6 text-center">Resultados del Cálculo</h2>
        
        <div class="mb-6">
          <div class="flex flex-col md:flex-row md:items-end gap-4">
            <div class="flex-grow">
              <label for="gastosInput" class="block text-sm font-medium text-gray-700 mb-1">Ingrese monto de gastos en euros</label>
              <input
                type="number"
                id="gastosInput"
                placeholder="0.00"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>
            <button 
              onclick="processGastos()" 
              class="flex items-center justify-center gap-2 bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition-colors shadow-md whitespace-nowrap"
            >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 7a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zm-3 3a1 1 0 100 2h.01a1 1 0 100-2H10zm-4 1a1 1 0 011-1h.01a1 1 0 110 2H7a1 1 0 01-1-1zm1-4a1 1 0 100 2h.01a1 1 0 100-2H7zm2 1a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm4-4a1 1 0 100 2h.01a1 1 0 100-2H13zM9 9a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zM7 8a1 1 0 000 2h.01a1 1 0 000-2H7z"
                clip-rule="evenodd" />
            </svg>
              Calcular Euros
            </button>
          </div>
        </div>
        
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md">
          <table id="firstResultsTable" class="w-full border-collapse bg-white text-left text-sm text-gray-700">
            ${generateTableHTML(data, [
      "OT CRM",
      "OT NAVISION",
      "TOTAL MINUTOS",
      "PORCENTAJE",
    ])}
          </table>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center mt-6">
          <button 
            onclick="copyResults('firstResultsTable')" 
            class="flex items-center justify-center gap-2 bg-gray-600 text-white py-2 px-6 rounded-lg hover:bg-gray-700 transition-colors shadow-md"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
              <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
            </svg>
            Copiar Resultados
          </button>
          <button 
            onclick="reloadForm()" 
            class="flex items-center justify-center gap-2 bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition-colors shadow-md"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            Volver al Formulario
          </button>
        </div>
      </div>
    `;
  }

  function displaySecondTable(data) {
    const container = document.getElementById("secondTableContainer");
    container.innerHTML = `
      <div class="p-6">
        <h2 class="text-2xl font-bold mb-6 text-center">Resultados en Euros</h2>
        
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md">
          <table id="secondResultsTable" class="w-full border-collapse bg-white text-left text-sm text-gray-700">
            ${generateTableHTML(data, [
      "OT CRM",
      "OT NAVISION",
      "PORCENTAJE",
      "TOTAL EUROS",
    ])}
          </table>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center mt-6">
          <button 
            onclick="copyResults('secondResultsTable')" 
            class="flex items-center justify-center gap-2 bg-gray-600 text-white py-2 px-6 rounded-lg hover:bg-gray-700 transition-colors shadow-md"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
              <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
            </svg>
            Copiar Resultados
          </button>
          <button 
            onclick="reloadForm()" 
            class="flex items-center justify-center gap-2 bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition-colors shadow-md"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            Volver al Formulario
          </button>
        </div>
      </div>
    `;
    container.classList.remove("hidden");
    document.getElementById("firstTableContainer").classList.add("hidden");
  }

  function processGastos() {
    const gastos = parseFloat(document.getElementById("gastosInput").value);
    if (isNaN(gastos) || gastos <= 0) {
      alerta("Por favor, ingrese un monto válido.");
      return;
    }

    const calculatedData = {};
    Object.entries(originalTableData).forEach(([key, value]) => {
      calculatedData[key] = {
        ...value,
        euros: ((gastos * (value.porcentaje || 0)) / 100).toFixed(3),
      };
    });

    displaySecondTable(calculatedData);
  }

  function reloadForm() {
    document.getElementById("gastosRutasForm").parentElement.classList.remove("hidden");
    document.getElementById("tableSection").classList.add("hidden");
    clearForm();
  }

  function generateTableHTML(data, headers) {
    let totalPorcentaje = 0;
    let totalMinutos = 0;
    let totalEuros = 0;

    let html = `
      <thead class="bg-red-600 text-white">
        <tr>
    `;

    headers.forEach((header) => {
      html += `<th scope="col" class="px-6 py-4 font-medium">${header}</th>`;
    });

    html += `
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
    `;

    Object.entries(data).forEach(([key, value]) => {
      if (headers.includes("TOTAL EUROS")) {
        totalEuros += parseFloat(value.euros || 0);
      }
      totalPorcentaje += value.porcentaje || 0;
      totalMinutos += value.totalMinutos || 0;

      html += `<tr class="hover:bg-gray-50">`;
      html += `<td class="px-6 py-4">${key}</td>`;
      html += `<td class="px-6 py-4">${value.navision || ""}</td>`;

      if (headers.includes("TOTAL MINUTOS")) {
        html += `<td class="px-6 py-4">${value.totalMinutos || 0}</td>`;
      }

      if (headers.includes("TOTAL EUROS")) {
        html += `<td class="px-6 py-4">${value.porcentaje?.toFixed(3) || 0}%</td>`;
        html += `<td class="px-6 py-4">${value.euros || "0.00"} €</td>`;
      } else {
        html += `<td class="px-6 py-4">${value.porcentaje?.toFixed(3) || 0}%</td>`;
      }

      html += `</tr>`;
    });

    // Footer row
    html += `
      <tr class="bg-gray-100 font-medium">
        <td colspan="2" class="px-6 py-4">Totales</td>
    `;

    if (headers.includes("TOTAL MINUTOS")) {
      html += `<td class="px-6 py-4">${totalMinutos}</td>`;
    }

    if (headers.includes("TOTAL EUROS")) {
      html += `<td class="px-6 py-4">${totalPorcentaje.toFixed(3)}%</td>`;
      html += `<td class="px-6 py-4">${totalEuros.toFixed(3)} €</td>`;
    } else {
      html += `<td class="px-6 py-4">${totalPorcentaje.toFixed(3)}%</td>`;
    }

    html += `
      </tr>
      </tbody>
    `;

    return html;
  }

  /* USER LOGIN CHECK */
  function vLogin() {
    return new Promise((resolve, reject) => {
      const login = localStorage.getItem('login');
      if (login && login !== null) {
        leerDatos('dosxdos', 'usuario')
          .then(res => {
            usuario = res[0];
            resolve(true);
          })
          .catch(err => {
            resolve(false);
          });
      } else {
        resolve(false);
      }
    });
  }

  /* INITIALIZATION AND EVENT LISTENERS */
  document.addEventListener("DOMContentLoaded", initializeApp);

  // Handle online/offline events
  window.addEventListener("online", () => {
    console.log("La conexión a Internet se ha recuperado.");
    // You might want to sync data here if needed
  });

  window.addEventListener("offline", () => {
    console.log("La conexión a Internet se ha perdido.");
    alerta("Se ha perdido la conexión a Internet. Algunas funciones pueden no estar disponibles.");
  });

  // Prevent form resubmission on refresh
  if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
  }

  // MAKE THESE FUNCTIONS AVAILABLE IN THE GLOBAL SCOPE
  window.toggleDropdown = toggleDropdown;
  window.removeTag = removeTag;
  window.validateForm = validateForm;
  window.clearForm = clearForm;
  window.processGastos = processGastos;
  window.copyResults = copyResults;
  window.reloadForm = reloadForm;
  window.filterItems = filterItems;
</script>
<script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
<script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>

</html>