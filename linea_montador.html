<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Línea</title>
    <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logo-red.png" />
    <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
    <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
</head>

<body id="body" class="relative bg-gray-100 overflow-x-hidden min-h-screen">
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
        <span class="loader"></span>
    </div>

    <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
        <!-- Main header -->
        <div class="flex items-center justify-between w-full px-6 py-4">
            <!-- Logo -->
            <div class="flex items-center">
                <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden xl:block"
                    alt="Logo completo" />
                <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 xl:hidden" alt="Isotipo" />
            </div>

            <!-- Desktop Navigation -->
            <nav class="hidden xl:flex items-center space-x-8">
                <!-- Navigation items will be dynamically created by createDesktopNavigation() -->

                <!-- Desktop Menu Notifications Bell -->
                <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10"
                    id="desktopBellContainer">
                    <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
                    <span id="desktopNotificationCount"
                        class="absolute top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
                </a>

                <!-- Desktop User Menu -->
                <div class="relative group drop-shadow">
                    <button id="userMenuButton"
                        class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
                        aria-expanded="false">
                        <div
                            class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
                            <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                                class="w-full h-full object-cover" alt="Profile"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                            <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>

                        <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>

                    <!-- Desktop Dropdown Menu -->
                    <div id="userDropdownMenu"
                        class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
                        <button id="editarUsuarioDesktop"
                            class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                            </svg>
                            Editar Usuario
                        </button>
                        <button id="cerrarSesionDesktop"
                            class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                                <polyline points="16 17 21 12 16 7" />
                                <line x1="21" y1="12" x2="9" y2="12" />
                            </svg>
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Mobile Navigation -->
            <div class="xl:hidden flex items-center space-x-2 mx-2">
                <!-- Mobile Bell -->
                <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10"
                    id="mobileBellContainer">
                    <img id="bellMobile" src="https://dosxdos.app.iidos.com/img/bell2.png"
                        class="w-8 text-gray-900 object-contain mt-2" />
                    <span id="mobileNotificationCount"
                        class="absolute top-2 right-0 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
                </a>

                <!-- Mobile Menu Button -->
                <button id="menuButton" class="xl:hidden relative z-50 p-2 focus:outline-none">
                    <div class="relative w-8 h-8">
                        <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
                            id="hamburgerTop"></span>
                        <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
                            id="hamburgerMiddle"></span>
                        <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
                            id="hamburgerBottom"></span>
                    </div>
                </button>
            </div>

        </div>

        <div id="opcionesMenu"
            class="xl:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
            <div class="absolute inset-0 z-0"
                style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain; opacity: 0.7;">
            </div>
            <!-- User Profile Section -->
            <div class="px-8 py-4 mt-16 relative z-10">
                <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
                    <!-- Profile image -->
                    <div class="absolute left-0 w-28 h-28 rounded-full overflow-hidden border-4 border-white bg-gradient-to-br from-red-50 to-white flex items-center justify-center shadow-xl"
                        style="transform: translateX(-15%);">
                        <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
                            class="w-full h-full object-cover" alt="Profile"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                        <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="ml-28 flex items-center py-4">
                        <!-- User name -->
                        <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
                        <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
                        <span class="text-black font-medium text-xl">!</span>
                    </div>
                </div>
            </div>

            <!-- Mobile Menu Navigation Links -->
            <nav class="px-8 pt-3 space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar mt-2">
                <!-- Dynamic menu items will be added here based on user role -->
            </nav>

            <!-- Mobile Menu Footer -->
            <div class="relative z-10">
                <div class="website-divider-container-734167" style="height: 100px; overflow: visible">
                    <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
                        preserveAspectRatio="none" style="bottom: -20px">
                        <path
                            d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
                            style="fill: #ffffff"></path>
                        <path
                            d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
                            style="fill: #ffffff; opacity: 0.5"></path>
                        <path
                            d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
                            style="fill: #ffffff; opacity: 0.25"></path>
                    </svg>
                </div>
            </div>

            <!-- User Actions -->
            <div
                class="relative z-10 mt-auto px-8 pb-6 bg-white shadow-lg flex justify-center space-x-6 pb-2 rounded-t-xl">
                <!-- Edit Button -->
                <button id="editarUsuarioMobile"
                    class="flex items-center justify-center w-14 h-14 bg-white border-2 border-red-500 rounded-full hover:bg-red-100 transition-all duration-300">
                    <svg class="w-8 h-8 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                </button>

                <!-- Logout Button -->
                <button id="cerrarSesionMobile"
                    class="flex items-center justify-center w-14 h-14 bg-red-600 rounded-full transition-all duration-300">
                    <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                </button>
            </div>
        </div>
        </div>
    </section>

    <!-- Main Content Container -->
    <div class="container mx-auto px-4 sm:px-6 pb-12 pt-32">
        <!-- Header Section -->
        <section class="mb-8">
            <div class="rounded-xl shadow-lg overflow-hidden relative">
                <div class="absolute inset-0"
                    style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain;">
                </div>
                <div class="relative p-6 sm:p-8 text-white z-10">
                    <h1 id="titulo" class="text-2xl sm:text-3xl font-bold mb-2">Cargando Datos</h1>
                    <p id="subtitulo" class="text-sm sm:text-base opacity-90">...</p>
                </div>
            </div>
        </section>

        <!-- Quick Actions Row -->
        <section class="mb-8">
            <!-- Back Button and Action Buttons -->
            <div class="flex flex-col md:flex-row gap-3">
                <!-- Back Button -->
                <a href="https://dosxdos.app.iidos.com/ruta_montador.html"
                    class="flex items-center gap-2 text-red-600 mb-3 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium md:hidden">Volver</span>
                </a>

                <!-- Action Buttons Container -->
                <div class="grid grid-cols-2 gap-3 flex-grow">
                    <!-- Telephone Button -->
                    <button id="telefonoBoton"
                        class="flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-800 rounded-lg py-3 px-4 shadow-md transition-all border border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        <span class="font-medium truncate">No Disponible</span>
                    </button>

                    <!-- Line Details Button -->
                    <button id="datosBoton" type="button"
                        class="flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-800 rounded-lg py-3 px-4 shadow-md transition-all border border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="font-medium truncate">Detalles</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Main Form Container -->
        <section class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-6">
                <form action="linea_montador.html" method="post" enctype="multipart/form-data" id="formLinea"
                    class="space-y-6" novalidate>
                    <!-- State Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="estado" class="block text-sm font-medium text-gray-700">ESTADO:</label>
                            <div class="relative">
                                <select name="estado" id="estado"
                                    class="block w-full p-2.5 pr-12 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent cursor-pointer appearance-none">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Realizado">Realizado</option>
                                </select>
                                <div
                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20">
                                        <path
                                            d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Incident Selection -->
                        <div class="space-y-2">
                            <label for="incidencia" class="block text-sm font-medium text-gray-700">INCIDENCIA:</label>
                            <div class="relative">
                                <select name="incidencia" id="incidencia"
                                    class="block w-full p-2.5 pr-12 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent cursor-pointer appearance-none">
                                    <option value="" selected>Ninguna</option>
                                    <option value="Medidas incorrectas (2x2)">Medidas incorrectas (2x2)</option>
                                    <option value="Medidas incorrectas (cliente)">Medidas incorrectas (cliente)</option>
                                    <option value="Medidas incorrectas (proveedor)">Medidas incorrectas (proveedor)
                                    </option>
                                    <option value="Error administrativo (2x2)">Error administrativo (2x2)</option>
                                    <option value="Error de diseño (2x2)">Error de diseño (2x2)</option>
                                    <option value="Error de producción (2x2)">Error de producción (2x2)</option>
                                    <option value="Error montadores (2x2)">Error montadores (2x2)</option>
                                    <option value="Error del cliente">Error del cliente</option>
                                    <option value="Error del proveedor">Error del proveedor</option>
                                </select>
                                <div
                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20">
                                        <path
                                            d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date Input -->
                    <div class="space-y-2">
                        <label for="fecha" class="block text-sm font-medium text-gray-700">FECHA DE ACTUACIÓN:</label>
                        <input type="date" id="fecha" name="fecha"
                            class="cursor-pointer block w-full p-2.5 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
                    </div>

                    <!-- Days, Hours, Minutes Inputs -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label for="dias" class="block text-sm font-medium text-gray-700">DÍAS DE ACTUACIÓN:</label>
                            <input type="number" id="dias" name="dias" min="0"
                                class="block w-full p-2.5 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
                        </div>
                        <div class="space-y-2">
                            <label for="horas" class="block text-sm font-medium text-gray-700">HORAS DE
                                ACTUACIÓN:</label>
                            <input type="number" id="horas" name="horas" min="0"
                                class="block w-full p-2.5 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
                        </div>
                        <div class="space-y-2">
                            <label for="minutos" class="block text-sm font-medium text-gray-700">MINUTOS DE
                                ACTUACIÓN:</label>
                            <input type="number" id="minutos" name="minutos" min="0"
                                class="block w-full p-2.5 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent" />
                        </div>
                    </div>

                    <!-- Technician Observations -->
                    <div class="space-y-2">
                        <label for="observacionesTecnico"
                            class="block text-sm font-medium text-gray-700">OBSERVACIONES:</label>
                        <textarea id="observacionesTecnico" name="observacionesTecnico" rows="3"
                            class="block w-full p-2.5 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent resize-none"></textarea>
                        <p class="text-xs text-gray-500">Máximo 250 caracteres para Navision</p>
                    </div>

                    <!-- App Notes -->
                    <div class="space-y-2">
                        <label for="appNotas" class="block text-sm font-medium text-gray-700">APP NOTAS:</label>
                        <textarea id="appNotas" name="appNotas" rows="3"
                            class="block w-full p-2.5 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent resize-none"></textarea>
                    </div>

                    <!-- Photos/Videos Section -->
                    <div class="space-y-4 border-t border-gray-200 pt-4">
                        <h3 class="text-lg font-medium text-gray-900">Fotos y Videos</h3>

                        <!-- Upload Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3">
                            <!-- Mobile-only camera button (hidden on desktop) -->
                            <!-- <button type="button" id="fotos"
                                class="sm:hidden flex items-center justify-center gap-2 bg-gray-50 hover:bg-gray-100 text-gray-700 border border-gray-300 rounded-lg py-3 px-4 shadow-sm transition-all w-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span class="font-medium">Usar cámara</span>
                            </button> -->

                            <!-- Camera options -->
                            <!-- <div id="listaCamaras" class="hidden space-y-2 px-4 py-3 bg-gray-50 rounded-lg"></div> -->

                            <label for="fotosGaleria"
                                class="flex items-center justify-center gap-2 bg-gray-50 hover:bg-gray-100 text-gray-700 border border-gray-300 rounded-lg py-3 px-4 shadow-sm transition-all cursor-pointer w-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="font-medium">Subir fotos o videos</span>
                                <input type="file" name="fotosGaleria[]" id="fotosGaleria" class="hidden" multiple
                                    accept="image/*,video/*" />
                            </label>
                        </div>

                        <!-- Photo Grid -->
                        <div id="photosContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 pt-2">
                        </div>
                    </div>

                    <!-- Signatures Section -->
                    <div class="space-y-4 border-t border-gray-200 pt-4">
                        <h3 class="text-lg font-medium text-gray-900">Firmas</h3>

                        <button type="button" id="firmar"
                            class="w-full flex items-center justify-center gap-2 bg-gray-50 hover:bg-gray-100 text-gray-700 border border-gray-300 rounded-lg py-3 px-4 shadow-sm transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                            <span class="font-medium">Añadir firma</span>
                        </button>

                        <!-- Signature Grid -->
                        <div id="firmasContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-4 pt-2"></div>
                    </div>

                    <!-- Submit and Cancel Buttons -->
                    <div class="flex flex-col-reverse md:flex-row gap-3 pt-4 border-t border-gray-200">
                        <button type="button" id="cancelar"
                            class="w-full flex items-center justify-center gap-2 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg shadow-md transition-all text-base font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            CANCELAR
                        </button>
                        <button type="submit" id="enviar"
                            class="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg shadow-md transition-all text-base font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            GUARDAR TODO
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <!-- Line Details Modal -->
    <!-- Modal Container -->
    <div id="datosModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-xl w-full mx-4 max-h-[85vh] flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="text-white p-4 rounded-t-xl flex justify-between items-center sticky top-0 z-10"
                style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain;">
                <h2 class="text-xl font-bold pr-4">Detalles de la OT</h2>
                <button class="text-white hover:text-gray-100" id="closeModal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-4 space-y-4 overflow-y-auto flex-grow custom-scrollbar"
                style="max-height: calc(85vh - 120px);">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">CLIENTE</h3>
                            <p id="cliente" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">OT</h3>
                            <p id="ot" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">TIPO DE OT</h3>
                            <p id="tipoOt" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">DESCRIPCIÓN OT</h3>
                            <p id="descripcionOt" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">LÍNEA</h3>
                            <p id="lineaOt" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">PUNTO DE VENTA</h3>
                            <p id="puntoDeVenta" class="text-gray-900 font-medium">-</p>
                            <p id="puntoDeVenta2" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">ZONA</h3>
                            <p id="zona" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">SECTOR</h3>
                            <p id="sector" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">DIRECCIÓN</h3>
                            <p id="direccion" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">FIRMA</h3>
                            <p id="firmaDatos" class="text-gray-900 font-medium">-</p>
                        </div>

                    </div>

                    <div class="flex-1">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">OBSERVACIONES</h3>
                            <p id="observaciones" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">TIPO DE TRABAJO</h3>
                            <p id="tipoDeTrabajo" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">TIPO
                                TRABAJO</h3>
                            <p id="tipoDeTrabajo2" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">PONER</h3>
                            <p id="poner" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">QUITAR</h3>
                            <p id="quitar" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">ALTO</h3>
                            <p id="alto" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">ANCHO</h3>
                            <p id="ancho" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">REVISADO</h3>
                            <p id="revisado" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">NAVISION OT</h3>
                            <p id="navisionOt" class="text-gray-900 font-medium">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="border-t border-gray-200 p-4 flex justify-end">
                <button id="closeModalBottom"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-sm">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="camara" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden">
        <button id="imgCerrarCamara"
            class="absolute top-4 right-4 bg-red-600 w-12 h-12 rounded-full flex items-center justify-center z-50 cursor-pointer text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <video id="video" class="flex w-full h-full bg-white" autoplay></video>
    </div>

    <!-- Signature Canvas Modal -->
    <div id="cajaCanvasFirma"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-xl w-full mx-4 max-h-[85vh] flex flex-col overflow-hidden">
            <!-- Signature Header -->
            <div class="text-white p-4 rounded-t-xl flex justify-between items-center sticky top-0 z-10"
                style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain;">
                <h2 class="text-xl font-bold pr-4">Firma</h2>
                <button class="text-white hover:text-gray-100" id="imgCerrarFirma">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Signature Area -->
            <div class="flex-grow flex items-center justify-center p-4 bg-white">
                <canvas id="canvasFirma" class="border border-gray-300 w-full max-w-md rounded-lg shadow-inner bg-white"
                    style="touch-action: none"></canvas>
            </div>

            <!-- Signature Actions -->
            <div class="bg-gray-100 p-4 rounded-b-xl flex justify-between items-center gap-4 sticky bottom-0">
                <button id="borrarFirma"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 w-1/2 rounded-lg flex-grow">
                    Borrar
                </button>
                <button id="guardarFirma"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 w-1/2 rounded-lg flex-grow">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Media Viewer Modal -->
    <div id="mediaViewerModal"
        class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center">
        <div class=" w-full h-full max-w-6xl mx-auto flex flex-col items-center justify-center p-4">
            <!-- Close Button -->
            <button id="closeMediaViewer"
                class="absolute top-6 right-6 z-10 text-white p-1 rounded-full bg-red-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Media Container -->
            <div class="w-full h-full flex items-center justify-center">
                <!-- Image will be inserted here -->
                <div id="mediaViewerContent" class="max-w-full max-h-full"></div>
            </div>
        </div>
    </div>

    <div id="confirmationModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <!-- Modal Header -->
            <div class="text-white p-4 rounded-t-xl flex justify-between items-center"
                style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain;">
                <h2 class="text-xl font-bold" id="confirmationTitle">Confirmar acción</h2>
                <button class="text-white hover:text-gray-100" id="closeConfirmationModal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <p id="confirmationMessage" class="text-gray-700 text-lg mb-6">
                    ¿Estás seguro que deseas eliminar este elemento?
                </p>

                <!-- Modal Footer -->
                <div class="flex justify-center space-x-4">
                    <button id="cancelConfirmation"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button id="confirmAction"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
<script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
<script src="https://dosxdos.app.iidos.com/js/navigation.js"></script>
<script>
    document.getElementById("datosBoton").addEventListener("click", function () {
        document.getElementById("datosModal").classList.remove("hidden");
    });

    document.getElementById("closeModal").addEventListener("click", function () {
        document.getElementById("datosModal").classList.add("hidden");
    });

    document.getElementById("closeModalBottom").addEventListener("click", function () {
        document.getElementById("datosModal").classList.add("hidden");
    });


    function alerta(mensaje) {
        // Remove existing alert if present
        const existingAlert = document.querySelector("#customAlert");
        if (existingAlert) {
            existingAlert.remove();
        }

        // Create alert container
        const alertContainer = document.createElement("div");
        alertContainer.id = "customAlert";
        alertContainer.className =
            "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[85vw] md:w-[80vw] lg:w-[75vw]";
        alertContainer.style.top = "-100px";

        // Create alert content
        const alertContent = document.createElement("div");
        alertContent.className = `
    relative
    bg-white
    border-2 border-red-600
    rounded-lg
    shadow-lg
    p-4 md:p-5
    flex flex-col md:flex-row md:items-center gap-3 md:gap-4
  `;

        // Create close button
        const closeButton = document.createElement("button");
        closeButton.className =
            "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600 rounded-full p-1.5 transition-colors duration-200";
        closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

        // Create main content container for mobile layout
        const contentContainer = document.createElement("div");
        contentContainer.className =
            "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

        // Create icon with exclamation mark
        const iconContainer = document.createElement("div");
        iconContainer.className = "flex-shrink-0 text-red-600";
        iconContainer.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="10" />
  <path d="M12 7v6" />
  <path d="M12 16h0.01" />
</svg>
`;
        // Create message text
        const messageText = document.createElement("p");
        messageText.className = "text-gray-900 text-base md:text-lg flex-1";
        messageText.textContent = mensaje;

        // Assemble the content container
        contentContainer.appendChild(iconContainer);
        contentContainer.appendChild(messageText);

        // Assemble the alert
        alertContent.appendChild(closeButton);
        alertContent.appendChild(contentContainer);
        alertContainer.appendChild(alertContent);
        document.body.appendChild(alertContainer);

        // Slide down animation
        requestAnimationFrame(() => {
            alertContainer.style.top = "56px";
        });

        // Add event listeners
        closeButton.addEventListener("click", () => {
            hideAlert(alertContainer);
        });

        // Hide loader if it exists
        loaderOff();
    }

    function hideAlert(alertContainer) {
        alertContainer.style.top = "-100px";

        setTimeout(() => {
            alertContainer.remove();
        }, 300);
    }

    let lineaObj;
    let initialY = null;

    // Evitar la recarga de la página al deslizar hacia abajo en dispositivos táctiles
    window.addEventListener(
        "touchstart",
        function (e) {
            if (e.touches.length !== 1) return;
            initialY = e.touches[0].clientY;
        },
        { passive: false }
    );

    window.addEventListener(
        "touchmove",
        function (e) {
            if (initialY === null) return;

            const currentY = e.touches[0].clientY;
            const diffY = initialY - currentY;

            // Si estamos en la parte superior de la página y se está deslizando hacia abajo
            if (window.scrollY === 0 && diffY < 0) {
                e.preventDefault();
            }
        },
        { passive: false }
    );

    window.addEventListener(
        "touchend",
        function () {
            initialY = null;
        },
        { passive: false }
    );


    /* LISTENERS */
    document.addEventListener("DOMContentLoaded", () => {
        const datosBoton = document.getElementById("datosBoton");
        datosBoton.addEventListener("click", () => {
            toggleElemento("datosLinea");
        });

    });

    const canvasFirma = document.getElementById("canvasFirma");
    const anchoVentana = window.innerWidth;
    if (anchoVentana >= 400) {
        canvasFirma.width = 400;
        canvasFirma.height = 250;
    } else {
        canvasFirma.width = anchoVentana - 20;
        canvasFirma.height = 250;
    }
    window.addEventListener("resize", () => {
        const anchoVentana = window.innerWidth;
        if (anchoVentana >= 412) {
            canvasFirma.width = 400;
            canvasFirma.height = 250;
        } else {
            canvasFirma.width = anchoVentana - 20;
            canvasFirma.height = 250;
        }
    });
    canvasFirma.addEventListener("mousedown", startPosition);
    canvasFirma.addEventListener("mouseup", endPosition);
    canvasFirma.addEventListener("mousemove", draw);
    canvasFirma.addEventListener("touchstart", startPosition);
    canvasFirma.addEventListener("touchend", endPosition);
    canvasFirma.addEventListener("touchmove", draw);

    if (firmar) {
        firmar.addEventListener("click", () => {
            // Show signature modal
            cajaCanvasFirma.classList.remove("hidden");

            // Clear canvas to ensure it's empty for a new signature
            clearcanvasFirma();
        });
    }

    const borrarFirma = document.getElementById("borrarFirma");
    if (borrarFirma) {
        borrarFirma.addEventListener("click", clearcanvasFirma);
    }

    const guardarFirma = document.getElementById("guardarFirma");
    if (guardarFirma) {
        guardarFirma.addEventListener("click", () => {
            saveSignature();
            cajaCanvasFirma.classList.add("hidden");
        });
    }

    function safeToggleElement(elementId) {
        const elemento = document.getElementById(elementId);
        if (elemento) {
            elemento.classList.toggle("hidden");
        } else {
            console.warn(`Element with id ${elementId} not found`);
        }
    }

    function toggleElemento(elementId) {
        const elemento = document.getElementById(elementId);
        if (elemento) {
            if (elemento.classList.contains("hidden")) {
                elemento.classList.remove("hidden");
            } else {
                elemento.classList.add("hidden");
            }
        } else {
            console.warn(`Element with id ${elementId} not found`);
        }
    }


    const fileInput = document.getElementById("fotosGaleria");
    fileInput.addEventListener("change", (e) => {
        handleFileUpload(e);
    });

    const cancelar = document.getElementById("cancelar");
    cancelar.addEventListener("click", (e) => {
        window.location.href =
            "https://dosxdos.app.iidos.com/ruta_montador.html";
    });

    //SUBMIT
    const formulario = document.getElementById("formLinea");
    formulario.addEventListener("submit", (e) => {
        //console.log('entra al evento submit');
        e.preventDefault();
        loaderOn();
        let aviso = "",
            caracteres = true,
            fecha,
            validarFecha,
            vJsonFirmas = true,
            vJsonFotos = true;
        const estado = document.getElementById("estado").value;
        //console.log(estado);
        const incidencia = document.getElementById("incidencia").value;
        //console.log(incidencia);
        //console.log(fecha);
        const dias = document.getElementById("dias").value;
        //console.log(dias);
        const horas = document.getElementById("horas").value;
        //console.log(horas);
        const minutos = document.getElementById("minutos").value;
        //console.log(minutos);
        let observaciones = document.getElementById(
            "observacionesTecnico"
        ).value;
        //observaciones = escaparHTML(observaciones);

        //console.log(observaciones);
        const numeroFotos = Object.keys(photos).length;
        //console.log(numeroFotos);
        const numeroFirmas = Object.keys(firmas).length;
        //console.log(numeroFirmas);
        const caracteresObs = observaciones.length;

        if (estado == "Pendiente") {
            fecha = "";
            validarFecha = true;
        } else {
            fecha = document.getElementById("fecha").value;
            if (fecha) {
                validarFecha = true;
            } else {
                validarFecha = false;
                aviso += "Es necesario ingresar la fecha de actuación";
            }
        }

        if (caracteresObs > 250) {
            aviso +=
                "El campo de observaciones de NAVISION sólo permite un máximo de 250 caracteres - Utiliza mejor el campo de APP NOTAS";
            caracteres = false;
        }

        let vNota;
        const nota = $nota.value;
        if (nota) {
            vNota = true;
        } else {
            vNota = false;
        }
        const notaObj = {};
        notaObj.ot = ot;
        notaObj.linea = lineaActividad;
        notaObj.nota = nota;
        const notaJson = JSON.stringify(notaObj);

        if (!caracteres || !validarFecha) {
            alerta(aviso);
            aviso = "";
            loaderOff();
        } else {
            const bodyNavision = {
                CodigoRuta: ruta,
                LineaRuta: linea,
                DescripcionIncidencia: "",
                DiasActuacion: dias,
                Estado: estado,
                FechaActuacion: fecha,
                FirmaCliente: `https://dosxdos.app.iidos.com/fotos_y_firmas.php?ruta=${ruta}&linea=${linea}&ot=${ot}&lineaActividad=${lineaActividad}`,
                FotosSubidas: numeroFotos,
                HorasActuacion: horas,
                Incidencia: incidencia,
                MinutosActuacion: minutos,
                ObservacionesTecnico: observaciones,
                LinkWeb: `https://dosxdos.app.iidos.com/fotos_y_firmas.php?ruta=${ruta}&linea=${linea}&ot=${ot}&lineaActividad=${lineaActividad}`,
            };

            //console.log(bodyNavision);
            const bodyNavisionJson = JSON.stringify(bodyNavision);
            //console.log(bodyNavisionJson);

            const valoresFotos = Object.values(photos);
            const valoresFirmas = Object.values(firmas);

            if (valoresFotos.length == 0) {
                vJsonFotos = false;
            }

            if (valoresFirmas.length == 0) {
                vJsonFirmas = false;
            }

            const totalFotos = {};
            const totalFirmas = {};

            totalFotos.ruta = ruta;
            totalFotos.linea = linea;
            totalFotos.ot = ot;
            totalFotos.lineaActividad = lineaActividad;
            totalFotos.fecha = fecha;
            totalFotos.cliente = cliente;
            totalFotos.nombreCliente = lineaObj.NombreCliente;
            totalFotos.pv = lineaObj.PuntoVenta;
            totalFotos.pvNombre = lineaObj.NombrePuntoVenta;
            totalFotos.usuario = usuarioId;

            totalFirmas.ruta = ruta;
            totalFirmas.linea = linea;
            totalFirmas.ot = ot;
            totalFirmas.lineaActividad = lineaActividad;
            totalFirmas.fecha = fecha;
            totalFirmas.cliente = cliente;
            totalFirmas.nombreCliente = lineaObj.NombreCliente;
            totalFirmas.pv = lineaObj.PuntoVenta;
            totalFirmas.pvNombre = lineaObj.NombrePuntoVenta;
            totalFirmas.usuario = usuarioId;
            totalFotos.fotos = [];
            totalFotos.fotos = valoresFotos;
            totalFirmas.firmas = [];
            totalFirmas.firmas = valoresFirmas;

            //console.log(totalFotos);
            //console.log(totalFirmas);

            const fotosJson = JSON.stringify(totalFotos);
            const firmasJson = JSON.stringify(totalFirmas);

            //console.log(fotosJson);
            //console.log(firmasJson);

            if (navigator.onLine) {
                procesarFormulario(
                    bodyNavisionJson,
                    vJsonFotos,
                    fotosJson,
                    vJsonFirmas,
                    firmasJson,
                    vNota,
                    notaJson
                );
            } else {
                procesarFormularioOff(
                    bodyNavision,
                    vJsonFotos,
                    totalFotos,
                    vJsonFirmas,
                    totalFirmas,
                    vNota,
                    notaObj
                );
            }
        }
    });

    function redirectToRutas() {
        window.location.href = "https://dosxdos.app.iidos.com/rutas_montador.html";
    }

    /* CONSTANTES Y VARIABLES */

    const $opcionesMenu = document.getElementById("opcionesMenu"),
        $contenido = document.getElementById("contenido"),
        $loader = document.getElementById("loader"),
        $body = document.getElementById("body"),
        $imgCerrar = document.getElementById("imgCerrar"),
        $nombreUsuario = document.getElementById("nombreUsuario"),
        $imagenUsuario = document.getElementById("imagenUsuario"),
        $botonRutas = document.getElementById("rutasIconoBoton"),
        $datosLinea = document.getElementById("datosLinea"),
        $datos = document.getElementById("datos"),
        photos = {},
        firmas = {},
        camara = document.getElementById("camara"),
        video = document.getElementById("video"),
        fotos = document.getElementById("fotos"),
        photosContainer = document.getElementById("photosContainer"),
        cerrarCamara = document.getElementById("imgCerrarCamara"),
        encabezado = document.getElementById("encabezado"),
        contenido = document.getElementById("contenido"),
        estado = document.getElementById("estado"),
        cajaForm = document.getElementById("cajaForm"),
        $nota = document.getElementById("appNotas");
    let montador,
        rutas,
        usuario,
        lineas,
        notificacionesSinAcpetarNumero = 0;
    const cajaCanvasFirmaModal = document.getElementById("cajaCanvasFirma");

    function deletePhoto(photoId) {
        // Prevent any form submission
        event.preventDefault();
        event.stopPropagation();

        showConfirmationModal("¿Estás seguro que deseas eliminar esta imagen?", (confirmed) => {
            if (confirmed) {
                // Remove the image from the photos object
                delete photos[photoId];

                // Remove the image from the DOM
                const imgElement = document.getElementById(photoId);
                if (imgElement) {
                    imgElement.parentElement.remove();
                }
            }
        });
    }

    function generateUniqueId() {
        return Date.now().toString();
    }

    function generarIdNumerico() {
        const id = Math.floor(Math.random() * 77);
        return id;
    }

    // Función para convertir un archivo a base64
    function convertirABase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    /* FOTOS DE GALERÍA */

    // Función para manejar el evento de cambio en el input de tipo archivo
    async function handleFileUpload(event) {
        const files = event.target.files;
        for (const file of files) {
            const base64String = await convertirABase64(file);
            const base64Image = `data:${file.type};base64,${base64String}`;
            const id1 = generateUniqueId();
            const id2 = generarIdNumerico();
            const idUnico = id1 + id2;
            photos[idUnico] = base64Image;
            const imgElement = document.createElement("img");
            imgElement.className = "imgCamara";
            imgElement.src = base64Image;
            imgElement.id = idUnico;

            // Crear un botón para eliminar la foto
            const deleteButton = document.createElement("button");
            deleteButton.className = "ruta2";
            deleteButton.setAttribute("type", "button"); // This is crucial
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
</svg>`;

            // Keep idUnico in a closure to ensure we're deleting the right image
            deleteButton.setAttribute('type', 'button'); // This is crucial to prevent form submission
            deleteButton.onclick = (function (currentPhotoId) {
                return function (e) {
                    e.preventDefault();  // Prevent default form submission
                    e.stopPropagation(); // Stop event from bubbling up

                    showConfirmationModal("¿Estás seguro que deseas eliminar esta imagen?", function (confirmed) {
                        if (confirmed) {
                            // Remove the specific image with the captured ID
                            delete photos[currentPhotoId];

                            // Remove from DOM
                            const imgToRemove = document.getElementById(currentPhotoId);
                            if (imgToRemove && imgToRemove.parentElement) {
                                imgToRemove.parentElement.remove();
                            }
                        }
                    });
                };
            })(idUnico);

            // Crear un contenedor para la imagen y el botón
            const container = document.createElement("div");
            container.className = "cajaFoto";
            container.appendChild(imgElement);
            container.appendChild(deleteButton);
            document.getElementById("photosContainer").appendChild(container);
            //console.log(photos);
        }
    }

    /* EVITAR REENVÍO DE FORMULARIOS */
    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }

    function scrollToTop() {
        // Para navegadores modernos
        document.documentElement.scrollTop = 0;
        // Para navegadores antiguos
        document.body.scrollTop = 0;
    }

    /* LOADER */
    function loaderOn() {
        scrollToTop();
        $loader.classList.remove("displayOff");
        $loader.classList.add("displayOn");
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
    }

    function loaderOff() {
        setTimeout(() => {
            $loader.classList.remove("displayOn");
            $loader.classList.add("displayOff");
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
        }, 1000);
    }

    function showConfirmationModal(message, callback) {
        const modal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmButton = document.getElementById('confirmAction');
        const cancelButton = document.getElementById('cancelConfirmation');
        const closeButton = document.getElementById('closeConfirmationModal');

        // Set message
        if (message) {
            confirmationMessage.textContent = message;
        } else {
            confirmationMessage.textContent = '¿Estás seguro que deseas eliminar este elemento?';
        }

        // Show modal
        modal.classList.remove('hidden');

        // Setup confirm action
        const confirmHandler = (e) => {
            e.preventDefault(); // Prevent form submission
            e.stopPropagation(); // Stop event propagation
            modal.classList.add('hidden');
            confirmButton.removeEventListener('click', confirmHandler);
            cancelButton.removeEventListener('click', cancelHandler);
            closeButton.removeEventListener('click', cancelHandler);
            document.removeEventListener('keydown', escHandler);
            if (typeof callback === 'function') {
                callback(true);
            }
        };

        // Setup cancel action
        const cancelHandler = (e) => {
            e.preventDefault(); // Prevent form submission
            e.stopPropagation(); // Stop event propagation
            modal.classList.add('hidden');
            confirmButton.removeEventListener('click', confirmHandler);
            cancelButton.removeEventListener('click', cancelHandler);
            closeButton.removeEventListener('click', cancelHandler);
            document.removeEventListener('keydown', escHandler);
            if (typeof callback === 'function') {
                callback(false);
            }
        };

        // Setup escape key handler
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                e.preventDefault(); // Prevent form submission
                cancelHandler(e);
            }
        };

        // Add event listeners
        confirmButton.addEventListener('click', confirmHandler);
        cancelButton.addEventListener('click', cancelHandler);
        closeButton.addEventListener('click', cancelHandler);
        document.addEventListener('keydown', escHandler);

        // Close when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                e.preventDefault(); // Prevent form submission
                cancelHandler(e);
            }
        }, { once: true });
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (!document.getElementById('confirmationModal')) {
            document.body.insertAdjacentHTML('beforeend', document.getElementById('confirmationModal').outerHTML);
        }
    });

    /* FIRMA */

    const ctx = canvasFirma.getContext("2d");
    let drawing = false;

    function startPosition(e) {
        drawing = true;
        draw(e);
    }

    function endPosition() {
        drawing = false;
        ctx.beginPath();
    }

    function draw(e) {
        if (!drawing) return;

        const rect = canvasFirma.getBoundingClientRect();
        let clientX, clientY;

        if (e.type === "mousemove") {
            clientX = e.clientX;
            clientY = e.clientY;
        } else if (e.type === "touchmove") {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        }

        const x = clientX - rect.left;
        const y = clientY - rect.top;

        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    function clearcanvasFirma() {
        const canvasFirma = document.getElementById("canvasFirma");
        const ctx = canvasFirma.getContext("2d");
        ctx.clearRect(0, 0, canvasFirma.width, canvasFirma.height);

        // Reset canvas dimensions based on window width
        const anchoVentana = window.innerWidth;
        if (anchoVentana >= 400) {
            canvasFirma.width = 400;
            canvasFirma.height = 250;
        } else {
            canvasFirma.width = anchoVentana - 20;
            canvasFirma.height = 250;
        }
    }

    function saveSignature() {
        const canvasFirma = document.getElementById("canvasFirma");
        const cajaCanvasFirma = document.getElementById("cajaCanvasFirma");
        const firmar = document.getElementById("firmar");

        if (!canvasFirma || !cajaCanvasFirma || !firmar) {
            console.warn("One or more required elements are missing");
            return;
        }

        const image = canvasFirma.toDataURL("image/png");
        const firmaId = generateUniqueId();

        firmas[firmaId] = image;

        const imgElement = document.createElement("img");
        imgElement.className = "imgFirma";
        imgElement.src = image;
        imgElement.id = firmaId;

        const deleteButton = document.createElement("button");
        deleteButton.className = "ruta2";
        deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
</svg>`;
        deleteButton.onclick = function () {
            deleteFirma(firmaId);
        };

        const container = document.createElement("div");
        container.className = "cajaFirma";
        container.appendChild(imgElement);
        container.appendChild(deleteButton);

        // Add console trace to see where this is being called from
        console.trace('Signature creation trace');

        const firmasContainer = document.getElementById("firmasContainer");
        if (firmasContainer) {
            firmasContainer.appendChild(container);
        } else {
            console.warn("Firmas container not found");
        }

        // Hide the signature modal
        cajaCanvasFirma.classList.add("hidden");

        // Clear the canvas after saving the signature
        clearcanvasFirma();

        firmar.scrollIntoView({ behavior: "smooth" });
    }

    function deleteFirma(firmaId) {
        // Prevent any form submission
        event.preventDefault();
        event.stopPropagation();

        showConfirmationModal("¿Estás seguro que deseas eliminar esta firma?", (confirmed) => {
            if (confirmed) {
                // Remove the signature from the firmas object
                delete firmas[firmaId];

                // Remove the signature from the DOM
                const imgElement = document.getElementById(firmaId);
                if (imgElement) {
                    imgElement.parentElement.remove();
                }
            }
        });
    }

    /* FUNCIONALIDADES ASÍNCRONAS DE LA APP */

    /* LOCALSTORAGE */
    const linea = localStorage.getItem("linea");
    if (linea && linea !== null) {
        console.log("Linea: " + linea);
    } else {
        //window.location.href = 'https://dosxdos.app.iidos.com/ruta_montador.html';
        console.log("No existe Linea");
    }
    const ruta = localStorage.getItem("ruta");
    if (ruta && ruta !== null) {
        console.log("Ruta: " + ruta);
    } else {
        // window.location.href = 'https://dosxdos.app.iidos.com/rutas_montador.html';
        console.log("No existe Ruta");
    }
    const cliente = localStorage.getItem("cliente");
    if (cliente && cliente !== null) {
        console.log("Cliente: " + cliente);
    } else {
        //window.location.href = 'https://dosxdos.app.iidos.com/rutas_montador.html';
        console.log("No existe Cliente");
    }
    const nombreCliente = localStorage.getItem("nombreCliente");
    if (nombreCliente && nombreCliente !== null) {
        console.log("nombreCliente: " + nombreCliente);
    } else {
        //window.location.href = 'https://dosxdos.app.iidos.com/rutas_montador.html';
        console.log("No existe nombreCliente");
    }
    const nombreRuta = localStorage.getItem("nombreRuta");
    if (nombreRuta && nombreRuta !== null) {
        console.log("nombreRuta: " + nombreRuta);
    } else {
        //window.location.href = 'https://dosxdos.app.iidos.com/rutas_montador.html';
        console.log("No existe nombreRuta");
    }
    const lineaActividad = localStorage.getItem("lineaActividad");
    if (lineaActividad && lineaActividad !== null) {
        console.log("LineaActividad: " + lineaActividad);
    } else {
        //window.location.href = 'https://dosxdos.app.iidos.com/rutas_montador.html';
        console.log("No existe lineaActividad");
    }
    const ot = localStorage.getItem("ot");
    if (ot && ot !== null) {
        console.log("ot: " + ot);
    } else {
        //window.location.href = 'https://dosxdos.app.iidos.com/rutas_montador.html';
        console.log("No existe ot");
    }
    const usuarioId = localStorage.getItem("usuario");
    if (usuarioId && usuarioId !== null) {
        console.log("usuario: " + usuarioId);
    } else {
        //window.location.href = 'https://dosxdos.app.iidos.com/index.html';
        console.log("No existe Usuario");
    }

    /* CERRAR SESIÓN */

    function eliminarCookie(nombre) {
        const tiempoExpiracion = 1; // Segundo 1 de la Época Unix
        document.cookie = `${nombre}=; expires=${new Date(
            tiempoExpiracion * 1000
        ).toUTCString()}; path=/;`;
    }

    /* TRAER DATOS DE LOS SERVIDORES */

    function fetchRutas() {
        return new Promise((resolve, reject) => {
            url =
                "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" + montador;
            fetch(url)
                .then((res) => {
                    if (res.ok) {
                        return res.json();
                    } else {
                        mensaje =
                            "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
                        alerta(mensaje);
                    }
                })
                .then((res) => {
                    if (res[0]) {
                        const request = indexedDB.open("dosxdos");
                        request.onsuccess = (event) => {
                            const db = event.target.result;
                            const transaction = db.transaction("rutas", "readwrite");
                            const datosStore = transaction.objectStore("rutas");
                            const clearRequest = datosStore.clear();
                            clearRequest.onsuccess = (clearEvent) => {
                                const datos = res[1];
                                datos.forEach((item) => {
                                    datosStore.add(item);
                                });
                                resolve(true);
                            };
                            clearRequest.onerror = (event) => {
                                error = event.target.error;
                                mensaje = `ERROR: ` + error;
                                console.error(error);
                                alerta(mensaje);
                            };
                        };
                        request.onerror = (event) => {
                            error = event.target.error;
                            mensaje = `ERROR: ` + error;
                            console.error(error);
                            alerta(mensaje);
                        };
                    } else {
                        mensaje = res[1];
                        console.error(mensaje);
                        alerta(mensaje);
                    }
                })
                .catch((error) => {
                    mensaje = "Sin conexión: " + error.message;
                    console.error(mensaje);
                    alerta(mensaje);
                });
        });
    }

    function fetchLineas(vectorRutas) {
        return new Promise(async (resolve, reject) => {
            try {
                const promises = vectorRutas.map(async (objeto) => {
                    const url =
                        "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
                        objeto.cod;
                    const res = await fetch(url);

                    if (!res.ok) {
                        throw new Error(
                            `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
                        );
                    }

                    const resJson = await res.json();

                    if (resJson[0]) {
                        const db = await new Promise((dbResolve, dbReject) => {
                            const request = indexedDB.open("dosxdos");
                            request.onsuccess = (event) => {
                                const db = event.target.result;
                                dbResolve(db);
                            };
                            request.onerror = (event) => {
                                dbReject(
                                    new Error(
                                        `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                                    )
                                );
                            };
                        });

                        const transaction = db.transaction("lineas", "readwrite");
                        const datosStore = transaction.objectStore("lineas");
                        const datos = resJson[1];
                        if (Array.isArray(datos)) {
                            datos.forEach((item) => {
                                datosStore.add(item);
                            });
                        } else {
                            datosStore.add(datos);
                        }
                    } else {
                        throw new Error(
                            `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
                        );
                    }
                });

                await Promise.all(promises);
                resolve(true);
            } catch (err) {
                console.error(err);
                reject(err);
            }
        });
    }

    function fetchTelefono(pdv) {
        return new Promise((resolve, reject) => {
            try {
                url =
                    "https://dosxdos.app.iidos.com/apirest/zoho.php?app=crm&pdv=" + pdv;
                fetch(url)
                    .then((res) => {
                        if (res.ok) {
                            return res.json();
                        } else {
                            mensaje =
                                "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchTelefono";
                            resolve(false);
                            console.log("Error en la API de Zoho");
                        }
                    })
                    .then((res) => {
                        if (res[0]) {
                            objetoPdv = res[1].data[0];
                            resolve(objetoPdv);
                        } else {
                            mensaje = res[1];
                            console.error(mensaje);
                            console.log("Error en la API de Zoho");
                            resolve(false);
                        }
                    })
                    .catch((error) => {
                        mensaje = "Sin conexión: " + error.message;
                        console.error(mensaje);
                        console.log("Error en la API de Zoho");
                        resolve(false);
                    });
            } catch (error) {
                mensaje = "Sin conexión: " + error.message;
                console.error(mensaje);
                console.log("Error en la API de Zoho");
                resolve(false);
            }
        });
    }

    /* SINCRONIZAR BASE DE DATOS */

    async function sincronizarDb() {
        try {
            loaderOn();
            const fRutas = await fetchRutas();
            rutas = await leerDatos("dosxdos", "rutas");
            rutas = rutas.map((objeto) => ({
                cod: objeto["No."],
                nombre: objeto["Descripcion"],
            }));
            const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
            if (limpiarLineas) {
                lineas = await fetchLineas(rutas);
                if (lineas) {
                    const mensaje = " - Se ha sincronizado la base de datos exitosamente";
                    localStorage.setItem("mensaje", mensaje);
                    window.location.href =
                        "https://dosxdos.app.iidos.com/linea_montador.html";
                } else {
                    alerta(
                        "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
                    );
                    loaderOff();
                }
            }
        } catch (error) {
            const mensaje =
                "No se ha sincronizado la base de datos: " + error.message;
            localStorage.setItem("mensaje", mensaje);
            window.location.href =
                "https://dosxdos.app.iidos.com/rutas_montador.html";
        }
    }

    async function sincronizarDb2() {
        return new Promise(async (resolve, reject) => {
            try {
                loaderOn();
                const fRutas = await fetchRutas();
                rutas = await leerDatos("dosxdos", "rutas");
                rutas = rutas.map((objeto) => ({
                    cod: objeto["No."],
                    nombre: objeto["Descripcion"],
                }));
                const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
                if (limpiarLineas) {
                    lineas = await fetchLineas(rutas);
                    if (lineas) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                }
            } catch (error) {
                console.error(error);
                reject(false);
            }
        });
    }

    /* LOGIN */

    function vLogin() {
        return new Promise((resolve, reject) => {
            const login = localStorage.getItem("login");
            if (login && login !== null) {
                leerDatos("dosxdos", "usuario")
                    .then((res) => {
                        usuario = res[0];
                        resolve(usuario.clase);
                    })
                    .catch((err) => {
                        resolve(false);
                    });
            } else {
                resolve(false);
            }
        });
    }

    /* CARGAR DATOS */

    function cargarDatoTexto(id, valor) {
        const elemento = document.getElementById(id);
        temporalDiv = document.createElement("div");
        temporalDiv.innerHTML = valor;
        textoConvertido = temporalDiv.textContent || temporalDiv.innerText;
        elemento.innerHTML = textoConvertido;
    }

    function cargarDatoValor(id, valor) {
        const elemento = document.getElementById(id);
        //const numeroParseado = parseFloat(valor.replace(',', '.'));
        //elemento.value = numeroParseado;
        elemento.value = valor;
    }

    function cargarDatoSelect(id, valor) {
        const elemento = document.getElementById(id);
        for (let i = 0; i < elemento.options.length; i++) {
            if (elemento.options[i].value == valor) {
                elemento.selectedIndex = i;
                break;
            }
        }
    }

    /*
    // Cargar fecha para Navision
    function cargarFecha(id, fechaEnFormatoLocal) {
        const partesFecha = fechaEnFormatoLocal.split('/');
        const dia = parseInt(partesFecha[0], 10);
        const mes = parseInt(partesFecha[1], 10) - 1; // Los meses en JavaScript van de 0 a 11
        const anio = parseInt(partesFecha[2], 10);
        // Si el año es menor que 100, asumimos que está en formato abreviado y le añadimos el siglo actual
        const anioCompleto = anio < 100 ? anio + 2000 : anio;
        const fecha = new Date(anioCompleto, mes, dia);
        const anio2 = fecha.getFullYear();
        const mes2 = ('0' + (fecha.getMonth() + 1)).slice(-2); // El mes está basado en 0, por eso +1
        const dia2 = ('0' + fecha.getDate()).slice(-2);
        const fecha2 = `${anio2}-${mes2}-${dia2}`;
        const fechaInput = document.getElementById(id);
        fechaInput.value = fecha2;
    }
    */

    // Cargar fecha para CRM
    function cargarFecha(id, fechaEnFormatoLocal) {
        const fechaInput = document.getElementById(id);
        fechaInput.value = fechaEnFormatoLocal;
    }

    function obtenerConfirmacion() {
        return new Promise((resolve, reject) => {
            const respuesta = confirm(
                "¿Estás segur@ que deseas eliminar el archivo del servidor?"
            );
            if (respuesta) {
                resolve(true);
            } else {
                resolve(false);
            }
        });
    }

    function eliminarFoto(jsonDelete) {
        return new Promise((resolve, reject) => {
            //console.log(jsonDelete);
            fetch("https://dosxdos.app.iidos.com/apirest/fotos.php", {
                method: "DELETE",
                headers: {
                    "Content-type": "application/json; charset=utf-8",
                },
                body: jsonDelete,
            })
                .then((res) =>
                    res.ok
                        ? res.json()
                        : reject(
                            new Error(
                                `Error en el servidor de la api intermedia al intentar consultar las fotos de la línea`
                            )
                        )
                )
                .then((res) => {
                    resolve(res[1]);
                })
                .catch((err) => {
                    mensaje = err.message;
                    console.error(err);
                    alerta(mensaje);
                    reject(new Error(mensaje));
                });
        });
    }

    function eliminarFirma(jsonDelete) {
        return new Promise((resolve, reject) => {
            //console.log(jsonDelete);
            fetch("https://dosxdos.app.iidos.com/apirest/firmas.php", {
                method: "DELETE",
                headers: {
                    "Content-type": "application/json; charset=utf-8",
                },
                body: jsonDelete,
            })
                .then((res) =>
                    res.ok
                        ? res.json()
                        : reject(
                            new Error(
                                `Error en el servidor de la api intermedia al intentar consultar las fotos de la línea`
                            )
                        )
                )
                .then((res) => {
                    resolve(res[1]);
                })
                .catch((err) => {
                    mensaje = err.message;
                    console.error(err);
                    alerta(mensaje);
                    reject(new Error(mensaje));
                });
        });
    }

    async function deletePhotoServidor(otFoto, id, usuarioElimina, tipo) {
        if (navigator.onLine) {
            showConfirmationModal("¿Estás seguro que deseas eliminar el archivo del servidor?", async (confirmed) => {
                if (confirmed) {
                    try {
                        loaderOn();
                        json = {};
                        json.ot = otFoto;
                        json.id = id;
                        json.usuarioElimina = usuarioElimina;
                        json.tipo = tipo;
                        const jsonDelete = JSON.stringify(json);

                        let eliminar;
                        if (tipo == "foto") {
                            eliminar = await eliminarFoto(jsonDelete);
                        } else {
                            eliminar = await eliminarFirma(jsonDelete);
                        }

                        localStorage.setItem("mensaje", eliminar);
                        window.location.href = "https://dosxdos.app.iidos.com/linea_montador.html";
                    } catch (err) {
                        console.error(err);
                        alerta(err.message);
                        loaderOff();
                    }
                }
            });
        } else {
            mensaje = "No es posible eliminar archivos del servidor sin conexión a internet";
            alerta(mensaje);
            scrollToTop();
        }
    }

    function esVideo(nombreArchivo) {
        return new Promise((resolve, reject) => {
            // Obtener la extensión del archivo
            const extension = nombreArchivo.split(".").pop().toLowerCase();
            // Lista de extensiones de video válidas
            const extensionesVideo = [
                "mp4",
                "mov",
                "avi",
                "wmv",
                "flv",
                "mkv",
                "mpg",
            ];
            // Verificar si la extensión está en la lista
            if (extensionesVideo.includes(extension)) {
                resolve(true);
            } else {
                resolve(false);
            }
        });
    }

    async function traerFotos() {
        return new Promise((resolve, reject) => {
            url =
                "https://dosxdos.app.iidos.com/apirest/fotos.php?ruta=" +
                ruta +
                "&linea=" +
                linea +
                "&ot=" +
                ot +
                "&lineaOt=" +
                lineaActividad;
            fetch(url)
                .then((res) =>
                    res.ok
                        ? res.json()
                        : reject(
                            new Error(
                                `Error en el servidor de la api intermedia al intentar consultar las fotos de la línea`
                            )
                        )
                )
                .then((res) => {
                    if (res[0]) {
                        if (res[1].length > 0) {
                            //console.log(res[1]);
                            vectorDeFotos = res[1];
                            vectorDeFotos.map(async (objeto) => {
                                if (objeto.ext != "zip") {
                                    imgElement = "";
                                    const esUnVideo = await esVideo(objeto.nombre);
                                    console.log(esUnVideo);
                                    // Puedes mostrar la imagen capturada si lo deseas
                                    if (esUnVideo) {
                                        imgElement = document.createElement("video");
                                        imgElement.controls = true;
                                        imgElement.className = "imgCamara";
                                        imgElement.src = objeto.link;
                                        console.log("Entró a video");
                                    } else {
                                        imgElement = document.createElement("img");
                                        imgElement.className = "imgCamara";
                                        imgElement.src = objeto.link;
                                        console.log("No entró a video");
                                    }
                                    // Crear un botón para eliminar la foto
                                    const deleteButton = document.createElement("button");
                                    deleteButton.className = "ruta";
                                    deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
</svg>`;
                                    deleteButton.type = "button";
                                    deleteButton.onclick = function () {
                                        deletePhotoServidor(ot, objeto.id, usuarioId, "foto");
                                    };

                                    // Crear un contenedor para la imagen y el botón
                                    const container = document.createElement("div");
                                    container.className = "cajaFoto";
                                    container.appendChild(imgElement);
                                    container.appendChild(deleteButton);

                                    document
                                        .getElementById("photosContainer")
                                        .appendChild(container);
                                }
                            });
                            resolve(true);
                        } else {
                            resolve(false);
                            //console.log('sin fotos')
                        }
                    }
                })
                .catch((res) => {
                    mensaje =
                        "Error al consultar la existencia de fotos: " + res.message;
                    console.error(res);
                    alerta(mensaje);
                });
        });
    }

    async function traerNota() {
        return new Promise((resolve, reject) => {
            url =
                "https://dosxdos.app.iidos.com/apirest/notas.php?ot=" +
                ot +
                "&linea=" +
                lineaActividad;
            fetch(url)
                .then((res) =>
                    res.ok
                        ? res.json()
                        : reject(
                            new Error(
                                `Error en el servidor de la api intermedia al intentar consultar la nota de la línea`
                            )
                        )
                )
                .then((res) => {
                    if (res[0]) {
                        notaObjeto = res[1];
                        notaTexto = notaObjeto.nota;
                        resolve(notaTexto);
                    } else {
                        resolve(false);
                    }
                })
                .catch((res) => {
                    mensaje =
                        "Error al consultar la existencia de nota: " + res.message;
                    console.error(res);
                    alerta(mensaje);
                });
        });
    }

    function traerFirmas() {
        return new Promise((resolve, reject) => {
            url =
                "https://dosxdos.app.iidos.com/apirest/firmas.php?ruta=" +
                ruta +
                "&linea=" +
                linea +
                "&ot=" +
                ot +
                "&lineaOt=" +
                lineaActividad;
            fetch(url)
                .then((res) =>
                    res.ok
                        ? res.json()
                        : reject(
                            new Error(
                                `Error en el servidor de la api intermedia al intentar consultar las fotos de la línea`
                            )
                        )
                )
                .then((res) => {
                    if (res[0]) {
                        if (res[1].length > 0) {
                            //console.log(res[1]);
                            vectorDeFotos = res[1];
                            vectorDeFotos.forEach((objeto) => {
                                if (objeto.ext != "zip") {
                                    // Puedes mostrar la imagen capturada si lo deseas
                                    const imgElement = document.createElement("img");
                                    imgElement.className = "imgCamara";
                                    imgElement.src = objeto.link;

                                    // Crear un botón para eliminar la foto
                                    const deleteButton = document.createElement("button");
                                    deleteButton.className = "ruta";
                                    deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
</svg>`;
                                    deleteButton.type = "button";
                                    deleteButton.onclick = function () {
                                        deletePhotoServidor(ot, objeto.id, usuarioId, "firma");
                                    };

                                    // Crear un contenedor para la imagen y el botón
                                    const container = document.createElement("div");
                                    container.className = "cajaFoto";
                                    container.appendChild(imgElement);
                                    container.appendChild(deleteButton);

                                    document
                                        .getElementById("firmasContainer")
                                        .appendChild(container);
                                }
                            });
                            resolve(true);
                        } else {
                            resolve(false);
                            //console.log('sin fotos')
                        }
                    }
                })
                .catch((res) => {
                    mensaje =
                        "Error al consultar la existencia de firmas: " + res.message;
                    console.error(res);
                    alerta(mensaje);
                });
        });
    }

    /* MANJEO DEL FORMULARIO */

    function actualizarLinea(json) {
        console.log(json);
        localStorage.setItem("jsonForm", json);
        return new Promise((resolve, reject) => {
            fetch("https://dosxdos.app.iidos.com/apirest/lineas.php", {
                method: "PUT",
                headers: {
                    "Content-type": "application/json; charset=utf-8",
                },
                body: json,
            })
                .then((res) => (res.ok ? res.json() : resolve(false)))
                .then((res) => {
                    if (res[0]) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                })
                .catch((err) => {
                    console.log(err);
                    resolve(false);
                });
        });
    }

    function subirFotos(json) {
        return new Promise((resolve, reject) => {
            fetch("https://dosxdos.app.iidos.com/apirest/fotos.php", {
                method: "POST",
                headers: {
                    "Content-type": "application/json; charset=utf-8",
                },
                body: json,
            })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error(
                            `Error en el servidor de la API intermedia al guardar las fotos. Status: ${res.status}`
                        );
                    }
                    return res.json();
                })
                .then((res) => {
                    if (res[0]) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                })
                .catch((err) => {
                    console.log(err);
                    reject(err);
                });
        });
    }

    function subirFirmas(json) {
        return new Promise((resolve, reject) => {
            fetch("https://dosxdos.app.iidos.com/apirest/firmas.php", {
                method: "POST",
                headers: {
                    "Content-type": "application/json; charset=utf-8",
                },
                body: json,
            })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error(
                            `Error en el servidor de la API intermedia al guardar las firmas. Status: ${res.status}`
                        );
                    }
                    return res.json();
                })
                .then((res) => {
                    if (res[0]) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                })
                .catch((err) => {
                    console.log(err);
                    reject(err);
                });
        });
    }

    function subirNota(json) {
        return new Promise((resolve, reject) => {
            fetch("https://dosxdos.app.iidos.com/apirest/notas.php", {
                method: "POST",
                headers: {
                    "Content-type": "application/json; charset=utf-8",
                },
                body: json,
            })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error(
                            `Error en el servidor de la API intermedia al guardar la nota. Status: ${res.status}`
                        );
                    }
                    return res.json();
                })
                .then((res) => {
                    if (res[0]) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                })
                .catch((err) => {
                    console.log(err);
                    reject(err);
                });
        });
    }

    async function procesarFormulario(
        jsonLinea,
        vJsonFotos,
        jsonFotos,
        vJsonFirmas,
        jsonFirmas,
        vNota,
        jsonNota
    ) {
        try {
            mensaje = "";
            const upLinea = await actualizarLinea(jsonLinea);
            if (upLinea) {
                mensaje = "-Datos guardados con éxito-";
            } else {
                mensaje = "-Error al guardar los datos-";
            }
            if (vJsonFotos) {
                const upFotos = await subirFotos(jsonFotos);
                if (upFotos) {
                    mensaje += "-Fotos subidas con éxito-";
                } else {
                    mensaje += "-Error al subir las fotos-";
                }
            }
            if (vJsonFirmas) {
                const upFirmas = await subirFirmas(jsonFirmas);
                if (upFirmas) {
                    mensaje += "-Firmas subidas con éxito-";
                } else {
                    mensaje += "-Error al subir las firmas-";
                }
            }
            if (vNota) {
                const upNota = await subirNota(jsonNota);
                if (upNota) {
                    mensaje += "-Nota subida con éxito-";
                } else {
                    mensaje += "-Error al subir la nota-";
                }
            }
            const sincronizacion = await sincronizarDb2();
            if (sincronizacion) {
                mensaje += "-Base de datos sincronizada con éxito-";
            } else {
                mensaje += "-Error en la sincronización de la base de datos-";
            }
            localStorage.setItem("mensaje", mensaje);
            /*alerta(mensaje);
                scrollToTop;*/
            window.location.href =
                "https://dosxdos.app.iidos.com/ruta_montador.html";
        } catch (error) {
            console.log(error);
            alerta(error.message);
        }
    }

    async function procesarFormularioOff(
        lineaOb,
        vJsonFotos,
        fotosOb,
        vJsonFirmas,
        firmasOb,
        vNota,
        notaOb
    ) {
        try {
            mensaje = "-Sin conexión a internet-";
            const upLinea = await agregarDato2(
                "dosxdos",
                "peticionesLineas",
                lineaOb
            );
            if (upLinea) {
                mensaje += "-Datos guardados para su posterior envío al servidor -";
            } else {
                mensaje += "-Error al guardar los datos-";
            }
            if (vJsonFotos) {
                const upFotos = await agregarDato2(
                    "dosxdos",
                    "peticionesFotos",
                    fotosOb
                );
                if (upFotos) {
                    mensaje += "-Fotos guardadas para su posterior envío al servidor-";
                } else {
                    mensaje += "-Error al guardar las fotos-";
                }
            }
            if (vJsonFirmas) {
                const upFirmas = await agregarDato2(
                    "dosxdos",
                    "peticionesFirmas",
                    firmasOb
                );
                if (upFirmas) {
                    mensaje += "-Firmas guardadas para su posterior envío al servidor-";
                } else {
                    mensaje += "-Error al guardar las firmas-";
                }
            }
            if (vNota) {
                const upNota = await agregarDato2("dosxdos", "notas", notaOb);
                if (upNota) {
                    mensaje += "-Nota guardada para su posterior envío al servidor-";
                } else {
                    mensaje += "-Error al guardar la nota-";
                }
            }
            alerta(mensaje);
            scrollToTop();
        } catch (error) {
            console.log(error);
            alerta(error.message);
        }
    }

    async function enviarPeticiones(vectorObjDb, tipoVector) {
        return new Promise(async (resolve, reject) => {
            try {
                let solicitud,
                    mensaje = "",
                    vaciarStore;
                for (const objeto of vectorObjDb) {
                    jsonObjeto = JSON.stringify(objeto);
                    if (tipoVector == "lineas") {
                        solicitud = await actualizarLinea(jsonObjeto);
                        if (!solicitud) {
                            mensaje += `-Error en el envío de la petición pendiente de la actualización de datos en la api de Navision en la ruta: ${objeto.CodigoRuta} y la línea de ruta: ${objeto.LineaRuta}-`;
                        }
                    } else if (tipoVector == "fotos") {
                        solicitud = await subirFotos(jsonObjeto);
                        if (!solicitud) {
                            mensaje += `-Error al subir las fotos pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
                        }
                    } else if (tipoVector == "firmas") {
                        solicitud = await subirFirmas(jsonObjeto);
                        if (!solicitud) {
                            mensaje += `-Error al subir las firmas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
                        }
                    } else if (tipoVector == "notas") {
                        solicitud = await subirNota(jsonObjeto);
                        if (!solicitud) {
                            mensaje += `-Error al subir las notas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.linea}-`;
                        }
                    }
                }
                if (tipoVector == "lineas") {
                    vaciarStore = await limpiarDatos("dosxdos", "peticionesLineas");
                    mensaje += "-Datos pendientes enviados al servidor-";
                } else if (tipoVector == "fotos") {
                    vaciarStore = await limpiarDatos("dosxdos", "peticionesFotos");
                    mensaje += "-Fotos pendientes subidas al servidor-";
                } else if (tipoVector == "firmas") {
                    vaciarStore = await limpiarDatos("dosxdos", "peticionesFirmas");
                    mensaje += "-Firmas pendientes subidas al servidor-";
                } else if (tipoVector == "notas") {
                    vaciarStore = await limpiarDatos("dosxdos", "notas");
                    mensaje += "-Notas pendientes subidas al servidor-";
                }
                resolve(mensaje);
            } catch (err) {
                console.error(err);
                alerta(err.message);
                scrollToTop();
                reject(err);
            }
        });
    }

    async function procesarPeticiones() {
        try {
            loaderOn();
            mensaje = "";
            const exPeticionesLineas = await almacenVacio(
                "dosxdos",
                "peticionesLineas"
            );
            if (!exPeticionesLineas) {
                const peticionesLineas = await leerDatos(
                    "dosxdos",
                    "peticionesLineas"
                );
                if (peticionesLineas) {
                    //console.log(peticionesLineas);
                    const enviarPeticionesLineas = await enviarPeticiones(
                        peticionesLineas,
                        "lineas"
                    );
                    if (enviarPeticionesLineas) {
                        mensaje += enviarPeticionesLineas;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
                }
            }
            const exPeticionesFotos = await almacenVacio(
                "dosxdos",
                "peticionesFotos"
            );
            if (!exPeticionesFotos) {
                const peticionesFotos = await leerDatos("dosxdos", "peticionesFotos");
                if (peticionesFotos) {
                    //console.log(peticionesFotos);
                    const enviarPeticionesFotos = await enviarPeticiones(
                        peticionesFotos,
                        "fotos"
                    );
                    if (enviarPeticionesFotos) {
                        mensaje += enviarPeticionesFotos;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
                }
            }
            const exPeticionesFirmas = await almacenVacio(
                "dosxdos",
                "peticionesFirmas"
            );
            if (!exPeticionesFirmas) {
                const peticionesFirmas = await leerDatos(
                    "dosxdos",
                    "peticionesFirmas"
                );
                if (peticionesFirmas) {
                    //console.log(peticionesFirmas);
                    const enviarPeticionesFirmas = await enviarPeticiones(
                        peticionesFirmas,
                        "firmas"
                    );
                    if (enviarPeticionesFirmas) {
                        mensaje += enviarPeticionesFirmas;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
                }
            }
            const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
            if (!exPeticionesNotas) {
                const peticionesNotas = await leerDatos("dosxdos", "notas");
                if (peticionesNotas) {
                    //console.log(peticionesFirmas);
                    const enviarPeticionesNotas = await enviarPeticiones(
                        peticionesNotas,
                        "notas"
                    );
                    if (enviarPeticionesNotas) {
                        mensaje += enviarPeticionesNotas;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
                }
            }
            if (!mensaje) {
                mensaje = "No hay datos pendientes para ser enviados al servidor";
            }
            const sincronizarBaseDatos = await sincronizarDb2();
            if (sincronizarBaseDatos) {
                mensaje += " - Se ha sincronizado la base de datos exitosamente";
            } else {
                mensaje += "-Error: No ha sido posible sincronizar la base de datos-";
            }
            localStorage.setItem("mensaje", mensaje);
            window.location.href =
                "https://dosxdos.app.iidos.com/ruta_montador.html";
            /*alerta(mensaje);
                scrollToTop();*/
        } catch (error) {
            console.error(error);
            alerta(error.message);
            scrollToTop();
        }
    }

    async function procesarPeticiones2(mensaje) {
        try {
            if (mensaje == null) {
                mensaje = "";
            }
            const exPeticionesLineas = await almacenVacio(
                "dosxdos",
                "peticionesLineas"
            );
            if (!exPeticionesLineas) {
                const peticionesLineas = await leerDatos(
                    "dosxdos",
                    "peticionesLineas"
                );
                if (peticionesLineas) {
                    //console.log(peticionesLineas);
                    const enviarPeticionesLineas = await enviarPeticiones(
                        peticionesLineas,
                        "lineas"
                    );
                    if (enviarPeticionesLineas) {
                        mensaje += enviarPeticionesLineas;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
                }
            }
            const exPeticionesFotos = await almacenVacio(
                "dosxdos",
                "peticionesFotos"
            );
            if (!exPeticionesFotos) {
                const peticionesFotos = await leerDatos("dosxdos", "peticionesFotos");
                if (peticionesFotos) {
                    //console.log(peticionesFotos);
                    const enviarPeticionesFotos = await enviarPeticiones(
                        peticionesFotos,
                        "fotos"
                    );
                    if (enviarPeticionesFotos) {
                        mensaje += enviarPeticionesFotos;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
                }
            }
            const exPeticionesFirmas = await almacenVacio(
                "dosxdos",
                "peticionesFirmas"
            );
            if (!exPeticionesFirmas) {
                const peticionesFirmas = await leerDatos(
                    "dosxdos",
                    "peticionesFirmas"
                );
                if (peticionesFirmas) {
                    //console.log(peticionesFirmas);
                    const enviarPeticionesFirmas = await enviarPeticiones(
                        peticionesFirmas,
                        "firmas"
                    );
                    if (enviarPeticionesFirmas) {
                        mensaje += enviarPeticionesFirmas;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
                }
            }
            const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
            if (!exPeticionesNotas) {
                const peticionesNotas = await leerDatos("dosxdos", "notas");
                if (peticionesNotas) {
                    //console.log(peticionesFirmas);
                    const enviarPeticionesNotas = await enviarPeticiones(
                        peticionesNotas,
                        "notas"
                    );
                    if (enviarPeticionesNotas) {
                        mensaje += enviarPeticionesNotas;
                    }
                } else {
                    mensaje +=
                        "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
                }
            }
            if (mensaje) {
                alerta(mensaje);
                scrollToTop();
            }
        } catch (error) {
            console.error(error);
            alerta(error.message);
            scrollToTop();
        }
    }

    function escaparHTML(texto) {
        return texto
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/'/g, "&#x27;")
            .replace(/"/g, "&quot;")
            .replace(/Á/g, "&Aacute;")
            .replace(/É/g, "&Eacute;")
            .replace(/Í/g, "&Iacute;")
            .replace(/Ó/g, "&Oacute;")
            .replace(/Ú/g, "&Uacute;")
            .replace(/Ü/g, "&Uuml;")
            .replace(/Ñ/g, "&Ntilde;")
            .replace(/á/g, "&aacute;")
            .replace(/é/g, "&eacute;")
            .replace(/í/g, "&iacute;")
            .replace(/ó/g, "&oacute;")
            .replace(/ú/g, "&uacute;")
            .replace(/ü/g, "&uuml;")
            .replace(/ñ/g, "&ntilde;");
    }

    function sanarNombre(nombre) {
        const escapedText = nombre.replace(/['\\/",]/, "");
        return escapedText;
    }

    /* TAREAS EN LA INTERMITENCIA DE LA CONEXIÓN */

    window.addEventListener("online", () => {
        console.log("La conexión a Internet se ha recuperado.");
        //cache();
        procesarPeticiones();
    });

    window.addEventListener("offline", () => {
        console.log("La conexión a Internet se ha perdido.");
    });

    /* PAGESHOW */
    window.addEventListener("pageshow", (e) => {
        console.log("Carga completa de los elementos de la página no fetch");
        let mensaje = localStorage.getItem("mensaje");
        if (mensaje && mensaje !== null) {
            alerta(mensaje);
            localStorage.removeItem("mensaje");
        }
        let login = localStorage.getItem("login");
        if (!login || login === null) {
            window.location.href = "https://dosxdos.app.iidos.com/index.html";
        }
    });

    // INITIALIZATION FUNCTION
    function initializeApplication() {
        // Dynamically create navigation based on user role
        createDesktopNavigation(usuario.clase);
        // Setup desktop and mobile navigation
        setupMenu(usuario.clase);

        // Setup menu interactions
        setupMenuInteractions();
        setupUserActions();
        setupGlobalMenuClosing();

        updateUserDisplay();

        // Update the user information in the new UI elements
        const nombreUsuarioDesktop = document.getElementById('nombreUsuarioDesktop');
        const nombreUsuarioMobile = document.getElementById('nombreUsuarioMobile');
        const imagenUsuarioDesktop = document.getElementById('imagenUsuarioDesktop');
        const imagenUsuarioMobile = document.getElementById('imagenUsuarioMobile');

        if (nombreUsuarioDesktop) nombreUsuarioDesktop.textContent = usuario.nombre;
        if (nombreUsuarioMobile) nombreUsuarioMobile.textContent = usuario.nombre;

        if (usuario.imagen !== "0") {
            if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
            if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
        }
    }

    /* INICIAR APP ONLINE */
    async function appOnline() {
        try {
            const login = await vLogin();
            if (!login) {
                window.location.href = "https://dosxdos.app.iidos.com/index.html";
            } else {
                const Arrayusuario = await leerDatos("dosxdos", "usuario");
                usuario = Arrayusuario[0];
                let loginMontador = localStorage.getItem("loginMontador");
                if (!loginMontador || loginMontador === null) {
                    window.location.href =
                        "https://dosxdos.app.iidos.com/dosxdos.php?id=" +
                        usuario.id +
                        "&rol=" +
                        usuario.clase;
                }
                montador = usuario.cod;
                initializeApplication()

                try {
                    const sincronizacionDeNotificaciones = await sincronizarNotificaciones();
                    if (sincronizacionDeNotificaciones) {
                        await notificar();
                    }
                } catch (error) {
                    console.error("Error loading notifications:", error);
                }

                sinc = await sincronizarDb2();
                sinc
                    ? console.log("Base de datos sincronizada")
                    : console.error("Error al sincronizar la base de datos");
                const TotalLineas = await leerDatos("dosxdos", "lineas");
                if (TotalLineas) {
                    //console.log(TotalLineas);
                    const lineas = TotalLineas.filter((objeto) => {
                        return objeto.Proyecto == ruta;
                    });
                    //console.log(lineas);
                    if (lineas) {
                        const lineaVector = lineas.filter((objeto) => {
                            return objeto.Linea == linea;
                        });
                        if (lineaVector) {
                            lineaObj = lineaVector[0];

                            const $titulo = document.getElementById("titulo");
                            const $subtitulo = document.getElementById("subtitulo");

                            if ($titulo && $subtitulo) {
                                // Ensure all values exist, fallback to empty string if missing
                                const nombreRutaText = nombreRuta || "Ruta Desconocida";
                                const otText = ot ? `OT: ${ot}` : "";
                                const lineaText = lineaActividad ? `Línea: ${lineaActividad}` : "";
                                const clienteText = lineaObj.NombreCliente ? `Cliente: ${lineaObj.NombreCliente}` : "";
                                const pvText = lineaObj.PuntoVenta ? `PV: ${lineaObj.PuntoVenta} ${lineaObj.NombrePuntoVenta || ''}` : "";
                                const firmaText = lineaObj.Firma ? `Firma: ${lineaObj.Firma}` : "";

                                // Set title and subtitle separately
                                $titulo.innerHTML = nombreRutaText;
                                $subtitulo.innerHTML = `${otText} | ${lineaText} | ${clienteText} | ${pvText} | ${firmaText}`;

                                // Make sure they are visible
                                $titulo.style.display = "block";
                                $subtitulo.style.display = "block";
                            } else {
                                console.warn("⚠️ Titulo or Subtitulo element not found");
                            }



                            numeroPuntoDeVenta = lineaObj.PuntoVenta;
                            const objPdv = await fetchTelefono(numeroPuntoDeVenta);
                            let telPdv;
                            if (objPdv) {
                                telPdv = objPdv.N_tel_fono;
                                if (telPdv) {
                                    const telefonoBoton =
                                        document.getElementById("telefonoBoton");
                                    telefonoBoton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>` + telPdv;
                                    telefonoBoton.addEventListener("click", () => {
                                        window.location.href = "tel:" + telPdv;
                                    });
                                } else {
                                    telefonoBoton.innerHTML = "Sin Teléfono";
                                }
                            } else {
                                telefonoBoton.innerHTML = "Sin Teléfono";
                            }
                            cargarDatoTexto("cliente", lineaObj.NombreCliente);
                            cargarDatoTexto("ot", lineaObj.OT);
                            cargarDatoTexto("tipoOt", lineaObj.TipoOT);
                            cargarDatoTexto("descripcionOt", lineaObj.DescripcionOT);
                            cargarDatoTexto("lineaOt", lineaObj.LineaActividad);
                            cargarDatoTexto("puntoDeVenta", lineaObj.PuntoVenta);
                            cargarDatoTexto("puntoDeVenta2", lineaObj.NombrePuntoVenta);
                            cargarDatoTexto("zona", lineaObj.Zona);
                            cargarDatoTexto("sector", lineaObj.Sector);
                            cargarDatoTexto("direccion", lineaObj.DireccionPuntoVenta);
                            cargarDatoTexto("tipoDeTrabajo", lineaObj.TipoTrabajo);
                            cargarDatoTexto(
                                "tipoDeTrabajo2",
                                lineaObj.DescripcionTipoTrabajo
                            );
                            cargarDatoTexto("observaciones", lineaObj.Observaciones);
                            cargarDatoTexto("poner", lineaObj.Poner);
                            cargarDatoTexto("quitar", lineaObj.Quitar);
                            cargarDatoTexto("alto", lineaObj.Alto);
                            cargarDatoTexto("ancho", lineaObj.Ancho);
                            cargarDatoTexto("firmaDatos", lineaObj.Firma);
                            cargarDatoTexto("revisado", lineaObj.Revisado);
                            cargarDatoSelect("estado", lineaObj.Estado);
                            cargarDatoTexto("navisionOt", lineaObj.Navision_OT);
                            /* FORMULARIO */
                            if (lineaObj.Incidencia) {
                                cargarDatoSelect("incidencia", lineaObj.Incidencia);
                            }
                            if (lineaObj.FechaActuacion) {
                                console.log(lineaObj.FechaActuacion);
                                cargarFecha("fecha", lineaObj.FechaActuacion);
                            }
                            if (lineaObj.DiasActuacion) {
                                cargarDatoValor("dias", lineaObj.DiasActuacion);
                            }
                            if (lineaObj.TiempoActuacion) {
                                cargarDatoValor("horas", lineaObj.TiempoActuacion);
                            }
                            if (lineaObj.MinutosActuacion) {
                                cargarDatoValor("minutos", lineaObj.MinutosActuacion);
                            }
                            if (lineaObj.ObservacionesTecnico) {
                                cargarDatoTexto(
                                    "observacionesTecnico",
                                    lineaObj.ObservacionesTecnico
                                );
                            }
                            const cargarNota = await traerNota();
                            console.log(cargarNota);
                            if (cargarNota) {
                                cargarDatoTexto("appNotas", cargarNota);
                            }
                            const peticionesCierre = await procesarPeticiones2();
                            const fotosServidor = await traerFotos();
                            const firmasServidor = await traerFirmas();
                            loaderOff();
                        } else {
                            alerta("Error al filtrar la línea de las líneas de la ruta");
                            scrollToTop();
                            const peticionesCierre = await procesarPeticiones2();
                            loaderOff();
                        }
                    } else {
                        alerta("Error al filtrar las líneas de la ruta");
                        scrollToTop();
                        const peticionesCierre = await procesarPeticiones2();
                        loaderOff();
                    }
                    const peticionesCierre = await procesarPeticiones2();
                    loaderOff();
                } else {
                    alerta("Error al leer el almacén de líneas");
                    scrollToTop();
                    const peticionesCierre = await procesarPeticiones2();
                    loaderOff();
                }
            }
        } catch (error) {
            mensaje = "ERROR: " + error.message;
            console.error(error);
            alerta(mensaje);
        }
    }

    /* INICIAR APP OFFLINE */
    async function appOffline() {
        try {
            const login = await vLogin();
            if (!login) {
                window.location.href = "https://dosxdos.app.iidos.com/index.html";
            } else {
                const Arrayusuario = await leerDatos("dosxdos", "usuario");
                usuario = Arrayusuario[0];
                montador = usuario.cod;
                // Dynamically create navigation based on user role
                createDesktopNavigation(usuario.clase);
                // Setup desktop and mobile navigation
                setupMenu(usuario.clase);

                // Setup menu interactions
                setupMenuInteractions();
                setupUserActions();
                setupGlobalMenuClosing();

                updateUserDisplay();

                // Update the user information in the new UI elements
                const nombreUsuarioDesktop = document.getElementById('nombreUsuarioDesktop');
                const nombreUsuarioMobile = document.getElementById('nombreUsuarioMobile');
                const imagenUsuarioDesktop = document.getElementById('imagenUsuarioDesktop');
                const imagenUsuarioMobile = document.getElementById('imagenUsuarioMobile');

                if (nombreUsuarioDesktop) nombreUsuarioDesktop.textContent = usuario.nombre;
                if (nombreUsuarioMobile) nombreUsuarioMobile.textContent = usuario.nombre;

                if (usuario.imagen !== "0") {
                    if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
                    if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
                }

                await notificar();

                mensajeDeConexion =
                    "Sin conexión a internet - Si existen datos, fotos o firmas que ya pertenecen a la línea, no serán visibles hasta que vuelvas a tener conexión";
                alerta(mensajeDeConexion);
                const TotalLineas = await leerDatos("dosxdos", "lineas");
                if (TotalLineas) {
                    //console.log(TotalLineas);
                    const lineas = TotalLineas.filter((objeto) => {
                        return objeto.Proyecto == ruta;
                    });
                    //console.log(lineas);
                    if (lineas) {
                        const lineaVector = lineas.filter((objeto) => {
                            return objeto.Linea == linea;
                        });
                        if (lineaVector) {
                            lineaObj = lineaVector[0];
                            //console.log(lineaObj);

                            const $titulo = document.getElementById("titulo");
                            const $subtitulo = document.getElementById("subtitulo");

                            if ($titulo && $subtitulo) {
                                // Ensure all values exist, fallback to empty string if missing
                                const nombreRutaText = nombreRuta || "Ruta Desconocida";
                                const otText = ot ? `OT: ${ot}` : "";
                                const lineaText = lineaActividad ? `Línea: ${lineaActividad}` : "";
                                const clienteText = lineaObj.NombreCliente ? `Cliente: ${lineaObj.NombreCliente}` : "";
                                const pvText = lineaObj.PuntoVenta ? `PV: ${lineaObj.PuntoVenta} ${lineaObj.NombrePuntoVenta || ''}` : "";
                                const firmaText = lineaObj.Firma ? `Firma: ${lineaObj.Firma}` : "";

                                // Set title and subtitle separately
                                $titulo.innerHTML = nombreRutaText;
                                $subtitulo.innerHTML = `${otText} | ${lineaText} | ${clienteText} | ${pvText} | ${firmaText}`;

                                // Make sure they are visible
                                $titulo.style.display = "block";
                                $subtitulo.style.display = "block";
                            } else {
                                console.warn("⚠️ Titulo or Subtitulo element not found");
                            }

                            cargarDatoTexto("cliente", lineaObj.NombreCliente);
                            cargarDatoTexto("ot", lineaObj.OT);
                            cargarDatoTexto("tipoOt", lineaObj.TipoOT);
                            cargarDatoTexto("descripcionOt", lineaObj.DescripcionOT);
                            cargarDatoTexto("lineaOt", lineaObj.LineaActividad);
                            cargarDatoTexto("puntoDeVenta", lineaObj.PuntoVenta);
                            cargarDatoTexto("puntoDeVenta2", lineaObj.NombrePuntoVenta);
                            cargarDatoTexto("zona", lineaObj.Zona);
                            cargarDatoTexto("sector", lineaObj.Sector);
                            cargarDatoTexto("direccion", lineaObj.DireccionPuntoVenta);
                            cargarDatoTexto("tipoDeTrabajo", lineaObj.TipoTrabajo);
                            cargarDatoTexto(
                                "tipoDeTrabajo2",
                                lineaObj.DescripcionTipoTrabajo
                            );
                            cargarDatoTexto("observaciones", lineaObj.Observaciones);
                            cargarDatoTexto("poner", lineaObj.Poner);
                            cargarDatoTexto("quitar", lineaObj.Quitar);
                            cargarDatoTexto("alto", lineaObj.Alto);
                            cargarDatoTexto("ancho", lineaObj.Ancho);
                            cargarDatoTexto("revisado", lineaObj.Revisado);
                            cargarDatoTexto("firmaDatos", lineaObj.Firma);
                            cargarDatoSelect("estado", lineaObj.Estado);
                            cargarDatoTexto("navisionOt", lineaObj.Navision_OT);
                            /* FORMULARIO */
                            if (lineaObj.Incidencia) {
                                cargarDatoSelect("incidencia", lineaObj.Incidencia);
                            }
                            if (lineaObj.FechaActuacion) {
                                cargarFecha("fecha", lineaObj.FechaActuacion);
                            }
                            if (lineaObj.DiasActuacion) {
                                cargarDatoValor("dias", lineaObj.DiasActuacion);
                            }
                            if (lineaObj.TiempoActuacion) {
                                cargarDatoValor("horas", lineaObj.TiempoActuacion);
                            }
                            if (lineaObj.MinutosActuacion) {
                                cargarDatoValor("minutos", lineaObj.MinutosActuacion);
                            }
                            if (lineaObj.ObservacionesTecnico) {
                                cargarDatoTexto(
                                    "observacionesTecnico",
                                    lineaObj.ObservacionesTecnico
                                );
                            }
                            loaderOff();
                        } else {
                            alerta("Error al filtrar la línea de las líneas de la ruta");
                            scrollToTop();
                            loaderOff();
                        }
                    } else {
                        alerta("Error al filtrar las líneas de la ruta");
                        scrollToTop();
                        loaderOff();
                    }
                    loaderOff();
                } else {
                    alerta("Error al leer el almacén de líneas");
                    scrollToTop();
                    loaderOff();
                }
            }
        } catch (error) {
            mensaje = "ERROR: " + error.message;
            console.error(error);
            alerta(mensaje);
        }
    }

    /* TAREAS AL INICIAR LA PANTALLA CON EL ESTADO DE LA CONEXIÓN */
    if (navigator.onLine) {
        console.log("La aplicación está en línea.");
        //cache();
        appOnline();
    } else {
        console.log("La aplicación está fuera de línea.");
        appOffline();
    }

    // Form reset on navigation
    window.addEventListener('beforeunload', function () {
        // Reset the form
        document.getElementById('formLinea').reset();

        // Clear photos and signatures
        photos = {};
        firmas = {};

        // Clear containers
        const photosContainer = document.getElementById('photosContainer');
        const firmasContainer = document.getElementById('firmasContainer');
        if (photosContainer) photosContainer.innerHTML = '';
        if (firmasContainer) firmasContainer.innerHTML = '';
    });

    // Also ensure the back button resets form
    document.addEventListener('DOMContentLoaded', function () {
        const backLink = document.querySelector('a[href="https://dosxdos.app.iidos.com/ruta_montador.html"]');
        if (backLink) {
            backLink.addEventListener('click', function () {
                document.getElementById('formLinea').reset();
            });
        }
    });

    // media viewer functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Create modal viewer if it doesn't exist yet
        if (!document.getElementById('mediaViewerModal')) {
            const modalHTML = `
        <div id="mediaViewerModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center">
            <div class="relative w-full h-full flex flex-col items-center justify-center">
                <button id="closeMediaViewer" class="absolute top-6 right-6 z-10 text-white p-2 rounded-full transition-colors bg-red-600 hover:bg-red-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div id="mediaViewerContent" class="w-full h-full flex items-center justify-center overflow-hidden">
                    <!-- Media will be inserted here -->
                </div>
            </div>
        </div>
        `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Setup modal functionality
        const modal = document.getElementById('mediaViewerModal');
        const closeBtn = document.getElementById('closeMediaViewer');
        const contentDiv = document.getElementById('mediaViewerContent');

        // Close modal function
        function closeModal() {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            contentDiv.innerHTML = '';
        }

        // Close on button click
        closeBtn.addEventListener('click', closeModal);

        // Close on click outside
        modal.addEventListener('click', function (e) {
            if (e.target === modal || e.target === contentDiv) closeModal();
        });

        // Close on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
        });

        // Create a function to add zoom functionality to an element
        function addZoomFunctionality(element) {
            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let startX = 0;
            let startY = 0;
            let isDragging = false;

            // Reset zoom
            function resetZoom() {
                scale = 1;
                translateX = 0;
                translateY = 0;
                element.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
            }

            // Apply transform with boundaries
            function applyTransform() {
                // Ensure the image stays centered when not zoomed
                if (scale <= 1) {
                    scale = 1;
                    translateX = 0;
                    translateY = 0;
                } else {
                    // Constrain translation to prevent the image from leaving the viewport
                    const maxTranslateX = (element.offsetWidth * (scale - 1)) / 2;
                    const maxTranslateY = (element.offsetHeight * (scale - 1)) / 2;

                    translateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, translateX));
                    translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, translateY));
                }

                element.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
            }

            // Mouse wheel zoom
            element.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.2 : 0.2;
                const prevScale = scale;
                scale = Math.max(1, Math.min(5, scale + delta));

                // If scale has changed
                if (prevScale !== scale) {
                    // Calculate mouse position relative to the center of the image
                    const rect = element.getBoundingClientRect();
                    const x = e.clientX - rect.left - rect.width / 2;
                    const y = e.clientY - rect.top - rect.height / 2;

                    // Adjust translation to zoom toward cursor position
                    if (scale > 1) {
                        translateX += x * (delta / prevScale);
                        translateY += y * (delta / prevScale);
                    }
                }

                applyTransform();
            }, { passive: false });

            // Mouse drag
            element.addEventListener('mousedown', (e) => {
                if (scale > 1) {
                    e.preventDefault();
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    isDragging = true;
                }
            });

            element.addEventListener('mousemove', (e) => {
                if (isDragging && scale > 1) {
                    e.preventDefault();
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    applyTransform();
                }
            });

            element.addEventListener('mouseup', () => {
                isDragging = false;
            });

            element.addEventListener('mouseleave', () => {
                isDragging = false;
            });

            // Touch pinch zoom and pan
            let initialTouchDistance = 0;
            let initialScale = 1;
            let lastTouchTime = 0;

            element.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    // Two-finger pinch zoom
                    initialTouchDistance = Math.hypot(
                        e.touches[1].clientX - e.touches[0].clientX,
                        e.touches[1].clientY - e.touches[0].clientY
                    );
                    initialScale = scale;
                } else if (e.touches.length === 1) {
                    // Single touch for panning when zoomed
                    if (scale > 1) {
                        startX = e.touches[0].clientX - translateX;
                        startY = e.touches[0].clientY - translateY;
                        isDragging = true;
                    }

                    // Check for double tap
                    const now = new Date().getTime();
                    const timeDiff = now - lastTouchTime;
                    if (timeDiff < 300) {
                        // Double tap detected
                        resetZoom();
                    }
                    lastTouchTime = now;
                }
            }, { passive: false });

            element.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevents browser zooming

                if (e.touches.length === 2) {
                    // Calculate current touch distance
                    const currentDistance = Math.hypot(
                        e.touches[1].clientX - e.touches[0].clientX,
                        e.touches[1].clientY - e.touches[0].clientY
                    );

                    // Calculate center point between two touches
                    const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;

                    // Calculate new scale based on touch distance ratio
                    const newScale = initialScale * (currentDistance / initialTouchDistance);
                    scale = Math.max(1, Math.min(5, newScale));

                    applyTransform();
                } else if (e.touches.length === 1 && isDragging && scale > 1) {
                    // Pan when zoomed
                    translateX = e.touches[0].clientX - startX;
                    translateY = e.touches[0].clientY - startY;
                    applyTransform();
                }
            }, { passive: false });

            element.addEventListener('touchend', (e) => {
                // Keep the current scale and translation - just update isDragging
                if (e.touches.length === 0) {
                    isDragging = false;
                }
            });

            // Add double-click for desktop reset
            element.addEventListener('dblclick', resetZoom);
        }

        // Make all media items clickable with zoom functionality
        function makeMediaClickable() {
            // For photos
            const photos = document.querySelectorAll('#photosContainer img.imgCamara');
            photos.forEach(img => {
                img.style.cursor = 'pointer';
                img.addEventListener('click', function (e) {
                    e.preventDefault();

                    contentDiv.innerHTML = '';
                    const zoomImg = document.createElement('img');
                    zoomImg.src = img.src;
                    zoomImg.className = 'max-h-full max-w-full object-contain';
                    zoomImg.style.touchAction = 'none'; // Prevents browser touch actions

                    contentDiv.appendChild(zoomImg);
                    addZoomFunctionality(zoomImg);

                    modal.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                });
            });

            // For videos
            const videos = document.querySelectorAll('#photosContainer video.imgCamara');
            videos.forEach(video => {
                video.style.cursor = 'pointer';
                video.addEventListener('click', function (e) {
                    e.preventDefault();

                    contentDiv.innerHTML = '';
                    const videoElement = document.createElement('video');
                    videoElement.src = video.src;
                    videoElement.className = 'max-h-full max-w-full';
                    videoElement.controls = true;
                    videoElement.autoplay = true;

                    contentDiv.appendChild(videoElement);

                    modal.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                });
            });

            // For signatures
            const signatures = document.querySelectorAll('#firmasContainer img.imgCamara, #firmasContainer img.imgFirma');
            signatures.forEach(img => {
                img.style.cursor = 'pointer';
                img.addEventListener('click', function (e) {
                    e.preventDefault();

                    contentDiv.innerHTML = '';

                    // Create the signature image directly without a separate container
                    const zoomImg = document.createElement('img');
                    zoomImg.src = img.src;
                    zoomImg.className = 'object-contain';
                    zoomImg.style.touchAction = 'none';
                    zoomImg.style.backgroundColor = 'white'; // White background on the image itself
                    zoomImg.style.maxWidth = '90vw';
                    zoomImg.style.maxHeight = '80vh';
                    zoomImg.style.border = '2px solid #ddd';
                    zoomImg.style.borderRadius = '0.5rem';

                    contentDiv.appendChild(zoomImg);

                    addZoomFunctionality(zoomImg);

                    modal.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                });
            });
        }

        // Run initially
        makeMediaClickable();

        // Create MutationObserver to detect when new images are added
        const photosContainer = document.getElementById('photosContainer');
        const firmasContainer = document.getElementById('firmasContainer');

        if (photosContainer) {
            const photosObserver = new MutationObserver(makeMediaClickable);
            photosObserver.observe(photosContainer, { childList: true, subtree: true });
        }

        if (firmasContainer) {
            const firmasObserver = new MutationObserver(makeMediaClickable);
            firmasObserver.observe(firmasContainer, { childList: true, subtree: true });
        }
    });

    // Fixed signature viewer with white background
    document.addEventListener('DOMContentLoaded', function () {
        // Fix signature display style
        const signatures = document.querySelectorAll('#firmasContainer img.imgFirma');
        signatures.forEach(img => {
            // Add white background and border for better signature visibility
            img.style.backgroundColor = 'white';
            img.style.border = '1px solid #ddd';
            img.style.borderRadius = '0.25rem';
        });

        // Fix signature modal close button
        const imgCerrarFirma = document.getElementById('imgCerrarFirma');
        const cajaCanvasFirma = document.getElementById('cajaCanvasFirma');

        if (imgCerrarFirma && cajaCanvasFirma) {
            imgCerrarFirma.addEventListener('click', function () {
                cajaCanvasFirma.classList.add('hidden');
            });
        }

        // Prevent modal from closing when clicking on the signature canvas
        const canvasFirma = document.getElementById('canvasFirma');
        if (canvasFirma) {
            canvasFirma.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }
    });

    // Prevent page reload on orientation change
    window.addEventListener('orientationchange', function (event) {
        // Don't call event.preventDefault() as orientation change isn't cancelable

        // Update any dimensions after orientation change
        setTimeout(() => {
            const modal = document.getElementById('mediaViewerModal');
            if (modal && !modal.classList.contains('hidden')) {
                // If modal is open, adjust the view if needed
                const contentDiv = document.getElementById('mediaViewerContent');
                if (contentDiv && contentDiv.firstChild) {
                    // Trigger a repaint/reflow to ensure proper sizing
                    contentDiv.style.display = 'none';
                    setTimeout(() => {
                        contentDiv.style.display = 'flex';
                    }, 10);
                }
            }
        }, 100);
    });
</script>

<script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>

</html>