<!DOCTYPE html>

<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title></title>
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logo-red.png" />
  <meta name="description" content="DOS.DOS GRUPO IMAGEN - Aplicación Web Progresiva (PWA)" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      letter-spacing: 0.05vw;
      -webkit-tap-highlight-color: transparent;
    }

    /* ESCRITORIO */
    :root {
      --x20: 20vw;
      --x0_7: 0.7vw;
      --x35: 35vw;
      --x22: 22vw;
      --x3_5: 3.5vw;
      --x1: 1vw;
      --x2: 2vw;
      --x4: 4vw;
      --x1_2: 1.2vw;
      --x2_5: 2.5vw;
      --x0_5: 0.5vw;
      --x0_8: 0.8vw;
      --x0_9: 0.9vw;
      --x0_3: 0.3vw;
      --z2: 2vw;
      --z1: 1vw;
      --x2_3: 2.3vw;
      --x10: 10vw;
      --x3: 3vw;
    }

    /* FUENTES */
    @font-face {
      font-family: "FuturaBold";
      src: url("https://dosxdos.app.iidos.com/css/fuentes/Futura/Futura_Bold.otf") format("truetype");
    }

    @font-face {
      font-family: "FuturaLight";
      src: url("https://dosxdos.app.iidos.com/css/fuentes/Futura/Futura_Light.otf") format("truetype");
    }

    @font-face {
      font-family: "FuturaMedium";
      src: url("https://dosxdos.app.iidos.com/css/fuentes/Futura/Futura_Medium.otf") format("truetype");
    }

    .displayOn {
      display: flex;
    }

    .displayOff {
      display: none;
    }

    .futuraBold {
      font-family: "FuturaBold";
    }

    .futuraMedium {
      font-family: "FuturaMedium";
    }

    .futuraLight {
      font-family: "FuturaLight";
    }

    body {
      display: flex;
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: transparent !important;
    }

    /* Logo container for new animation */
    .logo-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 80%;
      max-width: 800px;
      z-index: 1;
    }

    .logo {
      width: var(--x20);
      opacity: 0;
      transition: opacity 2s;
      display: none;
      /* Hidden initially for GSAP animation */
    }

    .puntoFondo {
      position: absolute;
      border-radius: 50%;
      width: var(--x0_7);
      height: var(--x0_7);
      background-color: #db0032;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      opacity: 0;
    }

    .puntoFondo2 {
      width: var(--x35);
      height: var(--x35);
    }

    .saludo {
      z-index: 10;
      width: var(--x22);
      animation: animate 15s linear infinite;
      opacity: 0;
      transition: opacity 2s;
      align-self: center;
      justify-self: center;
    }

    @keyframes animate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .logo2 {
      position: absolute;
      width: 5rem;
      bottom: var(--x1);
      right: var(--x2);
      opacity: 0;
      transition: opacity 2s;
    }

    .formulario {
      flex-direction: column;
      margin-top: 4vh;
    }

    label {
      font-family: "FuturaLight";
      display: flex;
      color: rgb(255, 255, 255);
      margin-right: auto;
      margin-left: 4%;
      font-size: 15px;
    }

    input {
      width: 80%;
      border-radius: 30px;
      padding: 24px 10px;
      font-family: "FuturaMedium";
      color: #000;
      font-size: 16px;
      border: none;
      -webkit-appearance: none;
      appearance: none;
      outline: none;
      box-shadow: none;
    }

    #olvidar {
      display: flex;
      margin-left: auto;
      font-family: "FuturaLight";
      color: rgb(255, 255, 255);
      font-size: 12px;
      width: fit-content;
      margin-block: 5px;
    }

    #olvidar:hover {
      cursor: pointer;
    }

    .accion {
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 15px;
      padding: 10px 24px;
      font-family: "FuturaBold";
      background-color: rgb(255, 255, 255);
      color: #db0032;
      font-size: 15px;
      border: none;
      align-self: center;
      margin-top: 0;
    }

    .accion:hover {
      cursor: pointer;
    }

    .idiomas {
      position: absolute;
      top: 2.15vw;
      right: 6.5vw;
      font-family: "FuturaBold";
      font-size: 15px;
      opacity: 0;
      transition: opacity 2s;
    }

    #separador {
      margin-left: 0.2vw;
      margin-right: 0.2vw;
      margin-top: -0.1vw;
    }

    #english:hover {
      cursor: pointer;
    }

    #espanol:hover {
      cursor: pointer;
    }

    .instalar {
      position: absolute;
      top: 1.5vw;
      right: 2vw;
      flex-direction: column;
      opacity: 0;
      padding: 5px;
      transition: opacity 2s;
    }

    .instalar>img {
      width: 40px;
    }

    .instalar>img:hover {
      cursor: pointer;
    }

    #tipInstalar {
      width: fit-content;
      margin-top: 10px;
      border-radius: 0.7vw;
      background-color: #e5e5e5;
      color: #999999;
      padding: 10px;
      font-family: "FuturaLight";
      font-size: 13px;
      text-wrap: nowrap;
      align-self: flex-start;
      justify-content: center;
      text-align: center;
    }

    .noVisible {
      opacity: 0;
      transition: opacity 2s;
    }

    .visible {
      opacity: 1;
    }

    /* TABLETS = ROOT + 60% */
    @media screen and (min-width: 540px) and (max-width: 1200px) {
      :root {
        --x20: 32vw;
        --x0_7: 1.12vw;
        --x35: 56vw;
        --x22: 35.2vw;
        --x3_5: 5.6vw;
        --x4: 6.4vw;
        --x1_2: 1.92vw;
        --x2_5: 4vw;
        --x0_5: 0.8vw;
        --x0_8: 1.28vw;
        --x0_9: 1.44vw;
        --x0_3: 0.48vw;
        --z2: 3.2vw;
        --z1: 1.6vw;
        --x2_3: 3.68vw;
        --x10: 16vw;
        --x3: 4.8vw;
      }

      .idiomas {
        top: 2.6vw;
        right: 7.5vw;
      }
    }

    /* MOVILES = ROOT + 172% */
    @media screen and (max-width: 539px) {
      :root {
        --x20: 54.4vw;
        --x0_7: 1.9vw;
        --x35: 95.2vw;
        --x22: 59.84vw;
        --x3_5: 9.52vw;
        --x4: 10.88vw;
        --x1_2: 3.26vw;
        --x2_5: 4vw;
        --x0_5: 1.36vw;
        --x0_8: 2.17vw;
        --x0_9: 2.44vw;
        --x0_3: 0.81vw;
        --z2: 5.44vw;
        --z1: 2.72vw;
        --x2_3: 6.25vw;
        --x10: 27.2vw;
        --x3: 8.16vw;
      }

      .idiomas {
        top: 3.5vw;
        right: 12vw;
      }
    }

    .puntoFondo {
      position: absolute;
      border-radius: 50%;
      width: var(--x0_7);
      height: var(--x0_7);
      background-color: #db0032;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      opacity: 0;
      transition: width 1.5s, height 1.5s, opacity 2s;
    }

    /* Override for the punto element when used in animation */
    #punto.visible {
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
      align-items: center !important;
      padding: 20px !important;
      box-sizing: border-box !important;
    }

    #formularioRecordar {
      display: flex;
      flex-direction: column;
      width: 100%;
      align-items: center;
      padding: 20px;
    }

    #formularioRecordar input {
      width: 80%;
      padding: 8px 20px;
      border-radius: 30px;
      background-color: white;
      color: #333;
      border: none;
    }

    #formularioRecordar label {
      font-family: "FuturaLight";
      display: flex;
      color: rgb(255, 255, 255);
      margin: 0 auto 5px 12%;
      font-size: 15px;
    }

    #formularioRecordar #recordar {
      background-color: white;
      color: #db0032;
      padding: 8px 24px;
      width: 100%;
      font-family: "FuturaMedium";
      font-weight: bold;
    }

    #formularioRecordar #volver {
      background-color: transparent;
      color: white;
      border: 1px solid white;
      padding: 8px 24px;
      width: auto;
      font-family: "FuturaMedium";
      font-weight: bold;
    }

    @media screen and (max-width: 539px) {
      input {
        width: 100%;
      }

      label {
        margin-left: 4%;
        font-size: 15px;
      }

      label:first-child {
        margin-left: 10%;
      }
    }
  </style>
  <!-- PWA -->
  <meta name="theme-color" content="#000000" />
  <meta name="MobileOptimized" content="width" />
  <meta name="HandheldFriendly" content="true" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="https://dosxdos.app.iidos.com/img/logoPwa256.png" />
  <link rel="apple-touch-startup-image" href="https://dosxdos.app.iidos.com/img/dosxdos.png" />
  <link rel="manifest" href="https://dosxdos.app.iidos.com/manifest.json" />
  <!-- Importacion de IndexDB -->
  <script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
  <!-- SERVICEWORKER CACHE-->
  <script src="https://dosxdos.app.iidos.com/serviceworker.js"></script>
  <!-- SERVICEWORKER FIREBASE-->
  <script src="https://dosxdos.app.iidos.com/serviceWorkerFirebase.js"></script>
  <!-- GSAP Animation Library -->
  <script src="https://dosxdos.app.iidos.com/gsap.min.js"></script>
</head>

<body>
  <!-- Logo container for GSAP animation -->
  <div class="logo-container">
    <img src="img/logo-full.svg" alt="Logo" class="logo">
  </div>

  <div class="puntoFondo displayOn" id="punto">
    <img src="https://dosxdos.app.iidos.com/img/saludo.png" class="saludo displayOn" id="saludo" />
    <form action="index.html" method="post" id="formularioLogin" class="displayOff formulario noVisible">
      <label for="usuario" id="labelUsuario" class="flex mr-auto"></label>
      <input type="text" name="usuario" id="usuario" maxlength="8" placeholder="usuario (max 8 caracteres)" />
      <label for="contrasena" id="labelContrasena"></label>
      <input type="password" name="contrasena" id="contrasena" maxlength="12"
        placeholder="&lowast;&lowast;&lowast;&lowast;&lowast;&lowast;&lowast;&lowast;" />
      <p class="w-fit" id="olvidar"></p>
      <button type="submit" id="acceder" class="accion"></button>
    </form>
    <form action="index.html" method="post" id="formularioRecordar" class="displayOff formulario">
      <label for="email" id="labelEmail"></label>
      <input type="email" name="email" id="email" placeholder="correo@ejemplo.com" />
      <div class="flex gap-4 items-center mt-4">
        <button type="submit" id="recordar" class="accion"></button>
        <button type="button" id="volver" class="accion"></button>
      </div>
    </form>
  </div>

  <img src="https://dosxdos.app.iidos.com/img/logo2930.png" class="logo displayOn" id="logo" />

  <img src="https://dosxdos.app.iidos.com/img/logo-black.png" id="logo2" class="logo2" />

  <div id="idiomas" class="idiomas displayOn">
    <p id="espanol">ESP</p>
    <p id="separador">|</p>
    <p id="english">ENG</p>
  </div>

  <div id="instalar" class="instalar displayOn">
    <img src="https://dosxdos.app.iidos.com/img/instalar.png" id="instalarImg" />
    <p id="tipInstalar" class="displayOff"></p>
  </div>
</body>

<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-messaging-compat.js"></script>

<!-- GSAP Animation Script -->
<script>
  // Replace your animation code with this fully responsive version
  document.addEventListener("DOMContentLoaded", () => {
    const svgImage = document.querySelector(".logo");
    const logoContainer = document.querySelector(".logo-container");
    const formularioLogin = document.getElementById("formularioLogin");
    const punto = document.getElementById("punto");

    // Clear any existing styles that might interfere
    document.body.style.backgroundColor = "transparent";

    // Hide login form initially
    if (formularioLogin) {
      formularioLogin.classList.add("displayOff");
      formularioLogin.classList.remove("displayOn");
    }

    fetch(svgImage.src)
      .then((response) => response.text())
      .then((svgContent) => {
        logoContainer.innerHTML = svgContent;
        const svgElement = logoContainer.querySelector("svg");
        svgElement.id = "main-svg";
        svgElement.style.width = "100%";
        svgElement.style.height = "auto";
        svgElement.style.display = "block";

        createAnimation();
      })
      .catch((error) => console.error("Error loading SVG:", error));

    function createAnimation() {
      const mainTimeline = gsap.timeline();

      const angleLeft = document.querySelector("#angle-left");
      const angleRight = document.querySelector("#angle-right");
      const d2 = document.querySelector("#letter-d2");

      const allPaths = document.querySelectorAll("#main-svg path");

      const allExceptX = Array.from(allPaths).filter(
        (path) => path !== angleLeft && path !== angleRight
      );

      const allExceptAngleLeftAndD2 = Array.from(allPaths).filter(
        (path) => path !== angleRight && path !== d2
      );

      // Group all letters for GRUPO together as one unit
      const grupoLetters = [
        document.querySelector("#letter-g"),
        document.querySelector("#letter-p"),
        document.querySelector("#letter-a"),
        document.querySelector("#letter-p2"),
        document.querySelector("#letter-o3"),
      ].filter(el => el);

      // Group all letters for IMAGEN together as one unit
      const imagenLetters = [
        document.querySelector("#letter-i"),
        document.querySelector("#letter-m"),
        document.querySelector("#letter-a2"),
        document.querySelector("#letter-g2"),
        document.querySelector("#letter-e"),
        document.querySelector("#letter-n"),
      ].filter(el => el);

      // Calculate responsive circle size that works on all devices
      function getResponsiveSize() {
        // Get viewport dimensions
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        // For mobile devices, use more screen space
        if (viewportWidth <= 539) {
          // Use 95% of viewport width on mobile
          return viewportWidth * 0.90;
        } else {
          // Original logic for larger screens
          let baseSize = Math.min(viewportWidth, viewportHeight) * 0.7;
          if (baseSize < 300) baseSize = 300;
          if (baseSize > viewportWidth * 0.9) baseSize = viewportWidth * 0.9;
          if (baseSize > viewportHeight * 0.9) baseSize = viewportHeight * 0.9;
          return baseSize;
        }
      }

      const circleSize = getResponsiveSize();

      // Create expanding dot for transition
      const expandingDot = document.createElement("div");
      expandingDot.style.position = "fixed";
      expandingDot.style.top = "50%";
      expandingDot.style.left = "50%";
      expandingDot.style.transform = "translate(-50%, -50%)";
      expandingDot.style.backgroundColor = "#db0032";
      expandingDot.style.borderRadius = "50%";
      expandingDot.style.width = "0px";
      expandingDot.style.height = "0px";
      expandingDot.style.opacity = "0";
      expandingDot.style.zIndex = "5";
      document.body.appendChild(expandingDot);

      // Set initial states for animation
      gsap.set(allPaths, {
        opacity: 0,
        scale: 0,
        transformOrigin: "center center",
        rotation: () => gsap.utils.random(-100, 100),
        y: () => gsap.utils.random(-300, 300),
      });

      // Pre-position the letters for the separated look
      gsap.set(grupoLetters, { x: -700 });
      gsap.set(imagenLetters, { x: 700 });

      // Ensure angleLeft and angleRight are aligned vertically
      gsap.set([angleLeft, angleRight], {
        opacity: 0,
        scale: 0,
        y: 0,
      });

      // Animation steps 1-5...
      mainTimeline.to([angleLeft, angleRight], {
        opacity: 1,
        scale: 1,
        rotation: 0,
        x: 0,
        duration: 0.8,
        ease: "back.out(1.7)",
        stagger: 0.1
      });

      mainTimeline.to(
        allExceptX,
        {
          opacity: 1,
          scale: 1,
          rotation: 0,
          y: 0,
          duration: 1,
          stagger: 0,
          ease: "back.out(1.7)",
        },
        "-=0.4"
      );

      mainTimeline.to({}, { duration: 0.5 });

      mainTimeline.to(allExceptAngleLeftAndD2, {
        scale: 0,
        opacity: 0,
        duration: 0.6,
        ease: "power3.in",
      });

      mainTimeline.to(d2, {
        rotation: 720,
        x: -3500,
        duration: 0.5,
        ease: "power4.inOut",
      });

      mainTimeline.to(
        angleRight,
        {
          scale: 1.6,
          x: -2300,
          y: -200,
          duration: 0.8,
          ease: "power2.out",
        },
        "-=0.2"
      );

      mainTimeline.to(
        [angleRight, d2],
        {
          duration: 0.6,
          scale: 1.2,
          stagger: { each: 0.03, from: "random" },
          ease: "back.out(1.5)",
        },
        "-=0.3"
      );

      mainTimeline.to([angleRight, d2], {
        opacity: 1,
        duration: 0.3,
        ease: "power2.inOut",
      });

      mainTimeline.to([angleRight, d2], {
        scale: 0,
        opacity: 0,
        duration: 0.4,
        ease: "power3.in",
      });

      // Final step - create the circle and center the form
      mainTimeline.to(expandingDot, {
        width: `${circleSize}px`,
        height: `${circleSize}px`,
        opacity: 1,
        duration: 0.7,
        ease: "back.out(1.7)",
        onComplete: function () {
          // Hide animation elements
          logoContainer.style.display = "none";
          expandingDot.style.display = "none";

          punto.style = "";
          punto.className = "";

          punto.style.position = "fixed";
          punto.style.top = "50%";
          punto.style.left = "50%";
          punto.style.transform = "translate(-50%, -50%)";
          punto.style.width = `${circleSize}px`;
          punto.style.height = `${circleSize}px`;
          punto.style.maxWidth = "95vw";
          punto.style.maxHeight = "95vh";
          punto.style.backgroundColor = "#db0032";
          punto.style.borderRadius = "50%";
          punto.style.display = "flex";
          punto.style.justifyContent = "center";
          punto.style.alignItems = "center";
          punto.style.zIndex = "10";
          punto.style.overflow = "hidden";
          punto.style.boxSizing = "border-box";

          // Reset form styling
          formularioLogin.style = "";
          formularioLogin.className = "formulario";

          // Make the form visible but with initial animation state
          formularioLogin.style.display = "flex";
          formularioLogin.style.flexDirection = "column";
          formularioLogin.style.width = "80%";
          formularioLogin.style.gap = "10px";
          formularioLogin.style.maxWidth = "450px";
          formularioLogin.style.boxSizing = "border-box";
          formularioLogin.style.opacity = "0"; // Start invisible for animation

          // Center the form directly in the middle of the circle
          // Get reference to the recovery form
          const formularioRecordar = document.getElementById("formularioRecordar");
          // Clear punto container but preserve both forms
          punto.innerHTML = "";
          punto.appendChild(formularioLogin);
          punto.appendChild(formularioRecordar);
          formularioRecordar.style.display = "none";

          // Get all form elements for animation
          const labels = formularioLogin.querySelectorAll("label");
          const inputs = formularioLogin.querySelectorAll("input");
          const buttons = formularioLogin.querySelectorAll("button");
          const paragraphs = formularioLogin.querySelectorAll("p");

          // Set form element styles
          labels.forEach(label => {
            label.style.textAlign = "left";
            label.style.alignSelf = "flex-start";
            label.style.color = "white";
            label.style.width = "100%";
            label.style.fontSize = "15px";
            label.style.marginBottom = "-5px"
          });

          inputs.forEach(input => {
            input.style.width = "100%";
            input.style.boxSizing = "border-box";
            input.style.borderRadius = "30px";
            input.style.border = "none";
            input.style.padding = "8px 20px";
          });

          buttons.forEach(button => {
            button.style.alignSelf = "center";
            button.style.padding = "8px 20px";
            button.style.backgroundColor = "white";
            button.style.color = "#db0032";
            button.style.borderRadius = "15px";
            button.style.border = "none";
            button.style.cursor = "pointer";
            button.style.marginTop = "5px";
            button.style.fontFamily = "FuturaMedium";
            button.style.fontWeight = "bold";
          });

          // Set initial states for form elements
          gsap.set(formularioLogin, { opacity: 0, y: 20 });
          gsap.set([...labels, ...inputs, ...buttons, ...paragraphs], { opacity: 0, y: 15 });

          // Create a new timeline for form animation
          const formTimeline = gsap.timeline();

          // Animate the form container first
          formTimeline.to(formularioLogin, {
            opacity: 1,
            y: 0,
            duration: 0.5,
            ease: "power2.out"
          });

          // Then animate each form element with staggered timing
          formTimeline.to([...labels, ...inputs, ...buttons, ...paragraphs], {
            opacity: 1,
            y: 0,
            duration: 0.4,
            stagger: 0.1, // 0.1 second delay between each element
            ease: "back.out(1.2)"
          }, "-=0.3"); // Start a bit before the form animation completes

          // Add this inside the onComplete function of the main timeline
          const logo2 = document.getElementById("logo2");
          const idiomas = document.getElementById("idiomas");
          const instalar = document.getElementById("instalar");

          // Ensure these elements are visible immediately
          if (logo2) {
            logo2.style.display = 'block';
            logo2.style.opacity = '1';
            logo2.style.position = 'absolute';
            logo2.style.width = '4rem';
            logo2.style.bottom = '0.7rem';
            logo2.style.right = '0.7rem';
          }

          if (idiomas) {
            idiomas.style.display = 'flex';
            idiomas.style.opacity = '1';
            idiomas.style.position = 'absolute';
            idiomas.style.top = '0.7rem';
            idiomas.style.right = '0.7rem';
          }

          if (instalar) {
            instalar.style.display = 'flex';
            instalar.style.opacity = '1';
            instalar.style.position = 'absolute';
            instalar.style.width = '4rem';
            instalar.style.top = '0.7rem';
            instalar.style.left = '0.7rem';
          }

          // Re-add event listeners for form switching
          const olvidarLink = formularioLogin.querySelector("#olvidar");
          const volverButton = formularioRecordar.querySelector("#volver");

          if (olvidarLink) {
            olvidarLink.addEventListener("click", function (e) {
              e.preventDefault();
              formularioLogin.style.display = "none";
              formularioRecordar.style.display = "flex";
            });
          }

          if (volverButton) {
            volverButton.addEventListener("click", function (e) {
              e.preventDefault();
              formularioRecordar.style.display = "none";
              formularioLogin.style.display = "flex";
            });
          }

          // Add install button functionality
          const instalarButton = document.getElementById("instalarImg");
          if (instalarButton) {
            instalarButton.addEventListener("click", function () {
              if (isAndroid) {
                window.open('https://play.google.com/store/apps/details?id=com.dosxdos.dosxdos.app', '_blank');
              } else if (isiOS) {
                // Ejecutar flujo de PWA
                if (window.deferredPrompt) {
                  window.deferredPrompt.prompt();
                  window.deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('User choice result:', choiceResult.outcome);
                    window.deferredPrompt = null;
                  });
                } else {
                  if (idioma === "es") {
                    alerta("No es posible instalar la aplicación por algunas de las razones: Aplicación ya instalada, navegador no compatible o se ha denegado la instalación anteriormente por el usuario.");
                  } else {
                    alerta("The application cannot be installed for a number of reasons: Application already installed, browser not supported, or installation has been previously denied by the user.");
                  }
                }
              } else {
                // Ejecutar flujo de PWA
                if (window.deferredPrompt) {
                  window.deferredPrompt.prompt();
                  window.deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('User choice result:', choiceResult.outcome);
                    window.deferredPrompt = null;
                  });
                } else {
                  if (idioma === "es") {
                    alerta("No es posible instalar la aplicación por alguna de las razones: Aplicación ya instalada, navegador no compatible o se ha denegado la instalación anteriormente por el usuario.");
                  } else {
                    alerta("The application cannot be installed for one of the following reasons: Application already installed, browser not supported, or installation has been previously denied by the user.");
                  }
                }
              }
            });
          }

          // Call appOnline function if it exists
          if (typeof appOnline === 'function') {
            appOnline();
          }
        }
      })
    }

    // Add window resize event to keep circle responsive
    window.addEventListener("resize", function () {
      if (punto && punto.style.position === "fixed") {
        const newSize = getResponsiveSize();
        punto.style.width = `${newSize}px`;
        punto.style.height = `${newSize}px`;
      }
    });

    // Helper function for responsive sizing
    function getResponsiveSize() {
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      let baseSize = Math.min(viewportWidth, viewportHeight) * 0.7;
      if (baseSize < 300) baseSize = 300;
      if (baseSize > viewportWidth * 0.9) baseSize = viewportWidth * 0.9;
      if (baseSize > viewportHeight * 0.9) baseSize = viewportHeight * 0.9;
      return baseSize;
    }
  });
</script>

<script>
  const versionLocal = "dosxdos113";

  tokenNativo = null;
  tokenFirebase = null;
  idioma = "";
  usuario = "";
  jsonIdioma = "";
  messaging = null;

  const userAgent = navigator.userAgent;

  const isWindows = /windows/i.test(userAgent);
  const isMacOS = /macintosh|mac os x|mac os/i.test(userAgent);
  const isLinux = /linux/i.test(userAgent);
  const isAndroid = /android/i.test(userAgent);
  const isiOS = /(iphone|ipad|ipod)/i.test(userAgent);

  function alerta(mensaje) {
    // Remove existing alert if present
    const existingAlert = document.querySelector("#customAlert");
    if (existingAlert) {
      existingAlert.remove();
    }

    // Create alert container
    const alertContainer = document.createElement("div");
    alertContainer.id = "customAlert";
    alertContainer.style.position = 'fixed';
    alertContainer.style.left = '50%';
    alertContainer.style.transform = 'translateX(-50%)';
    alertContainer.style.zIndex = '50';
    alertContainer.style.transition = 'all 0.3s ease-in-out';
    alertContainer.style.width = '95%';
    alertContainer.style.maxWidth = '65%';
    alertContainer.style.top = '-100px';

    // Create alert content
    const alertContent = document.createElement("div");
    alertContent.style.position = 'relative';
    alertContent.style.backgroundColor = 'white';
    alertContent.style.border = '2px solid #dc2626'; // red-600
    alertContent.style.borderRadius = '0.5rem';
    alertContent.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
    alertContent.style.padding = '1rem';
    alertContent.style.display = 'flex';
    alertContent.style.fontFamily = 'FuturaLight';
    alertContent.style.flexDirection = 'column';
    alertContent.style.gap = '0.75rem';

    // Create close button
    const closeButton = document.createElement("button");
    closeButton.style.cursor = 'pointer';
    closeButton.style.position = 'absolute';
    closeButton.style.right = '-0.75rem';
    closeButton.style.top = '-1rem';
    closeButton.style.backgroundColor = '#dc2626'; // red-600
    closeButton.style.borderRadius = '9999px';
    closeButton.style.padding = '7px';
    closeButton.style.paddingBottom = '5px';
    closeButton.style.border = '#dc2626';
    closeButton.style.transition = 'background-color 0.2s';
    closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" style="width: 1.25rem; height: 1.25rem; color: white;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

    // Create main content container
    const contentContainer = document.createElement("div");
    contentContainer.style.display = 'flex';
    contentContainer.style.alignItems = 'center';
    contentContainer.style.gap = '0.75rem';
    contentContainer.style.flex = '1';


    // Create message text
    const messageText = document.createElement("p");
    messageText.style.color = '#111827'; // gray-900
    messageText.style.fontSize = '1rem';
    messageText.style.flex = '1';
    messageText.textContent = mensaje;

    // Assemble the content container
    contentContainer.appendChild(messageText);

    // Assemble the alert
    alertContent.appendChild(closeButton);
    alertContent.appendChild(contentContainer);
    alertContainer.appendChild(alertContent);
    document.body.appendChild(alertContainer);

    // Slide down animation
    requestAnimationFrame(() => {
      alertContainer.style.top = "56px";
    });

    // Add event listeners
    closeButton.addEventListener("click", () => {
      hideAlert(alertContainer);
    });

    // Hide loader if it exists
    if (typeof loaderOff === 'function') {
      loaderOff();
    }
  }

  function hideAlert(alertContainer) {
    alertContainer.style.top = "-100px";
    setTimeout(() => {
      alertContainer.remove();
    }, 300);
  }

  //Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCPtGrKaRYMUxDx6SXIQvlewLNxyapnxcM",
    authDomain: "dosxdos-app.firebaseapp.com",
    projectId: "dosxdos-app",
    storageBucket: "dosxdos-app.firebasestorage.app",
    messagingSenderId: "52849872855",
    appId: "1:52849872855:web:3d68fa7ed8dd785fe14592",
    measurementId: "G-ZG5EKJDHL5",
  };

  //Inicializa la Firebase
  function iniciarFirebase() {
    return new Promise((resolve, reject) => {
      try {
        firebase.initializeApp(firebaseConfig);
        resolve(true);
      } catch (error) {
        reject("Error al inicializar Firebase: " + error);
      }
    });
  }

  //Inicializa el servicio de mensajería
  function iniciarFirebaseMensajeria() {
    return new Promise((resolve, reject) => {
      try {
        messaging = firebase.messaging();
        resolve(true);
      } catch (error) {
        reject("Error al inicializar Firebase Mensajería: " + error);
      }
    });
  }

  //Solicita permiso para recibir notificaciones
  function solicitarPermisoNotificaciones() {
    return new Promise((resolve, reject) => {
      const permiso = Notification.requestPermission()
        .then((permiso) => {
          if (permiso === "granted") {
            //Aquí ya puedes obtener el token
            resolve(messaging.getToken());
          } else {
            resolve(false);
          }
        })
        .catch((error) => {
          console.error("Error al obtener el permiso o token: ", error);
          reject("Error al obtener el permiso o token: ", error);
        });
    });
  }

  //Guarda el token en tu servidor usando PHP
  function guardarTokenEnServidor(token, usuario) {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/apirest/guardar_token.php", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          token: token,
          user_id: usuario,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Token guardado en servidor:", data);
          resolve(data);
        })
        .catch((error) => {
          console.error("Error al guardar el token en servidor:", error);
          reject(error);
        });
    });
  }

  async function ejecutarFirebase() {
    try {
      const firebase = await iniciarFirebase();
      if (firebase) {
        console.log("Firebase inicializado");
        const mensajeria = await iniciarFirebaseMensajeria();
        if (mensajeria) {
          console.log("Firebase Mensajería inicializado");
          const permiso = await solicitarPermisoNotificaciones();
          if (permiso) {
            console.log("Token Firebase:", permiso);
            tokenFirebase = permiso;
          } else {
            console.error(
              "El permiso para recibir notificaciones fue denegado"
            );
          }
        }
      }
    } catch (error) {
      reinicioFirebase = localStorage.getItem("reinicioFirebase");
      if (!reinicioFirebase || reinicioFirebase == null) {
        localStorage.setItem("reinicioFirebase", true);
        window.location.reload();
      } else {
        console.error("Este dispositivo no recibirá notificaciones de la App");
      }
    }
  }

  function crearBaseDeDatos() {
    return new Promise((resolve, reject) => {
      const stores = [
        "usuario",
        "rutas",
        "lineas",
        "peticionesLineas",
        "peticionesFotos",
        "peticionesFirmas",
        "notas",
        "historial",
        "notificaciones",
      ];
      db("dosxdos", stores)
        .then((res) => {
          if (res) {
            console.log("Base de datos abierta exitosamente");
            resolve(true);
          }
        })
        .catch((err) => {
          console.log(err);
          resolve(false);
        });
    });
  }

  /* EVITAR REENVÍO DE FORMULARIOS */
  if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
  }

  function espanol() {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/espanol.json")
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error en la solicitud del json en español: ${res.status}`
            );
          }
          return res.json();
        })
        .then((idiom) => {
          resolve(idiom);
        })
        .catch((error) => {
          console.error(error.massage);
          console.error(error);
          reject(error);
        });
    });
  }

  function english() {
    return new Promise((resolve, reject) => {
      fetch("https://dosxdos.app.iidos.com/english.json")
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              `Error in the json request in English: ${res.status}`
            );
          }
          return res.json();
        })
        .then((idiom) => {
          resolve(idiom);
        })
        .catch((error) => {
          console.error(error.massage);
          console.error(error);
          reject(error);
        });
    });
  }

  function cargarDatoTexto(id, valor) {
    const elemento = document.getElementById(id);
    temporalDiv = document.createElement("div");
    temporalDiv.innerHTML = valor;
    textoConvertido = temporalDiv.textContent || temporalDiv.innerText;
    elemento.innerHTML = textoConvertido;
  }

  async function cargarIdioma(idm) {
    try {
      if (navigator.onLine) {
        if (idm == "es") {
          idioma = idm;
          jsonIdioma = await espanol();
          document.title = jsonIdioma.tittle;
          cargarDatoTexto("labelUsuario", jsonIdioma.usuario);
          cargarDatoTexto("labelContrasena", jsonIdioma.contrasena);
          cargarDatoTexto("olvidar", jsonIdioma.olvidar);
          cargarDatoTexto("acceder", jsonIdioma.acceder);
          cargarDatoTexto("labelEmail", jsonIdioma.email);
          cargarDatoTexto("recordar", jsonIdioma.recordar);
          cargarDatoTexto("volver", jsonIdioma.volver);
          cargarDatoTexto("tipInstalar", jsonIdioma.instalar);
          localStorage.setItem("idioma", idioma);
        } else {
          idioma = idm;
          jsonIdioma = await english();
          document.title = jsonIdioma.tittle;
          cargarDatoTexto("labelUsuario", jsonIdioma.usuario);
          cargarDatoTexto("labelContrasena", jsonIdioma.contrasena);
          cargarDatoTexto("olvidar", jsonIdioma.olvidar);
          cargarDatoTexto("acceder", jsonIdioma.acceder);
          cargarDatoTexto("labelEmail", jsonIdioma.email);
          cargarDatoTexto("recordar", jsonIdioma.recordar);
          cargarDatoTexto("volver", jsonIdioma.volver);
          cargarDatoTexto("tipInstalar", jsonIdioma.instalar);
          localStorage.setItem("idioma", idioma);
        }
      } else {
        if (idm == "es") {
          alerta(
            "Sin conexión a internet no es posible realizar esta acción"
          );
        } else {
          alerta(
            "Without an internet connection it is not possible to perform this action"
          );
        }
      }
    } catch (error) {
      console.error(error);
    }
  }

  /* VALIDACIÓN DE FORMULARIOS */
  /* Expresiones regulares */
  const expresiones = {
    usuario: /^(?:[a-zA-Z]+|\d+|[a-zA-Z\d]+){4,8}$/,
    contrasena: /^(?:[a-zA-Z\d!@#$%^&*()-+=<>?/\|[\]{}:;,.]+){4,12}$/,
    correo: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
  },
    /* Campos */
    campos = {
      usuario: false,
      contrasena: false,
      correoRecordar: false,
    };

  /* Función VALIDAR CAMPO */
  const validarCampo = (expresion, input, campo) => {
    if (expresion.test(input)) {
      campos[campo] = true;
    } else {
      campos[campo] = false;
    }
  };

  /* COOKIES */
  function setCookie(nombre, valor, duracionDias) {
    const fechaExpiracion = new Date();
    fechaExpiracion.setTime(
      fechaExpiracion.getTime() + duracionDias * 24 * 60 * 60 * 1000
    );
    const expires = "expires=" + fechaExpiracion.toUTCString();
    document.cookie = nombre + "=" + valor + ";" + expires + ";path=/";
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener("click", (e) => {
      const formularioLogin = document.getElementById("formularioLogin");
      const formularioRecordar =
        document.getElementById("formularioRecordar");
      if (e.target.id == "olvidar") {
        formularioLogin.classList.replace("displayOn", "displayOff");
        formularioRecordar.classList.replace("displayOff", "displayOn");
      } else if (e.target.id == "volver") {
        formularioRecordar.classList.replace("displayOn", "displayOff");
        formularioLogin.classList.replace("displayOff", "displayOn");
      } else if (e.target.id == "espanol") {
        cargarIdioma("es");
      } else if (e.target.id == "english") {
        cargarIdioma("en");
      }
    });
    const $instalar = document.getElementById("instalar");
    const $tipInstalar = document.getElementById("tipInstalar");

    $instalar.addEventListener("mouseover", () => {
      $tipInstalar.classList.replace("displayOff", "displayOn");
    });

    $instalar.addEventListener("mouseout", () => {
      $tipInstalar.classList.replace("displayOn", "displayOff");
    });
  });

  function inicio() {
    try {
      const logo = document.getElementById("logo");
      const punto = document.getElementById("punto");
      const saludo = document.getElementById("saludo");
      const logo2 = document.getElementById("logo2");
      const formularioLogin = document.getElementById("formularioLogin");
      const idiomas = document.getElementById("idiomas");
      const instalar = document.getElementById("instalar");
      setTimeout(() => {
        logo.classList.add("visible");
        punto.classList.add("visible");
        setTimeout(() => {
          punto.classList.add("puntoFondo2");
          setTimeout(() => {
            saludo.classList.add("visible");
            logo.classList.remove("displayOn");
            logo.classList.add("displayOff");
            setTimeout(() => {
              saludo.classList.remove("visible");
              setTimeout(() => {
                saludo.classList.replace("displayOn", "displayOff");
                formularioLogin.classList.replace("displayOff", "displayOn");
                setTimeout(() => {
                  formularioLogin.classList.add("visible");
                  logo2.classList.add("visible");
                  idiomas.classList.add("visible");
                  instalar.classList.add("visible");
                }, 200);
              }, 1000);
            }, 2000);
          }, 1500);
        }, 1000);
      }, 500);
    } catch (error) {
      console.error(error);
    }
  }

  function inicio2() {
    return new Promise((resolve, reject) => {
      try {
        const logo = document.getElementById("logo");
        const punto = document.getElementById("punto");
        const saludo = document.getElementById("saludo");
        const logo2 = document.getElementById("logo2");
        const formularioLogin = document.getElementById("formularioLogin");
        const idiomas = document.getElementById("idiomas");
        const instalar = document.getElementById("instalar");
        const mensaje = document.getElementById("mensaje");
        formularioLogin.classList.replace("displayOn", "displayOff");
        idiomas.classList.replace("displayOn", "displayOff");
        instalar.classList.replace("displayOn", "displayOff");
        setTimeout(() => {
          logo.classList.add("visible");
          punto.classList.add("visible");
          setTimeout(() => {
            punto.classList.add("puntoFondo2");
            setTimeout(() => {
              saludo.classList.add("visible");
              logo.classList.remove("displayOn");
              logo.classList.add("displayOff");
              setTimeout(() => {
                saludo.classList.remove("visible");
                setTimeout(() => {
                  saludo.classList.replace("displayOn", "displayOff");
                  resolve(true);
                }, 1000);
              }, 2000);
            }, 1500);
          }, 1000);
        }, 500);
      } catch (error) {
        console.error(error);
        reject(error);
      }
    });
  }

  function vLogin() {
    return new Promise((resolve, reject) => {
      const login = localStorage.getItem("login");
      if (login && login !== null) {
        leerDatos("dosxdos", "usuario")
          .then((res) => {
            usuario = res[0];
            resolve(usuario);
          })
          .catch((err) => {
            resolve(false);
          });
      } else {
        resolve(false);
      }
    });
  }

  function eliminarCookie(nombre) {
    const tiempoExpiracion = 1; // Segundo 1 de la Época Unix
    document.cookie = `${nombre}=; expires=${new Date(
      tiempoExpiracion * 1000
    ).toUTCString()}; path=/;`;
  }

  //ESTA FUNCION ELIMINA POR COMPLETO DEL LADO DEL CLIENTE LA BASE DE DATOS CADA VEZ QUE SE EJEUTA
  function deleteDB2(database) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.deleteDatabase(database);

      // Evento que se dispara cuando la base de datos se elimina correctamente
      request.onsuccess = () => {
        console.log(`Base de datos "${database}" eliminada exitosamente.`);
        resolve(true);
      };

      // Evento que se dispara si ocurre un error al eliminar la base de datos
      request.onerror = (event) => {
        console.error(
          `Error al eliminar la base de datos "${database}":`,
          event.target.error
        );
        reject(event.target.error);
      };
    });
  }

  async function cerrarSesionsVersion() {
    if (navigator.onLine) {
      try {
        const eliminarBaseDeDatosCliente = await deleteDB2("dosxdos");
        if (eliminarBaseDeDatosCliente) {
          const eliminarTokenDeLasNotificaciones = eliminarTokenNotificaciones()
          if (eliminarTokenDeLasNotificaciones) {
            localStorage.clear();
            eliminarCookie("login");
            eliminarCookie("usuario");
            localStorage.setItem("cierrePorVersion", true);
            localStorage.setItem("version", versionLocal);
            window.location.href = "https://dosxdos.app.iidos.com/index.html";
          }
        }
      } catch (error) {
        mensaje = "ERROR: " + error.message;
        console.error(error);
        alerta(mensaje);
      }
    } else {
      mensaje = "No es posible cerrar la sesión sin conexión a internet";
      alerta(mensaje);
    }
  }

  if (navigator.onLine) {
    console.log("La aplicación está en línea.");
    let login = localStorage.getItem("login");
    if (login && login !== null) {
      let usuario = localStorage.getItem("usuario");
      url =
        "https://dosxdos.app.iidos.com/apirest/usuarios.php?id=" + usuario;
      fetch(url)
        .then((res) => {
          if (!res.ok) {
            throw new Error(`Error en la solicitud: ${res.status}`);
          } else {
            console.log(res);
            return res.json();
          }
        })
        .then((res) => {
          const dataVector = res[1];
          if (dataVector.length == 0) {
            cerrarSesions();
          } else {
            const data = dataVector[0];
            if (data.activo == 0 || data.eliminado == 1) {
              cerrarSesions();
            }
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }
  } else {
    console.log("La aplicación está fuera de línea.");
  }

  /* PAGESHOW */

  window.addEventListener("pageshow", async (e) => {
    const validacionDeCierrePorVersion = await validarCierrePorVersion();
    if (validacionDeCierrePorVersion == null) {
      cerrarSesionsVersion();
    } else if (validacionDeCierrePorVersion == true) {
      vLogin().then((login) => {
        if (login) {
          if (login.length != 0) {
            if (login.clase == "montador") {
              window.location.href =
                "https://dosxdos.app.iidos.com/rutas_montador.html";
            } else if (login.clase == "cliente") {
              window.location.href =
                "https://dosxdos.app.iidos.com/clientes.html";
            } else {
              window.location.href = "https://dosxdos.app.iidos.com/ot.html";
            }
          } else {
            console.log("Usuario no reconocido");
          }
        } else {
          console.log("Sin login");
        }
      });
      let mensaj = localStorage.getItem("mensaje");
      if (mensaj && mensaj !== null) {
        alerta(mensaj);
        localStorage.removeItem("mensaje");
      }
    } else {
      const validacionDeVersion = await validarVersion();
      if (validacionDeVersion == true) {
        vLogin().then((login) => {
          if (login) {
            if (login.length != 0) {
              if (login.clase == "montador") {
                window.location.href =
                  "https://dosxdos.app.iidos.com/rutas_montador.html";
              } else if (login.clase == "cliente") {
                window.location.href =
                  "https://dosxdos.app.iidos.com/clientes.html";
              } else {
                window.location.href =
                  "https://dosxdos.app.iidos.com/ot.html";
              }
            } else {
              console.log("Usuario no reconocido");
            }
          } else {
            console.log("Sin login");
          }
        });
        let mensaj = localStorage.getItem("mensaje");
        if (mensaj && mensaj !== null) {
          alerta(mensaj);
          localStorage.removeItem("mensaje");
        }
      } else {
        cerrarSesionsVersion();
      }
    }
  });

  async function appOnline() {
    try {
      const validacionDeCierrePorVersion = await validarCierrePorVersion();
      if (validacionDeCierrePorVersion == true) {
        // Removed inicio() call as it's now handled by GSAP animation
        idioma = localStorage.getItem("idioma");
        if (idioma && idioma !== null) {
          await cargarIdioma(idioma);
          const htmlElement = document.querySelector("html");
          if (htmlElement) {
            htmlElement.lang = idioma;
          }
        } else {
          const idiomaNavegador =
            navigator.language || navigator.userLanguage;
          idioma = idiomaNavegador.split("-")[0];
          const htmlElement = document.querySelector("html");
          if (htmlElement) {
            htmlElement.lang = idioma;
          }
          await cargarIdioma(idioma);
        }
        if ("standalone" in window.navigator && window.navigator.standalone) {
          const instalarApp = document.getElementById("instalar");
          instalarApp.classList.replace("displayOn", "displayOff");
        }
        await ejecutarFirebase();
        if (!isAndroid || !isiOS) {
          if (!tokenFirebase) {
            //alerta("Este dispositivo no recibirá notificaciones de la App")
          }
        }
      } else {
        const validacionDeVersion = await validarVersion();
        console.log("validacionDeVersion: " + validacionDeVersion);
        if (validacionDeVersion == true) {
          // Removed inicio() call as it's now handled by GSAP animation
          idioma = localStorage.getItem("idioma");
          if (idioma && idioma !== null) {
            await cargarIdioma(idioma);
            const htmlElement = document.querySelector("html");
            if (htmlElement) {
              htmlElement.lang = idioma;
            }
          } else {
            const idiomaNavegador =
              navigator.language || navigator.userLanguage;
            idioma = idiomaNavegador.split("-")[0];
            const htmlElement = document.querySelector("html");
            if (htmlElement) {
              htmlElement.lang = idioma;
            }
            await cargarIdioma(idioma);
          }
          if (
            "standalone" in window.navigator &&
            window.navigator.standalone
          ) {
            const instalarApp = document.getElementById("instalar");
            instalarApp.classList.replace("displayOn", "displayOff");
          }
          await ejecutarFirebase();
          if (!isAndroid || !isiOS) {
            if (!tokenFirebase) {
              //alerta("Este dispositivo no recibirá notificaciones de la App")
            }
          }
        } else {
          cerrarSesionsVersion();
        }
      }
    } catch (error) {
      console.error(error);
    }
  }

  async function appOffline() {
    try {
      // Removed inicio2() call as it's now handled by GSAP animation
      idioma = localStorage.getItem("idioma");
      if (idioma && idioma !== null) {
        const htmlElement = document.querySelector("html");
        if (htmlElement) {
          htmlElement.lang = idioma;
        }
      } else {
        const idiomaNavegador = navigator.language || navigator.userLanguage;
        idioma = idiomaNavegador.split("-")[0];
        const htmlElement = document.querySelector("html");
        if (htmlElement) {
          htmlElement.lang = idioma;
        }
      }
      if (idioma == "es") {
        alerta(
          "Sin conexión a internet no es posible iniciar la autenticación"
        );
      } else {
        alerta(
          "Without an internet connection it is not possible to start login"
        );
      }
    } catch (error) {
      console.error(error);
    }
  }

  /* TAREAS AL INICIAR LA PANTALLA CON EL ESTADO DE LA CONEXIÓN */
  // These are now handled by the GSAP animation which will call appOnline() on completion
  // if (navigator.onLine) {
  //   console.log("La aplicación está en línea.");
  //   appOnline();
  // } else {
  //   console.log("La aplicación está fuera de línea.");
  //   appOffline();
  // }

  /* TAREAS EN LA INTERMITENCIA DE LA CONEXIÓN */
  window.addEventListener("online", () => {
    location.reload();
  });
  window.addEventListener("offline", () => {
    console.log("La conexión a Internet se ha perdido.");
  });

  //SUBMITS
  document.addEventListener("submit", (e) => {
    if (e.target.matches("#formularioLogin")) {
      e.preventDefault();
      let mensaj = "";
      let formData = new FormData(e.target);
      e.target.reset();
      window.scrollTo(0, 0);
      usuario = formData.get("usuario");
      contrasena = formData.get("contrasena");
      validarCampo(expresiones.usuario, usuario, "usuario");
      validarCampo(expresiones.contrasena, contrasena, "contrasena");
      if (!campos.usuario || !campos.contrasena) {
        if (!campos.usuario) {
          if (idioma == "es") {
            mensaj =
              "Formato de usuario no válido; en el usuario sólo se permite el uso de letras y dígitos (4 a 8 caracteres sin espacios). ";
          } else {
            mensaj =
              "Invalid user format; only letters and digits (4 to 8 characters without spaces) are allowed in the user. ";
          }
        }
        if (!campos.contrasena) {
          if (idioma == "es") {
            mensaj +=
              "Formato de contraseña no válido; en la contraseña sólo se permite el uso de letras, dígitos y caracteres especiales (4 a 12 caracteres sin espacios).";
          } else {
            mensaj +=
              "Invalid password format; Only letters, digits and special characters (4 to 12 characters without spaces) are allowed in the password.";
          }
        }
        alerta(mensaj);
      }
      if (campos.usuario && campos.contrasena) {
        if (navigator.onLine) {
          const body = {
            login: "",
            usuario,
            contrasena,
          };
          fetch("https://dosxdos.app.iidos.com/apirest/usuarios.php", {
            method: "POST",
            headers: {
              "Content-type": "application/json; charset=utf-8",
            },
            body: JSON.stringify(body),
          })
            .then((res) => {
              if (!res.ok) {
                if (res.status == 401) {
                  if (idioma == "es") {
                    mensaj += "Datos de acceso incorrectos";
                  } else {
                    mensaj += "Incorrect access data";
                  }
                  alerta(mensaj);
                } else if (res.status == 500) {
                  if (idioma == "es") {
                    mensaj += "Error interno del servidor";
                  } else {
                    mensaj += "Internal server error";
                  }
                } else {
                  throw new Error(`Error: ${res.status} - ${res.statusText}`);
                }
              }
              return res.json();
            })
            .then(async (res) => {
              if (res[0]) {
                const data = res[1];
                await crearBaseDeDatos();
                agregarDato("dosxdos", "usuario", data)
                  .then(async (res) => {
                    if (res) {
                      const eliminado = parseInt(data.eliminado);
                      const activo = parseInt(data.activo);
                      if (!eliminado) {
                        if (activo) {
                          if (data.clase == "montador") {
                            const login = true;
                            const usuario = data.id;
                            const loginMontador = true;
                            localStorage.setItem("login", login);
                            localStorage.setItem("usuario", usuario);
                            localStorage.setItem(
                              "loginMontador",
                              loginMontador
                            );
                            localStorage.setItem("version", versionLocal);
                            localStorage.setItem("cierrePorVersion", false);
                            setCookie("login", login, 365);
                            setCookie("usuario", usuario, 365);
                            if (isAndroid || isiOS) {
                              if (tokenNativo != null) {
                                await guardarTokenEnServidor(
                                  tokenNativo,
                                  usuario
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  tokenNativo
                                );
                              } else {
                                if (tokenFirebase != null) {
                                  await guardarTokenEnServidor(
                                    tokenFirebase,
                                    usuario
                                  );
                                  localStorage.setItem(
                                    "tokenNotificaciones",
                                    tokenFirebase
                                  );
                                } else {
                                  localStorage.setItem(
                                    "mensaje",
                                    "Este dispositivo no recibirá notificaciones de la App, ya que no permite las notificaciones nativas ni las notificaciones web."
                                  );
                                  localStorage.setItem(
                                    "tokenNotificaciones",
                                    null
                                  );
                                }
                              }
                            } else {
                              if (tokenFirebase != null) {
                                await guardarTokenEnServidor(
                                  tokenFirebase,
                                  usuario
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  tokenFirebase
                                );
                              } else {
                                localStorage.setItem(
                                  "mensaje",
                                  "Este dispositivo no recibirá notificaciones de la App, ya que no permite las notificaciones Web."
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  null
                                );
                              }
                            }
                            window.location.href =
                              "https://dosxdos.app.iidos.com/rutas_montador.html";
                          } else if (data.clase == "cliente") {
                            const login = true;
                            const usuario = data.id;
                            localStorage.setItem("login", login);
                            localStorage.setItem("usuario", usuario);
                            localStorage.setItem("version", versionLocal);
                            localStorage.setItem("cierrePorVersion", false);
                            setCookie("login", login, 365);
                            setCookie("usuario", usuario, 365);
                            if (isAndroid || isiOS) {
                              if (tokenNativo != null) {
                                await guardarTokenEnServidor(
                                  tokenNativo,
                                  usuario
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  tokenNativo
                                );
                              } else {
                                if (tokenFirebase != null) {
                                  await guardarTokenEnServidor(
                                    tokenFirebase,
                                    usuario
                                  );
                                  localStorage.setItem(
                                    "tokenNotificaciones",
                                    tokenFirebase
                                  );
                                } else {
                                  localStorage.setItem(
                                    "mensaje",
                                    "Este dispositivo no recibirá notificaciones de la App, ya que no permite las notificaciones nativas ni las notificaciones web."
                                  );
                                  localStorage.setItem(
                                    "tokenNotificaciones",
                                    null
                                  );
                                }
                              }
                            } else {
                              if (tokenFirebase != null) {
                                await guardarTokenEnServidor(
                                  tokenFirebase,
                                  usuario
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  tokenFirebase
                                );
                              } else {
                                localStorage.setItem(
                                  "mensaje",
                                  "Este dispositivo no recibirá notificaciones de la App, ya que no permite las notificaciones Web."
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  null
                                );
                              }
                            }
                            window.location.href =
                              "https://dosxdos.app.iidos.com/clientes.html";
                          } else {
                            const login = true;
                            const usuario = data.id;
                            localStorage.setItem("login", login);
                            localStorage.setItem("usuario", usuario);
                            localStorage.setItem("version", versionLocal);
                            localStorage.setItem("cierrePorVersion", false);
                            setCookie("login", login, 365);
                            setCookie("usuario", usuario, 365);
                            if (isAndroid || isiOS) {
                              if (tokenNativo != null) {
                                await guardarTokenEnServidor(
                                  tokenNativo,
                                  usuario
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  tokenNativo
                                );
                              } else {
                                if (tokenFirebase != null) {
                                  await guardarTokenEnServidor(
                                    tokenFirebase,
                                    usuario
                                  );
                                  localStorage.setItem(
                                    "tokenNotificaciones",
                                    tokenFirebase
                                  );
                                } else {
                                  localStorage.setItem(
                                    "mensaje",
                                    "Este dispositivo no recibirá notificaciones de la App, ya que no permite las notificaciones nativas ni las notificaciones web."
                                  );
                                  localStorage.setItem(
                                    "tokenNotificaciones",
                                    null
                                  );
                                }
                              }
                            } else {
                              if (tokenFirebase != null) {
                                await guardarTokenEnServidor(
                                  tokenFirebase,
                                  usuario
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  tokenFirebase
                                );
                              } else {
                                localStorage.setItem(
                                  "mensaje",
                                  "Este dispositivo no recibirá notificaciones de la App, ya que no permite las notificaciones Web."
                                );
                                localStorage.setItem(
                                  "tokenNotificaciones",
                                  null
                                );
                              }
                            }
                            window.location.href =
                              "https://dosxdos.app.iidos.com/ot.html";
                          }
                        } else {
                          mensaj =
                            "Tu usuario está inactivo, comunícate por favor con nosotros";
                          alerta(mensaj);
                          window.scrollTo(0, 0);
                        }
                      } else {
                        mensaj =
                          "El usuario ya no existe, ha sido eliminado, comunícate por favor con nosotros";
                        alerta(mensaj);
                        window.scrollTo(0, 0);
                      }
                    } else {
                      alerta(
                        "Error al intentar agregar los datos al almacén usuario"
                      );
                    }
                  })
                  .catch((err) => {
                    mensaj = "ERROR - " + err.message;
                    alerta(mensaj);
                    console.error(err);
                  });
              } else {
                men = "";
                if (idioma == "es") {
                  men = "DATOS INCORRECTOS";
                } else {
                  men = "INCORRECT DATA";
                }
                alerta(men);
              }
            })
            .catch((err) => {
              mensaj = "ERROR - " + err.message;
              alerta(mensaj);
              console.error(err);
            });
        } else {
          mensaj = "";
          if (idioma == "es") {
            mensaj =
              "No es posible iniciar la sesión sin conexión a internet";
          } else {
            mensaj =
              "It is not possible to login without an internet connection";
          }
          alerta(mensaj);
        }
      }
    }

    if (e.target.matches("#formularioRecordar")) {
      e.preventDefault();
      let mensaj = "";
      let formData = new FormData(e.target);
      e.target.reset();
      window.scrollTo(0, 0);
      const correo = formData.get("email");
      validarCampo(expresiones.correo, correo, "correoRecordar");
      if (!campos.correoRecordar) {
        if (idioma == "es") {
          mensaj += "Formato de correo no válido";
        } else {
          mensaj += "Invalid email format";
        }
        alerta(mensaj);
      } else {
        const body = {
          funcion: "recordar",
          correo: correo,
          idioma: idioma,
        };
        console.log(body);
        fetch("https://dosxdos.app.iidos.com/apirest/correos.php", {
          method: "POST",
          headers: {
            "Content-type": "application/json; charset=utf-8",
          },
          body: JSON.stringify(body),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`Error en la solicitud: ${res.status}`);
            }
            return res.json();
          })
          .then((res) => {
            men = res[1];
            alerta(men);
          })
          .catch((err) => {
            mensaj = "ERROR - " + err.message;
            alerta(mensaj);
            console.error(err);
          });
      }
    }
  });

  /* FUNCIÓN PARA OBLIGAR EL CIERRE DE SESIÓN */

  function validarVersion() {
    return new Promise((resolve, reject) => {
      const version = localStorage.getItem("version");
      console.log("Versión: " + version);
      if (version != versionLocal) {
        console.error(
          "Se procede a cerrar sesión para actualizar la versión de la aplicación"
        );
        resolve(false);
      } else {
        resolve(true);
      }
    });
  }

  function validarCierrePorVersion() {
    return new Promise((resolve, reject) => {
      const cierrePorVersion = localStorage.getItem("cierrePorVersion");
      console.log("cierrePorVersion: " + cierrePorVersion);
      if (cierrePorVersion == true) {
        console.error("Hay cierre por versión: " + cierrePorVersion);
        resolve(true);
      } else if (cierrePorVersion == null) {
        console.error(
          "No existe la variable de cierre por versión: " + cierrePorVersion
        );
        resolve(null);
      } else {
        console.log("No hay cierre por versión: " + cierrePorVersion);
        resolve(false);
      }
    });
  }

  function asignarTokenNativo() {
    tokenNativo = window.localStorage.getItem('tokenNativo');
  }

  function eliminarTokenNotificaciones() {
    return new Promise((resolve) => {
      tokenEliminar = localStorage.getItem("tokenNotificaciones");
      if (tokenEliminar != null) {
        urlTokenEliminar =
          "https://dosxdos.app.iidos.com/apirest/rutas_notificaciones.php/notificaciones/token/" +
          tokenEliminar;
        fetch(urlTokenEliminar, {
          method: "DELETE",
        })
          .then((res) =>
            res.ok
              ? res.json()
              : reject(
                new Error(`Error al eliminar el token de las notificaciones.`)
              )
          )
          .then((res) => {
            if (res.success) {
              localStorage.setItem("tokenNotificaciones", null);
              resolve(true);
            } else {
              console.error(res);
              alerta(
                "Error al eliminar el token de las notificaciones: " + res.message
              );
              resolve(false);
            }
          })
          .catch((err) => {
            mensaje = err.message;
            console.error(err);
            alerta(mensaje);
            reject(new Error(mensaje));
          });
      }
    });
  }

  // Set up PWA installation prompt handling
  window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent Chrome from automatically showing the prompt
    e.preventDefault();
    // Save the event so it can be triggered later
    window.deferredPrompt = e;
    console.log('App can be installed, saved prompt event');
  });

  // Track when the app is successfully installed
  window.addEventListener('appinstalled', (evt) => {
    console.log('App was installed');
    // Hide the install button after successful installation
    const instalar = document.getElementById("instalar");
    if (instalar) {
      instalar.style.display = 'none';
    }
  });
</script>

</html>