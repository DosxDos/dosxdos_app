<!DOCTYPE html>

<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Líneas de ruta</title>
  <link rel="icon" type="image/png" href="https://dosxdos.app.iidos.com/img/logo-red.png" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/tailwindmain.css" />
  <link rel="stylesheet" href="https://dosxdos.app.iidos.com/css/index.css" />
</head>

<body id="body" class="oyh overflow-x-hidden min-h-screen">
  <div id="loader" class="displayOn">
    <span class="loader"></span>
  </div>

  <section id="encabezado" class="w-full bg-white shadow-md fixed top-0 z-30">
    <!-- Main header -->
    <div class="flex items-center justify-between w-full px-6 py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="https://dosxdos.app.iidos.com/img/logo300.png" class="h-16 hidden xl:block" alt="Logo completo" />
        <img src="https://dosxdos.app.iidos.com/img/Isotipo-38.png" class="h-16 xl:hidden" alt="Isotipo" />
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden xl:flex items-center space-x-8">
        <!-- Navigation items will be dynamically created by createDesktopNavigation() -->

        <!-- Desktop Menu Notifications Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="desktopBellContainer">
          <img id="bellDesktop" src="" class="text-gray-900 object-contain" />
          <span id="desktopNotificationCount"
            class="absolute top-0 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Desktop User Menu -->
        <div class="relative group drop-shadow">
          <button id="userMenuButton"
            class="group flex items-center gap-3 py-1 pl-1.5 pr-4 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition-all duration-200"
            aria-expanded="false">
            <div
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm bg-gray-100 flex items-center justify-center">
              <img id="imagenUsuarioDesktop" src="https://dosxdos.app.iidos.com/img/usuario.png"
                class="w-full h-full object-cover" alt="Profile"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <svg class="w-5 h-5 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>

            <span id="nombreUsuarioDesktop" class="text-gray-700 font-medium text-lg"></span>

            <svg xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-400 group-hover:text-gray-600 transition-transform duration-200 group-hover:rotate-180"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Desktop Dropdown Menu -->
          <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-lg shadow-lg p-4 z-50">
            <button id="editarUsuarioDesktop"
              class="flex items-center gap-2 w-full mb-4 text-left text-xl text-black hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Editar Usuario
            </button>
            <button id="cerrarSesionDesktop"
              class="flex items-center gap-2 w-full text-left text-xl text-red-500 hover:bg-red-600/20 rounded-lg transition-colors duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
              </svg>
              Cerrar Sesión
            </button>
          </div>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <div class="xl:hidden flex items-center space-x-2 mx-2">
        <!-- Mobile Bell -->
        <a href="https://dosxdos.app.iidos.com/notificaciones.html" class="relative z-10" id="mobileBellContainer">
          <img id="bellMobile" src="https://dosxdos.app.iidos.com/img/bell2.png"
            class="w-8 text-gray-900 object-contain mt-2" />
          <span id="mobileNotificationCount"
            class="absolute top-2 right-1 bg-red-600 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[20px] text-center border hidden"></span>
        </a>

        <!-- Mobile Menu Button -->
        <button id="menuButton" class="xl:hidden relative z-50 p-2 focus:outline-none">
          <div class="relative w-8 h-8">
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-1"
              id="hamburgerTop"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-4"
              id="hamburgerMiddle"></span>
            <span class="absolute h-1 w-8 bg-gray-900 transition-all duration-300 ease-in-out top-7"
              id="hamburgerBottom"></span>
          </div>
        </button>
      </div>

    </div>

    <div id="opcionesMenu"
      class="xl:hidden fixed inset-0 bg-gradient-to-r from-red-500 to-red-600 bg-opacity-95 transform translate-x-full transition-all duration-500 ease-in-out z-40 overflow-hidden backdrop-blur-sm flex flex-col">
      <div class="absolute inset-0 z-0"
        style="background-image: url('https://dosxdos.app.iidos.com/img/texture-red.svg'); background-size: contain; opacity: 0.7;">
      </div>
      <!-- User Profile Section -->
      <div class="px-8 py-4 mt-16 relative z-10">
        <div class="relative flex items-center gap-3 py-1 pl-1.5 pr-4 bg-white shadow-lg rounded-full">
          <!-- Profile image -->
          <div
            class="absolute left-0 w-28 h-28 rounded-full overflow-hidden border-4 border-white bg-gradient-to-br from-red-50 to-white flex items-center justify-center shadow-xl"
            style="transform: translateX(-15%);">
            <img id="imagenUsuarioMobile" src="https://dosxdos.app.iidos.com/img/usuario.png"
              class="w-full h-full object-cover" alt="Profile"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
            <svg class="w-12 h-12 text-gray-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="ml-28 flex items-center py-4">
            <!-- User name -->
            <span class="text-black font-medium text-xl">¡Hola,&nbsp;</span>
            <span id="nombreUsuarioMobile" class="text-black font-medium text-xl"></span>
            <span class="text-black font-medium text-xl">!</span>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Navigation Links -->
      <nav class="px-8 pt-3 space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar mt-2">
        <!-- Dynamic menu items will be added here based on user role -->
      </nav>

      <!-- Mobile Menu Footer -->
      <div class="relative z-10">
        <div class="website-divider-container-734167" style="height: 100px; overflow: visible">
          <svg xmlns="http://www.w3.org/2000/svg" class="divider-img-734167" viewBox="0 0 1080 137"
            preserveAspectRatio="none" style="bottom: -20px">
            <path
              d="M 0,137 V 59.03716 c 158.97703,52.21241 257.17659,0.48065 375.35967,2.17167 118.18308,1.69101 168.54911,29.1665 243.12679,30.10771 C 693.06415,92.25775 855.93515,29.278599 1080,73.61449 V 137 Z"
              style="fill: #ffffff"></path>
            <path
              d="M 0,10.174557 C 83.419822,8.405668 117.65911,41.78116 204.11379,44.65308 290.56846,47.52499 396.02558,-7.4328 620.04248,94.40134 782.19141,29.627636 825.67279,15.823104 1080,98.55518 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.5"></path>
            <path
              d="M 0,45.10182 C 216.27861,-66.146913 327.90348,63.09813 416.42665,63.52904 504.94982,63.95995 530.42054,22.125806 615.37532,25.210412 700.33012,28.295019 790.77619,132.60682 1080,31.125744 V 137 H 0 Z"
              style="fill: #ffffff; opacity: 0.25"></path>
          </svg>
        </div>
      </div>

      <!-- User Actions -->
      <div class="relative z-10 mt-auto px-8 pb-6 bg-white shadow-lg flex justify-center space-x-6 pb-2 rounded-t-xl">
        <!-- Edit Button -->
        <button id="editarUsuarioMobile"
          class="flex items-center justify-center w-14 h-14 bg-white border-2 border-red-500 rounded-full hover:bg-red-100 transition-all duration-300">
          <svg class="w-8 h-8 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>

        <!-- Logout Button -->
        <button id="cerrarSesionMobile"
          class="flex items-center justify-center w-14 h-14 bg-red-600 rounded-full transition-all duration-300">
          <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        </button>
      </div>
    </div>
    </div>
  </section>

  <div class="p-6 pt-32 w-full bg-gray-100 ">
    <!-- Header with search functionality -->
    <div id="cabeceraContenido" class="flex items-center gap-4 z-10">
      <button id="volverBtn" class="text-red-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd" />
        </svg>
      </button>

      <div class="relative flex items-center w-full">
        <svg xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>

        <input type="text" id="buscador"
          class="shadow w-full h-12 pl-12 pr-4 bg-white/10 border border-white/20 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-red-600 transition-all duration-300 ease-in-out text-black placeholder-white/70"
          placeholder="Buscar líneas..." />
      </div>
    </div>

    <h1 id="titulo" class="text-2xl font-bold text-center my-8 text-gray-800">LANZAROTE_(A)</h1>

    <!-- map button -->
    <div id="contMapa" class="flex items-center justify-center mb-6">
      <button id="mapa"
        class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition-colors duration-200 shadow-sm px-4 py-2">
        <span class="whitespace-nowrap">Ver en mapa</span>
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <!-- Map outline -->
          <path d="M3 7l6 3l6-3l6 3v10l-6-3l-6 3l-6-3V7z" stroke="white" stroke-width="1.5" stroke-linecap="round"
            stroke-linejoin="round" />

          <!-- Map fold lines -->
          <path d="M9 10v10" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M15 7v10" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />

          <!-- Larger Location pin - prominent teardrop shape -->
          <path d="M12 4c-2.2 0-4 1.8-4 4c0 4 4 8 4 8s4-4 4-8c0-2.2-1.8-4-4-4z" fill="white" stroke="white"
            stroke-width="0.5" />
          <circle cx="12" cy="8" r="1.5" fill="#e11d48" stroke="none" />
        </svg>
      </button>
    </div>

    <section class="flex flex-col min-h-screen">
      <div class="flex-grow bg-gray-100">
        <div id="contenido" class="w-full"></div>
      </div>
    </section>
  </div>

  <script src="https://dosxdos.app.iidos.com/js/index_db.js"></script>
  <script src="https://dosxdos.app.iidos.com/js/notificaciones.js"></script>
  <script src="https://dosxdos.app.iidos.com/js/navigation.js"></script>
  <script>
    const ruta = localStorage.getItem("ruta");
    if (ruta && ruta !== null) {
      console.log(ruta);
    } else {
      window.location.href = "https://dosxdos.app.iidos.com/rutas_montador.html";
    }
    const nombreRuta = localStorage.getItem("nombreRuta");
    console.log(nombreRuta);
    $titulo = document.getElementById("titulo");
    $titulo.innerHTML = nombreRuta;

    const mapa = document.getElementById("mapa");
    mapa.addEventListener("click", () => {
      if (navigator.onLine) {
        window.location.href = "https://dosxdos.app.iidos.com/mapa_ruta.html";
      } else {
        alerta("No es posibler crear el mapa sin conexión a internet");
      }
    });

    const
      $contenido = document.getElementById("contenido"),
      $loader = document.getElementById("loader"),
      $body = document.getElementById("body"),
      $botonRutas = document.getElementById("rutasIconoBoton");
    const buscador = document.getElementById("buscador");
    let usuario, montador, rutas, notificacionesSinAcpetarNumero = 0;

    // event listener for back button
    const volverBtn = document.getElementById("volverBtn");
    if (volverBtn) {
      volverBtn.addEventListener("click", () => {
        window.location.href =
          "https://dosxdos.app.iidos.com/rutas_montador.html";
      });
    }

    /* LOADER */
    function scrollToTop() {
      // Para navegadores modernos
      document.documentElement.scrollTop = 0;
      // Para navegadores antiguos
      document.body.scrollTop = 0;
    }

    /* LOADER */
    function loaderOn() {
      scrollToTop();
      $loader.classList.remove("displayOff");
      $loader.classList.add("displayOn");
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
    }

    function loaderOff() {
      setTimeout(() => {
        $loader.classList.remove("displayOn");
        $loader.classList.add("displayOff");
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
      }, 1000);
    }

    function alerta(mensaje) {
      // Remove existing alert if present
      const existingAlert = document.querySelector("#customAlert");
      if (existingAlert) {
        existingAlert.remove();
      }

      // Create alert container
      const alertContainer = document.createElement("div");
      alertContainer.id = "customAlert";
      alertContainer.className =
        "fixed left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ease-in-out w-[85vw] md:w-[80vw] lg:w-[75vw]";
      alertContainer.style.top = "-100px";

      // Create alert content
      const alertContent = document.createElement("div");
      alertContent.className = `
    relative
    bg-white
    border-2 border-red-600
    rounded-lg
    shadow-lg
    p-4 md:p-5
    flex flex-col md:flex-row md:items-center gap-3 md:gap-4
  `;

      // Create close button
      const closeButton = document.createElement("button");
      closeButton.className =
        "absolute -right-3 -top-3 hover:bg-red-400 p-1 bg-red-600 rounded-full p-1.5 transition-colors duration-200";
      closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

      // Create main content container for mobile layout
      const contentContainer = document.createElement("div");
      contentContainer.className =
        "flex flex-col md:flex-row items-center gap-3 md:gap-4 flex-1";

      // Create icon with exclamation mark
      const iconContainer = document.createElement("div");
      iconContainer.className = "flex-shrink-0 text-red-600";
      iconContainer.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="10" />
  <path d="M12 7v6" />
  <path d="M12 16h0.01" />
</svg>
`;
      // Create message text
      const messageText = document.createElement("p");
      messageText.className = "text-gray-900 text-base md:text-lg flex-1";
      messageText.textContent = mensaje;

      // Assemble the content container
      contentContainer.appendChild(iconContainer);
      contentContainer.appendChild(messageText);

      // Assemble the alert
      alertContent.appendChild(closeButton);
      alertContent.appendChild(contentContainer);
      alertContainer.appendChild(alertContent);
      document.body.appendChild(alertContainer);

      // Slide down animation
      requestAnimationFrame(() => {
        alertContainer.style.top = "56px";
      });

      // Add event listeners
      closeButton.addEventListener("click", () => {
        hideAlert(alertContainer);
      });

      // Hide loader if it exists
      loaderOff();
    }

    function hideAlert(alertContainer) {
      alertContainer.style.top = "-100px";

      setTimeout(() => {
        alertContainer.remove();
      }, 300);
    }

    /* TRAER DATOS DE LOS SERVIDORES */
    function fetchRutas() {
      return new Promise((resolve, reject) => {
        url =
          "https://dosxdos.app.iidos.com/apirest/rutas.php?montador=" + montador;
        fetch(url)
          .then((res) => {
            if (res.ok) {
              return res.json();
            } else {
              mensaje =
                "Error: no se pudo recibir una respuesta de la api intermedia en la función fetchRutas";
              alerta(mensaje);
            }
          })
          .then((res) => {
            if (res[0]) {
              const request = indexedDB.open("dosxdos");
              request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction("rutas", "readwrite");
                const datosStore = transaction.objectStore("rutas");
                const clearRequest = datosStore.clear();
                clearRequest.onsuccess = (clearEvent) => {
                  const datos = res[1];
                  datos.forEach((item) => {
                    datosStore.add(item);
                  });
                  resolve(true);
                };
                clearRequest.onerror = (event) => {
                  error = event.target.error;
                  mensaje = `ERROR: ` + error;
                  console.error(error);
                  alerta(mensaje);
                };
              };
              request.onerror = (event) => {
                error = event.target.error;
                mensaje = `ERROR: ` + error;
                console.error(error);
                alerta(mensaje);
              };
            } else {
              mensaje = res[1];
              console.error(error);
              alerta(mensaje);
            }
          })
          .catch((res) => {
            mensaje = "Sin conexión: " + res.message;
            console.error(error);
            alerta(mensaje);
          });
      });
    }

    function fetchLineas(vectorRutas) {
      return new Promise(async (resolve, reject) => {
        try {
          const promises = vectorRutas.map(async (objeto) => {
            const url =
              "https://dosxdos.app.iidos.com/apirest/lineas.php?ruta=" +
              objeto.cod;
            const res = await fetch(url);

            if (!res.ok) {
              throw new Error(
                `Error en la solicitud de las líneas de la ruta ${objeto.cod}: ${res.status}`
              );
            }

            const resJson = await res.json();

            if (resJson[0]) {
              const db = await new Promise((dbResolve, dbReject) => {
                const request = indexedDB.open("dosxdos");
                request.onsuccess = (event) => {
                  const db = event.target.result;
                  dbResolve(db);
                };
                request.onerror = (event) => {
                  dbReject(
                    new Error(
                      `Error al abrir la base de datos para ingresar las líneas de la ruta: ${objeto.cod}`
                    )
                  );
                };
              });

              const transaction = db.transaction("lineas", "readwrite");
              const datosStore = transaction.objectStore("lineas");
              const datos = resJson[1];
              if (Array.isArray(datos)) {
                datos.forEach((item) => {
                  datosStore.add(item);
                });
              } else {
                datosStore.add(datos);
              }
            } else {
              throw new Error(
                `Error al solicitar las líneas de la ruta ${objeto.cod}: ${resJson[1]}`
              );
            }
          });

          await Promise.all(promises);
          resolve(true);
        } catch (err) {
          console.error(err);
          reject(err);
        }
      });
    }

    /* SINCRONIZAR BASE DE DATOS */
    async function sincronizarDb() {
      try {
        if (navigator.onLine) {
          loaderOn();
          const fRutas = await fetchRutas();
          rutas = await leerDatos("dosxdos", "rutas");
          rutas = rutas.map((objeto) => ({
            cod: objeto["No."],
            nombre: objeto["Descripcion"],
          }));
          const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
          if (limpiarLineas) {
            lineas = await fetchLineas(rutas);
            if (lineas) {
              const mensaje =
                " - Se ha sincronizado la base de datos exitosamente";
              localStorage.setItem("mensaje", mensaje);
              window.location.href =
                "https://dosxdos.app.iidos.com/ruta_montador.html";
            } else {
              alerta(
                "Error al cargar las líneas de las rutas del servidor, se han sincronizado las rutas pero no las líneas"
              );
              loaderOff();
            }
          }
        }
      } catch (error) {
        const mensaje =
          "No se ha sincronizado la base de datos: " + error.message;
        localStorage.setItem("mensaje", mensaje);
        window.location.href =
          "https://dosxdos.app.iidos.com/rutas_montador.html";
      }
    }

    async function sincronizarDb2() {
      return new Promise(async (resolve, reject) => {
        try {
          loaderOn();
          const fRutas = await fetchRutas();
          rutas = await leerDatos("dosxdos", "rutas");
          rutas = rutas.map((objeto) => ({
            cod: objeto["No."],
            nombre: objeto["Descripcion"],
          }));
          const limpiarLineas = await limpiarDatos("dosxdos", "lineas");
          if (limpiarLineas) {
            lineas = await fetchLineas(rutas);
            if (lineas) {
              resolve(true);
            } else {
              resolve(false);
            }
          }
        } catch (error) {
          console.error(error);
          reject(false);
        }
      });
    }

    /* LOGIN */

    function vLogin() {
      return new Promise((resolve, reject) => {
        const login = localStorage.getItem("login");
        if (login && login !== null) {
          leerDatos("dosxdos", "usuario")
            .then((res) => {
              usuario = res[0];
              resolve(usuario.clase);
            })
            .catch((err) => {
              resolve(false);
            });
        } else {
          resolve(false);
        }
      });
    }

    // for the search bar initialization
    function initializeSearch() {
      const buscador = document.getElementById("buscador");
      if (buscador) {
        buscador.addEventListener("input", () => {
          const searchTerm = buscador.value.toLowerCase().trim();

          document.querySelectorAll("[data-search-text]").forEach((card) => {
            const searchText = card.getAttribute("data-search-text");

            // Reset any previous highlighting
            const highlightedElements = card.querySelectorAll(".bg-yellow-200");
            highlightedElements.forEach((el) => {
              // Replace the highlighted span with its text content
              if (el.parentNode) {
                el.outerHTML = el.textContent;
              }
            });

            if (searchText.includes(searchTerm)) {
              card.style.display = "block";

              // If search term is present, highlight it
              if (searchTerm) {
                const textElements = card.querySelectorAll(
                  "p, h3, span:not(.icon-span)"
                );
                textElements.forEach((el) => {
                  const originalText = el.textContent;
                  if (originalText.toLowerCase().includes(searchTerm)) {
                    const regex = new RegExp(
                      `(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
                      "gi"
                    );
                    el.innerHTML = originalText.replace(
                      regex,
                      '<span class="bg-yellow-200 font-bold">$1</span>'
                    );
                  }
                });
              }
            } else {
              card.style.display = "none";
            }
          });
        });
      }
    }

    function createLineDetailsModal(objeto) {
      // Modal backdrop - Fullscreen, centered
      const modalBackdrop = document.createElement('div');
      modalBackdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';

      // MODAL CONTAINER (Limited Height, Forced to Never Overflow)
      const modalContainer = document.createElement('div');
      modalContainer.className = 'bg-white rounded-xl shadow-xl max-w-xl w-full mx-4 max-h-[85vh] flex flex-col overflow-hidden';

      // MODAL HEADER 
      const modalHeader = document.createElement('div');
      modalHeader.className = 'text-white p-4 rounded-t-xl flex justify-between items-center sticky top-0 z-10';
      modalHeader.style.backgroundImage =
        "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
      modalHeader.style.backgroundSize = "contain";
      modalHeader.style.backgroundPosition = "center";

      const modalTitle = document.createElement('h2');
      modalTitle.className = 'text-xl font-bold pr-4';
      modalTitle.textContent = objeto.NombrePuntoVenta;

      const closeButton = document.createElement('button');
      closeButton.className = 'text-white hover:text-gray-200';
      closeButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `;

      modalHeader.appendChild(modalTitle);
      modalHeader.appendChild(closeButton);

      // MODAL BODY 
      const modalBody = document.createElement('div');
      modalBody.className = 'p-4 space-y-4 overflow-y-auto flex-grow custom-scrollbar';
      modalBody.style.maxHeight = 'calc(85vh - 120px)';

      // Sections for information
      const infoSections = [
        { title: 'Información General', fields: ['LineaActividad', 'NombreCliente', 'TipoTrabajo', 'Estado'] },
        { title: 'Detalles de la Orden', fields: ['Navision_OT', 'OT', 'DescripcionOT', 'FechaActuacion'] },
        { title: 'Ubicación', fields: ['DireccionPuntoVenta', 'Sector', 'Zona'] }
      ];

      infoSections.forEach(section => {
        const sectionContainer = document.createElement('div');
        sectionContainer.className = 'bg-gray-100 rounded-lg p-4';

        const sectionTitle = document.createElement('h3');
        sectionTitle.className = 'text-lg font-semibold text-gray-800 mb-3';
        sectionTitle.textContent = section.title;
        sectionContainer.appendChild(sectionTitle);

        section.fields.forEach(field => {
          if (objeto[field] && objeto[field] !== 'null') {
            const infoRow = document.createElement('div');
            infoRow.className = 'flex justify-between gap-4 py-1.5 border-b border-gray-200 last:border-b-0';

            const label = document.createElement('span');
            label.className = 'text-gray-600 font-medium text-sm';
            label.textContent = field.replace(/([A-Z])/g, ' $1');

            const value = document.createElement('span');
            value.className = 'text-gray-900 text-sm text-right whitespace-normal break-words';
            value.style.maxWidth = '70%';

            value.textContent = objeto[field];

            infoRow.appendChild(label);
            infoRow.appendChild(value);
            sectionContainer.appendChild(infoRow);
          }
        });

        modalBody.appendChild(sectionContainer);
      });

      // OBSERVACIONES SECTION 
      if (objeto.Observaciones || objeto.ObservacionesTecnico) {
        const observationsContainer = document.createElement('div');
        observationsContainer.className = 'bg-gray-100 rounded-lg p-4';

        const obsTitle = document.createElement('h3');
        obsTitle.className = 'text-lg font-semibold text-gray-800 mb-3';
        obsTitle.textContent = "Observaciones";
        observationsContainer.appendChild(obsTitle);

        if (objeto.Observaciones) {
          const obsValue = document.createElement('p');
          obsValue.className = 'text-gray-900 text-sm whitespace-normal break-words';
          obsValue.textContent = objeto.Observaciones;
          observationsContainer.appendChild(obsValue);
        }

        if (objeto.ObservacionesTecnico) {
          const obsTechValue = document.createElement('p');
          obsTechValue.className = 'text-gray-900 text-sm whitespace-normal break-words mt-2';
          obsTechValue.textContent = `Técnico: ${objeto.ObservacionesTecnico}`;
          observationsContainer.appendChild(obsTechValue);
        }

        modalBody.appendChild(observationsContainer);
      }

      // MODAL FOOTER
      const modalFooter = document.createElement('div');
      modalFooter.className = 'bg-gray-100 p-4 rounded-b-xl flex justify-between items-center gap-4 sticky bottom-0';

      const cancelButton = document.createElement('button');
      cancelButton.className = 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 w-1/2 rounded-lg flex-grow';
      cancelButton.textContent = 'Cerrar';

      const reportarButton = document.createElement('button');
      reportarButton.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 w-1/2 rounded-lg flex-grow';
      reportarButton.textContent = 'Reportar';

      // Restore scrolling when closing the modal
      closeButton.addEventListener('click', () => {
        document.body.style.overflow = ''; // Restore scrolling
        document.body.removeChild(modalBackdrop);
      });

      cancelButton.addEventListener('click', () => {
        document.body.style.overflow = ''; // Restore scrolling
        document.body.removeChild(modalBackdrop);
      });

      reportarButton.addEventListener('click', () => {
        localStorage.setItem("renderizarHistorial", false);
        localStorage.setItem("linea", objeto.Linea);
        localStorage.setItem("lineaActividad", objeto.LineaActividad);
        localStorage.setItem("ot", objeto.OT);
        localStorage.setItem("cliente", objeto.Cliente);
        localStorage.setItem("nombreCliente", objeto.NombreCliente);

        window.location.href = "https://dosxdos.app.iidos.com/linea_montador.html";
      });

      modalFooter.appendChild(cancelButton);
      modalFooter.appendChild(reportarButton);

      // Assemble Modal
      modalContainer.appendChild(modalHeader);
      modalContainer.appendChild(modalBody);
      modalContainer.appendChild(modalFooter);
      modalBackdrop.appendChild(modalContainer);
      document.body.appendChild(modalBackdrop);

      // Close Modal on Click Outside
      modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) {
          document.body.style.overflow = ''; // Restore scrolling
          document.body.removeChild(modalBackdrop);
        }
      });

      //  Prevent Body Scroll When Modal is Open
      document.body.style.overflow = 'hidden'; // Lock scroll only when modal is open
    }

    // Function to handle featured items (urgent and new)
    function processAndSortItems(items) {
      // First sort items: urgent ones first, then new ones, then the rest
      items.sort((a, b) => {
        if (a.urgente && !b.urgente) return -1;
        if (!a.urgente && b.urgente) return 1;
        if (a.nueva && !b.nueva) return -1;
        if (!a.nueva && b.nueva) return 1;
        return 0;
      });

      return items;
    }

    // INITIALIZATION FUNCTION
    function initializeApplication() {
      // Dynamically create navigation based on user role
      createDesktopNavigation(usuario.clase);
      // Setup desktop and mobile navigation
      setupMenu(usuario.clase);

      // Setup menu interactions
      setupMenuInteractions();
      setupUserActions();
      setupGlobalMenuClosing();

      updateUserDisplay();

      // Update the user information in the new UI elements
      const nombreUsuarioDesktop = document.getElementById('nombreUsuarioDesktop');
      const nombreUsuarioMobile = document.getElementById('nombreUsuarioMobile');
      const imagenUsuarioDesktop = document.getElementById('imagenUsuarioDesktop');
      const imagenUsuarioMobile = document.getElementById('imagenUsuarioMobile');

      if (nombreUsuarioDesktop) nombreUsuarioDesktop.textContent = usuario.nombre;
      if (nombreUsuarioMobile) nombreUsuarioMobile.textContent = usuario.nombre;

      if (usuario.imagen !== "0") {
        if (imagenUsuarioDesktop) imagenUsuarioDesktop.src = usuario.imagen;
        if (imagenUsuarioMobile) imagenUsuarioMobile.src = usuario.imagen;
      }
    }

    async function appOnline() {
      try {
        const login = await vLogin();
        if (!login) {
          window.location.href = "https://dosxdos.app.iidos.com/index.html";
        } else {
          const Arrayusuario = await leerDatos("dosxdos", "usuario");
          usuario = Arrayusuario[0];
          let loginMontador = localStorage.getItem("loginMontador");
          if (!loginMontador || loginMontador === null) {
            window.location.href =
              "https://dosxdos.app.iidos.com/dosxdos.php?id=" +
              usuario.id +
              "&rol=" +
              usuario.clase;
          }
          montador = usuario.cod;

          initializeApplication()

          try {
            const sincronizacionDeNotificaciones = await sincronizarNotificaciones();
            if (sincronizacionDeNotificaciones) {
              await notificar();
            }
          } catch (error) {
            console.error("Error loading notifications:", error);
          }

          sinc = await sincronizarDb2();
          sinc
            ? console.log("Base de datos sincronizada")
            : console.error("Error al sincronizar la base de datos");

          rutas = await leerDatos("dosxdos", "rutas");
          rutas = rutas.map((objeto) => ({
            cod: objeto["No."],
            nombre: objeto["Descripcion"],
          }));

          const TotalLineas = await leerDatos("dosxdos", "lineas");

          if (TotalLineas) {
            const lineas = TotalLineas.filter((objeto) => {
              return objeto.Proyecto == ruta;
            });

            // Clear the content area
            $contenido.innerHTML = "";

            if (lineas.length === 0) {
              // Create a no data placeholder
              const noDataPlaceholder = document.createElement('div');
              noDataPlaceholder.className = 'flex flex-col items-center justify-center min-h-[calc(100vh-300px)] text-center p-8 bg-gray-100';

              noDataPlaceholder.innerHTML = `
            <h2 class="text-2xl font-semibold text-gray-600 mb-4">No hay líneas disponibles</h2>
            <p class="text-gray-500 max-w-md">
                Parece que no hay líneas asignadas a esta ruta en este momento.
            </p>
        `;

              $contenido.appendChild(noDataPlaceholder);

              // Exit the function early since there are no lines
              loaderOff();
              return;
            }

            // Extract unique sectors from the lines
            const sectors = [];
            lineas.forEach(line => {
              // Extract main sector (first word before space)
              const sectorText = line.Sector || '';
              const sectorMain = sectorText.split(' ')[0];
              if (sectorMain && !sectors.includes(sectorMain)) {
                sectors.push(sectorMain);
              }
            });

            if (sectors.length > 0) {
              // Create the tabs container
              const tabsContainer = document.createElement('div');
              tabsContainer.className = 'mb-6 overflow-hidden';

              // Create the tabs header
              const tabsHeader = document.createElement('div');
              tabsHeader.className = 'flex overflow-x-auto border-b border-gray-200';

              // Create tab content container
              const tabsContent = document.createElement('div');
              tabsContent.className = 'my-4';

              // Add TODOS tab first
              const todosButton = document.createElement('button');
              todosButton.className = 'p-2 text-gray-700 font-medium text-sm uppercase whitespace-nowrap transition-all duration-200 border-b-2 border-red-600 text-red-600';
              todosButton.textContent = "TODOS";
              todosButton.dataset.sector = "todos";

              // Add count badge to TODOS tab
              const todosCountBadge = document.createElement('span');
              todosCountBadge.className = 'ml-2 bg-red-700 text-white text-xs rounded-full h-5 inline-flex items-center justify-center px-1.5';
              todosCountBadge.textContent = lineas.length;
              todosButton.appendChild(todosCountBadge);

              // Create content div for TODOS tab
              const todosContentDiv = document.createElement('div');
              todosContentDiv.className = 'sector-content';
              todosContentDiv.dataset.sector = "todos";
              todosContentDiv.style.display = 'block'; // TODOS tab is active by default

              // Create a grid for the TODOS tab
              const todosGrid = document.createElement('div');
              todosGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 place-items-center';

              // Create all cards for TODOS tab (all items)
              lineas.forEach((objeto) => {
                // Create card for each line
                const card = document.createElement("div");
                card.className = "relative rounded-xl shadow-lg transition-all duration-300 border border-gray-200 w-full h-full";
                card.style.backgroundColor = "#FFFFFF";

                // Special styling for urgent and new items
                if (objeto.urgente) {
                  card.style.backgroundColor = "#FEF2F2"; // Light red background

                  card.style.borderLeft = "4px solid #dc2626"; // Red border all around
                  card.style.order = "-2"; // Will appear first

                } else if (objeto.nueva) {
                  card.style.backgroundColor = "#EFF6FF"; // Light blue background
                  card.style.borderLeft = "4px solid #3b82f6"; // Blue border
                  card.style.order = "-1"; // Will appear after urgent items
                }

                // Header with SVG Red Texture Background
                const header = document.createElement("div");
                header.className = "relative flex flex-col px-5 py-5 text-center text-white rounded-t-lg";
                header.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
                header.style.backgroundSize = "contain";
                header.style.backgroundPosition = "center";

                // Title
                const titleContainer = document.createElement("div");
                titleContainer.className = "flex items-center justify-center mb-1 my-2 lg:my-0";

                const title = document.createElement("h3");
                title.className = "text-white font-bold text-lg truncate max-w-full";
                title.textContent = `${objeto.NombrePuntoVenta}`;

                titleContainer.appendChild(title);
                header.appendChild(titleContainer);

                const locationIcon = document.createElement("div");
                locationIcon.className = "mr-2";
                locationIcon.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
</svg>
`;

                // Subtitle
                const subtitle = document.createElement("div");
                subtitle.className = "text-white/95 text-xs font-medium";
                subtitle.appendChild(locationIcon);
                subtitle.textContent = `${objeto.Sector} - ${objeto.Zona}`;
                header.appendChild(subtitle);

                // "Pendiente" Badge
                const statusBadge = document.createElement("div");
                statusBadge.className = "absolute top-2 right-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md";
                statusBadge.textContent = objeto.Estado;
                statusBadge.style.backgroundColor = "#A22323";
                header.appendChild(statusBadge);

                // Add badges for urgent or new items
                if (objeto.urgente && objeto.nueva) {
                  // Create a container for badges that allows them to be side by side
                  const badgesContainer = document.createElement("div");
                  badgesContainer.className = "absolute -top-2 left-2 flex space-x-2 z-10";

                  // Urgent Badge
                  const urgentBadge = document.createElement("div");
                  urgentBadge.className = "px-3 py-1 text-xs font-bold rounded-md shadow-md flex items-center";
                  urgentBadge.style.backgroundColor = "#FFFFFF";
                  urgentBadge.style.color = "#dc2626"; // Red text
                  urgentBadge.style.border = "2px solid #dc2626";
                  urgentBadge.style.animation = "pulse 2s infinite";

                  // Add alert icon SVG
                  const alertIcon = document.createElement("span");
                  alertIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#dc2626">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>
  `;
                  urgentBadge.appendChild(alertIcon);

                  // Add urgent text
                  const urgentText = document.createElement("span");
                  urgentText.textContent = "URGENTE";
                  urgentBadge.appendChild(urgentText);

                  // New Badge
                  const newBadge = document.createElement("div");
                  newBadge.className = "px-3 py-1 text-xs font-bold text-white rounded-md shadow-md flex items-center";
                  newBadge.style.backgroundColor = "#3b82f6";

                  // Add star icon SVG
                  const newIcon = document.createElement("span");
                  newIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  `;
                  newBadge.appendChild(newIcon);

                  // Add new text
                  const newText = document.createElement("span");
                  newText.textContent = "NUEVA";
                  newBadge.appendChild(newText);

                  // Add both badges to container
                  badgesContainer.appendChild(urgentBadge);
                  badgesContainer.appendChild(newBadge);

                  // Add badges container to header
                  header.appendChild(badgesContainer);

                  // Modify card style to accommodate both badges
                  card.style.backgroundColor = "#FEF2F2"; // Light red background
                  card.style.borderLeft = "4px solid #dc2626"; // Red border
                  card.style.order = "-3"; // Will appear first among displayed items
                } else if (objeto.urgente && !objeto.nueva) {
                  const urgentBadge = document.createElement("div");
                  // Use a white badge with red text for contrast against red background
                  urgentBadge.className = "absolute -top-2 left-2 px-3 py-1 text-xs font-bold rounded-md shadow-md flex items-center";
                  urgentBadge.style.backgroundColor = "#FFFFFF";
                  urgentBadge.style.color = "#dc2626"; // Red text
                  urgentBadge.style.border = "2px solid #dc2626";
                  urgentBadge.style.zIndex = "10";
                  urgentBadge.style.animation = "pulse 2s infinite";

                  // Add alert icon SVG
                  const alertIcon = document.createElement("span");
                  alertIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#dc2626">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>
  `;
                  urgentBadge.appendChild(alertIcon);

                  // Add text
                  const badgeText = document.createElement("span");
                  badgeText.textContent = "URGENTE";
                  urgentBadge.appendChild(badgeText);

                  header.appendChild(urgentBadge);
                } else if (objeto.nueva && !objeto.urgente) {
                  const newBadge = document.createElement("div");
                  // Use a blue badge with white text - matching position with urgent badge
                  newBadge.className = "absolute -top-2 left-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md flex items-center";
                  newBadge.style.backgroundColor = "#3b82f6";
                  newBadge.style.zIndex = "10";

                  // Add star icon SVG
                  const newIcon = document.createElement("span");
                  newIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  `;
                  newBadge.appendChild(newIcon);

                  // Add text
                  const badgeText = document.createElement("span");
                  badgeText.textContent = "NUEVA";
                  newBadge.appendChild(badgeText);

                  header.appendChild(newBadge);
                }


                // Card Body
                const body = document.createElement("div");
                body.className = "text-gray-900 p-4 space-y-2 mb-12";

                // Information Rows
                const createInfoRow = (label, value) => {
                  const row = document.createElement("div");
                  row.className = "flex justify-between gap-4 items-center py-2 px-4 bg-gray-100 border border-gray-200 rounded-lg";

                  const labelCol = document.createElement("div");
                  labelCol.className = "text-gray-700 text-xs uppercase font-semibold";
                  labelCol.textContent = label;

                  const valueCol = document.createElement("div");
                  valueCol.className = "text-gray-900 font-medium text-sm text-right";
                  valueCol.textContent = value || "-";

                  row.appendChild(labelCol);
                  row.appendChild(valueCol);
                  return row;
                };

                // Add Key Data
                body.appendChild(createInfoRow("LÍNEA", objeto.LineaActividad));
                body.appendChild(createInfoRow("CLIENTE", objeto.NombreCliente));
                body.appendChild(createInfoRow("TIPO", objeto.TipoTrabajo));
                body.appendChild(createInfoRow("OBSERVACIONES", objeto.Observaciones));
                body.appendChild(createInfoRow("DIRECCIÓN", objeto.DireccionPuntoVenta));
                body.appendChild(createInfoRow("OT NAVISION", objeto.Navision_OT));
                body.appendChild(createInfoRow("OT CRM", objeto.OT));

                // Footer with button
                const footer = document.createElement("div");
                footer.className = "flex justify-center bg-white rounded-b-lg px-4 mb-3";

                // "Reportar" Button
                const actionBtn = document.createElement("button");
                actionBtn.className = "mx-6 absolute bottom-4 bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-24 transition-all duration-300 rounded-lg shadow-sm mx-auto flex justify-center items-center";
                actionBtn.innerHTML = "<span class='ml-1'>Más Detalles</span>";

                actionBtn.onclick = (e) => {
                  e.stopPropagation();

                  localStorage.setItem("renderizarHistorial", false);
                  localStorage.setItem("linea", objeto.Linea);
                  localStorage.setItem("lineaActividad", objeto.LineaActividad);
                  localStorage.setItem("ot", objeto.OT);
                  localStorage.setItem("cliente", objeto.Cliente);
                  localStorage.setItem("nombreCliente", objeto.NombreCliente);

                  createLineDetailsModal(objeto);
                };

                footer.appendChild(actionBtn);

                // Assemble Card
                card.appendChild(header);
                card.appendChild(body);
                card.appendChild(footer);

                // Full Card Search Data
                const fullText = `${objeto.Sector} ${objeto.Zona} ${objeto.LineaActividad} ${objeto.NombrePuntoVenta} ${objeto.NombreCliente} ${objeto.TipoTrabajo} ${objeto.Observaciones || ""} DIRECCIÓN: ${objeto.DireccionPuntoVenta || ""} NAVISION: ${objeto.Navision_OT} CRM: ${objeto.OT}`;
                card.setAttribute("data-search-text", fullText.toLowerCase());

                // Append card to TODOS grid
                todosGrid.appendChild(card);
              });

              todosContentDiv.appendChild(todosGrid);

              // Add TODOS tab to header first
              tabsHeader.appendChild(todosButton);

              // For each sector, create a tab and content section
              sectors.forEach((sector, index) => {
                // Create tab button (not active by default)
                const tabButton = document.createElement('button');
                tabButton.className = 'p-4 text-gray-700 font-medium text-sm uppercase whitespace-nowrap transition-all duration-200 border-b-2 border-transparent hover:text-red-600 hover:border-red-600/50';
                tabButton.textContent = sector;
                tabButton.dataset.sector = sector;

                // Create content div for this sector
                const contentDiv = document.createElement('div');
                contentDiv.className = 'sector-content';
                contentDiv.dataset.sector = sector;
                contentDiv.style.display = 'none'; // Hidden by default (TODOS is active)

                // Filter lines for this sector and add them to the content
                const sectorLines = lineas.filter(line => {
                  const lineSector = line.Sector?.split(' ')[0] || '';
                  return lineSector === sector;
                });

                // Create a grid for the cards
                const sectorGrid = document.createElement('div');
                sectorGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 place-items-center';

                // Create cards for each line in this sector
                // Sort the lines to have urgent and new items first
                const sortedLines = processAndSortItems(sectorLines);
                sortedLines.forEach((objeto) => {                  // Create a card container for each item
                  const card = document.createElement("div");
                  card.className = "relative rounded-xl shadow-lg transition-all duration-300 border border-gray-200 w-full h-full";
                  card.style.backgroundColor = "#FFFFFF";


                  // Special styling for urgent and new items
                  if (objeto.urgente) {
                    card.style.backgroundColor = "#FEF2F2"; // Light red background

                    card.style.borderLeft = "4px solid #dc2626"; // Red border all around
                    card.style.order = "-2"; // Will appear first

                  } else if (objeto.nueva) {
                    card.style.backgroundColor = "#EFF6FF"; // Light blue background
                    card.style.borderLeft = "4px solid #3b82f6"; // Blue border
                    card.style.order = "-1"; // Will appear after urgent items
                  }

                  // Header with SVG Red Texture Background
                  const header = document.createElement("div");
                  header.className = "relative flex flex-col px-5 py-5 text-center text-white rounded-t-lg";

                  header.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
                  header.style.backgroundSize = "contain";
                  header.style.backgroundPosition = "center";

                  // Title
                  const titleContainer = document.createElement("div");
                  titleContainer.className = "flex items-center justify-center mb-1 my-2 lg:my-0";

                  const title = document.createElement("h3");
                  title.className = "text-white font-bold text-lg truncate max-w-full";
                  title.textContent = `${objeto.NombrePuntoVenta}`;

                  titleContainer.appendChild(title);
                  header.appendChild(titleContainer);

                  const locationIcon = document.createElement("div");
                  locationIcon.className = "mr-2";
                  locationIcon.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
</svg>
`;

                  // Subtitle
                  const subtitle = document.createElement("div");
                  subtitle.className = "text-white/95 text-xs font-medium";
                  subtitle.appendChild(locationIcon);
                  subtitle.textContent = `${objeto.Sector} - ${objeto.Zona}`;
                  header.appendChild(subtitle);

                  // "Pendiente" Badge
                  const statusBadge = document.createElement("div");
                  statusBadge.className = "absolute top-2 right-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md";
                  statusBadge.textContent = objeto.Estado;
                  statusBadge.style.backgroundColor = "#A22323";
                  header.appendChild(statusBadge);


                  // Add badges for urgent or new items
                  if (objeto.urgente && objeto.nueva) {
                    // Create a container for badges that allows them to be side by side
                    const badgesContainer = document.createElement("div");
                    badgesContainer.className = "absolute -top-2 left-2 flex space-x-2 z-10";

                    // Urgent Badge
                    const urgentBadge = document.createElement("div");
                    urgentBadge.className = "px-3 py-1 text-xs font-bold rounded-md shadow-md flex items-center";
                    urgentBadge.style.backgroundColor = "#FFFFFF";
                    urgentBadge.style.color = "#dc2626"; // Red text
                    urgentBadge.style.border = "2px solid #dc2626";
                    urgentBadge.style.animation = "pulse 2s infinite";

                    // Add alert icon SVG
                    const alertIcon = document.createElement("span");
                    alertIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#dc2626">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>
  `;
                    urgentBadge.appendChild(alertIcon);

                    // Add urgent text
                    const urgentText = document.createElement("span");
                    urgentText.textContent = "URGENTE";
                    urgentBadge.appendChild(urgentText);

                    // New Badge
                    const newBadge = document.createElement("div");
                    newBadge.className = "px-3 py-1 text-xs font-bold text-white rounded-md shadow-md flex items-center";
                    newBadge.style.backgroundColor = "#3b82f6";

                    // Add star icon SVG
                    const newIcon = document.createElement("span");
                    newIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  `;
                    newBadge.appendChild(newIcon);

                    // Add new text
                    const newText = document.createElement("span");
                    newText.textContent = "NUEVA";
                    newBadge.appendChild(newText);

                    // Add both badges to container
                    badgesContainer.appendChild(urgentBadge);
                    badgesContainer.appendChild(newBadge);

                    // Add badges container to header
                    header.appendChild(badgesContainer);

                    // Modify card style to accommodate both badges
                    card.style.backgroundColor = "#FEF2F2"; // Light red background
                    card.style.borderLeft = "4px solid #dc2626"; // Red border
                    card.style.order = "-3"; // Will appear first among displayed items
                  } else if (objeto.urgente && !objeto.nueva) {
                    const urgentBadge = document.createElement("div");
                    // Use a white badge with red text for contrast against red background
                    urgentBadge.className = "absolute -top-2 left-2 px-3 py-1 text-xs font-bold rounded-md shadow-md flex items-center";
                    urgentBadge.style.backgroundColor = "#FFFFFF";
                    urgentBadge.style.color = "#dc2626"; // Red text
                    urgentBadge.style.border = "2px solid #dc2626";
                    urgentBadge.style.zIndex = "10";
                    urgentBadge.style.animation = "pulse 2s infinite";

                    // Add alert icon SVG
                    const alertIcon = document.createElement("span");
                    alertIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#dc2626">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>
  `;
                    urgentBadge.appendChild(alertIcon);

                    // Add text
                    const badgeText = document.createElement("span");
                    badgeText.textContent = "URGENTE";
                    urgentBadge.appendChild(badgeText);

                    header.appendChild(urgentBadge);
                  } else if (objeto.nueva && !objeto.urgente) {
                    const newBadge = document.createElement("div");
                    // Use a blue badge with white text - matching position with urgent badge
                    newBadge.className = "absolute -top-2 left-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md flex items-center";
                    newBadge.style.backgroundColor = "#3b82f6";
                    newBadge.style.zIndex = "10";

                    // Add star icon SVG
                    const newIcon = document.createElement("span");
                    newIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  `;
                    newBadge.appendChild(newIcon);

                    // Add text
                    const badgeText = document.createElement("span");
                    badgeText.textContent = "NUEVA";
                    newBadge.appendChild(badgeText);

                    header.appendChild(newBadge);
                  }

                  // Card Body
                  const body = document.createElement("div");
                  body.className = "text-gray-900 p-4 space-y-2 mb-12";

                  // Information Rows
                  const createInfoRow = (label, value) => {
                    const row = document.createElement("div");
                    row.className = "flex justify-between gap-4 items-center py-2 px-4 bg-gray-100 border border-gray-200 rounded-lg";

                    const labelCol = document.createElement("div");
                    labelCol.className = "text-gray-700 text-xs uppercase font-semibold";
                    labelCol.textContent = label;

                    const valueCol = document.createElement("div");
                    valueCol.className = "text-gray-900 font-medium text-sm text-right";
                    valueCol.textContent = value || "-";

                    row.appendChild(labelCol);
                    row.appendChild(valueCol);
                    return row;
                  };

                  // Add Key Data
                  body.appendChild(createInfoRow("LÍNEA", objeto.LineaActividad));
                  body.appendChild(createInfoRow("CLIENTE", objeto.NombreCliente));
                  body.appendChild(createInfoRow("TIPO", objeto.TipoTrabajo));
                  body.appendChild(createInfoRow("OBSERVACIONES", objeto.Observaciones));
                  body.appendChild(createInfoRow("DIRECCIÓN", objeto.DireccionPuntoVenta));
                  body.appendChild(createInfoRow("OT NAVISION", objeto.Navision_OT));
                  body.appendChild(createInfoRow("OT CRM", objeto.OT));

                  // Footer - now more subtle with centered button
                  const footer = document.createElement("div");
                  footer.className = "flex justify-center bg-white rounded-b-lg px-4 mb-3";

                  // "Reportar" Button - smaller and more subtle
                  const actionBtn = document.createElement("button");
                  actionBtn.className = "mx-6 absolute bottom-4 bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-24 transition-all duration-300 rounded-lg shadow-sm mx-auto flex justify-center items-center";
                  actionBtn.innerHTML = "<span class='ml-1'>Más Detalles</span>";

                  actionBtn.onclick = (e) => {
                    e.stopPropagation();

                    localStorage.setItem("renderizarHistorial", false);
                    localStorage.setItem("linea", objeto.Linea);
                    localStorage.setItem("lineaActividad", objeto.LineaActividad);
                    localStorage.setItem("ot", objeto.OT);
                    localStorage.setItem("cliente", objeto.Cliente);
                    localStorage.setItem("nombreCliente", objeto.NombreCliente);

                    createLineDetailsModal(objeto);
                  };

                  footer.appendChild(actionBtn);

                  // Assemble Card
                  card.appendChild(header);
                  card.appendChild(body);
                  card.appendChild(footer);

                  // Full Card Search Data
                  const fullText = `${objeto.Sector} ${objeto.Zona} ${objeto.LineaActividad} ${objeto.NombrePuntoVenta} ${objeto.NombreCliente} ${objeto.TipoTrabajo} ${objeto.Observaciones || ""} DIRECCIÓN: ${objeto.DireccionPuntoVenta || ""} NAVISION: ${objeto.Navision_OT} CRM: ${objeto.OT}`;
                  card.setAttribute("data-search-text", fullText.toLowerCase());

                  // Append to Grid Container
                  sectorGrid.appendChild(card);
                });

                contentDiv.appendChild(sectorGrid);

                // Add count badge to tab
                const countBadge = document.createElement('span');
                countBadge.className = 'ml-2 bg-red-700 text-white text-xs rounded-full h-5  inline-flex items-center justify-center px-1.5';
                countBadge.textContent = sectorLines.length;
                tabButton.appendChild(countBadge);

                // Add click event to switch tabs
                tabButton.addEventListener('click', () => {
                  // Remove active class and red border from all tabs
                  const allTabs = tabsHeader.querySelectorAll('button');
                  allTabs.forEach(tab => {
                    tab.classList.remove('border-red-600', 'text-red-600');
                    tab.classList.add('border-transparent');
                    tab.classList.remove('bg-red-600', 'text-white');
                    tab.classList.add('text-gray-700', 'hover:text-red-600', 'hover:border-red-600/50');
                  });

                  // Add red border and text to clicked tab
                  tabButton.classList.add('border-red-600', 'text-red-600');
                  tabButton.classList.remove('border-transparent');
                  tabButton.classList.remove('bg-red-600', 'text-white', 'hover:text-red-600', 'hover:border-red-600/50');

                  // Hide all content sections
                  const allContent = tabsContent.querySelectorAll('.sector-content');
                  allContent.forEach(content => {
                    content.style.display = 'none';
                  });

                  // Show the selected content section
                  const activeContent = tabsContent.querySelector(`.sector-content[data-sector="${sector}"]`);
                  if (activeContent) {
                    activeContent.style.display = 'block';
                  }
                });

                // Add to containers
                tabsHeader.appendChild(tabButton);
                tabsContent.appendChild(contentDiv);
              });

              // Add TODOS tab click handler
              todosButton.addEventListener('click', () => {
                // Remove active class from all tabs
                const allTabs = tabsHeader.querySelectorAll('button');
                allTabs.forEach(tab => {
                  tab.classList.remove('border-red-600', 'text-red-600');
                  tab.classList.add('border-transparent');
                  tab.classList.add('text-gray-700', 'hover:text-red-600', 'hover:border-red-600/50');
                });

                // Make TODOS tab active
                todosButton.classList.add('border-red-600', 'text-red-600');
                todosButton.classList.remove('border-transparent', 'hover:text-red-600', 'hover:border-red-600/50');

                // Hide all content sections
                const allContent = tabsContent.querySelectorAll('.sector-content');
                allContent.forEach(content => {
                  content.style.display = 'none';
                });

                // Show TODOS content
                todosContentDiv.style.display = 'block';
              });

              // Add TODOS content to the tab contents
              tabsContent.appendChild(todosContentDiv);

              // Add tabs and content to the main container
              tabsContainer.appendChild(tabsHeader);
              tabsContainer.appendChild(tabsContent);

              // Add to main content area
              $contenido.appendChild(tabsContainer);
            } else {
              // Fallback to regular grid if no sectors found
              const gridContainer = document.createElement("div");
              gridContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 place-items-center";

              // Create cards for regular view if no sectors
              lineas.forEach((objeto) => {
                // Create a card container for each item
                const card = document.createElement("div");
                card.className = "relative rounded-xl shadow-lg overflow-hidden transition-all duration-300 border border-gray-200 w-full h-full";
                card.style.backgroundColor = "#FFFFFF";

                // Header with SVG Red Texture Background
                const header = document.createElement("div");
                header.className = "relative flex flex-col px-5 py-5 text-center text-white";

                header.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
                header.style.backgroundSize = "contain";
                header.style.backgroundPosition = "center";

                // Title
                const titleContainer = document.createElement("div");
                titleContainer.className = "flex items-center justify-center mb-1 my-2 lg:my-0";

                // Add star icon for featured items
                if (objeto.urgente || objeto.nueva) {
                  const starIcon = document.createElement("span");
                  starIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  `;
                  starIcon.className = "mr-2";
                  titleContainer.appendChild(starIcon);
                }

                const title = document.createElement("h3");
                title.className = "text-white font-bold text-lg truncate max-w-full";
                title.textContent = `${objeto.NombrePuntoVenta}`;

                titleContainer.appendChild(title);
                header.appendChild(titleContainer);

                const locationIcon = document.createElement("div");
                locationIcon.className = "mr-2";
                locationIcon.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
</svg>
`;

                // Subtitle
                const subtitle = document.createElement("div");
                subtitle.className = "text-white/95 text-xs font-medium";
                subtitle.appendChild(locationIcon);
                subtitle.textContent = `${objeto.Sector} - ${objeto.Zona}`;
                header.appendChild(subtitle);

                // "Pendiente" Badge
                const statusBadge = document.createElement("div");
                statusBadge.className = "absolute top-2 right-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md";
                statusBadge.textContent = objeto.Estado;
                statusBadge.style.backgroundColor = "#A22323";
                header.appendChild(statusBadge);

                // Card Body
                const body = document.createElement("div");
                body.className = "text-gray-900 p-4 space-y-2 mb-12";

                // Information Rows
                const createInfoRow = (label, value) => {
                  const row = document.createElement("div");
                  row.className = "flex justify-between gap-4 items-center py-2 px-4 bg-gray-100 border border-gray-200 rounded-lg";

                  const labelCol = document.createElement("div");
                  labelCol.className = "text-gray-700 text-xs uppercase font-semibold";
                  labelCol.textContent = label;

                  const valueCol = document.createElement("div");
                  valueCol.className = "text-gray-900 font-medium text-sm text-right";
                  valueCol.textContent = value || "-";

                  row.appendChild(labelCol);
                  row.appendChild(valueCol);
                  return row;
                };

                // Add Key Data
                body.appendChild(createInfoRow("LÍNEA", objeto.LineaActividad));
                body.appendChild(createInfoRow("CLIENTE", objeto.NombreCliente));
                body.appendChild(createInfoRow("TIPO", objeto.TipoTrabajo));
                body.appendChild(createInfoRow("OBSERVACIONES", objeto.Observaciones));
                body.appendChild(createInfoRow("DIRECCIÓN", objeto.DireccionPuntoVenta));
                body.appendChild(createInfoRow("OT NAVISION", objeto.Navision_OT));
                body.appendChild(createInfoRow("OT CRM", objeto.OT));

                // Footer - now more subtle with centered button
                const footer = document.createElement("div");
                footer.className = "flex justify-center bg-white rounded-b-lg px-4 mb-3";

                // "Reportar" Button - smaller and more subtle
                const actionBtn = document.createElement("button");
                actionBtn.className = "mx-6 absolute bottom-4 bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-24 transition-all duration-300 rounded-lg shadow-sm mx-auto flex justify-center items-center";
                actionBtn.innerHTML = "<span class='ml-1'>Más Detalles</span>";

                actionBtn.onclick = (e) => {
                  e.stopPropagation();

                  localStorage.setItem("renderizarHistorial", false);
                  localStorage.setItem("linea", objeto.Linea);
                  localStorage.setItem("lineaActividad", objeto.LineaActividad);
                  localStorage.setItem("ot", objeto.OT);
                  localStorage.setItem("cliente", objeto.Cliente);
                  localStorage.setItem("nombreCliente", objeto.NombreCliente);

                  createLineDetailsModal(objeto);
                };

                footer.appendChild(actionBtn);

                // Assemble Card
                card.appendChild(header);
                card.appendChild(body);
                card.appendChild(footer);

                // Full Card Search Data
                const fullText = `${objeto.Sector} ${objeto.Zona} ${objeto.LineaActividad} ${objeto.NombrePuntoVenta} ${objeto.NombreCliente} ${objeto.TipoTrabajo} ${objeto.Observaciones || ""} DIRECCIÓN: ${objeto.DireccionPuntoVenta || ""} NAVISION: ${objeto.Navision_OT} CRM: ${objeto.OT}`;
                card.setAttribute("data-search-text", fullText.toLowerCase());

                // Append to Grid Container
                gridContainer.appendChild(card);
              });

              $contenido.appendChild(gridContainer);
            }

            // Update search to work across all tabs
            buscador.addEventListener("input", () => {
              const searchTerm = buscador.value.toLowerCase().trim();

              // Get all tabs and cards
              const sectorTabs = document.querySelectorAll('button[data-sector]');
              const allCards = document.querySelectorAll("[data-search-text]");

              // Remove any "no results" message
              const noResults = document.getElementById('no-search-results');
              if (noResults) noResults.remove();

              if (searchTerm === '') {
                // If search is cleared, reset view

                // Make all cards visible first
                allCards.forEach(card => {
                  card.style.display = "block";
                });

                // Find active tab
                const activeTab = document.querySelector('button[data-sector].border-red-600');

                if (activeTab) {
                  const activeSector = activeTab.dataset.sector;

                  // Show only content for active tab
                  document.querySelectorAll('.sector-content').forEach(content => {
                    if (content.dataset.sector === activeSector) {
                      content.style.display = 'block';
                    } else {
                      content.style.display = 'none';
                    }
                  });
                }
                return;
              }

              // When searching, always go to TODOS tab for complete results
              if (sectors.length > 0) {
                // Activate TODOS tab
                const todosTab = document.querySelector('button[data-sector="todos"]');
                if (todosTab) {
                  // Deactivate all tabs
                  sectorTabs.forEach(tab => {
                    tab.classList.remove('border-red-600', 'text-red-600');
                    tab.classList.add('border-transparent', 'text-gray-700');
                  });

                  // Activate TODOS tab
                  todosTab.classList.add('border-red-600', 'text-red-600');
                  todosTab.classList.remove('border-transparent');

                  // Show TODOS content
                  document.querySelectorAll('.sector-content').forEach(content => {
                    if (content.dataset.sector === 'todos') {
                      content.style.display = 'block';
                    } else {
                      content.style.display = 'none';
                    }
                  });
                }
              }

              // Filter cards based on search
              let hasResults = false;
              allCards.forEach(card => {
                const searchText = card.getAttribute("data-search-text");

                if (searchText.includes(searchTerm)) {
                  card.style.display = "block";
                  hasResults = true;
                } else {
                  card.style.display = "none";
                }
              });

              // Show no results message if needed
              if (!hasResults) {
                const noResultsMsg = document.createElement('div');
                noResultsMsg.id = 'no-search-results';
                noResultsMsg.className = 'p-8 bg-gray-100 rounded-lg text-center text-gray-500 my-4';
                noResultsMsg.innerHTML = `No se encontraron resultados para <strong>"${searchTerm}"</strong>`;

                const todosContent = document.querySelector('.sector-content[data-sector="todos"]');
                if (todosContent) {
                  todosContent.insertBefore(noResultsMsg, todosContent.firstChild);
                } else {
                  $contenido.insertBefore(noResultsMsg, $contenido.firstChild);
                }
              }
            });

            const peticionesCierre = await procesarPeticiones2();
            setInterval(sincronizarDb, 300000);
            loaderOff();
          } else {
            alerta("Error al leer el almacén de líneas");
            initializeSearch();
            loaderOff();
          }
        }
      } catch (error) {
        const errorMsg = "ERROR: " + error.message;
        console.error(error);
        alerta(errorMsg);
      }
    }

    async function appOffline() {
      try {
        const login = await vLogin();
        if (!login) {
          window.location.href = "https://dosxdos.app.iidos.com/index.html";
        } else {
          const Arrayusuario = await leerDatos("dosxdos", "usuario");
          usuario = Arrayusuario[0];
          let loginMontador = localStorage.getItem("loginMontador");
          if (!loginMontador || loginMontador === null) {
            window.location.href =
              "https://dosxdos.app.iidos.com/dosxdos.php?id=" +
              usuario.id +
              "&rol=" +
              usuario.clase;
          }
          montador = usuario.cod;

          initializeApplication()

          await notificar();

          rutas = await leerDatos("dosxdos", "rutas");
          rutas = rutas.map((objeto) => ({
            cod: objeto["No."],
            nombre: objeto["Descripcion"],
          }));

          const TotalLineas = await leerDatos("dosxdos", "lineas");
          if (TotalLineas) {
            const lineas = TotalLineas.filter((objeto) => {
              return objeto.Proyecto == ruta;
            });

            // Clear the content area
            $contenido.innerHTML = "";

            if (lineas.length === 0) {
              // Create a no data placeholder
              const noDataPlaceholder = document.createElement('div');
              noDataPlaceholder.className = 'flex flex-col items-center justify-center min-h-[calc(100vh-300px)] text-center p-8 bg-gray-100';

              noDataPlaceholder.innerHTML = `
            <h2 class="text-2xl font-semibold text-gray-600 mb-4">No hay líneas disponibles</h2>
            <p class="text-gray-500 max-w-md">
                Parece que no hay líneas asignadas a esta ruta en este momento.
            </p>
        `;

              $contenido.appendChild(noDataPlaceholder);

              // Exit the function early since there are no lines
              loaderOff();
              return;
            }

            // Extract unique sectors from the lines
            const sectors = [];
            lineas.forEach(line => {
              // Extract main sector (first word before space)
              const sectorText = line.Sector || '';
              const sectorMain = sectorText.split(' ')[0];
              if (sectorMain && !sectors.includes(sectorMain)) {
                sectors.push(sectorMain);
              }
            });

            if (sectors.length > 0) {
              // Create the tabs container
              const tabsContainer = document.createElement('div');
              tabsContainer.className = 'mb-6 overflow-hidden';

              // Create the tabs header
              const tabsHeader = document.createElement('div');
              tabsHeader.className = 'flex overflow-x-auto border-b border-gray-200';

              // Create tab content container
              const tabsContent = document.createElement('div');
              tabsContent.className = 'my-4';

              // Add TODOS tab first
              const todosButton = document.createElement('button');
              todosButton.className = 'p-2 text-gray-700 font-medium text-sm uppercase whitespace-nowrap transition-all duration-200 border-b-2 border-red-600 text-red-600';
              todosButton.textContent = "TODOS";
              todosButton.dataset.sector = "todos";

              // Add count badge to TODOS tab
              const todosCountBadge = document.createElement('span');
              todosCountBadge.className = 'ml-2 bg-red-700 text-white text-xs rounded-full h-5 inline-flex items-center justify-center px-1.5';
              todosCountBadge.textContent = lineas.length;
              todosButton.appendChild(todosCountBadge);

              // Create content div for TODOS tab
              const todosContentDiv = document.createElement('div');
              todosContentDiv.className = 'sector-content';
              todosContentDiv.dataset.sector = "todos";
              todosContentDiv.style.display = 'block'; // TODOS tab is active by default

              // Create a grid for the TODOS tab
              const todosGrid = document.createElement('div');
              todosGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 place-items-center';

              // Create all cards for TODOS tab (all items)
              lineas.forEach((objeto) => {
                // Create card for each line
                const card = document.createElement("div");
                card.className = "relative rounded-xl shadow-lg transition-all duration-300 border border-gray-200 w-full h-full";
                card.style.backgroundColor = "#FFFFFF";

                // Special styling for urgent and new items
                if (objeto.urgente) {
                  card.style.backgroundColor = "#FEF2F2"; // Light red background

                  card.style.borderLeft = "4px solid #dc2626"; // Red border all around
                  card.style.order = "-2"; // Will appear first

                } else if (objeto.nueva) {
                  card.style.backgroundColor = "#EFF6FF"; // Light blue background
                  card.style.borderLeft = "4px solid #3b82f6"; // Blue border
                  card.style.order = "-1"; // Will appear after urgent items
                }

                // Header with SVG Red Texture Background
                const header = document.createElement("div");
                header.className = "relative flex flex-col px-5 py-5 text-center text-white rounded-t-lg";
                header.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
                header.style.backgroundSize = "contain";
                header.style.backgroundPosition = "center";

                // Title
                const titleContainer = document.createElement("div");
                titleContainer.className = "flex items-center justify-center mb-1 my-2 lg:my-0";

                const title = document.createElement("h3");
                title.className = "text-white font-bold text-lg truncate max-w-full";
                title.textContent = `${objeto.NombrePuntoVenta}`;

                titleContainer.appendChild(title);
                header.appendChild(titleContainer);

                const locationIcon = document.createElement("div");
                locationIcon.className = "mr-2";
                locationIcon.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
</svg>
`;

                // Subtitle
                const subtitle = document.createElement("div");
                subtitle.className = "text-white/95 text-xs font-medium";
                subtitle.appendChild(locationIcon);
                subtitle.textContent = `${objeto.Sector} - ${objeto.Zona}`;
                header.appendChild(subtitle);

                // "Pendiente" Badge
                const statusBadge = document.createElement("div");
                statusBadge.className = "absolute top-2 right-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md";
                statusBadge.textContent = objeto.Estado;
                statusBadge.style.backgroundColor = "#A22323";
                header.appendChild(statusBadge);

                // Add badges for urgent or new items
                if (objeto.urgente && objeto.nueva) {
                  // Create a container for badges that allows them to be side by side
                  const badgesContainer = document.createElement("div");
                  badgesContainer.className = "absolute -top-2 left-2 flex space-x-2 z-10";

                  // Urgent Badge
                  const urgentBadge = document.createElement("div");
                  urgentBadge.className = "px-3 py-1 text-xs font-bold rounded-md shadow-md flex items-center";
                  urgentBadge.style.backgroundColor = "#FFFFFF";
                  urgentBadge.style.color = "#dc2626"; // Red text
                  urgentBadge.style.border = "2px solid #dc2626";
                  urgentBadge.style.animation = "pulse 2s infinite";

                  // Add alert icon SVG
                  const alertIcon = document.createElement("span");
                  alertIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#dc2626">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>
  `;
                  urgentBadge.appendChild(alertIcon);

                  // Add urgent text
                  const urgentText = document.createElement("span");
                  urgentText.textContent = "URGENTE";
                  urgentBadge.appendChild(urgentText);

                  // New Badge
                  const newBadge = document.createElement("div");
                  newBadge.className = "px-3 py-1 text-xs font-bold text-white rounded-md shadow-md flex items-center";
                  newBadge.style.backgroundColor = "#3b82f6";

                  // Add star icon SVG
                  const newIcon = document.createElement("span");
                  newIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  `;
                  newBadge.appendChild(newIcon);

                  // Add new text
                  const newText = document.createElement("span");
                  newText.textContent = "NUEVA";
                  newBadge.appendChild(newText);

                  // Add both badges to container
                  badgesContainer.appendChild(urgentBadge);
                  badgesContainer.appendChild(newBadge);

                  // Add badges container to header
                  header.appendChild(badgesContainer);

                  // Modify card style to accommodate both badges
                  card.style.backgroundColor = "#FEF2F2"; // Light red background
                  card.style.borderLeft = "4px solid #dc2626"; // Red border
                  card.style.order = "-3"; // Will appear first among displayed items
                } else if (objeto.urgente && !objeto.nueva) {
                  const urgentBadge = document.createElement("div");
                  // Use a white badge with red text for contrast against red background
                  urgentBadge.className = "absolute -top-2 left-2 px-3 py-1 text-xs font-bold rounded-md shadow-md flex items-center";
                  urgentBadge.style.backgroundColor = "#FFFFFF";
                  urgentBadge.style.color = "#dc2626"; // Red text
                  urgentBadge.style.border = "2px solid #dc2626";
                  urgentBadge.style.zIndex = "10";
                  urgentBadge.style.animation = "pulse 2s infinite";

                  // Add alert icon SVG
                  const alertIcon = document.createElement("span");
                  alertIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#dc2626">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>
  `;
                  urgentBadge.appendChild(alertIcon);

                  // Add text
                  const badgeText = document.createElement("span");
                  badgeText.textContent = "URGENTE";
                  urgentBadge.appendChild(badgeText);

                  header.appendChild(urgentBadge);
                } else if (objeto.nueva && !objeto.urgente) {
                  const newBadge = document.createElement("div");
                  // Use a blue badge with white text - matching position with urgent badge
                  newBadge.className = "absolute -top-2 left-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md flex items-center";
                  newBadge.style.backgroundColor = "#3b82f6";
                  newBadge.style.zIndex = "10";

                  // Add star icon SVG
                  const newIcon = document.createElement("span");
                  newIcon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
    </svg>
  `;
                  newBadge.appendChild(newIcon);

                  // Add text
                  const badgeText = document.createElement("span");
                  badgeText.textContent = "NUEVA";
                  newBadge.appendChild(badgeText);

                  header.appendChild(newBadge);
                }


                // Card Body
                const body = document.createElement("div");
                body.className = "text-gray-900 p-4 space-y-2 mb-12";

                // Information Rows
                const createInfoRow = (label, value) => {
                  const row = document.createElement("div");
                  row.className = "flex justify-between gap-4 items-center py-2 px-4 bg-gray-100 border border-gray-200 rounded-lg";

                  const labelCol = document.createElement("div");
                  labelCol.className = "text-gray-700 text-xs uppercase font-semibold";
                  labelCol.textContent = label;

                  const valueCol = document.createElement("div");
                  valueCol.className = "text-gray-900 font-medium text-sm text-right";
                  valueCol.textContent = value || "-";

                  row.appendChild(labelCol);
                  row.appendChild(valueCol);
                  return row;
                };

                // Add Key Data
                body.appendChild(createInfoRow("LÍNEA", objeto.LineaActividad));
                body.appendChild(createInfoRow("CLIENTE", objeto.NombreCliente));
                body.appendChild(createInfoRow("TIPO", objeto.TipoTrabajo));
                body.appendChild(createInfoRow("OBSERVACIONES", objeto.Observaciones));
                body.appendChild(createInfoRow("DIRECCIÓN", objeto.DireccionPuntoVenta));
                body.appendChild(createInfoRow("OT NAVISION", objeto.Navision_OT));
                body.appendChild(createInfoRow("OT CRM", objeto.OT));

                // Footer with button
                const footer = document.createElement("div");
                footer.className = "flex justify-center bg-white rounded-b-lg px-4 mb-3";

                // "Reportar" Button
                const actionBtn = document.createElement("button");
                actionBtn.className = "mx-6 absolute bottom-4 bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-24 transition-all duration-300 rounded-lg shadow-sm mx-auto flex justify-center items-center";
                actionBtn.innerHTML = "<span class='ml-1'>Más Detalles</span>";

                actionBtn.onclick = (e) => {
                  e.stopPropagation();

                  localStorage.setItem("renderizarHistorial", false);
                  localStorage.setItem("linea", objeto.Linea);
                  localStorage.setItem("lineaActividad", objeto.LineaActividad);
                  localStorage.setItem("ot", objeto.OT);
                  localStorage.setItem("cliente", objeto.Cliente);
                  localStorage.setItem("nombreCliente", objeto.NombreCliente);

                  createLineDetailsModal(objeto);
                };

                footer.appendChild(actionBtn);

                // Assemble Card
                card.appendChild(header);
                card.appendChild(body);
                card.appendChild(footer);

                // Full Card Search Data
                const fullText = `${objeto.Sector} ${objeto.Zona} ${objeto.LineaActividad} ${objeto.NombrePuntoVenta} ${objeto.NombreCliente} ${objeto.TipoTrabajo} ${objeto.Observaciones || ""} DIRECCIÓN: ${objeto.DireccionPuntoVenta || ""} NAVISION: ${objeto.Navision_OT} CRM: ${objeto.OT}`;
                card.setAttribute("data-search-text", fullText.toLowerCase());

                // Append card to TODOS grid
                todosGrid.appendChild(card);
              });
              todosContentDiv.appendChild(todosGrid);

              // Add TODOS tab to header first
              tabsHeader.appendChild(todosButton);

              // For each sector, create a tab and content section
              sectors.forEach((sector, index) => {
                // Create tab button (not active by default)
                const tabButton = document.createElement('button');
                tabButton.className = 'p-4 text-gray-700 font-medium text-sm uppercase whitespace-nowrap transition-all duration-200 border-b-2 border-transparent hover:text-red-600 hover:border-red-600/50';
                tabButton.textContent = sector;
                tabButton.dataset.sector = sector;

                // Create content div for this sector
                const contentDiv = document.createElement('div');
                contentDiv.className = 'sector-content';
                contentDiv.dataset.sector = sector;
                contentDiv.style.display = 'none'; // Hidden by default (TODOS is active)

                // Filter lines for this sector and add them to the content
                const sectorLines = lineas.filter(line => {
                  const lineSector = line.Sector?.split(' ')[0] || '';
                  return lineSector === sector;
                });

                // Create a grid for the cards
                const sectorGrid = document.createElement('div');
                sectorGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 place-items-center';

                // Create cards for each line in this sector
                // Sort the lines to have urgent and new items first
                const sortedLines = processAndSortItems(sectorLines);
                sortedLines.forEach((objeto) => {                  // Create a card container for each item
                  const card = document.createElement("div");
                  card.className = "relative rounded-xl shadow-lg overflow-hidden transition-all duration-300 border border-gray-200 w-full h-full";
                  card.style.backgroundColor = "#FFFFFF";

                  // Header with SVG Red Texture Background
                  const header = document.createElement("div");
                  header.className = "relative flex flex-col px-5 py-5 text-center text-white";

                  header.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
                  header.style.backgroundSize = "contain";
                  header.style.backgroundPosition = "center";

                  // Title
                  const titleContainer = document.createElement("div");
                  titleContainer.className = "flex items-center justify-center mb-1 my-2 lg:my-0";

                  const title = document.createElement("h3");
                  title.className = "text-white font-bold text-lg truncate max-w-full";
                  title.textContent = `${objeto.NombrePuntoVenta}`;

                  titleContainer.appendChild(title);
                  header.appendChild(titleContainer);

                  const locationIcon = document.createElement("div");
                  locationIcon.className = "mr-2";
                  locationIcon.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
</svg>
`;

                  // Subtitle
                  const subtitle = document.createElement("div");
                  subtitle.className = "text-white/95 text-xs font-medium";
                  subtitle.appendChild(locationIcon);
                  subtitle.textContent = `${objeto.Sector} - ${objeto.Zona}`;
                  header.appendChild(subtitle);

                  // "Pendiente" Badge
                  const statusBadge = document.createElement("div");
                  statusBadge.className = "absolute top-2 right-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md";
                  statusBadge.textContent = objeto.Estado;
                  statusBadge.style.backgroundColor = "#A22323";
                  header.appendChild(statusBadge);

                  // Card Body
                  const body = document.createElement("div");
                  body.className = "text-gray-900 p-4 space-y-2 mb-12";

                  // Information Rows
                  const createInfoRow = (label, value) => {
                    const row = document.createElement("div");
                    row.className = "flex justify-between gap-4 items-center py-2 px-4 bg-gray-100 border border-gray-200 rounded-lg";

                    const labelCol = document.createElement("div");
                    labelCol.className = "text-gray-700 text-xs uppercase font-semibold";
                    labelCol.textContent = label;

                    const valueCol = document.createElement("div");
                    valueCol.className = "text-gray-900 font-medium text-sm text-right";
                    valueCol.textContent = value || "-";

                    row.appendChild(labelCol);
                    row.appendChild(valueCol);
                    return row;
                  };

                  // Add Key Data
                  body.appendChild(createInfoRow("LÍNEA", objeto.LineaActividad));
                  body.appendChild(createInfoRow("CLIENTE", objeto.NombreCliente));
                  body.appendChild(createInfoRow("TIPO", objeto.TipoTrabajo));
                  body.appendChild(createInfoRow("OBSERVACIONES", objeto.Observaciones));
                  body.appendChild(createInfoRow("DIRECCIÓN", objeto.DireccionPuntoVenta));
                  body.appendChild(createInfoRow("OT NAVISION", objeto.Navision_OT));
                  body.appendChild(createInfoRow("OT CRM", objeto.OT));

                  // Footer - now more subtle with centered button
                  const footer = document.createElement("div");
                  footer.className = "flex justify-center bg-white rounded-b-lg px-4 mb-3";

                  // "Reportar" Button - smaller and more subtle
                  const actionBtn = document.createElement("button");
                  // Change button color based on item type
                  let btnClass = "mx-6 absolute bottom-4 text-white text-sm font-bold py-2 px-24 transition-all duration-300 rounded-lg shadow-sm mx-auto flex justify-center items-center";

                  if (objeto.urgente) {
                    btnClass += " bg-red-700 hover:bg-red-800"; // Darker red for urgent
                  } else if (objeto.nueva) {
                    btnClass += " bg-blue-600 hover:bg-blue-700"; // Blue for new
                  } else {
                    btnClass += " bg-red-600 hover:bg-red-700"; // Default red
                  }
                  actionBtn.className = btnClass;
                  actionBtn.innerHTML = "<span class='ml-1'>Más Detalles</span>";

                  actionBtn.onclick = (e) => {
                    e.stopPropagation();

                    localStorage.setItem("renderizarHistorial", false);
                    localStorage.setItem("linea", objeto.Linea);
                    localStorage.setItem("lineaActividad", objeto.LineaActividad);
                    localStorage.setItem("ot", objeto.OT);
                    localStorage.setItem("cliente", objeto.Cliente);
                    localStorage.setItem("nombreCliente", objeto.NombreCliente);

                    createLineDetailsModal(objeto);
                  };

                  footer.appendChild(actionBtn);

                  // Assemble Card
                  card.appendChild(header);
                  card.appendChild(body);
                  card.appendChild(footer);

                  // Full Card Search Data
                  const fullText = `${objeto.Sector} ${objeto.Zona} ${objeto.LineaActividad} ${objeto.NombrePuntoVenta} ${objeto.NombreCliente} ${objeto.TipoTrabajo} ${objeto.Observaciones || ""} DIRECCIÓN: ${objeto.DireccionPuntoVenta || ""} NAVISION: ${objeto.Navision_OT} CRM: ${objeto.OT}`;
                  card.setAttribute("data-search-text", fullText.toLowerCase());

                  // Append to Grid Container
                  sectorGrid.appendChild(card);
                });

                contentDiv.appendChild(sectorGrid);

                // Add count badge to tab
                const countBadge = document.createElement('span');
                countBadge.className = 'ml-2 bg-red-700 text-white text-xs rounded-full h-5  inline-flex items-center justify-center px-1.5';
                countBadge.textContent = sectorLines.length;
                tabButton.appendChild(countBadge);

                // Add click event to switch tabs
                tabButton.addEventListener('click', () => {
                  // Remove active class and red border from all tabs
                  const allTabs = tabsHeader.querySelectorAll('button');
                  allTabs.forEach(tab => {
                    tab.classList.remove('border-red-600', 'text-red-600');
                    tab.classList.add('border-transparent');
                    tab.classList.remove('bg-red-600', 'text-white');
                    tab.classList.add('text-gray-700', 'hover:text-red-600', 'hover:border-red-600/50');
                  });

                  // Add red border and text to clicked tab
                  tabButton.classList.add('border-red-600', 'text-red-600');
                  tabButton.classList.remove('border-transparent');
                  tabButton.classList.remove('bg-red-600', 'text-white', 'hover:text-red-600', 'hover:border-red-600/50');

                  // Hide all content sections
                  const allContent = tabsContent.querySelectorAll('.sector-content');
                  allContent.forEach(content => {
                    content.style.display = 'none';
                  });

                  // Show the selected content section
                  const activeContent = tabsContent.querySelector(`.sector-content[data-sector="${sector}"]`);
                  if (activeContent) {
                    activeContent.style.display = 'block';
                  }
                });

                // Add to containers
                tabsHeader.appendChild(tabButton);
                tabsContent.appendChild(contentDiv);
              });

              // Add TODOS tab click handler
              todosButton.addEventListener('click', () => {
                // Remove active class from all tabs
                const allTabs = tabsHeader.querySelectorAll('button');
                allTabs.forEach(tab => {
                  tab.classList.remove('border-red-600', 'text-red-600');
                  tab.classList.add('border-transparent');
                  tab.classList.add('text-gray-700', 'hover:text-red-600', 'hover:border-red-600/50');
                });

                // Make TODOS tab active
                todosButton.classList.add('border-red-600', 'text-red-600');
                todosButton.classList.remove('border-transparent', 'hover:text-red-600', 'hover:border-red-600/50');

                // Hide all content sections
                const allContent = tabsContent.querySelectorAll('.sector-content');
                allContent.forEach(content => {
                  content.style.display = 'none';
                });

                // Show TODOS content
                todosContentDiv.style.display = 'block';
              });

              // Add TODOS content to the tab contents
              tabsContent.appendChild(todosContentDiv);

              // Add tabs and content to the main container
              tabsContainer.appendChild(tabsHeader);
              tabsContainer.appendChild(tabsContent);

              // Add to main content area
              $contenido.appendChild(tabsContainer);
            } else {
              // Fallback to regular grid if no sectors found
              const gridContainer = document.createElement("div");
              gridContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 place-items-center";

              // Create cards for regular view if no sectors
              lineas.forEach((objeto) => {
                // Create a card container for each item
                const card = document.createElement("div");
                card.className = "relative rounded-xl shadow-lg overflow-hidden transition-all duration-300 border border-gray-200 w-full h-full";
                card.style.backgroundColor = "#FFFFFF";

                // Special styling for urgent and new items
                if (objeto.urgente) {
                  card.style.backgroundColor = "#FEF2F2"; // Light red background
                  card.style.boxShadow = "0 0 15px rgba(220, 38, 38, 0.5)";
                  card.style.borderLeft = "4px solid #dc2626"; // Red border
                  card.style.order = "-2"; // Will appear first
                } else if (objeto.nueva) {
                  card.style.backgroundColor = "#EFF6FF"; // Light blue background
                  card.style.borderLeft = "4px solid #3b82f6"; // Blue border
                  card.style.order = "-1"; // Will appear after urgent items
                }

                // Header with SVG Red Texture Background
                const header = document.createElement("div");
                header.className = "relative flex flex-col px-5 py-5 text-center text-white";

                header.style.backgroundImage = "url('https://dosxdos.app.iidos.com/img/texture-red.svg')";
                header.style.backgroundSize = "contain";
                header.style.backgroundPosition = "center";

                // Title
                const titleContainer = document.createElement("div");
                titleContainer.className = "flex items-center justify-center mb-1 my-2 lg:my-0";

                const title = document.createElement("h3");
                title.className = "text-white font-bold text-lg truncate max-w-full";
                title.textContent = `${objeto.NombrePuntoVenta}`;

                titleContainer.appendChild(title);
                header.appendChild(titleContainer);

                const locationIcon = document.createElement("div");
                locationIcon.className = "mr-2";
                locationIcon.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
</svg>
`;

                // Subtitle
                const subtitle = document.createElement("div");
                subtitle.className = "text-white/95 text-xs font-medium";
                subtitle.appendChild(locationIcon);
                subtitle.textContent = `${objeto.Sector} - ${objeto.Zona}`;
                header.appendChild(subtitle);

                // "Pendiente" Badge
                const statusBadge = document.createElement("div");
                statusBadge.className = "absolute top-2 right-2 px-3 py-1 text-xs font-bold text-white rounded-md shadow-md";
                statusBadge.textContent = objeto.Estado;
                statusBadge.style.backgroundColor = "#A22323";
                header.appendChild(statusBadge);

                // Card Body
                const body = document.createElement("div");
                body.className = "text-gray-900 p-4 space-y-2 mb-12";

                // Information Rows
                const createInfoRow = (label, value) => {
                  const row = document.createElement("div");
                  row.className = "flex justify-between gap-4 items-center py-2 px-4 bg-gray-100 border border-gray-200 rounded-lg";

                  const labelCol = document.createElement("div");
                  labelCol.className = "text-gray-700 text-xs uppercase font-semibold";
                  labelCol.textContent = label;

                  const valueCol = document.createElement("div");
                  valueCol.className = "text-gray-900 font-medium text-sm text-right";
                  valueCol.textContent = value || "-";

                  row.appendChild(labelCol);
                  row.appendChild(valueCol);
                  return row;
                };

                // Add Key Data
                body.appendChild(createInfoRow("LÍNEA", objeto.LineaActividad));
                body.appendChild(createInfoRow("CLIENTE", objeto.NombreCliente));
                body.appendChild(createInfoRow("TIPO", objeto.TipoTrabajo));
                body.appendChild(createInfoRow("OBSERVACIONES", objeto.Observaciones));
                body.appendChild(createInfoRow("DIRECCIÓN", objeto.DireccionPuntoVenta));
                body.appendChild(createInfoRow("OT NAVISION", objeto.Navision_OT));
                body.appendChild(createInfoRow("OT CRM", objeto.OT));

                // Footer - now more subtle with centered button
                const footer = document.createElement("div");
                footer.className = "flex justify-center bg-white rounded-b-lg px-4 mb-3";

                // "Reportar" Button - smaller and more subtle
                const actionBtn = document.createElement("button");
                actionBtn.className = "mx-6 absolute bottom-4 bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-24 transition-all duration-300 rounded-lg shadow-sm mx-auto flex justify-center items-center";
                actionBtn.innerHTML = "<span class='ml-1'>Más Detalles</span>";

                actionBtn.onclick = (e) => {
                  e.stopPropagation();

                  localStorage.setItem("renderizarHistorial", false);
                  localStorage.setItem("linea", objeto.Linea);
                  localStorage.setItem("lineaActividad", objeto.LineaActividad);
                  localStorage.setItem("ot", objeto.OT);
                  localStorage.setItem("cliente", objeto.Cliente);
                  localStorage.setItem("nombreCliente", objeto.NombreCliente);

                  createLineDetailsModal(objeto);
                };

                footer.appendChild(actionBtn);

                // Assemble Card
                card.appendChild(header);
                card.appendChild(body);
                card.appendChild(footer);

                // Full Card Search Data
                const fullText = `${objeto.Sector} ${objeto.Zona} ${objeto.LineaActividad} ${objeto.NombrePuntoVenta} ${objeto.NombreCliente} ${objeto.TipoTrabajo} ${objeto.Observaciones || ""} DIRECCIÓN: ${objeto.DireccionPuntoVenta || ""} NAVISION: ${objeto.Navision_OT} CRM: ${objeto.OT}`;
                card.setAttribute("data-search-text", fullText.toLowerCase());

                // Append to Grid Container
                gridContainer.appendChild(card);
              });

              $contenido.appendChild(gridContainer);
            }

            // Update search to work across all tabs
            buscador.addEventListener("input", () => {
              const searchTerm = buscador.value.toLowerCase().trim();

              // Get all tabs and cards
              const sectorTabs = document.querySelectorAll('button[data-sector]');
              const allCards = document.querySelectorAll("[data-search-text]");

              // Remove any "no results" message
              const noResults = document.getElementById('no-search-results');
              if (noResults) noResults.remove();

              if (searchTerm === '') {
                // If search is cleared, reset view

                // Make all cards visible first
                allCards.forEach(card => {
                  card.style.display = "block";
                });

                // Find active tab
                const activeTab = document.querySelector('button[data-sector].border-red-600');

                if (activeTab) {
                  const activeSector = activeTab.dataset.sector;

                  // Show only content for active tab
                  document.querySelectorAll('.sector-content').forEach(content => {
                    if (content.dataset.sector === activeSector) {
                      content.style.display = 'block';
                    } else {
                      content.style.display = 'none';
                    }
                  });
                }

                return;
              }

              // When searching, always go to TODOS tab for complete results
              if (sectors.length > 0) {
                // Activate TODOS tab
                const todosTab = document.querySelector('button[data-sector="todos"]');
                if (todosTab) {
                  // Deactivate all tabs
                  sectorTabs.forEach(tab => {
                    tab.classList.remove('border-red-600', 'text-red-600');
                    tab.classList.add('border-transparent', 'text-gray-700');
                  });

                  // Activate TODOS tab
                  todosTab.classList.add('border-red-600', 'text-red-600');
                  todosTab.classList.remove('border-transparent');

                  // Show TODOS content
                  document.querySelectorAll('.sector-content').forEach(content => {
                    if (content.dataset.sector === 'todos') {
                      content.style.display = 'block';
                    } else {
                      content.style.display = 'none';
                    }
                  });
                }
              }

              // Filter cards based on search
              let hasResults = false;
              allCards.forEach(card => {
                const searchText = card.getAttribute("data-search-text");

                if (searchText.includes(searchTerm)) {
                  card.style.display = "block";
                  hasResults = true;
                } else {
                  card.style.display = "none";
                }
              });

              // Show no results message if needed
              if (!hasResults) {
                const noResultsMsg = document.createElement('div');
                noResultsMsg.id = 'no-search-results';
                noResultsMsg.className = 'p-8 bg-gray-100 rounded-lg text-center text-gray-500 my-4';
                noResultsMsg.innerHTML = `No se encontraron resultados para <strong>"${searchTerm}"</strong>`;

                const todosContent = document.querySelector('.sector-content[data-sector="todos"]');
                if (todosContent) {
                  todosContent.insertBefore(noResultsMsg, todosContent.firstChild);
                } else {
                  $contenido.insertBefore(noResultsMsg, $contenido.firstChild);
                }
              }
            });
            loaderOff();
          } else {
            alerta("Error al leer el almacén de líneas");
            await notificar();
            loaderOff();
          }
        }
      } catch (error) {
        const mensaje = "ERROR: " + error.message;
        console.error(error);
        alerta(mensaje);
      }
    }

    /* EVENTOS CLIC */

    document.addEventListener("click", (e) => {
      if (e.target.matches("#cerrarSesion")) {
        cerrarSesion();
      }
    });

    /* PETICIONES PENDIENTES */

    function actualizarLinea(json) {
      return new Promise((resolve, reject) => {
        console.log(json);
        fetch("https://dosxdos.app.iidos.com/apirest/lineas.php", {
          method: "PUT",
          headers: {
            "Content-type": "application/json; charset=utf-8",
          },
          body: json,
        })
          .then((res) =>
            res.ok
              ? res.json()
              : reject(
                new Error(
                  `Error en los servidores al actualizar los datos de la línea`
                )
              )
          )
          .then((res) => {
            if (res[0]) {
              resolve(true);
            } else {
              resolve(false);
            }
          })
          .catch((err) => {
            console.log(err);
            reject(err);
          });
      });
    }

    function subirFotos(json) {
      return new Promise((resolve, reject) => {
        fetch("https://dosxdos.app.iidos.com/apirest/fotos.php", {
          method: "POST",
          headers: {
            "Content-type": "application/json; charset=utf-8",
          },
          body: json,
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(
                `Error en el servidor de la API intermedia al guardar las fotos. Status: ${res.status}`
              );
            }
            return res.json();
          })
          .then((res) => {
            if (res[0]) {
              resolve(true);
            } else {
              resolve(false);
            }
          })
          .catch((err) => {
            console.log(err);
            reject(err);
          });
      });
    }

    function subirFirmas(json) {
      return new Promise((resolve, reject) => {
        fetch("https://dosxdos.app.iidos.com/apirest/firmas.php", {
          method: "POST",
          headers: {
            "Content-type": "application/json; charset=utf-8",
          },
          body: json,
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(
                `Error en el servidor de la API intermedia al guardar las firmas. Status: ${res.status}`
              );
            }
            return res.json();
          })
          .then((res) => {
            if (res[0]) {
              resolve(true);
            } else {
              resolve(false);
            }
          })
          .catch((err) => {
            console.log(err);
            reject(err);
          });
      });
    }

    function subirNota(json) {
      return new Promise((resolve, reject) => {
        fetch("https://dosxdos.app.iidos.com/apirest/notas.php", {
          method: "POST",
          headers: {
            "Content-type": "application/json; charset=utf-8",
          },
          body: json,
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(
                `Error en el servidor de la API intermedia al guardar la nota. Status: ${res.status}`
              );
            }
            return res.json();
          })
          .then((res) => {
            if (res[0]) {
              resolve(true);
            } else {
              resolve(false);
            }
          })
          .catch((err) => {
            console.log(err);
            reject(err);
          });
      });
    }

    async function enviarPeticiones(vectorObjDb, tipoVector) {
      return new Promise(async (resolve, reject) => {
        try {
          let solicitud,
            mensaje = "",
            vaciarStore;
          for (const objeto of vectorObjDb) {
            jsonObjeto = JSON.stringify(objeto);
            if (tipoVector == "lineas") {
              solicitud = await actualizarLinea(jsonObjeto);
              if (!solicitud) {
                mensaje += `-Error en el envío de la petición pendiente de la actualización de datos en la api de Navision en la ruta: ${objeto.CodigoRuta} y la línea de ruta: ${objeto.LineaRuta}-`;
              }
            } else if (tipoVector == "fotos") {
              solicitud = await subirFotos(jsonObjeto);
              if (!solicitud) {
                mensaje += `-Error al subir las fotos pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
              }
            } else if (tipoVector == "firmas") {
              solicitud = await subirFirmas(jsonObjeto);
              if (!solicitud) {
                mensaje += `-Error al subir las firmas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.lineaActividad}-`;
              }
            } else if (tipoVector == "notas") {
              solicitud = await subirNota(jsonObjeto);
              if (!solicitud) {
                mensaje += `-Error al subir las notas pendientes de la ot: ${objeto.ot} y la línea: ${objeto.linea}-`;
              }
            }
          }
          if (tipoVector == "lineas") {
            vaciarStore = await limpiarDatos("dosxdos", "peticionesLineas");
            mensaje += "-Datos pendientes enviados al servidor-";
          } else if (tipoVector == "fotos") {
            vaciarStore = await limpiarDatos("dosxdos", "peticionesFotos");
            mensaje += "-Fotos pendientes subidas al servidor-";
          } else if (tipoVector == "firmas") {
            vaciarStore = await limpiarDatos("dosxdos", "peticionesFirmas");
            mensaje += "-Firmas pendientes subidas al servidor-";
          } else if (tipoVector == "notas") {
            vaciarStore = await limpiarDatos("dosxdos", "notas");
            mensaje += "-Notas pendientes subidas al servidor-";
          }
          resolve(mensaje);
        } catch (err) {
          console.error(err);
          alerta(err.message);
          scrollToTop();
          reject(err);
        }
      });
    }

    async function procesarPeticiones() {
      try {
        loaderOn();
        mensaje = "";
        const exPeticionesLineas = await almacenVacio(
          "dosxdos",
          "peticionesLineas"
        );
        if (!exPeticionesLineas) {
          const peticionesLineas = await leerDatos(
            "dosxdos",
            "peticionesLineas"
          );
          if (peticionesLineas) {
            //console.log(peticionesLineas);
            const enviarPeticionesLineas = await enviarPeticiones(
              peticionesLineas,
              "lineas"
            );
            if (enviarPeticionesLineas) {
              mensaje += enviarPeticionesLineas;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
          }
        }
        const exPeticionesFotos = await almacenVacio(
          "dosxdos",
          "peticionesFotos"
        );
        if (!exPeticionesFotos) {
          const peticionesFotos = await leerDatos("dosxdos", "peticionesFotos");
          if (peticionesFotos) {
            //console.log(peticionesFotos);
            const enviarPeticionesFotos = await enviarPeticiones(
              peticionesFotos,
              "fotos"
            );
            if (enviarPeticionesFotos) {
              mensaje += enviarPeticionesFotos;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
          }
        }
        const exPeticionesFirmas = await almacenVacio(
          "dosxdos",
          "peticionesFirmas"
        );
        if (!exPeticionesFirmas) {
          const peticionesFirmas = await leerDatos(
            "dosxdos",
            "peticionesFirmas"
          );
          if (peticionesFirmas) {
            //console.log(peticionesFirmas);
            const enviarPeticionesFirmas = await enviarPeticiones(
              peticionesFirmas,
              "firmas"
            );
            if (enviarPeticionesFirmas) {
              mensaje += enviarPeticionesFirmas;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
          }
        }
        const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
        if (!exPeticionesNotas) {
          const peticionesNotas = await leerDatos("dosxdos", "notas");
          if (peticionesNotas) {
            //console.log(peticionesFirmas);
            const enviarPeticionesNotas = await enviarPeticiones(
              peticionesNotas,
              "notas"
            );
            if (enviarPeticionesNotas) {
              mensaje += enviarPeticionesNotas;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
          }
        }
        if (!mensaje) {
          mensaje = "No hay datos pendientes para ser enviados al servidor";
        }
        const sincronizarBaseDatos = await sincronizarDb2();
        if (sincronizarBaseDatos) {
          mensaje += " - Se ha sincronizado la base de datos exitosamente";
        } else {
          mensaje += " - Error: No ha sido posible sincronizar la base de datos";
        }
        localStorage.setItem("mensaje", mensaje);
        location.reload();
        /*alerta(mensaje);
          scrollToTop();*/
      } catch (error) {
        console.error(error);
        alerta(error.message);
        scrollToTop();
      }
    }

    async function procesarPeticiones2(mensaje) {
      try {
        if (mensaje == null) {
          mensaje = "";
        }
        const exPeticionesLineas = await almacenVacio(
          "dosxdos",
          "peticionesLineas"
        );
        if (!exPeticionesLineas) {
          const peticionesLineas = await leerDatos(
            "dosxdos",
            "peticionesLineas"
          );
          if (peticionesLineas) {
            //console.log(peticionesLineas);
            const enviarPeticionesLineas = await enviarPeticiones(
              peticionesLineas,
              "lineas"
            );
            if (enviarPeticionesLineas) {
              mensaje += enviarPeticionesLineas;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las líneas. Las peticiones pendientes de las líneas no han sido procesadas-";
          }
        }
        const exPeticionesFotos = await almacenVacio(
          "dosxdos",
          "peticionesFotos"
        );
        if (!exPeticionesFotos) {
          const peticionesFotos = await leerDatos("dosxdos", "peticionesFotos");
          if (peticionesFotos) {
            //console.log(peticionesFotos);
            const enviarPeticionesFotos = await enviarPeticiones(
              peticionesFotos,
              "fotos"
            );
            if (enviarPeticionesFotos) {
              mensaje += enviarPeticionesFotos;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las fotos. Las peticiones pendientes de las fotos no han sido procesadas-";
          }
        }
        const exPeticionesFirmas = await almacenVacio(
          "dosxdos",
          "peticionesFirmas"
        );
        if (!exPeticionesFirmas) {
          const peticionesFirmas = await leerDatos(
            "dosxdos",
            "peticionesFirmas"
          );
          if (peticionesFirmas) {
            //console.log(peticionesFirmas);
            const enviarPeticionesFirmas = await enviarPeticiones(
              peticionesFirmas,
              "firmas"
            );
            if (enviarPeticionesFirmas) {
              mensaje += enviarPeticionesFirmas;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las firmas. Las peticiones pendientes de las firmas no han sido procesadas-";
          }
        }
        const exPeticionesNotas = await almacenVacio("dosxdos", "notas");
        if (!exPeticionesNotas) {
          const peticionesNotas = await leerDatos("dosxdos", "notas");
          if (peticionesNotas) {
            //console.log(peticionesFirmas);
            const enviarPeticionesNotas = await enviarPeticiones(
              peticionesNotas,
              "notas"
            );
            if (enviarPeticionesNotas) {
              mensaje += enviarPeticionesNotas;
            }
          } else {
            mensaje +=
              "-Error al leer las peticiones de las notas. Las peticiones pendientes de las notas no han sido procesadas-";
          }
        }
        if (mensaje) {
          alerta(mensaje);
          scrollToTop();
        }
      } catch (error) {
        console.error(error);
        alerta(error.message);
        scrollToTop();
      }
    }

    /* TAREAS EN LA INTERMITENCIA DE LA CONEXIÓN */

    window.addEventListener("online", () => {
      console.log("La conexión a Internet se ha recuperado.");
      //cache();
      procesarPeticiones();
    });

    window.addEventListener("offline", () => {
      console.log("La conexión a Internet se ha perdido.");
    });

    /* PAGESHOW */
    window.addEventListener("pageshow", (e) => {
      console.log("Carga completa de los elementos de la página no fetch");
      let mensaje = localStorage.getItem("mensaje");
      if (mensaje && mensaje !== null) {
        alerta(mensaje);
        localStorage.removeItem("mensaje");
      }
      let login = localStorage.getItem("login");
      if (!login || login === null) {
        window.location.href = "https://dosxdos.app.iidos.com/index.html";
      }
    });

    /* TAREAS AL INICIAR LA PANTALLA CON EL ESTADO DE LA CONEXIÓN */

    if (navigator.onLine) {
      console.log("La aplicación está en línea.");
      //cache();
      appOnline();
    } else {
      console.log("La aplicación está fuera de línea.");
      appOffline();
    }
  </script>

  <script src="https://dosxdos.app.iidos.com/js/loadFirebase.js"></script>

</html>